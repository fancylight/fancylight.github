<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>tomcat | 博客</title><meta name="description" content="tomcat"><meta name="keywords" content="源码"><meta name="author" content="fancylight"><meta name="copyright" content="fancylight"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="tomcat"><meta name="twitter:description" content="tomcat"><meta name="twitter:image" content="http://yoursite.com/img/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="tomcat"><meta property="og:url" content="http://yoursite.com/2018/10/06/tomcat/"><meta property="og:site_name" content="博客"><meta property="og:description" content="tomcat"><meta property="og:image" content="http://yoursite.com/img/post.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      now = new Date();
      hour = now.getHours();
      isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2018/10/06/tomcat/"><link rel="prev" title="标准库源码-io" href="http://yoursite.com/2018/11/12/%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81-io/"><link rel="next" title="链接" href="http://yoursite.com/2018/09/05/%E9%93%BE%E6%8E%A5/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: false,
  highlightShrink: false,
  isFontAwesomeV5: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">36</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">18</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#架构"><span class="toc-number">1.</span> <span class="toc-text">架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#server-xml相关"><span class="toc-number">1.1.</span> <span class="toc-text">server.xml相关</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#server-xml源"><span class="toc-number">1.1.1.</span> <span class="toc-text">server.xml源</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#server-xml对于java代码加载"><span class="toc-number">1.1.2.</span> <span class="toc-text">server.xml对于java代码加载</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#接口"><span class="toc-number">1.2.</span> <span class="toc-text">接口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Lifecycle-接口"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. Lifecycle 接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ContainerBase"><span class="toc-number">1.2.2.</span> <span class="toc-text">ContainerBase</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tomcat关键部分及各部分作用"><span class="toc-number">1.3.</span> <span class="toc-text">tomcat关键部分及各部分作用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-server-xml-该配置文件实际非常详实的说明了tomcat的架构"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. server.xml 该配置文件实际非常详实的说明了tomcat的架构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-类加载器"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 类加载器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-Server继承图"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. Server继承图</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-Service继承图"><span class="toc-number">1.3.4.</span> <span class="toc-text">4. Service继承图</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-Engine继承图"><span class="toc-number">1.3.5.</span> <span class="toc-text">5. Engine继承图</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-connector"><span class="toc-number">1.3.6.</span> <span class="toc-text">6. connector</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-Context"><span class="toc-number">1.3.7.</span> <span class="toc-text">7.Context</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#各部分作用"><span class="toc-number">1.4.</span> <span class="toc-text">各部分作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#监听器"><span class="toc-number">1.5.</span> <span class="toc-text">监听器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#VersionLoggerListener"><span class="toc-number">1.5.1.</span> <span class="toc-text">VersionLoggerListener</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AprLifecycleListener"><span class="toc-number">1.5.2.</span> <span class="toc-text">AprLifecycleListener</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JreMemoryLeakPreventionListener"><span class="toc-number">1.5.3.</span> <span class="toc-text">JreMemoryLeakPreventionListener</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GlobalResourcesLifecycleListener"><span class="toc-number">1.5.4.</span> <span class="toc-text">GlobalResourcesLifecycleListener</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ThreadLocalLeakPreventionListener"><span class="toc-number">1.5.5.</span> <span class="toc-text">ThreadLocalLeakPreventionListener</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NamingContextListener"><span class="toc-number">1.5.6.</span> <span class="toc-text">NamingContextListener</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MapperListener"><span class="toc-number">1.5.7.</span> <span class="toc-text">MapperListener</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Hostconfig"><span class="toc-number">1.5.8.</span> <span class="toc-text">Hostconfig</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#相关机制"><span class="toc-number">2.</span> <span class="toc-text">相关机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#life"><span class="toc-number">2.1.</span> <span class="toc-text">life</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Realm-域"><span class="toc-number">2.2.</span> <span class="toc-text">Realm 域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pipeline"><span class="toc-number">2.3.</span> <span class="toc-text">pipeline</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Valve"><span class="toc-number">2.4.</span> <span class="toc-text">Valve</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tomcat部署"><span class="toc-number">2.5.</span> <span class="toc-text">tomcat部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NioEndPoint底层机制"><span class="toc-number">2.6.</span> <span class="toc-text">NioEndPoint底层机制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#连接请求到执行器处理"><span class="toc-number">2.6.1.</span> <span class="toc-text">连接请求到执行器处理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#nio读写逻辑相关"><span class="toc-number">2.6.2.</span> <span class="toc-text">nio读写逻辑相关</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#processor-和adaptor"><span class="toc-number">2.7.</span> <span class="toc-text">processor 和adaptor</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Http11Processor-一般处理http请求的process"><span class="toc-number">2.7.1.</span> <span class="toc-text">Http11Processor 一般处理http请求的process</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mapper"><span class="toc-number">2.8.</span> <span class="toc-text">mapper</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tomcat中jdni"><span class="toc-number">2.9.</span> <span class="toc-text">tomcat中jdni</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">tomcat</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2018-10-06<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-05-09</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/java/">java</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2018/10/06/tomcat/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></div></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h3 id="架构"><a class="header-anchor" href="#架构">¶</a>架构</h3>
<img src="/2018/10/06/tomcat/%E6%9E%B6%E6%9E%84.png" class="">
<h4 id="server-xml相关"><a class="header-anchor" href="#server-xml相关">¶</a>server.xml相关</h4>
<h5 id="server-xml源"><a class="header-anchor" href="#server-xml源">¶</a>server.xml源</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--该文件说明了tomcat的 架构,以及很多细节--&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment">  contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment">  this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment">  The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment">  (the "License"); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment">  the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">  distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">  limitations under the License.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- <span class="doctag">Note:</span>  A "Server" is not itself a "Container", so you may not</span></span><br><span class="line"><span class="comment">     define subcomponents such as "Valves" at this level.</span></span><br><span class="line"><span class="comment">     Documentation at /docs/config/server.html</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--最外层的StanderServer--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--5个监听器,加上NamingContextListener一共6个--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.startup.VersionLoggerListener"</span> /&gt;</span><span class="comment">&lt;!--init时打印信息--&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Security listener. Documentation at /docs/config/listeners.html</span></span><br><span class="line"><span class="comment">  &lt;Listener className="org.apache.catalina.security.SecurityListener" /&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span> <span class="comment">&lt;!-- --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--APR library loader. Documentation at /docs/apr.html --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> <span class="attr">SSLEngine</span>=<span class="string">"on"</span> /&gt;</span>  <span class="comment">&lt;!--关于apr是否开启,init时触发--&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Prevent memory leaks due to use of particular java/javax APIs--&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span>    <span class="comment">&lt;!--关于防止内存溢出,init触发 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span>   <span class="comment">&lt;!-- 处理jndi start和stop触发--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Global JNDI resources</span></span><br><span class="line"><span class="comment">       Documentation at /docs/jndi-resources-howto.html</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span>    <span class="comment">&lt;!--NamingResourcesImpl实例,在digister构建该对象的过程中,不单单加入了Resource,还加入其他属性如ejb...,参考源码看 --&gt;</span>   </span><br><span class="line">    <span class="comment">&lt;!-- Editable user database that can also be used by</span></span><br><span class="line"><span class="comment">         UserDatabaseRealm to authenticate users</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"UserDatabase"</span> <span class="attr">auth</span>=<span class="string">"Container"</span>   </span></span><br><span class="line"><span class="tag">              <span class="attr">type</span>=<span class="string">"org.apache.catalina.UserDatabase"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">description</span>=<span class="string">"User database that can be updated and saved"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">factory</span>=<span class="string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">pathname</span>=<span class="string">"conf/tomcat-users.xml"</span> /&gt;</span> <span class="comment">&lt;!--这就是jndi管理的东西 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span>  </span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- A "Service" is a collection of one or more "Connectors" that share</span></span><br><span class="line"><span class="comment">       a single "Container" <span class="doctag">Note:</span>  A "Service" is not itself a "Container",</span></span><br><span class="line"><span class="comment">       so you may not define subcomponents such as "Valves" at this level.</span></span><br><span class="line"><span class="comment">       Documentation at /docs/config/service.html</span></span><br><span class="line"><span class="comment">   --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--The connectors can use a shared executor, you can define one or more named thread pools--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    &lt;Executor name="tomcatThreadPool" namePrefix="catalina-exec-"</span></span><br><span class="line"><span class="comment">        maxThreads="150" minSpareThreads="4"/&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- A "Connector" represents an endpoint by which requests are received</span></span><br><span class="line"><span class="comment">         and responses are returned. Documentation at :</span></span><br><span class="line"><span class="comment">         Java HTTP Connector: /docs/config/http.html</span></span><br><span class="line"><span class="comment">         Java AJP  Connector: /docs/config/ajp.html</span></span><br><span class="line"><span class="comment">         APR (HTTP/AJP) Connector: /docs/apr.html</span></span><br><span class="line"><span class="comment">         Define a non-SSL/TLS HTTP/1.1 Connector on port 8080</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- A "Connector" using the shared thread pool--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    &lt;Connector executor="tomcatThreadPool"</span></span><br><span class="line"><span class="comment">               port="8080" protocol="HTTP/1.1"</span></span><br><span class="line"><span class="comment">               connectionTimeout="20000"</span></span><br><span class="line"><span class="comment">               redirectPort="8443" /&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Define a SSL/TLS HTTP/1.1 Connector on port 8443</span></span><br><span class="line"><span class="comment">         This connector uses the NIO implementation. The default</span></span><br><span class="line"><span class="comment">         SSLImplementation will depend on the presence of the APR/native</span></span><br><span class="line"><span class="comment">         library and the useOpenSSL attribute of the</span></span><br><span class="line"><span class="comment">         AprLifecycleListener.</span></span><br><span class="line"><span class="comment">         Either JSSE or OpenSSL style configuration may be used regardless of</span></span><br><span class="line"><span class="comment">         the SSLImplementation selected. JSSE style configuration is used below.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    &lt;Connector port="8443" protocol="org.apache.coyote.http11.Http11NioProtocol"</span></span><br><span class="line"><span class="comment">               maxThreads="150" SSLEnabled="true"&gt;</span></span><br><span class="line"><span class="comment">        &lt;SSLHostConfig&gt;</span></span><br><span class="line"><span class="comment">            &lt;Certificate certificateKeystoreFile="conf/localhost-rsa.jks"</span></span><br><span class="line"><span class="comment">                         type="RSA" /&gt;</span></span><br><span class="line"><span class="comment">        &lt;/SSLHostConfig&gt;</span></span><br><span class="line"><span class="comment">    &lt;/Connector&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Define a SSL/TLS HTTP/1.1 Connector on port 8443 with HTTP/2</span></span><br><span class="line"><span class="comment">         This connector uses the APR/native implementation which always uses</span></span><br><span class="line"><span class="comment">         OpenSSL for TLS.</span></span><br><span class="line"><span class="comment">         Either JSSE or OpenSSL style configuration may be used. OpenSSL style</span></span><br><span class="line"><span class="comment">         configuration is used below.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    &lt;Connector port="8443" protocol="org.apache.coyote.http11.Http11AprProtocol"</span></span><br><span class="line"><span class="comment">               maxThreads="150" SSLEnabled="true" &gt;</span></span><br><span class="line"><span class="comment">        &lt;UpgradeProtocol className="org.apache.coyote.http2.Http2Protocol" /&gt;</span></span><br><span class="line"><span class="comment">        &lt;SSLHostConfig&gt;</span></span><br><span class="line"><span class="comment">            &lt;Certificate certificateKeyFile="conf/localhost-rsa-key.pem"</span></span><br><span class="line"><span class="comment">                         certificateFile="conf/localhost-rsa-cert.pem"</span></span><br><span class="line"><span class="comment">                         certificateChainFile="conf/localhost-rsa-chain.pem"</span></span><br><span class="line"><span class="comment">                         type="RSA" /&gt;</span></span><br><span class="line"><span class="comment">        &lt;/SSLHostConfig&gt;</span></span><br><span class="line"><span class="comment">    &lt;/Connector&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8009"</span> <span class="attr">protocol</span>=<span class="string">"AJP/1.3"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- An Engine represents the entry point (within Catalina) that processes</span></span><br><span class="line"><span class="comment">         every request.  The Engine implementation for Tomcat stand alone</span></span><br><span class="line"><span class="comment">         analyzes the HTTP headers included with the request, and passes them</span></span><br><span class="line"><span class="comment">         on to the appropriate Host (virtual host).</span></span><br><span class="line"><span class="comment">         Documentation at /docs/config/engine.html --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- You should set jvmRoute to support load-balancing via AJP ie :</span></span><br><span class="line"><span class="comment">    &lt;Engine name="Catalina" defaultHost="localhost" jvmRoute="jvm1"&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--For clustering, please take a look at documentation at:</span></span><br><span class="line"><span class="comment">          /docs/cluster-howto.html  (simple how to)</span></span><br><span class="line"><span class="comment">          /docs/config/cluster.html (reference documentation) --&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">      &lt;Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"/&gt;</span></span><br><span class="line"><span class="comment">      --&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- Use the LockOutRealm to prevent attempts to guess user passwords</span></span><br><span class="line"><span class="comment">           via a brute-force attack --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.LockOutRealm"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- This Realm uses the UserDatabase configured in the global JNDI</span></span><br><span class="line"><span class="comment">             resources under the key "UserDatabase".  Any edits</span></span><br><span class="line"><span class="comment">             that are performed against this UserDatabase are immediately</span></span><br><span class="line"><span class="comment">             available for use by the Realm.  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">resourceName</span>=<span class="string">"UserDatabase"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- SingleSignOn valve, share authentication between web applications</span></span><br><span class="line"><span class="comment">             Documentation at: /docs/config/valve.html --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        &lt;Valve className="org.apache.catalina.authenticator.SingleSignOn" /&gt;</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Access log processes all example.</span></span><br><span class="line"><span class="comment">             Documentation at: /docs/config/valve.html</span></span><br><span class="line"><span class="comment">             <span class="doctag">Note:</span> The pattern used is equivalent to using pattern="common" --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"localhost_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>整体架构(出自tomcat内核分析)</li>
</ul>
<img src="/2018/10/06/tomcat/%E6%95%B4%E4%BD%93.png" class="" title="这部分和我看我tomcat9并不是完全符合">
<h5 id="server-xml对于java代码加载"><a class="header-anchor" href="#server-xml对于java代码加载">¶</a>server.xml对于java代码加载</h5>
<figure class="highlight java"><figcaption><span>Catalina中xml解析</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create and configure the Digester we will be using for startup.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the main digester to parse server.xml</span></span><br><span class="line"><span class="comment"> *   看来此处是用来解析server.xml的,而Digester 相当于一个规则和defaultHandler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Digester <span class="title">createStartDigester</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> t1=System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// Initialize the digester  ---&gt;这个解析器代码比较复杂</span></span><br><span class="line">    Digester digester = <span class="keyword">new</span> Digester();</span><br><span class="line">    digester.setValidating(<span class="keyword">false</span>);</span><br><span class="line">    digester.setRulesValidation(<span class="keyword">true</span>);</span><br><span class="line">    Map&lt;Class&lt;?&gt;, List&lt;String&gt;&gt; fakeAttributes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; attrs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    attrs.add(<span class="string">"className"</span>);</span><br><span class="line">    fakeAttributes.put(Object<span class="class">.<span class="keyword">class</span>, <span class="title">attrs</span>)</span>;</span><br><span class="line">    digester.setFakeAttributes(fakeAttributes);</span><br><span class="line">    digester.setUseContextClassLoader(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure the actions we will be using</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  1.addObjectCreate() --&gt;将遇到的开始标签类进行创建</span></span><br><span class="line"><span class="comment">     *  2.addSetProperties()--&gt;将之填充</span></span><br><span class="line"><span class="comment">     *  3.addSetNext--&gt;使用栈顶次栈顶元素调用内部xx方法进行set</span></span><br><span class="line"><span class="comment">     *      在&#123;<span class="doctag">@link</span> Catalina#load()&#125;中push(this)这一步就将catalina本身放到了栈顶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//server</span></span><br><span class="line">    digester.addObjectCreate(<span class="string">"Server"</span>,</span><br><span class="line">                             <span class="string">"org.apache.catalina.core.StandardServer"</span>,</span><br><span class="line">                             <span class="string">"className"</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">"Server"</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">"Server"</span>,</span><br><span class="line">                        <span class="string">"setServer"</span>,</span><br><span class="line">                        <span class="string">"org.apache.catalina.Server"</span>);</span><br><span class="line">    <span class="comment">//NamingResourcesImpl</span></span><br><span class="line">    digester.addObjectCreate(<span class="string">"Server/GlobalNamingResources"</span>,</span><br><span class="line">                             <span class="string">"org.apache.catalina.deploy.NamingResourcesImpl"</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">"Server/GlobalNamingResources"</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">"Server/GlobalNamingResources"</span>,</span><br><span class="line">                        <span class="string">"setGlobalNamingResources"</span>,</span><br><span class="line">                        <span class="string">"org.apache.catalina.deploy.NamingResourcesImpl"</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">"Server/Listener"</span>,</span><br><span class="line">                             <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                             <span class="string">"className"</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">"Server/Listener"</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">"Server/Listener"</span>,</span><br><span class="line">                        <span class="string">"addLifecycleListener"</span>,</span><br><span class="line">                        <span class="string">"org.apache.catalina.LifecycleListener"</span>);</span><br><span class="line">    <span class="comment">//service</span></span><br><span class="line">    digester.addObjectCreate(<span class="string">"Server/Service"</span>,</span><br><span class="line">                             <span class="string">"org.apache.catalina.core.StandardService"</span>,</span><br><span class="line">                             <span class="string">"className"</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">"Server/Service"</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">"Server/Service"</span>,</span><br><span class="line">                        <span class="string">"addService"</span>,</span><br><span class="line">                        <span class="string">"org.apache.catalina.Service"</span>);</span><br><span class="line">    <span class="comment">//service::listener</span></span><br><span class="line">    digester.addObjectCreate(<span class="string">"Server/Service/Listener"</span>,</span><br><span class="line">                             <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                             <span class="string">"className"</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">"Server/Service/Listener"</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">"Server/Service/Listener"</span>,</span><br><span class="line">                        <span class="string">"addLifecycleListener"</span>,</span><br><span class="line">                        <span class="string">"org.apache.catalina.LifecycleListener"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//service::Executor</span></span><br><span class="line">    digester.addObjectCreate(<span class="string">"Server/Service/Executor"</span>,</span><br><span class="line">                     <span class="string">"org.apache.catalina.core.StandardThreadExecutor"</span>,</span><br><span class="line">                     <span class="string">"className"</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">"Server/Service/Executor"</span>);</span><br><span class="line"></span><br><span class="line">    digester.addSetNext(<span class="string">"Server/Service/Executor"</span>,</span><br><span class="line">                        <span class="string">"addExecutor"</span>,</span><br><span class="line">                        <span class="string">"org.apache.catalina.Executor"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//service::listener::Connector</span></span><br><span class="line">    digester.addRule(<span class="string">"Server/Service/Connector"</span>,</span><br><span class="line">                     <span class="keyword">new</span> ConnectorCreateRule());</span><br><span class="line">    digester.addRule(<span class="string">"Server/Service/Connector"</span>, <span class="keyword">new</span> SetAllPropertiesRule(</span><br><span class="line">            <span class="keyword">new</span> String[]&#123;<span class="string">"executor"</span>, <span class="string">"sslImplementationName"</span>, <span class="string">"protocol"</span>&#125;));</span><br><span class="line">    digester.addSetNext(<span class="string">"Server/Service/Connector"</span>,</span><br><span class="line">                        <span class="string">"addConnector"</span>,</span><br><span class="line">                        <span class="string">"org.apache.catalina.connector.Connector"</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">"Server/Service/Connector/SSLHostConfig"</span>,</span><br><span class="line">                             <span class="string">"org.apache.tomcat.util.net.SSLHostConfig"</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">"Server/Service/Connector/SSLHostConfig"</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">"Server/Service/Connector/SSLHostConfig"</span>,</span><br><span class="line">            <span class="string">"addSslHostConfig"</span>,</span><br><span class="line">            <span class="string">"org.apache.tomcat.util.net.SSLHostConfig"</span>);</span><br><span class="line"></span><br><span class="line">    digester.addRule(<span class="string">"Server/Service/Connector/SSLHostConfig/Certificate"</span>,</span><br><span class="line">                     <span class="keyword">new</span> CertificateCreateRule());</span><br><span class="line">    digester.addRule(<span class="string">"Server/Service/Connector/SSLHostConfig/Certificate"</span>,</span><br><span class="line">                     <span class="keyword">new</span> SetAllPropertiesRule(<span class="keyword">new</span> String[]&#123;<span class="string">"type"</span>&#125;));</span><br><span class="line">    digester.addSetNext(<span class="string">"Server/Service/Connector/SSLHostConfig/Certificate"</span>,</span><br><span class="line">                        <span class="string">"addCertificate"</span>,</span><br><span class="line">                        <span class="string">"org.apache.tomcat.util.net.SSLHostConfigCertificate"</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">"Server/Service/Connector/Listener"</span>,</span><br><span class="line">                             <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                             <span class="string">"className"</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">"Server/Service/Connector/Listener"</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">"Server/Service/Connector/Listener"</span>,</span><br><span class="line">                        <span class="string">"addLifecycleListener"</span>,</span><br><span class="line">                        <span class="string">"org.apache.catalina.LifecycleListener"</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">"Server/Service/Connector/UpgradeProtocol"</span>,</span><br><span class="line">                              <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                              <span class="string">"className"</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">"Server/Service/Connector/UpgradeProtocol"</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">"Server/Service/Connector/UpgradeProtocol"</span>,</span><br><span class="line">                        <span class="string">"addUpgradeProtocol"</span>,</span><br><span class="line">                        <span class="string">"org.apache.coyote.UpgradeProtocol"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add RuleSets for nested elements   这几个内容比较重要</span></span><br><span class="line">    digester.addRuleSet(<span class="keyword">new</span> NamingRuleSet(<span class="string">"Server/GlobalNamingResources/"</span>));  <span class="comment">//处理全局naming资源</span></span><br><span class="line">    digester.addRuleSet(<span class="keyword">new</span> EngineRuleSet(<span class="string">"Server/Service/"</span>));			      <span class="comment">// 加载Engine容器		</span></span><br><span class="line">    digester.addRuleSet(<span class="keyword">new</span> HostRuleSet(<span class="string">"Server/Service/Engine/"</span>));			  <span class="comment">//Host容器</span></span><br><span class="line"></span><br><span class="line">    digester.addRuleSet(<span class="keyword">new</span> ContextRuleSet(<span class="string">"Server/Service/Engine/Host/"</span>));   <span class="comment">//Context</span></span><br><span class="line">    addClusterRuleSet(digester, <span class="string">"Server/Service/Engine/Host/Cluster/"</span>);</span><br><span class="line">    digester.addRuleSet(<span class="keyword">new</span> NamingRuleSet(<span class="string">"Server/Service/Engine/Host/Context/"</span>));  <span class="comment">//向context中添加naming资源</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// When the 'engine' is found, set the parentClassLoader.</span></span><br><span class="line">    digester.addRule(<span class="string">"Server/Service/Engine"</span>,</span><br><span class="line">                     <span class="keyword">new</span> SetParentClassLoaderRule(parentClassLoader));</span><br><span class="line">    addClusterRuleSet(digester, <span class="string">"Server/Service/Engine/Cluster/"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> t2=System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Digester for server.xml created "</span> + ( t2-t1 ));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> digester;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>NamingRuleSet</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关于xml中 GlobalNamingResources标签的加载,处理naming资源映射</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRuleInstances</span><span class="params">(Digester digester)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果存在Ejb标签创建,并且调用addEjb添加到NamingResources中</span></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Ejb"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.tomcat.util.descriptor.web.ContextEjb"</span>);</span><br><span class="line">        digester.addRule(prefix + <span class="string">"Ejb"</span>, <span class="keyword">new</span> SetAllPropertiesRule());</span><br><span class="line">        digester.addRule(prefix + <span class="string">"Ejb"</span>,</span><br><span class="line">                <span class="keyword">new</span> SetNextNamingRule(<span class="string">"addEjb"</span>,</span><br><span class="line">                            <span class="string">"org.apache.tomcat.util.descriptor.web.ContextEjb"</span>));</span><br><span class="line">        <span class="comment">//Environment 添加</span></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Environment"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.tomcat.util.descriptor.web.ContextEnvironment"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Environment"</span>);</span><br><span class="line">        digester.addRule(prefix + <span class="string">"Environment"</span>,</span><br><span class="line">                            <span class="keyword">new</span> SetNextNamingRule(<span class="string">"addEnvironment"</span>,</span><br><span class="line">                            <span class="string">"org.apache.tomcat.util.descriptor.web.ContextEnvironment"</span>));</span><br><span class="line">        <span class="comment">//LocalEjb</span></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"LocalEjb"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.tomcat.util.descriptor.web.ContextLocalEjb"</span>);</span><br><span class="line">        digester.addRule(prefix + <span class="string">"LocalEjb"</span>, <span class="keyword">new</span> SetAllPropertiesRule());</span><br><span class="line">        digester.addRule(prefix + <span class="string">"LocalEjb"</span>,</span><br><span class="line">                <span class="keyword">new</span> SetNextNamingRule(<span class="string">"addLocalEjb"</span>,</span><br><span class="line">                            <span class="string">"org.apache.tomcat.util.descriptor.web.ContextLocalEjb"</span>));</span><br><span class="line">        <span class="comment">//这个就是默认常见的如数据库配置等</span></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Resource"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.tomcat.util.descriptor.web.ContextResource"</span>);</span><br><span class="line">        digester.addRule(prefix + <span class="string">"Resource"</span>, <span class="keyword">new</span> SetAllPropertiesRule());</span><br><span class="line">        digester.addRule(prefix + <span class="string">"Resource"</span>,</span><br><span class="line">                <span class="keyword">new</span> SetNextNamingRule(<span class="string">"addResource"</span>,</span><br><span class="line">                            <span class="string">"org.apache.tomcat.util.descriptor.web.ContextResource"</span>));</span><br><span class="line">        <span class="comment">//下边三种我不知道啥玩意</span></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"ResourceEnvRef"</span>,</span><br><span class="line">            <span class="string">"org.apache.tomcat.util.descriptor.web.ContextResourceEnvRef"</span>);</span><br><span class="line">        digester.addRule(prefix + <span class="string">"ResourceEnvRef"</span>, <span class="keyword">new</span> SetAllPropertiesRule());</span><br><span class="line">        digester.addRule(prefix + <span class="string">"ResourceEnvRef"</span>,</span><br><span class="line">                <span class="keyword">new</span> SetNextNamingRule(<span class="string">"addResourceEnvRef"</span>,</span><br><span class="line">                            <span class="string">"org.apache.tomcat.util.descriptor.web.ContextResourceEnvRef"</span>));</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"ServiceRef"</span>,</span><br><span class="line">            <span class="string">"org.apache.tomcat.util.descriptor.web.ContextService"</span>);</span><br><span class="line">        digester.addRule(prefix + <span class="string">"ServiceRef"</span>, <span class="keyword">new</span> SetAllPropertiesRule());</span><br><span class="line">        digester.addRule(prefix + <span class="string">"ServiceRef"</span>,</span><br><span class="line">                <span class="keyword">new</span> SetNextNamingRule(<span class="string">"addService"</span>,</span><br><span class="line">                            <span class="string">"org.apache.tomcat.util.descriptor.web.ContextService"</span>));</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Transaction"</span>,</span><br><span class="line">            <span class="string">"org.apache.tomcat.util.descriptor.web.ContextTransaction"</span>);</span><br><span class="line">        digester.addRule(prefix + <span class="string">"Transaction"</span>, <span class="keyword">new</span> SetAllPropertiesRule());</span><br><span class="line">        digester.addRule(prefix + <span class="string">"Transaction"</span>,</span><br><span class="line">                <span class="keyword">new</span> SetNextNamingRule(<span class="string">"setTransaction"</span>,</span><br><span class="line">                            <span class="string">"org.apache.tomcat.util.descriptor.web.ContextTransaction"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//最终在GlobalNamingResources中就会存在xml中配置的所有属性,这就是jndi</span></span><br><span class="line">	</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>SetNextNamingRule</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">(String namespace, String name)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//这个类是处理namingRuleSet的setNext情况,和一般的不一样,花里胡哨的</span></span><br><span class="line">     <span class="comment">// Identify the objects to be used</span></span><br><span class="line">     Object child = digester.peek(<span class="number">0</span>);</span><br><span class="line">     Object parent = digester.peek(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">     NamingResourcesImpl namingResources = <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">if</span> (parent <span class="keyword">instanceof</span> Context) &#123;  <span class="comment">//此处判断了栈顶类型,如果是Context 则取getNamingResources,这是一个慢加载代码</span></span><br><span class="line">         namingResources = ((Context) parent).getNamingResources(); <span class="comment">//第一次访问向对应context中创建namingResources,之后按照namingResources的逻辑添加资源映射</span></span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         namingResources = (NamingResourcesImpl) parent; <span class="comment">//否则就是向GlobalNamingResources中添加</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Call the specified method</span></span><br><span class="line">     IntrospectionUtils.callMethod1(namingResources, methodName,</span><br><span class="line">             child, paramType, digester.getClassLoader());</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>SetAllPropertiesRule</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment"> * contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment"> * this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment"> * The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment"> * (the "License"); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment"> * the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.catalina.startup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.IntrospectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.digester.Rule;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.Attributes;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Rule that uses the introspection utils to set properties.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Remy Maucherat</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SetAllPropertiesRule</span> <span class="keyword">extends</span> <span class="title">Rule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----------------------------------------------------------- Constructors</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SetAllPropertiesRule</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SetAllPropertiesRule</span><span class="params">(String[] exclude)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;exclude.length; i++ ) <span class="keyword">if</span> (exclude[i]!=<span class="keyword">null</span>) <span class="keyword">this</span>.excludes.put(exclude[i],exclude[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----------------------------------------------------- Instance Variables</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> HashMap&lt;String,String&gt; excludes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --------------------------------------------------------- Public Methods</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle the beginning of an XML element.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> attributes The attributes of this element</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> Exception if a processing error occurs</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(String namespace, String nameX, Attributes attributes)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attributes.getLength(); i++) &#123;</span><br><span class="line">            String name = attributes.getLocalName(i);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">""</span>.equals(name)) &#123;</span><br><span class="line">                name = attributes.getQName(i);</span><br><span class="line">            &#125;</span><br><span class="line">            String value = attributes.getValue(i);</span><br><span class="line">            <span class="keyword">if</span> ( !excludes.containsKey(name)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!digester.isFakeAttribute(digester.peek(), name)</span><br><span class="line">                        &amp;&amp; !IntrospectionUtils.setProperty(digester.peek(), name, value) <span class="comment">//这里牵扯到digester解析的过程,不仅仅能够该任意对象的某属性直接调用setXX(Value)赋值</span></span><br><span class="line">                        <span class="comment">//还能够对某对象内部成员为Map&lt;String,Object&gt; ,调用对应的setProperty(String name, Object value) 进行赋值,参考ResourceBase子类的创建过程</span></span><br><span class="line">                        &amp;&amp; digester.getRulesValidation()) &#123;</span><br><span class="line">                    digester.getLogger().warn(<span class="string">"[SetAllPropertiesRule]&#123;"</span> + digester.getMatch() +</span><br><span class="line">                            <span class="string">"&#125; Setting property '"</span> + name + <span class="string">"' to '"</span> +</span><br><span class="line">                            value + <span class="string">"' did not find a matching property."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>Engine复杂添加</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EngineRuleSet中逻辑</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRuleInstances</span><span class="params">(Digester digester)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建StandardEngine</span></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Engine"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.catalina.core.StandardEngine"</span>,</span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Engine"</span>);</span><br><span class="line">        digester.addRule(prefix + <span class="string">"Engine"</span>,</span><br><span class="line">                         <span class="keyword">new</span> LifecycleListenerRule</span><br><span class="line">                         (<span class="string">"org.apache.catalina.startup.EngineConfig"</span>,</span><br><span class="line">                          <span class="string">"engineConfigClass"</span>));   <span class="comment">//当此处有参数的时候,创建一个 engineConfigClass 如次的类,调用addLifecycleListener加入,明显这是属于Engine的一个监听器</span></span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Engine"</span>,</span><br><span class="line">                            <span class="string">"setContainer"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.Engine"</span>);     <span class="comment">//将engine加入到Service中</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Cluster configuration start                                    //添加cluster</span></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Engine/Cluster"</span>,</span><br><span class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Engine/Cluster"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Engine/Cluster"</span>,</span><br><span class="line">                            <span class="string">"setCluster"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.Cluster"</span>);</span><br><span class="line">        <span class="comment">//Cluster configuration end</span></span><br><span class="line">         <span class="comment">//创建并添加监听器</span></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Engine/Listener"</span>,</span><br><span class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Engine/Listener"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Engine/Listener"</span>,</span><br><span class="line">                            <span class="string">"addLifecycleListener"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.LifecycleListener"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//处理关于Realm 域添加</span></span><br><span class="line">        digester.addRuleSet(<span class="keyword">new</span> RealmRuleSet(prefix + <span class="string">"Engine/"</span>));</span><br><span class="line">        <span class="comment">//创建关于Valve标签的创建,并添加到engine中</span></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Engine/Valve"</span>,</span><br><span class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Engine/Valve"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Engine/Valve"</span>,</span><br><span class="line">                            <span class="string">"addValve"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.Valve"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>RealmRuleSet</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//补充关于RealmRuleSet中逻辑</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRuleInstances</span><span class="params">(Digester digester)</span> </span>&#123;</span><br><span class="line">        StringBuilder pattern = <span class="keyword">new</span> StringBuilder(prefix);</span><br><span class="line">        <span class="comment">//这里的逻辑还是用来动态生成关于xml中engine/Realm/Realm这中嵌套结构的规则,也就是说</span></span><br><span class="line">        Realm.</span><br><span class="line">        <span class="comment">//对于container子类使用set  CombinedRealm使用add,这个类子类就是默认xml中的LockOutRealm</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_NESTED_REALM_LEVELS; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                pattern.append(<span class="string">'/'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            pattern.append(<span class="string">"Realm"</span>);</span><br><span class="line">            addRuleInstances(digester, pattern.toString(), i == <span class="number">0</span> ? <span class="string">"setRealm"</span> : <span class="string">"addRealm"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addRuleInstances</span><span class="params">(Digester digester, String pattern, String methodName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//上边的函数用来判断使用哪个函数,这里就是创建org.apache.catalina.Realm,并且添加到Engine中</span></span><br><span class="line">        digester.addObjectCreate(pattern, <span class="keyword">null</span> <span class="comment">/* MUST be specified in the element */</span>,</span><br><span class="line">                <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(pattern);</span><br><span class="line">        digester.addSetNext(pattern, methodName, <span class="string">"org.apache.catalina.Realm"</span>);</span><br><span class="line">        digester.addRuleSet(<span class="keyword">new</span> CredentialHandlerRuleSet(pattern + <span class="string">"/"</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>SetAllPropertiesRule</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个类是关于某些属性设置的</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SetAllPropertiesRule</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SetAllPropertiesRule</span><span class="params">(String[] exclude)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;exclude.length; i++ ) <span class="keyword">if</span> (exclude[i]!=<span class="keyword">null</span>) <span class="keyword">this</span>.excludes.put(exclude[i],exclude[i]);   <span class="comment">///根据exclude配置此加载器,要去除的属性</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(String namespace, String nameX, Attributes attributes)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attributes.getLength(); i++) &#123;</span><br><span class="line">            String name = attributes.getLocalName(i);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">""</span>.equals(name)) &#123;</span><br><span class="line">                name = attributes.getQName(i);</span><br><span class="line">            &#125;</span><br><span class="line">            String value = attributes.getValue(i);</span><br><span class="line">            <span class="keyword">if</span> ( !excludes.containsKey(name)) &#123;  <span class="comment">//exclude中不包含的属性进行下面逻辑</span></span><br><span class="line">                <span class="keyword">if</span> (!digester.isFakeAttribute(digester.peek(), name)</span><br><span class="line">                        &amp;&amp; !IntrospectionUtils.setProperty(digester.peek(), name, value)</span><br><span class="line">                        &amp;&amp; digester.getRulesValidation()) &#123;</span><br><span class="line">                    digester.getLogger().warn(<span class="string">"[SetAllPropertiesRule]&#123;"</span> + digester.getMatch() +</span><br><span class="line">                            <span class="string">"&#125; Setting property '"</span> + name + <span class="string">"' to '"</span> +</span><br><span class="line">                            value + <span class="string">"' did not find a matching property."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>ConnectorCreateRule</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="comment">//创建connector的逻辑</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(String namespace, String name, Attributes attributes)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      Service svc = (Service)digester.peek();</span><br><span class="line">      Executor ex = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">//根据connector标签的中"executor" ,从Service中取executor,并且加入到来连接器中,默认情况Service是没有executor的</span></span><br><span class="line">      <span class="keyword">if</span> ( attributes.getValue(<span class="string">"executor"</span>)!=<span class="keyword">null</span> ) &#123;</span><br><span class="line">          ex = svc.getExecutor(attributes.getValue(<span class="string">"executor"</span>));</span><br><span class="line">      &#125;</span><br><span class="line">      Connector con = <span class="keyword">new</span> Connector(attributes.getValue(<span class="string">"protocol"</span>));</span><br><span class="line">      <span class="keyword">if</span> (ex != <span class="keyword">null</span>) &#123;</span><br><span class="line">          setExecutor(con, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//sslImplementationName这个属性默认也是没有的</span></span><br><span class="line">      String sslImplementationName = attributes.getValue(<span class="string">"sslImplementationName"</span>);</span><br><span class="line">      <span class="keyword">if</span> (sslImplementationName != <span class="keyword">null</span>) &#123;</span><br><span class="line">          setSSLImplementationName(con, sslImplementationName);</span><br><span class="line">      &#125;</span><br><span class="line">      digester.push(con);  <span class="comment">//将连接器放到栈顶,是因为接下来对于连接器标签内部也可以进行加载处理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>host加载</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HostRuleSet</span> <span class="keyword">implements</span> <span class="title">RuleSet</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRuleInstances</span><span class="params">(Digester digester)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//标准三套:创建StandardHost</span></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Host"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.catalina.core.StandardHost"</span>,</span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Host"</span>);</span><br><span class="line">        digester.addRule(prefix + <span class="string">"Host"</span>,</span><br><span class="line">                         <span class="keyword">new</span> CopyParentClassLoaderRule()); <span class="comment">//处理父加载器</span></span><br><span class="line"></span><br><span class="line">        digester.addRule(prefix + <span class="string">"Host"</span>,</span><br><span class="line">                         <span class="keyword">new</span> LifecycleListenerRule</span><br><span class="line">                         (<span class="string">"org.apache.catalina.startup.HostConfig"</span>,</span><br><span class="line">                          <span class="string">"hostConfigClass"</span>)); <span class="comment">//添加HostConfig监听器</span></span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Host"</span>,</span><br><span class="line">                            <span class="string">"addChild"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.Container"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addCallMethod(prefix + <span class="string">"Host/Alias"</span>,</span><br><span class="line">                               <span class="string">"addAlias"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Cluster configuration start</span></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Host/Cluster"</span>,</span><br><span class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Host/Cluster"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Host/Cluster"</span>,</span><br><span class="line">                            <span class="string">"setCluster"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.Cluster"</span>);</span><br><span class="line">        <span class="comment">//Cluster configuration end</span></span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Host/Listener"</span>,</span><br><span class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Host/Listener"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Host/Listener"</span>,</span><br><span class="line">                            <span class="string">"addLifecycleListener"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.LifecycleListener"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addRuleSet(<span class="keyword">new</span> RealmRuleSet(prefix + <span class="string">"Host/"</span>));</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Host/Valve"</span>,</span><br><span class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Host/Valve"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Host/Valve"</span>,</span><br><span class="line">                            <span class="string">"addValve"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.Valve"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>ContextRuleSet</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当遇到Server/Service/Engine/Host/Content 时进行创建,这是通过server.xml的方式配置项目,总体而言我不是要说具体的解析过程而是强调</span></span><br><span class="line"><span class="comment">//除了content.xml配置,可以通过server.xml进行配置</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRuleInstances</span><span class="params">(Digester digester)</span> </span>&#123;</span><br><span class="line"><span class="comment">//这其中包含了许多不太了解的类,但是可以反映出content也就是表示项目的结构</span></span><br><span class="line">        <span class="keyword">if</span> (create) &#123;</span><br><span class="line">            digester.addObjectCreate(prefix + <span class="string">"Context"</span>,</span><br><span class="line">                    <span class="string">"org.apache.catalina.core.StandardContext"</span>, <span class="string">"className"</span>);</span><br><span class="line">            digester.addSetProperties(prefix + <span class="string">"Context"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            digester.addRule(prefix + <span class="string">"Context"</span>, <span class="keyword">new</span> SetContextPropertiesRule());</span><br><span class="line">        &#125;</span><br><span class="line"> <span class="comment">//创建content,并加入到父容器Host中</span></span><br><span class="line">        <span class="keyword">if</span> (create) &#123;</span><br><span class="line">            digester.addRule(prefix + <span class="string">"Context"</span>,</span><br><span class="line">                             <span class="keyword">new</span> LifecycleListenerRule</span><br><span class="line">                                 (<span class="string">"org.apache.catalina.startup.ContextConfig"</span>,</span><br><span class="line">                                  <span class="string">"configClass"</span>));</span><br><span class="line">            digester.addSetNext(prefix + <span class="string">"Context"</span>,</span><br><span class="line">                                <span class="string">"addChild"</span>,</span><br><span class="line">                                <span class="string">"org.apache.catalina.Container"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/Listener"</span>,</span><br><span class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/Listener"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/Listener"</span>,</span><br><span class="line">                            <span class="string">"addLifecycleListener"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.LifecycleListener"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/Loader"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.loader.WebappLoader"</span>,</span><br><span class="line">                            <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/Loader"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/Loader"</span>,</span><br><span class="line">                            <span class="string">"setLoader"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.Loader"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/Manager"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.catalina.session.StandardManager"</span>,</span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/Manager"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/Manager"</span>,</span><br><span class="line">                            <span class="string">"setManager"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.Manager"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/Manager/Store"</span>,</span><br><span class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/Manager/Store"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/Manager/Store"</span>,</span><br><span class="line">                            <span class="string">"setStore"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.Store"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/Manager/SessionIdGenerator"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.catalina.util.StandardSessionIdGenerator"</span>,</span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/Manager/SessionIdGenerator"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/Manager/SessionIdGenerator"</span>,</span><br><span class="line">                            <span class="string">"setSessionIdGenerator"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.SessionIdGenerator"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/Parameter"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.tomcat.util.descriptor.web.ApplicationParameter"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/Parameter"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/Parameter"</span>,</span><br><span class="line">                            <span class="string">"addApplicationParameter"</span>,</span><br><span class="line">                            <span class="string">"org.apache.tomcat.util.descriptor.web.ApplicationParameter"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addRuleSet(<span class="keyword">new</span> RealmRuleSet(prefix + <span class="string">"Context/"</span>));</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/Resources"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.catalina.webresources.StandardRoot"</span>,</span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/Resources"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/Resources"</span>,</span><br><span class="line">                            <span class="string">"setResources"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.WebResourceRoot"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/Resources/PreResources"</span>,</span><br><span class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/Resources/PreResources"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/Resources/PreResources"</span>,</span><br><span class="line">                            <span class="string">"addPreResources"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.WebResourceSet"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/Resources/JarResources"</span>,</span><br><span class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/Resources/JarResources"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/Resources/JarResources"</span>,</span><br><span class="line">                            <span class="string">"addJarResources"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.WebResourceSet"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/Resources/PostResources"</span>,</span><br><span class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/Resources/PostResources"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/Resources/PostResources"</span>,</span><br><span class="line">                            <span class="string">"addPostResources"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.WebResourceSet"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/ResourceLink"</span>,   <span class="comment">//关于资源引用标签的解析就在此处</span></span><br><span class="line">                <span class="string">"org.apache.tomcat.util.descriptor.web.ContextResourceLink"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/ResourceLink"</span>);</span><br><span class="line">        digester.addRule(prefix + <span class="string">"Context/ResourceLink"</span>,</span><br><span class="line">                <span class="keyword">new</span> SetNextNamingRule(<span class="string">"addResourceLink"</span>,</span><br><span class="line">                        <span class="string">"org.apache.tomcat.util.descriptor.web.ContextResourceLink"</span>));</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/Valve"</span>,</span><br><span class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/Valve"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/Valve"</span>,</span><br><span class="line">                            <span class="string">"addValve"</span>,</span><br><span class="line">                            <span class="string">"org.apache.catalina.Valve"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addCallMethod(prefix + <span class="string">"Context/WatchedResource"</span>,</span><br><span class="line">                               <span class="string">"addWatchedResource"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        digester.addCallMethod(prefix + <span class="string">"Context/WrapperLifecycle"</span>,</span><br><span class="line">                               <span class="string">"addWrapperLifecycle"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        digester.addCallMethod(prefix + <span class="string">"Context/WrapperListener"</span>,</span><br><span class="line">                               <span class="string">"addWrapperListener"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/JarScanner"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.tomcat.util.scan.StandardJarScanner"</span>,</span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/JarScanner"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/JarScanner"</span>,</span><br><span class="line">                            <span class="string">"setJarScanner"</span>,</span><br><span class="line">                            <span class="string">"org.apache.tomcat.JarScanner"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/JarScanner/JarScanFilter"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.tomcat.util.scan.StandardJarScanFilter"</span>,</span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/JarScanner/JarScanFilter"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/JarScanner/JarScanFilter"</span>,</span><br><span class="line">                            <span class="string">"setJarScanFilter"</span>,</span><br><span class="line">                            <span class="string">"org.apache.tomcat.JarScanFilter"</span>);</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + <span class="string">"Context/CookieProcessor"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.tomcat.util.http.Rfc6265CookieProcessor"</span>,</span><br><span class="line">                                 <span class="string">"className"</span>);</span><br><span class="line">        digester.addSetProperties(prefix + <span class="string">"Context/CookieProcessor"</span>);</span><br><span class="line">        digester.addSetNext(prefix + <span class="string">"Context/CookieProcessor"</span>,</span><br><span class="line">                            <span class="string">"setCookieProcessor"</span>,</span><br><span class="line">                            <span class="string">"org.apache.tomcat.util.http.CookieProcessor"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="接口"><a class="header-anchor" href="#接口">¶</a>接口</h4>
<h5 id="1-Lifecycle-接口"><a class="header-anchor" href="#1-Lifecycle-接口">¶</a>1. Lifecycle 接口</h5>
<ul>
<li>该接口的子类要按照一定状态和顺序,完成init start stop destory 函数,并且该子类可以作为lifeEvent的事件源,并且调整life部件的状态</li>
</ul>
 <figure class="highlight java"><figcaption><span>lifeBase</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在生命周期初始化开端 改变状态,调用子类internal</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (!state.equals(LifecycleState.NEW)) &#123;</span><br><span class="line">           invalidTransition(Lifecycle.BEFORE_INIT_EVENT);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           setStateInternal(LifecycleState.INITIALIZING, <span class="keyword">null</span>, <span class="keyword">false</span>);   <span class="comment">// INITIALIZING(false, Lifecycle.BEFORE_INIT_EVENT),</span></span><br><span class="line">           initInternal();</span><br><span class="line">           setStateInternal(LifecycleState.INITIALIZED, <span class="keyword">null</span>, <span class="keyword">false</span>); <span class="comment">//INITIALIZED(false, Lifecycle.AFTER_INIT_EVENT),</span></span><br><span class="line">       &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">           handleSubClassException(t, <span class="string">"lifecycleBase.initFail"</span>, toString());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setStateInternal</span><span class="params">(LifecycleState state, Object data, <span class="keyword">boolean</span> check)</span></span></span><br><span class="line"><span class="function">           <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">           log.debug(sm.getString(<span class="string">"lifecycleBase.setState"</span>, <span class="keyword">this</span>, state));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (check) &#123;</span><br><span class="line">           <span class="comment">// Must have been triggered by one of the abstract methods (assume</span></span><br><span class="line">           <span class="comment">// code in this class is correct)</span></span><br><span class="line">           <span class="comment">// null is never a valid state</span></span><br><span class="line">           <span class="keyword">if</span> (state == <span class="keyword">null</span>) &#123;</span><br><span class="line">               invalidTransition(<span class="string">"null"</span>);</span><br><span class="line">               <span class="comment">// Unreachable code - here to stop eclipse complaining about</span></span><br><span class="line">               <span class="comment">// a possible NPE further down the method</span></span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Any method can transition to failed</span></span><br><span class="line">           <span class="comment">// startInternal() permits STARTING_PREP to STARTING</span></span><br><span class="line">           <span class="comment">// stopInternal() permits STOPPING_PREP to STOPPING and FAILED to</span></span><br><span class="line">           <span class="comment">// STOPPING</span></span><br><span class="line">           <span class="keyword">if</span> (!(state == LifecycleState.FAILED ||</span><br><span class="line">                   (<span class="keyword">this</span>.state == LifecycleState.STARTING_PREP &amp;&amp;</span><br><span class="line">                           state == LifecycleState.STARTING) ||</span><br><span class="line">                   (<span class="keyword">this</span>.state == LifecycleState.STOPPING_PREP &amp;&amp;</span><br><span class="line">                           state == LifecycleState.STOPPING) ||</span><br><span class="line">                   (<span class="keyword">this</span>.state == LifecycleState.FAILED &amp;&amp;</span><br><span class="line">                           state == LifecycleState.STOPPING))) &#123;</span><br><span class="line">               <span class="comment">// No other transition permitted</span></span><br><span class="line">               invalidTransition(state.name());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.state = state;</span><br><span class="line">       String lifecycleEvent = state.getLifecycleEvent();</span><br><span class="line">       <span class="keyword">if</span> (lifecycleEvent != <span class="keyword">null</span>) &#123;  <span class="comment">//此处事件源触发事件</span></span><br><span class="line">           fireLifecycleEvent(lifecycleEvent, data);  <span class="comment">//这个逻辑是当发生状态改变时,调用监听器,可以理解为事件发生,触发该事件源的监听器</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>lifecycleMbeanBase实现了其下属子类的共同接口函数,实现共同逻辑,类似的还有ContainBase</li>
</ul>
 <figure class="highlight java"><figcaption><span>lifecycleMbeanBase</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该类只在init和destory有用</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">  <span class="comment">//将life部件加入到mServer</span></span><br><span class="line">       <span class="comment">// If oname is not null then registration has already happened via</span></span><br><span class="line">       <span class="comment">// preRegister().</span></span><br><span class="line">       <span class="keyword">if</span> (oname == <span class="keyword">null</span>) &#123;</span><br><span class="line">           mserver = Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).getMBeanServer();</span><br><span class="line"></span><br><span class="line">           oname = register(<span class="keyword">this</span>, getObjectNameKeyProperties());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//卸除mbean</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">destroyInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">       unregister(oname);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//没有实现startInternal</span></span><br></pre></td></tr></table></figure>
<ul>
<li>衍生出了大部分第三层父类, ContainBase,LifecycleMBeanBase则实现了internal</li>
</ul>
<h5 id="ContainerBase"><a class="header-anchor" href="#ContainerBase">¶</a>ContainerBase</h5>

<p>此类加载过程通常都是 container.start()-&gt;ContainerBase.startInternal()-&gt;((导致子类容器start) &amp;&amp;( 自身pieple start-&gt;关联valve-&gt;start)-&gt;启动线程)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init 逻辑</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">        reconfigureStartStopExecutor(getStartStopThreadsInternal());  <span class="comment">//设置线程池</span></span><br><span class="line">        <span class="keyword">super</span>.initInternal();  <span class="comment">//父类是mbean 所以加入到jmx</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//关于线程的逻辑,这里要清楚要自己看看这几个线程类的继承关系</span></span><br><span class="line">    <span class="keyword">protected</span> ExecutorService startStopExecutor; <span class="comment">//startStopExecutor是该抽象类的属性</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reconfigureStartStopExecutor</span><span class="params">(<span class="keyword">int</span> threads)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (threads == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//这里的逻辑是,如果startStopExecutor为null,那么就实例化为InlineExecutorService</span></span><br><span class="line">            <span class="keyword">if</span> (!(startStopExecutor <span class="keyword">instanceof</span> InlineExecutorService)) &#123;  </span><br><span class="line">                startStopExecutor = <span class="keyword">new</span> InlineExecutorService();   </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//其他情况说明该startStopExecutor接口被实例化了,比如第二次调用该函数就调用如下逻辑</span></span><br><span class="line">        <span class="comment">//当为线程池时进行设置,否则将该startStopExecutor实例化为线程池类型,当再一次调用时就会进行改变</span></span><br><span class="line">            <span class="keyword">if</span> (startStopExecutor <span class="keyword">instanceof</span> ThreadPoolExecutor) &#123;</span><br><span class="line">                ((ThreadPoolExecutor) startStopExecutor).setMaximumPoolSize(threads);</span><br><span class="line">                ((ThreadPoolExecutor) startStopExecutor).setCorePoolSize(threads);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                BlockingQueue&lt;Runnable&gt; startStopQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line">                ThreadPoolExecutor tpe = <span class="keyword">new</span> ThreadPoolExecutor(threads, threads, <span class="number">10</span>,</span><br><span class="line">                        TimeUnit.SECONDS, startStopQueue,</span><br><span class="line">                        <span class="keyword">new</span> StartStopThreadFactory(getName() + <span class="string">"-startStop-"</span>));</span><br><span class="line">                tpe.allowCoreThreadTimeOut(<span class="keyword">true</span>);</span><br><span class="line">                startStopExecutor = tpe;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//被engine调用的获取realm逻辑    </span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Realm <span class="title">getRealm</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Lock l = realmLock.readLock();</span><br><span class="line">        l.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (realm != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> realm;</span><br><span class="line">            <span class="keyword">if</span> (parent != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> parent.getRealm();  <span class="comment">//如果该容器体系不存在realm则返回null</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            l.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">//设置Realm</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRealm</span><span class="params">(Realm realm)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Lock l = realmLock.writeLock();</span><br><span class="line">        l.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Change components if necessary</span></span><br><span class="line">            Realm oldRealm = <span class="keyword">this</span>.realm;</span><br><span class="line">            <span class="keyword">if</span> (oldRealm == realm)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">this</span>.realm = realm;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Stop the old component if necessary</span></span><br><span class="line">            <span class="keyword">if</span> (getState().isAvailable() &amp;&amp; (oldRealm != <span class="keyword">null</span>) &amp;&amp;  <span class="comment">//对于持有作用域的组件,只能持有一个域,并且域也是一种生命周期组件</span></span><br><span class="line">                (oldRealm <span class="keyword">instanceof</span> Lifecycle)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ((Lifecycle) oldRealm).stop();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">                    log.error(<span class="string">"ContainerBase.setRealm: stop: "</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start the new component if necessary</span></span><br><span class="line">            <span class="keyword">if</span> (realm != <span class="keyword">null</span>)</span><br><span class="line">                realm.setContainer(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (getState().isAvailable() &amp;&amp; (realm != <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">                (realm <span class="keyword">instanceof</span> Lifecycle)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ((Lifecycle) realm).start();  <span class="comment">//启动域</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">                    log.error(<span class="string">"ContainerBase.setRealm: start: "</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Report this property change to interested listeners</span></span><br><span class="line">            support.firePropertyChange(<span class="string">"realm"</span>, oldRealm, <span class="keyword">this</span>.realm);  <span class="comment">//类似于javafx的作用,当发生改变时触发事件,实际还是通过监听模式实现的</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            l.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//容器start    </span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start our subordinate components, if any</span></span><br><span class="line">        logger = <span class="keyword">null</span>;</span><br><span class="line">        getLogger();</span><br><span class="line">        Cluster cluster = getClusterInternal();  <span class="comment">//(cluster)是和集群相关的</span></span><br><span class="line">        <span class="keyword">if</span> (cluster <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">            ((Lifecycle) cluster).start();</span><br><span class="line">        &#125;</span><br><span class="line">        Realm realm = getRealmInternal();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 此处关于默认情况的逻辑进行lockoutRealm的生命周期init到start,看看lifeBase中的init/start函数并非在对应的函数其组件一定会执行对应生命周期函数,执行</span></span><br><span class="line"><span class="comment">         * 对应的函数取决于容器的state</span></span><br><span class="line"><span class="comment">         * 在处理lockoutRealm的过程中,也遍历启动了其内部realm的生命周期函数 默认就是UserDataRealm</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (realm <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">            ((Lifecycle) realm).start();   <span class="comment">//此处激活容器所属域,默认此处启动的是lockoutRealm,其内部可以含有子类realm,默认是userDataRealm</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start our child containers, if any</span></span><br><span class="line">        Container children[] = findChildren();  <span class="comment">//xml中的host等都是子类容器</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ExecutorService::&lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);</span></span><br><span class="line"><span class="comment">         * 返回的Future.get表示执行结果</span></span><br><span class="line"><span class="comment">         * 也就是说实际上此处执行的就是自容器的start函数,不过是通过线程执行的</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        List&lt;Future&lt;Void&gt;&gt; results = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">            results.add(startStopExecutor.submit(<span class="keyword">new</span> StartChild(children[i])));  <span class="comment">//通过线程池来执行StartChild(Call子类)中的call函数</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> fail = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (Future&lt;Void&gt; result : results) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result.get(); <span class="comment">//get表示</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(sm.getString(<span class="string">"containerBase.threadedStartFailed"</span>), e);</span><br><span class="line">                fail = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fail) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</span><br><span class="line">                    sm.getString(<span class="string">"containerBase.threadedStartFailed"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start the Valves in our pipeline (including the basic), if any</span></span><br><span class="line">        <span class="keyword">if</span> (pipeline <span class="keyword">instanceof</span> Lifecycle)</span><br><span class="line">            ((Lifecycle) pipeline).start(); <span class="comment">//启动pipeline</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start our thread</span></span><br><span class="line">        threadStart(); <span class="comment">//启动线程</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">//关于后台线程,一个内部线程类</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">ContainerBackgroundProcessor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Throwable t = <span class="keyword">null</span>;</span><br><span class="line">            String unexpectedDeathMessage = sm.getString(</span><br><span class="line">                    <span class="string">"containerBase.backgroundProcess.unexpectedThreadDeath"</span>,</span><br><span class="line">                    Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (!threadDone) &#123; <span class="comment">//当线程没有结束时，不断执行</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(backgroundProcessorDelay * <span class="number">1000L</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="comment">// Ignore</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!threadDone) &#123;</span><br><span class="line">                        processChildren(ContainerBase.<span class="keyword">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException|Error e) &#123;</span><br><span class="line">                t = e;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!threadDone) &#123;</span><br><span class="line">                    log.error(unexpectedDeathMessage, t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processChildren</span><span class="params">(Container container)</span> </span>&#123;</span><br><span class="line">            ClassLoader originalClassLoader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Context) &#123;</span><br><span class="line">                    Loader loader = ((Context) container).getLoader();</span><br><span class="line">                    <span class="comment">// Loader will be null for FailedContext instances</span></span><br><span class="line">                    <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Ensure background processing for Contexts and Wrappers</span></span><br><span class="line">                    <span class="comment">// is performed under the web app's class loader</span></span><br><span class="line">                    originalClassLoader = ((Context) container).bind(<span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                container.backgroundProcess(); <span class="comment">//实际上执行的是个这个函数</span></span><br><span class="line">                Container[] children = container.findChildren();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (children[i].getBackgroundProcessorDelay() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        processChildren(children[i]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                log.error(<span class="string">"Exception invoking periodic operation: "</span>, t);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Context) &#123;</span><br><span class="line">                    ((Context) container).unbind(<span class="keyword">false</span>, originalClassLoader);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">backgroundProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">//不断执行内部这些成员的back，不代表所有成员都实现了该函数</span></span><br><span class="line">        <span class="keyword">if</span> (!getState().isAvailable())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        Cluster cluster = getClusterInternal();</span><br><span class="line">        <span class="keyword">if</span> (cluster != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                cluster.backgroundProcess();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.warn(sm.getString(<span class="string">"containerBase.backgroundProcess.cluster"</span>,</span><br><span class="line">                        cluster), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Realm realm = getRealmInternal();</span><br><span class="line">        <span class="keyword">if</span> (realm != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                realm.backgroundProcess();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.warn(sm.getString(<span class="string">"containerBase.backgroundProcess.realm"</span>, realm), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Valve current = pipeline.getFirst();</span><br><span class="line">        <span class="keyword">while</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                current.backgroundProcess();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.warn(sm.getString(<span class="string">"containerBase.backgroundProcess.valve"</span>, current), e);</span><br><span class="line">            &#125;</span><br><span class="line">            current = current.getNext();</span><br><span class="line">        &#125;</span><br><span class="line">        fireLifecycleEvent(Lifecycle.PERIODIC_EVENT, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>ContainBase容器部分功能</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加子容器</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addChild</span><span class="params">(Container child)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">            PrivilegedAction&lt;Void&gt; dp =</span><br><span class="line">                <span class="keyword">new</span> PrivilegedAddChild(child);</span><br><span class="line">            AccessController.doPrivileged(dp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addChildInternal(child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addChildInternal</span><span class="params">(Container child)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( log.isDebugEnabled() )</span><br><span class="line">            log.debug(<span class="string">"Add child "</span> + child + <span class="string">" "</span> + <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">synchronized</span>(children) &#123;</span><br><span class="line">            <span class="keyword">if</span> (children.get(child.getName()) != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"addChild:  Child name '"</span> +</span><br><span class="line">                                                   child.getName() +</span><br><span class="line">                                                   <span class="string">"' is not unique"</span>);</span><br><span class="line">            child.setParent(<span class="keyword">this</span>);  <span class="comment">// May throw IAE</span></span><br><span class="line">            children.put(child.getName(), child);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start child</span></span><br><span class="line">        <span class="comment">// Don't do this inside sync block - start can be a slow process and</span></span><br><span class="line">        <span class="comment">// locking the children object can cause problems elsewhere</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((getState().isAvailable() ||</span><br><span class="line">                    LifecycleState.STARTING_PREP.equals(getState())) &amp;&amp;</span><br><span class="line">                    startChildren) &#123;</span><br><span class="line">                child.start();  <span class="comment">//并且会启动此时加入的子容器,  content的加入后 就是在此时启动的,根据触发条件来看,只有该父容器处于有效 或者准备阶段会启动父容器, mxl解析创建的时候是不会的</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">            log.error(<span class="string">"ContainerBase.addChild: start: "</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"ContainerBase.addChild: start: "</span> + e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            fireContainerEvent(ADD_CHILD_EVENT, child); <span class="comment">//会触发监听器</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//移除</span></span><br><span class="line">	    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeChild</span><span class="params">(Container child)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (child.getState().isAvailable()) &#123;</span><br><span class="line">                child.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">            log.error(<span class="string">"ContainerBase.removeChild: stop: "</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// child.destroy() may have already been called which would have</span></span><br><span class="line">            <span class="comment">// triggered this call. If that is the case, no need to destroy the</span></span><br><span class="line">            <span class="comment">// child again.</span></span><br><span class="line">            <span class="keyword">if</span> (!LifecycleState.DESTROYING.equals(child.getState())) &#123;</span><br><span class="line">                child.destroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">            log.error(<span class="string">"ContainerBase.removeChild: destroy: "</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(children) &#123;</span><br><span class="line">            <span class="keyword">if</span> (children.get(child.getName()) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            children.remove(child.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fireContainerEvent(REMOVE_CHILD_EVENT, child);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">  <span class="comment">//触发</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireContainerEvent</span><span class="params">(String type, Object data)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (listeners.size() &lt; <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        ContainerEvent event = <span class="keyword">new</span> ContainerEvent(<span class="keyword">this</span>, type, data);  <span class="comment">//ContainerEvent 和lifeEvent都是EventObject子类,它不记录容器状态</span></span><br><span class="line">        <span class="comment">// Note for each uses an iterator internally so this is safe</span></span><br><span class="line">        <span class="keyword">for</span> (ContainerListener listener : listeners) &#123;</span><br><span class="line">            listener.containerEvent(event); <span class="comment">//触发监听器</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="tomcat关键部分及各部分作用"><a class="header-anchor" href="#tomcat关键部分及各部分作用">¶</a>tomcat关键部分及各部分作用</h4>
<h5 id="1-server-xml-该配置文件实际非常详实的说明了tomcat的架构"><a class="header-anchor" href="#1-server-xml-该配置文件实际非常详实的说明了tomcat的架构">¶</a>1. server.xml 该配置文件实际非常详实的说明了tomcat的架构</h5>
<h5 id="2-类加载器"><a class="header-anchor" href="#2-类加载器">¶</a>2. 类加载器</h5>
<img src="/2018/10/06/tomcat/classLoader.png" class="">
<h5 id="3-Server继承图"><a class="header-anchor" href="#3-Server继承图">¶</a>3. Server继承图</h5>
<img src="/2018/10/06/tomcat/Server.png" class="">
<ul>
<li>init阶段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.initInternal();  <span class="comment">//将该对象加入到jmxServer中</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Register global String cache</span></span><br><span class="line">        <span class="comment">// Note although the cache is global, if there are multiple Servers</span></span><br><span class="line">        <span class="comment">// present in the JVM (may happen when embedding) then the same cache</span></span><br><span class="line">        <span class="comment">// will be registered under multiple names</span></span><br><span class="line">        onameStringCache = register(<span class="keyword">new</span> StringCache(), <span class="string">"type=StringCache"</span>);  <span class="comment">//将StringCache加入</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Register the MBeanFactory</span></span><br><span class="line">        MBeanFactory factory = <span class="keyword">new</span> MBeanFactory();</span><br><span class="line">        factory.setContainer(<span class="keyword">this</span>);</span><br><span class="line">        onameMBeanFactory = register(factory, <span class="string">"type=MBeanFactory"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Register the naming resources</span></span><br><span class="line">        globalNamingResources.init(); <span class="comment">// 此处完成了对于资源的处理,要理解就要看看</span></span><br><span class="line">globalNamingResources在digsiter的初始化</span><br><span class="line">        <span class="comment">// Populate the extension validator with JARs from common and shared</span></span><br><span class="line">        <span class="comment">// class loaders</span></span><br><span class="line">        <span class="keyword">if</span> (getCatalina() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ClassLoader cl = getCatalina().getParentClassLoader();</span><br><span class="line">            <span class="comment">// Walk the class loader hierarchy. Stop at the system class loader.</span></span><br><span class="line">            <span class="comment">// This will add the shared (if present) and common class loaders</span></span><br><span class="line">            <span class="keyword">while</span> (cl != <span class="keyword">null</span> &amp;&amp; cl != ClassLoader.getSystemClassLoader()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cl <span class="keyword">instanceof</span> URLClassLoader) &#123;</span><br><span class="line">                    URL[] urls = ((URLClassLoader) cl).getURLs();</span><br><span class="line">                    <span class="keyword">for</span> (URL url : urls) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (url.getProtocol().equals(<span class="string">"file"</span>)) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                File f = <span class="keyword">new</span> File (url.toURI());</span><br><span class="line">                                <span class="keyword">if</span> (f.isFile() &amp;&amp;</span><br><span class="line">                                        f.getName().endsWith(<span class="string">".jar"</span>)) &#123;</span><br><span class="line">                                    ExtensionValidator.addSystemResource(f);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                                <span class="comment">// Ignore</span></span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                <span class="comment">// Ignore</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                cl = cl.getParent();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Initialize our defined Services</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</span><br><span class="line">            services[i].init();  <span class="comment">//改变状态 加入jmx</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//globalNamingResources init时触发情况,将server.xml GlobalNamingResources标签中的所有Resource envs resourceLinks 加入到jmx中</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.initInternal();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set this before we register currently known naming resources to avoid</span></span><br><span class="line">        <span class="comment">// timing issues. Duplication registration is not an issue.</span></span><br><span class="line">        resourceRequireExplicitRegistration = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ContextResource cr : resources.values()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                MBeanUtils.createMBean(cr);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.warn(sm.getString(</span><br><span class="line">                        <span class="string">"namingResources.mbeanCreateFail"</span>, cr.getName()), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ContextEnvironment ce : envs.values()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                MBeanUtils.createMBean(ce);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.warn(sm.getString(</span><br><span class="line">                        <span class="string">"namingResources.mbeanCreateFail"</span>, ce.getName()), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ContextResourceLink crl : resourceLinks.values()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                MBeanUtils.createMBean(crl);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.warn(sm.getString(</span><br><span class="line">                        <span class="string">"namingResources.mbeanCreateFail"</span>, crl.getName()), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>start阶段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"><span class="comment">//首先lifeBase将该部件state由INITIALIZED-&gt;STARTING_PREP(调用对应监听器),再由server</span></span><br><span class="line">        fireLifecycleEvent(CONFIGURE_START_EVENT, <span class="keyword">null</span>); <span class="comment">//仅仅触发了NamingContentListenter的CONFIGURE_START_EVENT阶段</span></span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">        globalNamingResources.start(); <span class="comment">//触发STARTING_PREP时候globalNamingResources的监听器,默认没有</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start our defined Services</span></span><br><span class="line">        <span class="keyword">synchronized</span> (servicesLock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</span><br><span class="line">                services[i].start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-Service继承图"><a class="header-anchor" href="#4-Service继承图">¶</a>4. Service继承图</h5>
<img src="/2018/10/06/tomcat/Service.png" class=""> 
<figure class="highlight java"><figcaption><span>Service init</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认没有监听器</span></span><br><span class="line">- init阶段</span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.initInternal();  <span class="comment">//加入到jmx</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (engine != <span class="keyword">null</span>) &#123;</span><br><span class="line">            engine.init();  <span class="comment">//</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize any Executors   ,关于Executor 实际上就是线程池,而线程底层只想runnable还是通过</span></span><br><span class="line">        <span class="comment">//Thread,tomcat实现了一个StandardThreadExecutor,该对象时xml解析时创建的,默认xml这部分被注释了,同样属于生命周期组件 </span></span><br><span class="line">        <span class="comment">//拥有ThreadPoolExecutor,该对象继承于jdk中的ThreadPoolExecutor,这是线程池之一</span></span><br><span class="line">        <span class="keyword">for</span> (Executor executor : findExecutors()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (executor <span class="keyword">instanceof</span> JmxEnabled) &#123;</span><br><span class="line">                ((JmxEnabled) executor).setDomain(getDomain());</span><br><span class="line">            &#125;</span><br><span class="line">            executor.init();  <span class="comment">//</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize mapper listener</span></span><br><span class="line">        mapperListener.init();  <span class="comment">//加入jmx,这个监听器不会在Engine组件的生命周期被激活</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize our defined Connectors</span></span><br><span class="line">        <span class="keyword">synchronized</span> (connectorsLock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Connector connector : connectors) &#123;</span><br><span class="line">                connector.init();  <span class="comment">//加入jmx</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>start阶段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(log.isInfoEnabled())</span><br><span class="line">        log.info(sm.getString(<span class="string">"standardService.start.name"</span>, <span class="keyword">this</span>.name));  <span class="comment">//明显的service没有在start前要执行的监听器</span></span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start our defined Container first  engine也是容器子类</span></span><br><span class="line">    <span class="keyword">if</span> (engine != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (engine) &#123;</span><br><span class="line">            engine.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (executors) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Executor executor: executors) &#123; <span class="comment">//默认不存在</span></span><br><span class="line">            executor.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mapperListener.start();  <span class="comment">//mapper就是对于url的映射,当容器engine及其子容器启动后,mapper作为life监听器和container监听器加入到各个子容器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start our defined Connectors second</span></span><br><span class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Connector connector: connectors) &#123;</span><br><span class="line">            <span class="comment">// If it has already failed, don't try and start it</span></span><br><span class="line">            <span class="keyword">if</span> (connector.getState() != LifecycleState.FAILED) &#123;</span><br><span class="line">                connector.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-Engine继承图"><a class="header-anchor" href="#5-Engine继承图">¶</a>5. Engine继承图</h5>
<img src="/2018/10/06/tomcat/Engine.png" class="">
<ul>
<li>init阶段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Engine init时的逻辑</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">        <span class="comment">// Ensure that a Realm is present before any attempt is made to start</span></span><br><span class="line">        <span class="comment">// one. This will create the default NullRealm if necessary.</span></span><br><span class="line">        getRealm();</span><br><span class="line">        <span class="keyword">super</span>.initInternal();  <span class="comment">//父类 : ContainerBase--&gt;LifecycleMBeanBase</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//关于域的获取,realm是一个has a的一个成员变量</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Realm <span class="title">getRealm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//当自身不存在realm,则表示为NullRealm</span></span><br><span class="line">        Realm configured = <span class="keyword">super</span>.getRealm();</span><br><span class="line">        <span class="comment">// If no set realm has been called - default to NullRealm</span></span><br><span class="line">        <span class="comment">// This can be overridden at engine, context and host level</span></span><br><span class="line">        <span class="keyword">if</span> (configured == <span class="keyword">null</span>) &#123;</span><br><span class="line">            configured = <span class="keyword">new</span> NullRealm();</span><br><span class="line">            <span class="keyword">this</span>.setRealm(configured);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> configured;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>补充关于StandardThreadExecutor</p>
<img src="/2018/10/06/tomcat/StandardThreadExecutor.png" class="">
<ul>
<li>start阶段</li>
</ul>
<figure class="highlight java"><figcaption><span>Engine</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Log our server identification information</span></span><br><span class="line">       <span class="keyword">if</span>(log.isInfoEnabled())</span><br><span class="line">           log.info( <span class="string">"Starting Servlet Engine: "</span> + ServerInfo.getServerInfo());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Standard container startup</span></span><br><span class="line">       <span class="keyword">super</span>.startInternal();  <span class="comment">//engine是容器类们的父容器,通过此处进行containerBase::init,完成子类容器的加载,比较复杂</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>//子容器host的start触发</p>
<img src="/2018/10/06/tomcat/StandardHost.png" class="">
<figure class="highlight java"><figcaption><span>Host</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在这过程中触发了其初始化阶段,如继承图可易知加入jmx,启动后台线程池</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set error report valve  下边的逻辑只是给host.pipe加入了ReportValve这个阀</span></span><br><span class="line">        String errorValve = getErrorReportValveClass();</span><br><span class="line">        <span class="keyword">if</span> ((errorValve != <span class="keyword">null</span>) &amp;&amp; (!errorValve.equals(<span class="string">""</span>))) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">boolean</span> found = <span class="keyword">false</span>;</span><br><span class="line">                Valve[] valves = getPipeline().getValves();</span><br><span class="line">                <span class="keyword">for</span> (Valve valve : valves) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (errorValve.equals(valve.getClass().getName())) &#123;</span><br><span class="line">                        found = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(!found) &#123;</span><br><span class="line">                    Valve valve =</span><br><span class="line">                        (Valve) Class.forName(errorValve).getConstructor().newInstance();</span><br><span class="line">                    getPipeline().addValve(valve);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                log.error(sm.getString(</span><br><span class="line">                        <span class="string">"standardHost.invalidErrorReportValveClass"</span>,</span><br><span class="line">                        errorValve), t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.startInternal(); <span class="comment">//执行本身容器逻辑,仅仅是开启了内部pipe.start</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="6-connector"><a class="header-anchor" href="#6-connector">¶</a>6. connector</h5>
<img src="/2018/10/06/tomcat/connector.png" class="">
<figure class="highlight java"><figcaption><span>Connector</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">- init阶段</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Connector</span><span class="params">(String protocol)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> aprConnector = AprLifecycleListener.isAprAvailable() &amp;&amp;</span><br><span class="line">                AprLifecycleListener.getUseAprConnector();  <span class="comment">//根据之前Server apr监听器的处理,判断是否能够开启apr io,默认情况是无法开启的</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"HTTP/1.1"</span>.equals(protocol) || protocol == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (aprConnector) &#123;</span><br><span class="line">                protocolHandlerClassName = <span class="string">"org.apache.coyote.http11.Http11AprProtocol"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                protocolHandlerClassName = <span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span>;  <span class="comment">//对于http1.1连接器,tomcat 9版本使用nio</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"AJP/1.3"</span>.equals(protocol)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (aprConnector) &#123;</span><br><span class="line">                protocolHandlerClassName = <span class="string">"org.apache.coyote.ajp.AjpAprProtocol"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                protocolHandlerClassName = <span class="string">"org.apache.coyote.ajp.AjpNioProtocol"</span>;   <span class="comment">//对于ajp 使用ajpNio</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            protocolHandlerClassName = protocol;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Instantiate protocol handler</span></span><br><span class="line">        ProtocolHandler p = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(protocolHandlerClassName); <span class="comment">//这里体现了类加载的作用之一,当tomcat发布出去后,lib包的加载能力取决于类加载器</span></span><br><span class="line">            p = (ProtocolHandler) clazz.getConstructor().newInstance();  <span class="comment">//加载不同ProtocolHandler,</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(sm.getString(</span><br><span class="line">                    <span class="string">"coyoteConnector.protocolHandlerInstantiationFailed"</span>), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.protocolHandler = p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Default for Connector depends on this system property</span></span><br><span class="line">        setThrowOnFailure(Boolean.getBoolean(<span class="string">"org.apache.catalina.startup.EXIT_ON_INIT_FAILURE"</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<img src="/2018/10/06/tomcat/Http11NioProtocol.png" class="">
<figure class="highlight java"><figcaption><span>ProtocolHandler</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关于handler</span></span><br><span class="line"><span class="comment">//创建时 创建了 endpoint  以及ConnectionHandler</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Http11NioProtocol</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> NioEndpoint());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">AbstractHttp11JsseProtocol</span><span class="params">(AbstractJsseEndpoint&lt;S,?&gt; endpoint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(endpoint);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//明显这里的endpoint很重要</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractHttp11Protocol</span><span class="params">(AbstractEndpoint&lt;S,?&gt; endpoint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(endpoint);</span><br><span class="line">        setConnectionTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);</span><br><span class="line">        ConnectionHandler&lt;S&gt; cHandler = <span class="keyword">new</span> ConnectionHandler&lt;&gt;(<span class="keyword">this</span>); </span><br><span class="line">        setHandler(cHandler);  <span class="comment">//设置ConnectionHandler</span></span><br><span class="line">        getEndpoint().setHandler(cHandler);  <span class="comment">//endpoint.setHandler</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractProtocol</span><span class="params">(AbstractEndpoint&lt;S,?&gt; endpoint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.endpoint = endpoint; <span class="comment">//endpoint</span></span><br><span class="line">        setConnectionLinger(Constants.DEFAULT_CONNECTION_LINGER);</span><br><span class="line">        setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>初始化(Connector)</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.initInternal();  <span class="comment">//加入jmx</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (protocolHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</span><br><span class="line">                    sm.getString(<span class="string">"coyoteConnector.protocolHandlerInstantiationFailed"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize adapter</span></span><br><span class="line">        adapter = <span class="keyword">new</span> CoyoteAdapter(<span class="keyword">this</span>);  <span class="comment">//这个adapter貌似是处理servlet的</span></span><br><span class="line">        protocolHandler.setAdapter(adapter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure parseBodyMethodsSet has a default</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == parseBodyMethodsSet) &#123;</span><br><span class="line">            setParseBodyMethods(getParseBodyMethods()); <span class="comment">//当post请求解析body</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (protocolHandler.isAprRequired() &amp;&amp; !AprLifecycleListener.isAprAvailable()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(sm.getString(<span class="string">"coyoteConnector.protocolHandlerNoApr"</span>,</span><br><span class="line">                    getProtocolHandlerClassName()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (AprLifecycleListener.isAprAvailable() &amp;&amp; AprLifecycleListener.getUseOpenSSL() &amp;&amp;</span><br><span class="line">                protocolHandler <span class="keyword">instanceof</span> AbstractHttp11JsseProtocol) &#123;</span><br><span class="line">            AbstractHttp11JsseProtocol&lt;?&gt; jsseProtocolHandler =</span><br><span class="line">                    (AbstractHttp11JsseProtocol&lt;?&gt;) protocolHandler;</span><br><span class="line">            <span class="keyword">if</span> (jsseProtocolHandler.isSSLEnabled() &amp;&amp;</span><br><span class="line">                    jsseProtocolHandler.getSslImplementationName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// OpenSSL is compatible with the JSSE configuration, so use it if APR is available</span></span><br><span class="line">                jsseProtocolHandler.setSslImplementationName(OpenSSLImplementation<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            protocolHandler.init();  <span class="comment">//protocolHandler的初始化</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</span><br><span class="line">                    sm.getString(<span class="string">"coyoteConnector.protocolHandlerInitializationFailed"</span>), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>protocolHandler的初始化</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AbstractHttp11Protocol</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// Upgrade protocols have to be configured first since the endpoint</span></span><br><span class="line">        <span class="comment">// init (triggered via super.init() below) uses this list to configure</span></span><br><span class="line">        <span class="comment">// the list of ALPN protocols to advertise</span></span><br><span class="line">        <span class="keyword">for</span> (UpgradeProtocol upgradeProtocol : upgradeProtocols) &#123;</span><br><span class="line">            configureUpgradeProtocol(upgradeProtocol);  <span class="comment">//如果连接器没有配置upgradeProtocol  改良的协议,那么此处无效</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.init();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//AbstractProtocol</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getLog().isInfoEnabled()) &#123;</span><br><span class="line">            getLog().info(sm.getString(<span class="string">"abstractProtocolHandler.init"</span>, getName()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (oname == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Component not pre-registered so register it</span></span><br><span class="line">            oname = createObjectName();</span><br><span class="line">            <span class="keyword">if</span> (oname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(<span class="keyword">this</span>, oname, <span class="keyword">null</span>);  <span class="comment">//本身加入jmx</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.domain != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                tpOname = <span class="keyword">new</span> ObjectName(domain + <span class="string">":type=ThreadPool,name="</span> + getName());</span><br><span class="line">                Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(endpoint, tpOname, <span class="keyword">null</span>);  <span class="comment">//将endpoint加入 这个玩意是个重点</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                getLog().error(sm.getString( <span class="string">"abstractProtocolHandler.mbeanRegistrationFailed"</span>,</span><br><span class="line">                        tpOname, getName()), e);</span><br><span class="line">            &#125;</span><br><span class="line">            rgOname = <span class="keyword">new</span> ObjectName(domain + <span class="string">":type=GlobalRequestProcessor,name="</span> + getName());</span><br><span class="line">            Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(</span><br><span class="line">                    getHandler().getGlobal(), rgOname, <span class="keyword">null</span>);    <span class="comment">//ConnectorHandler.global 加入jmx</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (SSLHostConfig sslHostConfig : getEndpoint().findSslHostConfigs()) &#123;   <span class="comment">//默认此处应该没有数据</span></span><br><span class="line">                ObjectName sslOname = <span class="keyword">new</span> ObjectName(domain + <span class="string">":type=SSLHostConfig,ThreadPool="</span> +</span><br><span class="line">                        getName() + <span class="string">",name="</span> + ObjectName.quote(sslHostConfig.getHostName()));</span><br><span class="line">                Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(sslHostConfig, sslOname, <span class="keyword">null</span>);</span><br><span class="line">                sslOnames.add(sslOname);</span><br><span class="line">                <span class="keyword">for</span> (SSLHostConfigCertificate sslHostConfigCert : sslHostConfig.getCertificates()) &#123;</span><br><span class="line">                    ObjectName sslCertOname = <span class="keyword">new</span> ObjectName(domain +</span><br><span class="line">                            <span class="string">":type=SSLHostConfigCertificate,ThreadPool="</span> + getName() +</span><br><span class="line">                            <span class="string">",Host="</span> + ObjectName.quote(sslHostConfig.getHostName()) +</span><br><span class="line">                            <span class="string">",name="</span> + sslHostConfigCert.getType());</span><br><span class="line">                    Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(</span><br><span class="line">                            sslHostConfigCert, sslCertOname, <span class="keyword">null</span>);</span><br><span class="line">                    sslCertOnames.add(sslCertOname);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String endpointName = getName();</span><br><span class="line">        endpoint.setName(endpointName.substring(<span class="number">1</span>, endpointName.length()-<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        endpoint.init(); <span class="comment">//endpoint的初始化</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//AbstractEndpoint</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bindOnInit) &#123;</span><br><span class="line">            bind();</span><br><span class="line">            bindState = BindState.BOUND_ON_INIT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//这里我看的http11 所以是NioEndpoint</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        initServerSocket();  <span class="comment">//初始化socket,使用的nio的api,要看一下</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize thread count defaults for acceptor, poller</span></span><br><span class="line">        <span class="keyword">if</span> (acceptorThreadCount == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">FIXME:</span> Doesn't seem to work that well with multiple accept threads</span></span><br><span class="line">            acceptorThreadCount = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pollerThreadCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//minimum one poller thread</span></span><br><span class="line">            pollerThreadCount = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        setStopLatch(<span class="keyword">new</span> CountDownLatch(pollerThreadCount)); <span class="comment">//coutDownLatch.wait会计算内部cout,若&gt;0则该线程继续await</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize SSL if needed</span></span><br><span class="line">        initialiseSsl();   <span class="comment">//初始化ssl</span></span><br><span class="line"></span><br><span class="line">        selectorPool.open();  <span class="comment">//nioApi selector 关于复用器</span></span><br><span class="line">    &#125;</span><br><span class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initServerSocket</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        serverSock = ServerSocketChannel.open();  <span class="comment">//打开nioServerSocket</span></span><br><span class="line">        socketProperties.setProperties(serverSock.socket());</span><br><span class="line">        InetSocketAddress addr = (getAddress()!=<span class="keyword">null</span>?<span class="keyword">new</span> InetSocketAddress(getAddress(),getPort()):<span class="keyword">new</span> InetSocketAddress(getPort()));  <span class="comment">//地址</span></span><br><span class="line">        serverSock.socket().bind(addr,getAcceptCount()); <span class="comment">//绑定</span></span><br><span class="line">        serverSock.configureBlocking(<span class="keyword">true</span>); <span class="comment">//mimic APR behavior  //并且tomcat中这个serverSock默认blocking</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//NioSelectorPool.java  selectorPool(NioEndPoint的成员)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        enabled = <span class="keyword">true</span>;</span><br><span class="line">        getSharedSelector();</span><br><span class="line">        <span class="keyword">if</span> (SHARED) &#123;</span><br><span class="line">            blockingSelector = <span class="keyword">new</span> NioBlockingSelector();</span><br><span class="line">            blockingSelector.open(getSharedSelector());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">     <span class="function"><span class="keyword">protected</span> Selector <span class="title">getSharedSelector</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (SHARED &amp;&amp; SHARED_SELECTOR == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> ( NioSelectorPool<span class="class">.<span class="keyword">class</span> ) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> ( SHARED_SELECTOR == <span class="keyword">null</span> )  &#123;</span><br><span class="line">                    SHARED_SELECTOR = Selector.open(); <span class="comment">//创建一个选择器</span></span><br><span class="line">                    log.info(<span class="string">"Using a shared selector for servlet write/read"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  SHARED_SELECTOR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//NioBlockingSelect.java 无继承的类</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Selector selector)</span> </span>&#123;</span><br><span class="line">        sharedSelector = selector;  <span class="comment">//设置seletcor</span></span><br><span class="line">        poller = <span class="keyword">new</span> BlockPoller(); <span class="comment">//这个类关键,为该类静态内部类</span></span><br><span class="line">        poller.selector = sharedSelector;</span><br><span class="line">        poller.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        poller.setName(<span class="string">"NioBlockingSelector.BlockPoller-"</span>+(++threadCounter));</span><br><span class="line">        poller.start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>BlockPoller</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该方法时BlockPoller外部类BioBlockingSelector,只有阻塞情况使用以下逻辑</span></span><br><span class="line"><span class="comment">//该函数是连接器真正向外写数据的代码</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(ByteBuffer buf, NioChannel socket, <span class="keyword">long</span> writeTimeout)</span>  <span class="comment">//阻塞方式写出逻辑</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SelectionKey key = socket.getIOChannel().keyFor(socket.getPoller().getSelector());  <span class="comment">//获取此处这个channel对应的key</span></span><br><span class="line">        <span class="keyword">if</span> ( key == <span class="keyword">null</span> ) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Key no longer registered"</span>);</span><br><span class="line">        KeyReference reference = keyReferenceStack.pop();</span><br><span class="line">        <span class="keyword">if</span> (reference == <span class="keyword">null</span>) &#123;</span><br><span class="line">            reference = <span class="keyword">new</span> KeyReference();</span><br><span class="line">        &#125;</span><br><span class="line">        NioSocketWrapper att = (NioSocketWrapper) key.attachment();</span><br><span class="line">        <span class="keyword">int</span> written = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> timedout = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> keycount = <span class="number">1</span>; <span class="comment">//assume we can write</span></span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis(); <span class="comment">//start the timeout timer</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ( (!timedout) &amp;&amp; buf.hasRemaining()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (keycount &gt; <span class="number">0</span>) &#123; <span class="comment">//only write if we were registered for a write</span></span><br><span class="line">                    <span class="keyword">int</span> cnt = socket.write(buf); <span class="comment">//write the data   我记得这个socket默认是非阻塞写出</span></span><br><span class="line">                    <span class="keyword">if</span> (cnt == -<span class="number">1</span>)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</span><br><span class="line">                    written += cnt;</span><br><span class="line">                    <span class="keyword">if</span> (cnt &gt; <span class="number">0</span>) &#123; <span class="comment">//有数据写出则继续写</span></span><br><span class="line">                        time = System.currentTimeMillis(); <span class="comment">//reset our timeout timer</span></span><br><span class="line">                        <span class="keyword">continue</span>; <span class="comment">//we successfully wrote, try again without a selector</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> ( att.getWriteLatch()==<span class="keyword">null</span> || att.getWriteLatch().getCount()==<span class="number">0</span>) att.startWriteLatch(<span class="number">1</span>); <span class="comment">//设置countDown</span></span><br><span class="line">                    poller.add(att,SelectionKey.OP_WRITE,reference); <span class="comment">//加入写事件,创建一个addEvent,addEvent线程逻辑就是注册写操作到selector中</span></span><br><span class="line">                    <span class="keyword">if</span> (writeTimeout &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        att.awaitWriteLatch(Long.MAX_VALUE,TimeUnit.MILLISECONDS);  <span class="comment">//countDown停留到Long.MAX_VALUE毫秒,等待就是BlockPoller中的线程结束</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        att.awaitWriteLatch(writeTimeout,TimeUnit.MILLISECONDS);<span class="comment">//停留最大writeTimeout时间</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">                    <span class="comment">// Ignore</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( att.getWriteLatch()!=<span class="keyword">null</span> &amp;&amp; att.getWriteLatch().getCount()&gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//we got interrupted, but we haven't received notification from the poller.</span></span><br><span class="line">                    keycount = <span class="number">0</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//latch countdown has happened</span></span><br><span class="line">                    keycount = <span class="number">1</span>;</span><br><span class="line">                    att.resetWriteLatch();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (writeTimeout &gt; <span class="number">0</span> &amp;&amp; (keycount == <span class="number">0</span>))</span><br><span class="line">                    timedout = (System.currentTimeMillis() - time) &gt;= writeTimeout;</span><br><span class="line">            &#125; <span class="comment">//while</span></span><br><span class="line">            <span class="keyword">if</span> (timedout)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SocketTimeoutException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            poller.remove(att,SelectionKey.OP_WRITE);</span><br><span class="line">            <span class="keyword">if</span> (timedout &amp;&amp; reference.key!=<span class="keyword">null</span>) &#123;</span><br><span class="line">                poller.cancelKey(reference.key);</span><br><span class="line">            &#125;</span><br><span class="line">            reference.key = <span class="keyword">null</span>;</span><br><span class="line">            keyReferenceStack.push(reference);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> written;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//读取逻辑    </span></span><br><span class="line"><span class="comment">//代码逻辑和写相同</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(ByteBuffer buf, NioChannel socket, <span class="keyword">long</span> readTimeout)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SelectionKey key = socket.getIOChannel().keyFor(socket.getPoller().getSelector());</span><br><span class="line">        <span class="keyword">if</span> ( key == <span class="keyword">null</span> ) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Key no longer registered"</span>);</span><br><span class="line">        KeyReference reference = keyReferenceStack.pop();</span><br><span class="line">        <span class="keyword">if</span> (reference == <span class="keyword">null</span>) &#123;</span><br><span class="line">            reference = <span class="keyword">new</span> KeyReference();</span><br><span class="line">        &#125;</span><br><span class="line">        NioSocketWrapper att = (NioSocketWrapper) key.attachment();</span><br><span class="line">        <span class="keyword">int</span> read = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> timedout = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> keycount = <span class="number">1</span>; <span class="comment">//assume we can read</span></span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis(); <span class="comment">//start the timeout timer</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(!timedout) &#123;</span><br><span class="line">                <span class="keyword">if</span> (keycount &gt; <span class="number">0</span>) &#123; <span class="comment">//only read if we were registered for a read</span></span><br><span class="line">                    read = socket.read(buf);</span><br><span class="line">                    <span class="keyword">if</span> (read != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> ( att.getReadLatch()==<span class="keyword">null</span> || att.getReadLatch().getCount()==<span class="number">0</span>) att.startReadLatch(<span class="number">1</span>);</span><br><span class="line">                    poller.add(att,SelectionKey.OP_READ, reference);</span><br><span class="line">                    <span class="keyword">if</span> (readTimeout &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        att.awaitReadLatch(Long.MAX_VALUE, TimeUnit.MILLISECONDS);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        att.awaitReadLatch(readTimeout, TimeUnit.MILLISECONDS);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">                    <span class="comment">// Ignore</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( att.getReadLatch()!=<span class="keyword">null</span> &amp;&amp; att.getReadLatch().getCount()&gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//we got interrupted, but we haven't received notification from the poller.</span></span><br><span class="line">                    keycount = <span class="number">0</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//latch countdown has happened</span></span><br><span class="line">                    keycount = <span class="number">1</span>;</span><br><span class="line">                    att.resetReadLatch();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (readTimeout &gt;= <span class="number">0</span> &amp;&amp; (keycount == <span class="number">0</span>))</span><br><span class="line">                    timedout = (System.currentTimeMillis() - time) &gt;= readTimeout;</span><br><span class="line">            &#125; <span class="comment">//while</span></span><br><span class="line">            <span class="keyword">if</span> (timedout)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SocketTimeoutException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            poller.remove(att,SelectionKey.OP_READ);</span><br><span class="line">            <span class="keyword">if</span> (timedout &amp;&amp; reference.key!=<span class="keyword">null</span>) &#123;</span><br><span class="line">                poller.cancelKey(reference.key);</span><br><span class="line">            &#125;</span><br><span class="line">            reference.key = <span class="keyword">null</span>;</span><br><span class="line">            keyReferenceStack.push(reference);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> read;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//该类是NioBlockingSelecotr内部,NioSelectorPool持有NioBlockingSelecotr对象</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//实际上此类的作用用来处理当进行读写操作时,选择器对读写channel的管理NioBlockingSelecotr这套逻辑,可以选择不使用,而使用</span></span><br><span class="line"><span class="comment">//NioSelectorPool的读写逻辑,就没有selector</span></span><br><span class="line"><span class="comment">//逻辑就是当读写channel进行一次操作后加入selector中,等待下一次读写,默认情况是通过</span></span><br><span class="line"> <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockPoller</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (run) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    events();  <span class="comment">//每次循环将所有有的事件取出并执行,事件轮询</span></span><br><span class="line">                    <span class="keyword">int</span> keyCount = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">int</span> i = wakeupCounter.get();</span><br><span class="line">                        <span class="keyword">if</span> (i&gt;<span class="number">0</span>)  <span class="comment">//根据这个原子性int值,决定立即select还是超时1s</span></span><br><span class="line">                            keyCount = selector.selectNow();</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            wakeupCounter.set(-<span class="number">1</span>);</span><br><span class="line">                            keyCount = selector.select(<span class="number">1000</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        wakeupCounter.set(<span class="number">0</span>);  <span class="comment">//当select返回counter设为0</span></span><br><span class="line">                        <span class="keyword">if</span> (!run) <span class="keyword">break</span>;</span><br><span class="line">                    &#125;<span class="keyword">catch</span> ( NullPointerException x ) &#123;</span><br><span class="line">                        <span class="comment">//sun bug 5076772 on windows JDK 1.5</span></span><br><span class="line">                        <span class="keyword">if</span> (selector==<span class="keyword">null</span>) <span class="keyword">throw</span> x;</span><br><span class="line">                        <span class="keyword">if</span> ( log.isDebugEnabled() ) log.debug(<span class="string">"Possibly encountered sun bug 5076772 on windows JDK 1.5"</span>,x);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> ( CancelledKeyException x ) &#123;</span><br><span class="line">                        <span class="comment">//sun bug 5076772 on windows JDK 1.5</span></span><br><span class="line">                        <span class="keyword">if</span> ( log.isDebugEnabled() ) log.debug(<span class="string">"Possibly encountered sun bug 5076772 on windows JDK 1.5"</span>,x);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                        ExceptionUtils.handleThrowable(x);</span><br><span class="line">                        log.error(<span class="string">""</span>,x);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Iterator&lt;SelectionKey&gt; iterator = keyCount &gt; <span class="number">0</span> ? selector.selectedKeys().iterator() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Walk through the collection of ready keys and dispatch</span></span><br><span class="line">                    <span class="comment">// any active event.</span></span><br><span class="line">                    <span class="keyword">while</span> (run &amp;&amp; iterator != <span class="keyword">null</span> &amp;&amp; iterator.hasNext()) &#123;</span><br><span class="line">                        SelectionKey sk = iterator.next();</span><br><span class="line">                        NioSocketWrapper attachment = (NioSocketWrapper)sk.attachment();  <span class="comment">//返回与该key附加的对象</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            iterator.remove();</span><br><span class="line">                            sk.interestOps(sk.interestOps() &amp; (~sk.readyOps()));</span><br><span class="line">                            <span class="keyword">if</span> ( sk.isReadable() ) &#123;</span><br><span class="line">                                countDown(attachment.getReadLatch());  <span class="comment">//这里就是一个countdown逻辑,代码到了这里说明此key是readkey,减少count,上边的read代码的await可以执行,继续进行read逻辑</span></span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (sk.isWritable()) &#123;</span><br><span class="line">                                countDown(attachment.getWriteLatch());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;<span class="keyword">catch</span> (CancelledKeyException ckx) &#123;</span><br><span class="line">                            sk.cancel();</span><br><span class="line">                            countDown(attachment.getReadLatch());</span><br><span class="line">                            countDown(attachment.getWriteLatch());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;<span class="comment">//while</span></span><br><span class="line">                &#125;<span class="keyword">catch</span> ( Throwable t ) &#123;</span><br><span class="line">                    log.error(<span class="string">""</span>,t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            events.clear();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                selector.selectNow();<span class="comment">//cancel all remaining keys</span></span><br><span class="line">            &#125;<span class="keyword">catch</span>( Exception ignore ) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled())log.debug(<span class="string">""</span>,ignore);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                selector.close();<span class="comment">//Close the connector</span></span><br><span class="line">            &#125;<span class="keyword">catch</span>( Exception ignore ) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled())log.debug(<span class="string">""</span>,ignore);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">(CountDownLatch latch)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ( latch == <span class="keyword">null</span> ) <span class="keyword">return</span>;</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//下边三个类都是poller的私有子类,为了完成注册,取消</span></span><br><span class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">RunnableAdd</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;  </span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> SocketChannel ch;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> NioSocketWrapper key;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> ops;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> KeyReference ref;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">RunnableAdd</span><span class="params">(SocketChannel ch, NioSocketWrapper key, <span class="keyword">int</span> ops, KeyReference ref)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.ch = ch;</span><br><span class="line">                <span class="keyword">this</span>.key = key;</span><br><span class="line">                <span class="keyword">this</span>.ops = ops;</span><br><span class="line">                <span class="keyword">this</span>.ref = ref;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                SelectionKey sk = ch.keyFor(selector);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (sk == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        sk = ch.register(selector, ops, key);  <span class="comment">//附加key就是此处加上的</span></span><br><span class="line">                        ref.key = sk;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!sk.isValid()) &#123;</span><br><span class="line">                        cancel(sk, key, ops);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        sk.interestOps(sk.interestOps() | ops);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (CancelledKeyException cx) &#123;</span><br><span class="line">                    cancel(sk, key, ops);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClosedChannelException cx) &#123;</span><br><span class="line">                    cancel(sk, key, ops);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">RunnableRemove</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> SocketChannel ch;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> NioSocketWrapper key;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> ops;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">RunnableRemove</span><span class="params">(SocketChannel ch, NioSocketWrapper key, <span class="keyword">int</span> ops)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.ch = ch;</span><br><span class="line">                <span class="keyword">this</span>.key = key;</span><br><span class="line">                <span class="keyword">this</span>.ops = ops;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                SelectionKey sk = ch.keyFor(selector);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (sk == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (SelectionKey.OP_WRITE==(ops&amp;SelectionKey.OP_WRITE)) countDown(key.getWriteLatch());</span><br><span class="line">                        <span class="keyword">if</span> (SelectionKey.OP_READ==(ops&amp;SelectionKey.OP_READ))countDown(key.getReadLatch());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (sk.isValid()) &#123;</span><br><span class="line">                            sk.interestOps(sk.interestOps() &amp; (~ops));</span><br><span class="line">                            <span class="keyword">if</span> (SelectionKey.OP_WRITE==(ops&amp;SelectionKey.OP_WRITE)) countDown(key.getWriteLatch());</span><br><span class="line">                            <span class="keyword">if</span> (SelectionKey.OP_READ==(ops&amp;SelectionKey.OP_READ))countDown(key.getReadLatch());</span><br><span class="line">                            <span class="keyword">if</span> (sk.interestOps()==<span class="number">0</span>) &#123;</span><br><span class="line">                                sk.cancel();</span><br><span class="line">                                sk.attach(<span class="keyword">null</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                            sk.cancel();</span><br><span class="line">                            sk.attach(<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (CancelledKeyException cx) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (sk!=<span class="keyword">null</span>) &#123;</span><br><span class="line">                        sk.cancel();</span><br><span class="line">                        sk.attach(<span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RunnableCancel</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> SelectionKey key;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">RunnableCancel</span><span class="params">(SelectionKey key)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.key = key;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                key.cancel();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;   </span><br></pre></td></tr></table></figure>
<ul>
<li>start阶段</li>
</ul>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//AbstarctProtocol,connector在start_pre状态下没有监听器</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getLog().isInfoEnabled()) &#123;</span><br><span class="line">            getLog().info(sm.getString(<span class="string">"abstractProtocolHandler.start"</span>, getName()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        endpoint.start(); <span class="comment">//真正的重点</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start async timeout thread</span></span><br><span class="line">        asyncTimeout = <span class="keyword">new</span> AsyncTimeout();</span><br><span class="line">        Thread timeoutThread = <span class="keyword">new</span> Thread(asyncTimeout, getNameInternal() + <span class="string">"-AsyncTimeout"</span>);</span><br><span class="line">        <span class="keyword">int</span> priority = endpoint.getThreadPriority();</span><br><span class="line">        <span class="keyword">if</span> (priority &lt; Thread.MIN_PRIORITY || priority &gt; Thread.MAX_PRIORITY) &#123;</span><br><span class="line">            priority = Thread.NORM_PRIORITY;</span><br><span class="line">        &#125;</span><br><span class="line">        timeoutThread.setPriority(priority);</span><br><span class="line">        timeoutThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        timeoutThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">//NioEndPoint </span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!running) &#123;</span><br><span class="line">            running = <span class="keyword">true</span>;</span><br><span class="line">            paused = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">//           SynchronizedStack 是tomcat实现的简单stack,动态数组,操作都是同步函数</span></span><br><span class="line">            processorCache = <span class="keyword">new</span> SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,  <span class="comment">//默认值都是128</span></span><br><span class="line">                    socketProperties.getProcessorCache());  <span class="comment">//处理器最大500</span></span><br><span class="line">            eventCache = <span class="keyword">new</span> SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,</span><br><span class="line">                            socketProperties.getEventCache()); <span class="comment">//事件最大500</span></span><br><span class="line">            nioChannels = <span class="keyword">new</span> SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,</span><br><span class="line">                    socketProperties.getBufferPool()); <span class="comment">//通道最大500</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create worker collection</span></span><br><span class="line">            <span class="keyword">if</span> ( getExecutor() == <span class="keyword">null</span> ) &#123;</span><br><span class="line">                createExecutor();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            initializeConnectionLatch();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start poller threads</span></span><br><span class="line">            pollers = <span class="keyword">new</span> Poller[getPollerThreadCount()]; <span class="comment">//创建并启动轮询线程,代码放在机制部分,太长了</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;pollers.length; i++) &#123;</span><br><span class="line">                pollers[i] = <span class="keyword">new</span> Poller();</span><br><span class="line">                Thread pollerThread = <span class="keyword">new</span> Thread(pollers[i], getName() + <span class="string">"-ClientPoller-"</span>+i);</span><br><span class="line">                pollerThread.setPriority(threadPriority);</span><br><span class="line">                pollerThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">                pollerThread.start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            startAcceptorThreads();<span class="comment">//启动接受器线程</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建线程池对象ThreadPoolExecutor这也是tomcat实现的</span></span><br><span class="line">    <span class="comment">//如果按照一般线程池来理解,那么这个结构就是不停执行的线程从任务队列中不断取task的过程</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        internalExecutor = <span class="keyword">true</span>;</span><br><span class="line">        TaskQueue taskqueue = <span class="keyword">new</span> TaskQueue();</span><br><span class="line">        TaskThreadFactory tf = <span class="keyword">new</span> TaskThreadFactory(getName() + <span class="string">"-exec-"</span>, daemon, getThreadPriority());</span><br><span class="line">        executor = <span class="keyword">new</span> ThreadPoolExecutor(getMinSpareThreads(), getMaxThreads(), <span class="number">60</span>, TimeUnit.SECONDS,taskqueue, tf);</span><br><span class="line">        taskqueue.setParent( (ThreadPoolExecutor) executor);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<h5 id="7-Context"><a class="header-anchor" href="#7-Context">¶</a>7.Context</h5>
<p>Context的标准实现为StandardContext, 代表着一个web项目,在HostConfig监听器创建</p>
<h4 id="各部分作用"><a class="header-anchor" href="#各部分作用">¶</a>各部分作用</h4>
<ol>
<li>LifecycleMBeanBase</li>
</ol>
<figure class="highlight java"><figcaption><span>initInternal</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"><span class="comment">//该函数的作用就是将当前对象加入到jmx中</span></span><br><span class="line"><span class="comment">//并且该类仅仅实现了init阶段</span></span><br><span class="line">        <span class="comment">// If oname is not null then registration has already happened via</span></span><br><span class="line">        <span class="comment">// preRegister().</span></span><br><span class="line">        <span class="keyword">if</span> (oname == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mserver = Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).getMBeanServer();</span><br><span class="line"></span><br><span class="line">            oname = register(<span class="keyword">this</span>, getObjectNameKeyProperties());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="监听器"><a class="header-anchor" href="#监听器">¶</a>监听器</h4>
<p>LifecycleListener子类,在life组件各个生命周期根据事件触发</p>
<h5 id="VersionLoggerListener"><a class="header-anchor" href="#VersionLoggerListener">¶</a>VersionLoggerListener</h5>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打印日志,在Server.init触发 条件</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</span><br><span class="line">  BEFORE_INIT_EVENT</span><br><span class="line">       <span class="keyword">if</span> (Lifecycle.BEFORE_INIT_EVENT.equals(event.getType())) &#123;</span><br><span class="line">           log();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h5 id="AprLifecycleListener"><a class="header-anchor" href="#AprLifecycleListener">¶</a>AprLifecycleListener</h5>
<figure class="highlight java"><figcaption><span>apr</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//触发时间: 由Server.init触发,当正确配置,并且本地有jni库的情况,就会加载apr模式,并且后边会创建apr io</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123; Lifecycle.BEFORE_INIT_EVENT</span><br><span class="line">        <span class="keyword">if</span> (Lifecycle.BEFORE_INIT_EVENT.equals(event.getType())) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                init(); <span class="comment">//加载tcn本地库 当不能加载时 aprAvailable保持false</span></span><br><span class="line">                <span class="keyword">for</span> (String msg : initInfoLogMessages) &#123;</span><br><span class="line">                    log.info(msg);</span><br><span class="line">                &#125;</span><br><span class="line">                initInfoLogMessages.clear();</span><br><span class="line">                <span class="keyword">if</span> (aprAvailable) &#123;  <span class="comment">//只有init中加载了库,才会导致此处有效,也影响了protocolHandler的创建</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        initializeSSL();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                        t = ExceptionUtils.unwrapInvocationTargetException(t);</span><br><span class="line">                        ExceptionUtils.handleThrowable(t);</span><br><span class="line">                        log.error(sm.getString(<span class="string">"aprListener.sslInit"</span>), t);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Failure to initialize FIPS mode is fatal</span></span><br><span class="line">                <span class="keyword">if</span> (!(<span class="keyword">null</span> == FIPSMode || <span class="string">"off"</span>.equalsIgnoreCase(FIPSMode)) &amp;&amp; !isFIPSModeActive()) &#123;</span><br><span class="line">                    Error e = <span class="keyword">new</span> Error(</span><br><span class="line">                            sm.getString(<span class="string">"aprListener.initializeFIPSFailed"</span>));</span><br><span class="line">                    <span class="comment">// Log here, because thrown error might be not logged</span></span><br><span class="line">                    log.fatal(e.getMessage(), e);</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Lifecycle.AFTER_DESTROY_EVENT.equals(event.getType())) &#123;  <span class="comment">//destroy 时触发</span></span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!aprAvailable) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;   <span class="comment">//一般不是apr模式,就没有事情发生</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    terminateAPR();  <span class="comment">//这里是Library的native函数调用,也就是说library貌似就是控制tcn native的</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    t = ExceptionUtils.unwrapInvocationTargetException(t);</span><br><span class="line">                    ExceptionUtils.handleThrowable(t);</span><br><span class="line">                    log.info(sm.getString(<span class="string">"aprListener.aprDestroy"</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//这里 init  和terminateAPR 都是调用Library这个类的</span></span><br></pre></td></tr></table></figure>
<h5 id="JreMemoryLeakPreventionListener"><a class="header-anchor" href="#JreMemoryLeakPreventionListener">¶</a>JreMemoryLeakPreventionListener</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该监听器是用来防止某些jre类的加载导致对应类加载器无法被回收的情况</span></span><br><span class="line"><span class="comment">//首先tomcat的类加载器结构为 comm  server shaded 以及webAppclassLoader</span></span><br><span class="line"><span class="comment">//1.内存泄漏的原因:  由于某个对象引用链不断开,这里说的就是webAppClassLoader ||由于锁文件的导致,具体发生在urlConnection的缓冲机制</span></span><br><span class="line"><span class="comment">//2.在tomcat加载某些类 如:DriverManager 会由于该对象加载之后在java程序结束前都是以单例存在,而任意对象加载后会引用其类加载器对象,这就导致了加载器webAppClassLoader无法被回收</span></span><br><span class="line"><span class="comment">// 如:Disposer类被加载后会启动一个循环线程,也将导致webAppClassLoader无法被回收</span></span><br><span class="line"><span class="comment">//因此tomcat的解决方式是,在使用webAppClassLoader前使用系统类加载器将这些类加载一次,后边使用就不会发生这些事情,使用的时机就是Server.init触发的监听器</span></span><br><span class="line">  <span class="comment">//这里激活函数我没有全部截取</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Initialise these classes when Tomcat starts</span></span><br><span class="line">        <span class="keyword">if</span> (Lifecycle.BEFORE_INIT_EVENT.equals(event.getType())) &#123;</span><br><span class="line"></span><br><span class="line">            ClassLoader loader = Thread.currentThread().getContextClassLoader(); </span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Use the system classloader as the victim for all this</span></span><br><span class="line">                <span class="comment">// ClassLoader pinning we're about to do.</span></span><br><span class="line">                Thread.currentThread().setContextClassLoader(</span><br><span class="line">                        ClassLoader.getSystemClassLoader());   <span class="comment">//设置系统类加载器为上下文加载器</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * First call to this loads all drivers in the current class</span></span><br><span class="line"><span class="comment">                 * loader</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> (driverManagerProtection) &#123;</span><br><span class="line">                    DriverManager.getDrivers(); <span class="comment">//加载DriverManager</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Trigger the creation of the AWT (AWT-Windows, AWT-XAWT,</span></span><br><span class="line">                <span class="comment">// etc.) thread.</span></span><br><span class="line">                <span class="comment">// Note this issue is fixed in Java 8 update 05 onwards.</span></span><br><span class="line">                <span class="keyword">if</span> (awtThreadProtection &amp;&amp; !JreCompat.isJre9Available()) &#123;</span><br><span class="line">                    java.awt.Toolkit.getDefaultToolkit();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Several components end up calling</span></span><br><span class="line"><span class="comment">                 * sun.misc.GC.requestLatency(long) which creates a daemon</span></span><br><span class="line"><span class="comment">                 * thread without setting the TCCL.</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * Those libraries / components known to trigger memory leaks</span></span><br><span class="line"><span class="comment">                 * due to eventual calls to requestLatency(long) are:</span></span><br><span class="line"><span class="comment">                 * - javax.management.remote.rmi.RMIConnectorServer.start()</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * Note: Long.MAX_VALUE is a special case that causes the thread</span></span><br><span class="line"><span class="comment">                 *       to terminate</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * Fixed in Java 9 onwards (from early access build 130)</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> (gcDaemonProtection &amp;&amp; !JreCompat.isJre9Available()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Class&lt;?&gt; clazz = Class.forName(<span class="string">"sun.misc.GC"</span>);</span><br><span class="line">                        Method method = clazz.getDeclaredMethod(</span><br><span class="line">                                <span class="string">"requestLatency"</span>,</span><br><span class="line">                                <span class="keyword">new</span> Class[] &#123;<span class="keyword">long</span><span class="class">.<span class="keyword">class</span>&#125;)</span>;</span><br><span class="line">                        method.invoke(<span class="keyword">null</span>, Long.valueOf(Long.MAX_VALUE - <span class="number">1</span>));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (JreVendor.IS_ORACLE_JVM) &#123;</span><br><span class="line">                            log.error(sm.getString(</span><br><span class="line">                                    <span class="string">"jreLeakListener.gcDaemonFail"</span>), e);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            log.debug(sm.getString(</span><br><span class="line">                                    <span class="string">"jreLeakListener.gcDaemonFail"</span>), e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (SecurityException | NoSuchMethodException | IllegalArgumentException |</span><br><span class="line">                            IllegalAccessException e) &#123;</span><br><span class="line">                        log.error(sm.getString(<span class="string">"jreLeakListener.gcDaemonFail"</span>),</span><br><span class="line">                                e);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                        ExceptionUtils.handleThrowable(e.getCause());</span><br><span class="line">                        log.error(sm.getString(<span class="string">"jreLeakListener.gcDaemonFail"</span>),</span><br><span class="line">                                e);</span><br><span class="line">                    &#125;</span><br><span class="line">					</span><br><span class="line">                &#125;</span><br><span class="line">				  <span class="keyword">if</span> (tokenPollerProtection &amp;&amp; !JreCompat.isJre9Available()) &#123;</span><br><span class="line">                    java.security.Security.getProviders();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Several components end up opening JarURLConnections without</span></span><br><span class="line"><span class="comment">                 * first disabling caching. This effectively locks the file.</span></span><br><span class="line"><span class="comment">                 * Whilst more noticeable and harder to ignore on Windows, it</span></span><br><span class="line"><span class="comment">                 * affects all operating systems.</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * Those libraries/components known to trigger this issue</span></span><br><span class="line"><span class="comment">                 * include:</span></span><br><span class="line"><span class="comment">                 * - log4j versions 1.2.15 and earlier</span></span><br><span class="line"><span class="comment">                 * - javax.xml.bind.JAXBContext.newInstance()</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * https://bugs.openjdk.java.net/browse/JDK-8163449</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Set the default URL caching policy to not to cache</span></span><br><span class="line">                <span class="keyword">if</span> (urlCacheProtection) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// Doesn't matter that this JAR doesn't exist - just as</span></span><br><span class="line">                        <span class="comment">// long as the URL is well-formed</span></span><br><span class="line">                        URL url = <span class="keyword">new</span> URL(<span class="string">"jar:file://dummy.jar!/"</span>);</span><br><span class="line">                        URLConnection uConn = url.openConnection();</span><br><span class="line">                        uConn.setDefaultUseCaches(<span class="keyword">false</span>); <span class="comment">//取消缓冲机制</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">                        log.error(sm.getString(</span><br><span class="line">                                <span class="string">"jreLeakListener.jarUrlConnCacheFail"</span>), e);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        log.error(sm.getString(</span><br><span class="line">                                <span class="string">"jreLeakListener.jarUrlConnCacheFail"</span>), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="GlobalResourcesLifecycleListener"><a class="header-anchor" href="#GlobalResourcesLifecycleListener">¶</a>GlobalResourcesLifecycleListener</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//触发时机 start 和stop</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Lifecycle.START_EVENT.equals(event.getType())) &#123;</span><br><span class="line">            component = event.getLifecycle();</span><br><span class="line">            createMBeans();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Lifecycle.STOP_EVENT.equals(event.getType())) &#123;</span><br><span class="line">            destroyMBeans();</span><br><span class="line">            component = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">createMBeans</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Look up our global naming context</span></span><br><span class="line">        Context context = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            context = (Context) (<span class="keyword">new</span> InitialContext()).lookup(<span class="string">"java:/"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            log.error(<span class="string">"No global naming context defined for server"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Recurse through the defined global JNDI resources context</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            createMBeans(<span class="string">""</span>, context);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            log.error(<span class="string">"Exception processing Global JNDI Resources"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="ThreadLocalLeakPreventionListener"><a class="header-anchor" href="#ThreadLocalLeakPreventionListener">¶</a>ThreadLocalLeakPreventionListener</h5>
<figure class="highlight java"><figcaption><span>ThreadLocalLeakPreventionListener</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该监听器作用是处理由ThreadLocal 引起的内存泄漏问题</span></span><br><span class="line"><span class="comment">//原因: 当连接器获取req后,会创建执行器Process线程,参照EndPoint源码,此处如果是通过线程池创建的,那么当该线程一直继续进行后续处理,获取到web Context后,如果此线程中使用了ThreadLocal&lt;AA&gt;,当该context重新创建后,会通过重新创建</span></span><br><span class="line"><span class="comment">//一个 webAppClassLoader 来加载,而由于线程池的实现是将线程对象不断缓冲的模式,因此之前的Threadlocal引用,导致了之前webApploader不能释放</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalLeakPreventionListener</span> <span class="keyword">implements</span> <span class="title">LifecycleListener</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ContainerListener</span> </span>&#123; <span class="comment">//触发清理时机在任意context的销毁阶段</span></span><br><span class="line">		 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123; <span class="comment">//该监听器开始位于Server中</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Lifecycle lifecycle = event.getLifecycle();</span><br><span class="line">            <span class="keyword">if</span> (Lifecycle.AFTER_START_EVENT.equals(event.getType()) &amp;&amp;</span><br><span class="line">                    lifecycle <span class="keyword">instanceof</span> Server) &#123;</span><br><span class="line">                <span class="comment">// when the server starts, we register ourself as listener for</span></span><br><span class="line">                <span class="comment">// all context</span></span><br><span class="line">                <span class="comment">// as well as container event listener so that we know when new</span></span><br><span class="line">                <span class="comment">// Context are deployed</span></span><br><span class="line">                Server server = (Server) lifecycle;</span><br><span class="line">                registerListenersForServer(server);  <span class="comment">//当server.start后,说明context已经部署,一层层的加入监听器</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Lifecycle.BEFORE_STOP_EVENT.equals(event.getType()) &amp;&amp;</span><br><span class="line">                    lifecycle <span class="keyword">instanceof</span> Server) &#123;</span><br><span class="line">                <span class="comment">// Server is shutting down, so thread pools will be shut down so</span></span><br><span class="line">                <span class="comment">// there is no need to clean the threads</span></span><br><span class="line">                serverStopping = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Lifecycle.AFTER_STOP_EVENT.equals(event.getType()) &amp;&amp;</span><br><span class="line">                    lifecycle <span class="keyword">instanceof</span> Context) &#123;</span><br><span class="line">                stopIdleThreads((Context) lifecycle); <span class="comment">//当context.stop后进行处理</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            String msg =</span><br><span class="line">                sm.getString(</span><br><span class="line">                    <span class="string">"threadLocalLeakPreventionListener.lifecycleEvent.error"</span>,</span><br><span class="line">                    event);</span><br><span class="line">            log.error(msg, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">containerEvent</span><span class="params">(ContainerEvent event)</span> </span>&#123; <span class="comment">//当添加子容器,或移除,进行监听器注册/去除</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String type = event.getType();</span><br><span class="line">            <span class="keyword">if</span> (Container.ADD_CHILD_EVENT.equals(type)) &#123;</span><br><span class="line">                processContainerAddChild(event.getContainer(),</span><br><span class="line">                    (Container) event.getData());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Container.REMOVE_CHILD_EVENT.equals(type)) &#123;</span><br><span class="line">                processContainerRemoveChild(event.getContainer(),</span><br><span class="line">                    (Container) event.getData());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            String msg =</span><br><span class="line">                sm.getString(</span><br><span class="line">                    <span class="string">"threadLocalLeakPreventionListener.containerEvent.error"</span>,</span><br><span class="line">                    event);</span><br><span class="line">            log.error(msg, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerListenersForServer</span><span class="params">(Server server)</span> </span>&#123; <span class="comment">//逐层注册</span></span><br><span class="line">        <span class="keyword">for</span> (Service service : server.findServices()) &#123;</span><br><span class="line">            Engine engine = service.getContainer();</span><br><span class="line">            engine.addContainerListener(<span class="keyword">this</span>);</span><br><span class="line">            registerListenersForEngine(engine);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerListenersForEngine</span><span class="params">(Engine engine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Container hostContainer : engine.findChildren()) &#123;</span><br><span class="line">            Host host = (Host) hostContainer;</span><br><span class="line">            host.addContainerListener(<span class="keyword">this</span>);</span><br><span class="line">            registerListenersForHost(host);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerListenersForHost</span><span class="params">(Host host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Container contextContainer : host.findChildren()) &#123;</span><br><span class="line">            Context context = (Context) contextContainer;</span><br><span class="line">            registerContextListener(context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerContextListener</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        context.addLifecycleListener(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processContainerAddChild</span><span class="params">(Container parent, Container child)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            log.debug(<span class="string">"Process addChild[parent="</span> + parent + <span class="string">",child="</span> + child +</span><br><span class="line">                <span class="string">"]"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (child <span class="keyword">instanceof</span> Context) &#123;</span><br><span class="line">            registerContextListener((Context) child);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child <span class="keyword">instanceof</span> Engine) &#123;</span><br><span class="line">            registerListenersForEngine((Engine) child);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child <span class="keyword">instanceof</span> Host) &#123;</span><br><span class="line">            registerListenersForHost((Host) child);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processContainerRemoveChild</span><span class="params">(Container parent,</span></span></span><br><span class="line"><span class="function"><span class="params">        Container child)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            log.debug(<span class="string">"Process removeChild[parent="</span> + parent + <span class="string">",child="</span> +</span><br><span class="line">                child + <span class="string">"]"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (child <span class="keyword">instanceof</span> Context) &#123;</span><br><span class="line">            Context context = (Context) child;</span><br><span class="line">            context.removeLifecycleListener(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child <span class="keyword">instanceof</span> Host || child <span class="keyword">instanceof</span> Engine) &#123;</span><br><span class="line">            child.removeContainerListener(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Updates each ThreadPoolExecutor with the current time, which is the time</span></span><br><span class="line"><span class="comment">     * when a context is being stopped.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     *            the context being stopped, used to discover all the Connectors</span></span><br><span class="line"><span class="comment">     *            of its parent Service.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopIdleThreads</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (serverStopping) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(context <span class="keyword">instanceof</span> StandardContext) ||</span><br><span class="line">            !((StandardContext) context).getRenewThreadsWhenStoppingContext()) &#123;</span><br><span class="line">            log.debug(<span class="string">"Not renewing threads when the context is stopping. "</span></span><br><span class="line">                + <span class="string">"It is not configured to do it."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Engine engine = (Engine) context.getParent().getParent();</span><br><span class="line">        Service service = engine.getService();</span><br><span class="line">        Connector[] connectors = service.findConnectors();</span><br><span class="line">        <span class="keyword">if</span> (connectors != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Connector connector : connectors) &#123;</span><br><span class="line">                ProtocolHandler handler = connector.getProtocolHandler();</span><br><span class="line">                Executor executor = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    executor = handler.getExecutor();  <span class="comment">//这个线程池实际上就是Endpoint中的线程池,该线程池用来创建执行器线程来处理请求</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (executor <span class="keyword">instanceof</span> ThreadPoolExecutor) &#123;</span><br><span class="line">                    ThreadPoolExecutor threadPoolExecutor =</span><br><span class="line">                        (ThreadPoolExecutor) executor;</span><br><span class="line">                    threadPoolExecutor.contextStopping(); <span class="comment">//处理线程池,处理的方式就是阻塞线程池,并且停止线程池中线程,就能使的引用链断开</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (executor <span class="keyword">instanceof</span> StandardThreadExecutor) &#123;</span><br><span class="line">                    StandardThreadExecutor stdThreadExecutor =</span><br><span class="line">                        (StandardThreadExecutor) executor;</span><br><span class="line">                    stdThreadExecutor.contextStopping();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="NamingContextListener"><a class="header-anchor" href="#NamingContextListener">¶</a>NamingContextListener</h5>
<figure class="highlight java"><figcaption><span>NamingContextListener</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该监听器作用用于作为生命监听器和容器监听器</span></span><br><span class="line"><span class="comment">//1.作为生命监听器处理Server和Context中的naming资源,向jndi中注册,以及当生命组件destory时进行jndi解除,关于tomcat中jdni的实现部分在机制部分说明</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamingContextListener</span> <span class="keyword">implements</span> <span class="title">LifecycleListener</span>, <span class="title">ContainerListener</span>, <span class="title">PropertyChangeListener</span></span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        container = event.getLifecycle();</span><br><span class="line">        <span class="comment">//当Server 或者 context 分别获取内部的namingResouces,以及token(用来标识使用的Object对象)</span></span><br><span class="line">        <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Context)</span><br><span class="line">        &#123;</span><br><span class="line">            namingResources = ((Context) container).getNamingResources();</span><br><span class="line">            token = ((Context) container).getNamingToken();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Server)</span><br><span class="line">        &#123;</span><br><span class="line">            namingResources = ((Server) container).getGlobalNamingResources();</span><br><span class="line">            token = ((Server) container).getNamingToken();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Lifecycle.CONFIGURE_START_EVENT.equals(event.getType()))</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (initialized)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                Hashtable&lt;String, Object&gt; contextEnv = <span class="keyword">new</span> Hashtable&lt;&gt;();</span><br><span class="line">                namingContext = <span class="keyword">new</span> NamingContext(contextEnv, getName()); <span class="comment">//第一次创建上线文, 环境map为空,context对应的路径名为"/",就是表示根节点</span></span><br><span class="line">                <span class="comment">//ContextAccessController| ContextBindings这两个类中的变量都是map,并且都是static,这两个类是用来做标识给jndi系统使用的</span></span><br><span class="line">                ContextAccessController.setSecurityToken(getName(), token); <span class="comment">//使用验证map,</span></span><br><span class="line">                ContextAccessController.setSecurityToken(container, token);</span><br><span class="line">                <span class="comment">//Hashtable&lt;Object,Context&gt; objectBindings(container,namingContext) ,token是用来检查SecurityToken的</span></span><br><span class="line">                ContextBindings.bindContext(container, namingContext, token); <span class="comment">//验证 container,token存在,put container,namingContext</span></span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">                &#123;</span><br><span class="line">                    log.debug(<span class="string">"Bound "</span> + container);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Configure write when read-only behaviour</span></span><br><span class="line">                namingContext.setExceptionOnFailedWrite(getExceptionOnFailedWrite());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Setting the context in read/write mode</span></span><br><span class="line">                ContextAccessController.setWritable(getName(), token);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    createNamingContext(); <span class="comment">//进行jndi的初始化以及bind,目前看来加入的新的子context 或者ref都是存在于上层context中</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (NamingException e)</span><br><span class="line">                &#123;</span><br><span class="line">                    log.error(sm.getString(<span class="string">"naming.namingContextCreationFailed"</span>, e));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                namingResources.addPropertyChangeListener(<span class="keyword">this</span>);  <span class="comment">//添加改变监听器</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Binding the naming context to the class loader</span></span><br><span class="line">                <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Context)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// Setting the context in read only mode</span></span><br><span class="line">                    ContextAccessController.setReadOnly(getName());</span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//验证container,token  put(ClassLoader,container-&gt;context) put(ClassLoader,container)</span></span><br><span class="line">                        <span class="comment">// 将类加载器webAppClassLoader和context以及对应tomcat context联系</span></span><br><span class="line">                        ContextBindings.bindClassLoader(container, token, ((Context) container).getLoader().getClassLoader());  <span class="comment">//完成不同context的隔离工作</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (NamingException e)</span><br><span class="line">                    &#123;</span><br><span class="line">                        log.error(sm.getString(<span class="string">"naming.bindFailed"</span>, e));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Server)</span><br><span class="line">                &#123;</span><br><span class="line">                    org.apache.naming.factory.ResourceLinkFactory.setGlobalContext(namingContext); <span class="comment">//ResourceLink设置全局context,应该是该tomcat context访问全局资源使用的</span></span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        ContextBindings.bindClassLoader(container, token, <span class="keyword">this</span>.getClass().getClassLoader());</span><br><span class="line">                        <span class="comment">//测试</span></span><br><span class="line">                        <span class="comment">// env map 使用该给NamingManager创建工厂使用的变量,tomcat在系统初始化的时候将:</span></span><br><span class="line">                        <span class="comment">// Context.INITIAL_CONTEXT_FACTORY=org.apache.naming.java.javaURLContextFactory</span></span><br><span class="line">                        <span class="comment">// Context.URL_PKG_PREFIXES=org.apache.naming 放到了system.props中,当这两个变量被InitialContext对象创建时调用init(),被NamingManager使用</span></span><br><span class="line">                        <span class="comment">// 将defaultFactory设置了</span></span><br><span class="line">                        InitialContext initialContext = <span class="keyword">new</span> InitialContext();</span><br><span class="line">                        initialContext.lookup(<span class="string">"java:UserDatabase"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (NamingException e)</span><br><span class="line">                    &#123;</span><br><span class="line">                        log.error(sm.getString(<span class="string">"naming.bindFailed"</span>, e));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (container <span class="keyword">instanceof</span> StandardServer)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ((StandardServer) container).setGlobalNamingContext(namingContext);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Regardless of success, so that we can do cleanup on configure_stop</span></span><br><span class="line">                initialized = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Lifecycle.CONFIGURE_STOP_EVENT.equals(event.getType()))  <span class="comment">//卸载</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!initialized)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Setting the context in read/write mode</span></span><br><span class="line">                ContextAccessController.setWritable(getName(), token);</span><br><span class="line">                ContextBindings.unbindContext(container, token);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Context)</span><br><span class="line">                &#123;</span><br><span class="line">                    ContextBindings.unbindClassLoader(container, token, ((Context) container).getLoader().getClassLoader());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Server)</span><br><span class="line">                &#123;</span><br><span class="line">                    namingResources.removePropertyChangeListener(<span class="keyword">this</span>);</span><br><span class="line">                    ContextBindings.unbindClassLoader(container, token, <span class="keyword">this</span>.getClass().getClassLoader());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ContextAccessController.unsetSecurityToken(getName(), token);</span><br><span class="line">                ContextAccessController.unsetSecurityToken(container, token);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// unregister mbeans.</span></span><br><span class="line">                <span class="keyword">if</span> (!objectNames.isEmpty())</span><br><span class="line">                &#123;</span><br><span class="line">                    Collection&lt;ObjectName&gt; names = objectNames.values();</span><br><span class="line">                    Registry registry = Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">for</span> (ObjectName objectName : names)</span><br><span class="line">                    &#123;</span><br><span class="line">                        registry.unregisterComponent(objectName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                javax.naming.Context global = getGlobalNamingContext();</span><br><span class="line">                <span class="keyword">if</span> (global != <span class="keyword">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ResourceLinkFactory.deregisterGlobalResourceAccess(global);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                objectNames.clear();</span><br><span class="line"></span><br><span class="line">                namingContext = <span class="keyword">null</span>;</span><br><span class="line">                envCtx = <span class="keyword">null</span>;</span><br><span class="line">                compCtx = <span class="keyword">null</span>;</span><br><span class="line">                initialized = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create and initialize the JNDI naming context.</span></span><br><span class="line"><span class="comment">     * tomcat jdni 的过程:</span></span><br><span class="line"><span class="comment">     * 都在server.xml中配置,也就是作为 Server全局资源并且在任意context中配置ref进行使用|或者作为Context中局部资源</span></span><br><span class="line"><span class="comment">     * 1.创建nameRersouce</span></span><br><span class="line"><span class="comment">     *  Server中namingResource创建于构造函数, context namingResource创建参考</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.apache.catalina.startup.SetNextNamingRule#end(String, String) 导致在server.xml中配置的context内部namingResource的加载</span></span><br><span class="line"><span class="comment">     * 2.通过namingContextListener作为生命周期监听器调用该函数,将nameRersouce中资源进行注册</span></span><br><span class="line"><span class="comment">     *  Server的监听器在构造创建 ,context的在startInternal创建,并激活</span></span><br><span class="line"><span class="comment">     * --------</span></span><br><span class="line"><span class="comment">     * 至少在tomcat9中不存在在context.xml中配置任意web项目,具体源码参照Hostconfig解析xml过程</span></span><br><span class="line"><span class="comment">     * tomcat9支持在web.xml中配置局部资源,解析过程参见context的部分</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createNamingContext</span><span class="params">()</span>  <span class="comment">//该函数是Server /Context 这两种全局和局部jndi进行bind的入口,该函数具体对不同资源进行注册,特殊的有ref类型</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> NamingException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Creating the comp subcontext</span></span><br><span class="line">        <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Server)</span><br><span class="line">        &#123;</span><br><span class="line">            compCtx = namingContext;</span><br><span class="line">            envCtx = namingContext;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            compCtx = namingContext.createSubcontext(<span class="string">"comp"</span>);</span><br><span class="line">            envCtx = compCtx.createSubcontext(<span class="string">"env"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">        &#123;</span><br><span class="line">            log.debug(<span class="string">"Creating JNDI naming context"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (namingResources == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            namingResources = <span class="keyword">new</span> NamingResourcesImpl();</span><br><span class="line">            namingResources.setContainer(container);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Resource links</span></span><br><span class="line">        ContextResourceLink[] resourceLinks = namingResources.findResourceLinks();</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; resourceLinks.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            addResourceLink(resourceLinks[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Resources</span></span><br><span class="line">        ContextResource[] resources = namingResources.findResources();</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; resources.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            addResource(resources[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Resources Env</span></span><br><span class="line">        ContextResourceEnvRef[] resourceEnvRefs = namingResources.findResourceEnvRefs();</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; resourceEnvRefs.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            addResourceEnvRef(resourceEnvRefs[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Environment entries</span></span><br><span class="line">        ContextEnvironment[] contextEnvironments = namingResources.findEnvironments();</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; contextEnvironments.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            addEnvironment(contextEnvironments[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// EJB references</span></span><br><span class="line">        ContextEjb[] ejbs = namingResources.findEjbs();</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ejbs.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            addEjb(ejbs[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// WebServices references</span></span><br><span class="line">        ContextService[] services = namingResources.findServices();</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; services.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            addService(services[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Binding a User Transaction reference</span></span><br><span class="line">        <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Context)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                Reference ref = <span class="keyword">new</span> TransactionRef();</span><br><span class="line">                compCtx.bind(<span class="string">"UserTransaction"</span>, ref);</span><br><span class="line">                ContextTransaction transaction = namingResources.getTransaction();</span><br><span class="line">                <span class="keyword">if</span> (transaction != <span class="keyword">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Iterator&lt;String&gt; params = transaction.listProperties();</span><br><span class="line">                    <span class="keyword">while</span> (params.hasNext())</span><br><span class="line">                    &#123;</span><br><span class="line">                        String paramName = params.next();</span><br><span class="line">                        String paramValue = (String) transaction.getProperty(paramName);</span><br><span class="line">                        StringRefAddr refAddr = <span class="keyword">new</span> StringRefAddr(paramName, paramValue);</span><br><span class="line">                        ref.add(refAddr);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (NameAlreadyBoundException e)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Ignore because UserTransaction was obviously</span></span><br><span class="line">                <span class="comment">// added via ResourceLink</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (NamingException e)</span><br><span class="line">            &#123;</span><br><span class="line">                log.error(sm.getString(<span class="string">"naming.bindFailed"</span>, e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Binding the resources directory context</span></span><br><span class="line">        <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Context)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                compCtx.bind(<span class="string">"Resources"</span>, ((Context) container).getResources());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (NamingException e)</span><br><span class="line">            &#123;</span><br><span class="line">                log.error(sm.getString(<span class="string">"naming.bindFailed"</span>, e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//以添加ContextResource 为例:</span></span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResource</span><span class="params">(ContextResource resource)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a reference to the resource.  创建reference</span></span><br><span class="line">        Reference ref = <span class="keyword">new</span> ResourceRef(resource.getType(), resource.getDescription(), resource.getScope(), resource.getAuth(), resource.getSingleton());</span><br><span class="line">        <span class="comment">// Adding the additional parameters, if any 添加额外的内容,也就是存在于map中而不是直接成员变量的属性</span></span><br><span class="line">        Iterator&lt;String&gt; params = resource.listProperties();</span><br><span class="line">        <span class="keyword">while</span> (params.hasNext())</span><br><span class="line">        &#123;</span><br><span class="line">            String paramName = params.next();</span><br><span class="line">            String paramValue = (String) resource.getProperty(paramName);</span><br><span class="line">            StringRefAddr refAddr = <span class="keyword">new</span> StringRefAddr(paramName, paramValue);</span><br><span class="line">            ref.add(refAddr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            &#123;</span><br><span class="line">                log.debug(<span class="string">"  Adding resource ref "</span> + resource.getName() + <span class="string">"  "</span> + ref);</span><br><span class="line">            &#125;</span><br><span class="line">            createSubcontexts(envCtx, resource.getName());  <span class="comment">//创建子树上下文节点</span></span><br><span class="line">            envCtx.bind(resource.getName(), ref);  <span class="comment">//真正绑定资源对象到树结构上,至此完成资源在jdni中的绑定</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NamingException e)</span><br><span class="line">        &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"naming.bindFailed"</span>, e));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"javax.sql.DataSource"</span>.equals(ref.getClassName()) &amp;&amp; resource.getSingleton())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                ObjectName on = createObjectName(resource);</span><br><span class="line">                Object actualResource = envCtx.lookup(resource.getName());</span><br><span class="line">                Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(actualResource, on, <span class="keyword">null</span>);</span><br><span class="line">                objectNames.put(resource.getName(), on);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                log.warn(sm.getString(<span class="string">"naming.jmxRegistrationFailed"</span>, e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
<h5 id="MapperListener"><a class="header-anchor" href="#MapperListener">¶</a>MapperListener</h5>
<p>该监听器默认为Service成员,Service.startInternal() Service.initInternal()  都会触发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该监听器用于向mapper中田间context信息</span></span><br><span class="line"><span class="comment">//此监听器为 contrainerListener&amp;&amp;LifeListener&amp;&amp;LifeMbean 子类</span></span><br><span class="line"><span class="comment">//该监听器实体对象处于Service中,但是并不是Service的监听器,也属于生命组件和容器组件</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapperListener</span><span class="params">(Service service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.service = service;</span><br><span class="line">        <span class="keyword">this</span>.mapper = service.getMapper();  <span class="comment">//mapper是service的属性</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">        Engine engine = service.getContainer();</span><br><span class="line">        <span class="keyword">if</span> (engine == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        findDefaultHost();</span><br><span class="line"></span><br><span class="line">        addListeners(engine); <span class="comment">//递归将该监听器作为lifeListern和contianerlistern加如engine以及其子类中</span></span><br><span class="line"></span><br><span class="line">        Container[] conHosts = engine.findChildren();  <span class="comment">//engine的直接子容器,实际就是host</span></span><br><span class="line">        <span class="keyword">for</span> (Container conHost : conHosts) &#123;</span><br><span class="line">            Host host = (Host) conHost;</span><br><span class="line">            <span class="keyword">if</span> (!LifecycleState.NEW.equals(host.getState())) &#123;</span><br><span class="line">                <span class="comment">// Registering the host will register the context and wrappers</span></span><br><span class="line">                registerHost(host); <span class="comment">//注册host</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerHost</span><span class="params">(Host host)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String[] aliases = host.findAliases();</span><br><span class="line">        mapper.addHost(host.getName(), aliases, host);</span><br><span class="line">        <span class="keyword">for</span> (Container container : host.findChildren()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (container.getState().isAvailable()) &#123;</span><br><span class="line">                registerContext((Context) container);  <span class="comment">//对于host的子容器都是context,进行context在mapper的注册</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(sm.getString(<span class="string">"mapperListener.registerHost"</span>,</span><br><span class="line">                    host.getName(), domain, service));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerContext</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String contextPath = context.getPath();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"/"</span>.equals(contextPath)) &#123;</span><br><span class="line">            contextPath = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Host host = (Host)context.getParent();</span><br><span class="line"></span><br><span class="line">        WebResourceRoot resources = context.getResources();</span><br><span class="line">        String[] welcomeFiles = context.findWelcomeFiles();</span><br><span class="line">        List&lt;WrapperMappingInfo&gt; wrappers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Container container : context.findChildren()) &#123;</span><br><span class="line">            prepareWrapperMappingInfo(context, (Wrapper) container, wrappers);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(sm.getString(<span class="string">"mapperListener.registerWrapper"</span>,</span><br><span class="line">                        container.getName(), contextPath, service));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mapper.addContextVersion(host.getName(), host, contextPath,    <span class="comment">//添加信息,在CoyotesAdaptor处理res和rep的过程,识别url和映射就是通过mapper做的</span></span><br><span class="line">                context.getWebappVersion(), context, welcomeFiles, resources,</span><br><span class="line">                wrappers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(sm.getString(<span class="string">"mapperListener.registerContext"</span>,</span><br><span class="line">                    contextPath, service));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="Hostconfig"><a class="header-anchor" href="#Hostconfig">¶</a>Hostconfig</h5>
<figure class="highlight java"><figcaption><span>HostConfig</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该监听器加入时机在xml解析host的时候,该监听器触发的时机是Host被start的时候</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Identify the host we are associated with</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            host = (Host) event.getLifecycle();</span><br><span class="line">            <span class="keyword">if</span> (host <span class="keyword">instanceof</span> StandardHost) &#123;</span><br><span class="line">                setCopyXML(((StandardHost) host).isCopyXML());</span><br><span class="line">                setDeployXML(((StandardHost) host).isDeployXML());</span><br><span class="line">                setUnpackWARs(((StandardHost) host).isUnpackWARs());</span><br><span class="line">                setContextClass(((StandardHost) host).getContextClass());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"hostConfig.cce"</span>, event.getLifecycle()), e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process the event that has occurred 在host不同情况下触发不同函数</span></span><br><span class="line">        <span class="keyword">if</span> (event.getType().equals(Lifecycle.PERIODIC_EVENT)) &#123;  <span class="comment">//这种事件发生暂时没见过</span></span><br><span class="line">            check();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.BEFORE_START_EVENT)) &#123; <span class="comment">//host.state=beforeStart</span></span><br><span class="line">            beforeStart();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.START_EVENT)) &#123;  <span class="comment">//触发的时机就是Host变成startiing状态,也就是其子类容器已经初始化过的情况</span></span><br><span class="line">            start();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.STOP_EVENT)) &#123;</span><br><span class="line">            stop();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeStart</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (host.getCreateDirs()) &#123; <span class="comment">//判断是否创建文件</span></span><br><span class="line">            File[] dirs = <span class="keyword">new</span> File[] &#123;host.getAppBaseFile(),host.getConfigBaseFile()&#125;;  <span class="comment">//实际就是webapp路径和localhost路径</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;dirs.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!dirs[i].mkdirs() &amp;&amp; !dirs[i].isDirectory()) &#123;</span><br><span class="line">                    log.error(sm.getString(<span class="string">"hostConfig.createDirs"</span>,dirs[i]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            log.debug(sm.getString(<span class="string">"hostConfig.start"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectName hostON = host.getObjectName();</span><br><span class="line">            oname = <span class="keyword">new</span> ObjectName</span><br><span class="line">                (hostON.getDomain() + <span class="string">":type=Deployer,host="</span> + host.getName());</span><br><span class="line">            Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent</span><br><span class="line">                (<span class="keyword">this</span>, oname, <span class="keyword">this</span>.getClass().getName());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"hostConfig.jmx.register"</span>, oname), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!host.getAppBaseFile().isDirectory()) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"hostConfig.appBase"</span>, host.getName(),</span><br><span class="line">                    host.getAppBaseFile().getPath()));</span><br><span class="line">            host.setDeployOnStartup(<span class="keyword">false</span>);</span><br><span class="line">            host.setAutoDeploy(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (host.getDeployOnStartup())</span><br><span class="line">            deployApps();  <span class="comment">//部署app</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">           <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deployApps</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        File appBase = host.getAppBaseFile();</span><br><span class="line">        File configBase = host.getConfigBaseFile();<span class="comment">//表示 %CATALINA)HOMT%/conf/[EngineName](catalnia)/[HostName](localhost) 目录,如果没有配置则没用</span></span><br><span class="line">        String[] filteredAppPaths = filterAppPaths(appBase.list());<span class="comment">//表示webapps文件夹下一级目录</span></span><br><span class="line">        <span class="comment">// Deploy XML descriptors from configBase</span></span><br><span class="line">        deployDescriptors(configBase, configBase.list());  <span class="comment">//根据localhost有xml进行一部分配置</span></span><br><span class="line">        <span class="comment">// Deploy WARs</span></span><br><span class="line">        deployWARs(appBase, filteredAppPaths);   <span class="comment">//遍历webapp下文件,进行war的部署</span></span><br><span class="line">        <span class="comment">// Deploy expanded folders</span></span><br><span class="line">        deployDirectories(appBase, filteredAppPaths); <span class="comment">//根据文件夹进行部署</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">//上边三个判断逻辑都是这样的,复合条件则通过container中的startStopExe进行线程处理</span></span><br><span class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deployDirectories</span><span class="params">(File appBase, String[] files)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (files == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        ExecutorService es = host.getStartStopExecutor();</span><br><span class="line">        List&lt;Future&lt;?&gt;&gt; results = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; files.length; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (files[i].equalsIgnoreCase(<span class="string">"META-INF"</span>))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (files[i].equalsIgnoreCase(<span class="string">"WEB-INF"</span>))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            File dir = <span class="keyword">new</span> File(appBase, files[i]);</span><br><span class="line">            <span class="keyword">if</span> (dir.isDirectory()) &#123;</span><br><span class="line">                ContextName cn = <span class="keyword">new</span> ContextName(files[i], <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (isServiced(cn.getName()) || deploymentExists(cn.getName()))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                results.add(es.submit(<span class="keyword">new</span> DeployDirectory(<span class="keyword">this</span>, cn, dir))); <span class="comment">//有三个这样线程类,负责调用HostConfig中的不同部署方法</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Future&lt;?&gt; result : results) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result.get();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(sm.getString(</span><br><span class="line">                        <span class="string">"hostConfig.deployDir.threaded.error"</span>), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理线程</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DeployDirectory</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> HostConfig config;</span><br><span class="line">        <span class="keyword">private</span> ContextName cn;</span><br><span class="line">        <span class="keyword">private</span> File dir;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DeployDirectory</span><span class="params">(HostConfig config, ContextName cn, File dir)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.config = config;</span><br><span class="line">            <span class="keyword">this</span>.cn = cn;</span><br><span class="line">            <span class="keyword">this</span>.dir = dir;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            config.deployDirectory(cn, dir);  <span class="comment">//其他两个实际上也都是调用了hostConfig中其他对应函数</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//其中部署非war的文件夹</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deployDirectory</span><span class="params">(ContextName cn, File dir)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> startTime = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// Deploy the application in this directory</span></span><br><span class="line">        <span class="keyword">if</span>( log.isInfoEnabled() ) &#123;</span><br><span class="line">            startTime = System.currentTimeMillis();</span><br><span class="line">            log.info(sm.getString(<span class="string">"hostConfig.deployDir"</span>,</span><br><span class="line">                    dir.getAbsolutePath()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Context context = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//META-INFO/content.xml文件表示web项目,也就是说可以通过此处的xml文件进行配置content,如果没有该xml tomcat自行配置</span></span><br><span class="line">        <span class="comment">//例如: F:\apache-tomcat-9.0.0.M26-src\webapps\demo\META-INF/context.xml  对demo项目进行配置</span></span><br><span class="line">        File xml = <span class="keyword">new</span> File(dir, Constants.ApplicationContextXml);</span><br><span class="line">        File xmlCopy =</span><br><span class="line">                <span class="keyword">new</span> File(host.getConfigBaseFile(), cn.getBaseName() + <span class="string">".xml"</span>); <span class="comment">//复制一份到catalina/localhost/目录下</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> b=xml.exists();</span><br><span class="line">        DeployedApplication deployedApp;</span><br><span class="line">        <span class="keyword">boolean</span> copyThisXml = isCopyXML();</span><br><span class="line">        <span class="keyword">boolean</span> deployThisXML = isDeployThisXML(dir, cn);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (deployThisXML &amp;&amp; xml.exists()) &#123; <span class="comment">//当content存在解析创建content</span></span><br><span class="line">                <span class="keyword">synchronized</span> (digesterLock) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        context = (Context) digester.parse(xml); <span class="comment">//这个digester较为简单,说明content的结构也是简单的</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        log.error(sm.getString(</span><br><span class="line">                                <span class="string">"hostConfig.deployDescriptor.error"</span>,</span><br><span class="line">                                xml), e);</span><br><span class="line">                        context = <span class="keyword">new</span> FailedContext();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        digester.reset();</span><br><span class="line">                        <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            context = <span class="keyword">new</span> FailedContext();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (copyThisXml == <span class="keyword">false</span> &amp;&amp; context <span class="keyword">instanceof</span> StandardContext) &#123; <span class="comment">//拷贝xml</span></span><br><span class="line">                    <span class="comment">// Host is using default value. Context may override it.</span></span><br><span class="line">                    copyThisXml = ((StandardContext) context).getCopyXML();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (copyThisXml) &#123;</span><br><span class="line">                    Files.copy(xml.toPath(), xmlCopy.toPath());</span><br><span class="line">                    context.setConfigFile(xmlCopy.toURI().toURL());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    context.setConfigFile(xml.toURI().toURL());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!deployThisXML &amp;&amp; xml.exists()) &#123;</span><br><span class="line">                <span class="comment">// Block deployment as META-INF/context.xml may contain security</span></span><br><span class="line">                <span class="comment">// configuration necessary for a secure deployment.</span></span><br><span class="line">                log.error(sm.getString(<span class="string">"hostConfig.deployDescriptor.blocked"</span>,</span><br><span class="line">                        cn.getPath(), xml, xmlCopy));</span><br><span class="line">                context = <span class="keyword">new</span> FailedContext();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                context = (Context) Class.forName(contextClass).newInstance(); <span class="comment">//不存在xml时创建org.apache.catalina.core.StandardContext作为contentxt</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(host.getConfigClass()); <span class="comment">//创建contentConfig监听器</span></span><br><span class="line">            LifecycleListener listener =</span><br><span class="line">                (LifecycleListener) clazz.newInstance();</span><br><span class="line">            context.addLifecycleListener(listener);</span><br><span class="line">            <span class="comment">//此处表示这几个属性,即使在content.xml 配置了,此处还是会被改写成正确的,那么也就是说即使在content写了path doc都是没有用的</span></span><br><span class="line">            context.setName(cn.getName());</span><br><span class="line">            context.setWebappVersion(cn.getVersion());</span><br><span class="line"><span class="comment">//            if(!cn.getName().equalsIgnoreCase("/demo"))&#123;  //做个实验,如果此处更改,就能按照content.xml进行配置path 和docBase</span></span><br><span class="line">                context.setPath(cn.getPath());</span><br><span class="line">                context.setDocBase(cn.getBaseName());</span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"></span><br><span class="line">            host.addChild(context);  <span class="comment">//host持有对应的content,此处还启动了content.start,这部分应该很重要</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            log.error(sm.getString(<span class="string">"hostConfig.deployDir.error"</span>,</span><br><span class="line">                    dir.getAbsolutePath()), t);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            deployedApp = <span class="keyword">new</span> DeployedApplication(cn.getName(),</span><br><span class="line">                    xml.exists() &amp;&amp; deployThisXML &amp;&amp; copyThisXml); <span class="comment">//创建DeployedApplication 表示部署应用</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Fake re-deploy resource to detect if a WAR is added at a later</span></span><br><span class="line">            <span class="comment">// point</span></span><br><span class="line">            deployedApp.redeployResources.put(dir.getAbsolutePath() + <span class="string">".war"</span>,</span><br><span class="line">                    Long.valueOf(<span class="number">0</span>));</span><br><span class="line">            deployedApp.redeployResources.put(dir.getAbsolutePath(),</span><br><span class="line">                    Long.valueOf(dir.lastModified()));</span><br><span class="line">            <span class="keyword">if</span> (deployThisXML &amp;&amp; xml.exists()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (copyThisXml) &#123;</span><br><span class="line">                    deployedApp.redeployResources.put(</span><br><span class="line">                            xmlCopy.getAbsolutePath(),</span><br><span class="line">                            Long.valueOf(xmlCopy.lastModified()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    deployedApp.redeployResources.put(</span><br><span class="line">                            xml.getAbsolutePath(),</span><br><span class="line">                            Long.valueOf(xml.lastModified()));</span><br><span class="line">                    <span class="comment">// Fake re-deploy resource to detect if a context.xml file is</span></span><br><span class="line">                    <span class="comment">// added at a later point</span></span><br><span class="line">                    deployedApp.redeployResources.put(</span><br><span class="line">                            xmlCopy.getAbsolutePath(),</span><br><span class="line">                            Long.valueOf(<span class="number">0</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Fake re-deploy resource to detect if a context.xml file is</span></span><br><span class="line">                <span class="comment">// added at a later point</span></span><br><span class="line">                deployedApp.redeployResources.put(</span><br><span class="line">                        xmlCopy.getAbsolutePath(),</span><br><span class="line">                        Long.valueOf(<span class="number">0</span>));</span><br><span class="line">                <span class="keyword">if</span> (!xml.exists()) &#123;</span><br><span class="line">                    deployedApp.redeployResources.put(</span><br><span class="line">                            xml.getAbsolutePath(),</span><br><span class="line">                            Long.valueOf(<span class="number">0</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            addWatchedResources(deployedApp, dir.getAbsolutePath(), context);  <span class="comment">//监视这部分,当该部分改变时,重新加载content,此处源码我没有看</span></span><br><span class="line">            <span class="comment">// Add the global redeploy resources (which are never deleted) at</span></span><br><span class="line">            <span class="comment">// the end so they don't interfere with the deletion process</span></span><br><span class="line">            addGlobalRedeployResources(deployedApp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        deployed.put(cn.getName(), deployedApp);  <span class="comment">//将deployedApp加入到hostConfig的一个hashMap中</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( log.isInfoEnabled() ) &#123;</span><br><span class="line">            log.info(sm.getString(<span class="string">"hostConfig.deployDir.finished"</span>,</span><br><span class="line">                    dir.getAbsolutePath(), Long.valueOf(System.currentTimeMillis() - startTime)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//关于HostConfig内部的解析器,仅仅创建content,以及设置器属性,并不包含子属性,对比servelt.xml中content的解析</span></span><br><span class="line">	 <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> Digester <span class="title">createDigester</span><span class="params">(String contextClassName)</span> </span>&#123;</span><br><span class="line">        Digester digester = <span class="keyword">new</span> Digester();</span><br><span class="line">        digester.setValidating(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// Add object creation rule</span></span><br><span class="line">        digester.addObjectCreate(<span class="string">"Context"</span>, contextClassName, <span class="string">"className"</span>);</span><br><span class="line">        <span class="comment">// Set the properties on that object (it doesn't matter if extra</span></span><br><span class="line">        <span class="comment">// properties are set)</span></span><br><span class="line">        digester.addSetProperties(<span class="string">"Context"</span>);</span><br><span class="line">        <span class="keyword">return</span> digester;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h3 id="相关机制"><a class="header-anchor" href="#相关机制">¶</a>相关机制</h3>
<h4 id="life"><a class="header-anchor" href="#life">¶</a>life</h4>
<p>此机制实际上是通过观察者模式实现,将属于lifecycle接口的子类分成不通的<code>生命周期</code>,来处理不同的监听器.<br>
1.LifeBase子类属于事件源,state表示当前生命状态<br>
2.lifeListen持有fire函数,根据不同event判断是否调用对应的处理函数<br>
3.实际上tomcat中的事件类型就是通过字符串分别不过通过EventObject做了层封装,LifeState则是枚举类型</p>
<figure class="highlight java"><figcaption><span>LifecycleEvent</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleEvent</span> <span class="keyword">extends</span> <span class="title">EventObject</span> </span>&#123;</span><br><span class="line">  <span class="comment">//典型的java观察者模式中的EventObject</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifecycleEvent</span><span class="params">(Lifecycle lifecycle, String type, Object data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(lifecycle);</span><br><span class="line">        <span class="keyword">this</span>.type = type; <span class="comment">//使用type来分别事件类型,这个数量和lifecycle中string数量相同</span></span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Lifecycle) getSource();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>LifecycleState</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> LifecycleState &#123;</span><br><span class="line"><span class="comment">//生命周期状态</span></span><br><span class="line">    NEW(<span class="keyword">false</span>, <span class="keyword">null</span>),</span><br><span class="line">    INITIALIZING(<span class="keyword">false</span>, Lifecycle.BEFORE_INIT_EVENT),</span><br><span class="line">    INITIALIZED(<span class="keyword">false</span>, Lifecycle.AFTER_INIT_EVENT),</span><br><span class="line">    STARTING_PREP(<span class="keyword">false</span>, Lifecycle.BEFORE_START_EVENT),</span><br><span class="line">    STARTING(<span class="keyword">true</span>, Lifecycle.START_EVENT),      <span class="comment">//只有调用start和start结束后组件有效,其他时期组件处于无效状态</span></span><br><span class="line">    STARTED(<span class="keyword">true</span>, Lifecycle.AFTER_START_EVENT),</span><br><span class="line">    STOPPING_PREP(<span class="keyword">true</span>, Lifecycle.BEFORE_STOP_EVENT),</span><br><span class="line">    STOPPING(<span class="keyword">false</span>, Lifecycle.STOP_EVENT),</span><br><span class="line">    STOPPED(<span class="keyword">false</span>, Lifecycle.AFTER_STOP_EVENT),</span><br><span class="line">    DESTROYING(<span class="keyword">false</span>, Lifecycle.BEFORE_DESTROY_EVENT),</span><br><span class="line">    DESTROYED(<span class="keyword">false</span>, Lifecycle.AFTER_DESTROY_EVENT),</span><br><span class="line">    FAILED(<span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> available;  <span class="comment">//此处的状态在enum定义后是无法改变的,也就是说该变量代表了组件当前的状态,表示其是否有效</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String lifecycleEvent;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LifecycleState</span><span class="params">(<span class="keyword">boolean</span> available, String lifecycleEvent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.available = available;</span><br><span class="line">        <span class="keyword">this</span>.lifecycleEvent = lifecycleEvent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * May the public methods other than property getters/setters and lifecycle</span></span><br><span class="line"><span class="comment">     * methods be called for a component in this state? It returns</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;true&lt;/code&gt; for any component in any of the following states:</span></span><br><span class="line"><span class="comment">     * &lt;ul&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #STARTING&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #STARTED&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #STOPPING_PREP&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &lt;code&gt;true&lt;/code&gt; if the component is available for use,</span></span><br><span class="line"><span class="comment">     *         otherwise &lt;code&gt;false&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> available;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLifecycleEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lifecycleEvent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>Lifecycle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The valid state transitions for components that support &#123;@link Lifecycle&#125;</span></span><br><span class="line"><span class="comment">* are:</span></span><br><span class="line"><span class="comment">* &lt;pre&gt;</span></span><br><span class="line"><span class="comment">*            start()</span></span><br><span class="line"><span class="comment">*  -----------------------------</span></span><br><span class="line"><span class="comment">*  |                           |</span></span><br><span class="line"><span class="comment">*  | init()                    |</span></span><br><span class="line"><span class="comment">* NEW -»-- INITIALIZING        |</span></span><br><span class="line"><span class="comment">* | |           |              |     ------------------«-----------------------</span></span><br><span class="line"><span class="comment">* | |           |auto          |     |                                        |</span></span><br><span class="line"><span class="comment">* | |          \|/    start() \|/   \|/     auto          auto         stop() |</span></span><br><span class="line"><span class="comment">* | |      INITIALIZED --»-- STARTING_PREP --»- STARTING --»- STARTED --»---  |</span></span><br><span class="line"><span class="comment">* | |         |                                                            |  |</span></span><br><span class="line"><span class="comment">* | |destroy()|                                                            |  |</span></span><br><span class="line"><span class="comment">* | --»-----«--    ------------------------«--------------------------------  ^</span></span><br><span class="line"><span class="comment">* |     |          |                                                          |</span></span><br><span class="line"><span class="comment">* |     |         \|/          auto                 auto              start() |</span></span><br><span class="line"><span class="comment">* |     |     STOPPING_PREP ----»---- STOPPING ------»----- STOPPED -----»-----</span></span><br><span class="line"><span class="comment">* |    \|/                               ^                     |  ^</span></span><br><span class="line"><span class="comment">* |     |               stop()           |                     |  |</span></span><br><span class="line"><span class="comment">* |     |       --------------------------                     |  |</span></span><br><span class="line"><span class="comment">* |     |       |                                              |  |</span></span><br><span class="line"><span class="comment">* |     |       |    destroy()                       destroy() |  |</span></span><br><span class="line"><span class="comment">* |     |    FAILED ----»------ DESTROYING ---«-----------------  |</span></span><br><span class="line"><span class="comment">* |     |                        ^     |                          |</span></span><br><span class="line"><span class="comment">* |     |     destroy()          |     |auto                      |</span></span><br><span class="line"><span class="comment">* |     --------»-----------------    \|/                         |</span></span><br><span class="line"><span class="comment">* |                                 DESTROYED                     |</span></span><br><span class="line"><span class="comment">* |                                                               |</span></span><br><span class="line"><span class="comment">* |                            stop()                             |</span></span><br><span class="line"><span class="comment">* ----»-----------------------------»------------------------------</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//一下就是event的字符串标识</span></span><br><span class="line">   * The LifecycleEvent type <span class="keyword">for</span> the <span class="string">"component before init"</span> event.</span><br><span class="line">    */</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEFORE_INIT_EVENT = <span class="string">"before_init"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The LifecycleEvent type for the "component after init" event.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AFTER_INIT_EVENT = <span class="string">"after_init"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The LifecycleEvent type for the "component start" event.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String START_EVENT = <span class="string">"start"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The LifecycleEvent type for the "component before start" event.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEFORE_START_EVENT = <span class="string">"before_start"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The LifecycleEvent type for the "component after start" event.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AFTER_START_EVENT = <span class="string">"after_start"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The LifecycleEvent type for the "component stop" event.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String STOP_EVENT = <span class="string">"stop"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The LifecycleEvent type for the "component before stop" event.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEFORE_STOP_EVENT = <span class="string">"before_stop"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The LifecycleEvent type for the "component after stop" event.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AFTER_STOP_EVENT = <span class="string">"after_stop"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The LifecycleEvent type for the "component after destroy" event.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AFTER_DESTROY_EVENT = <span class="string">"after_destroy"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The LifecycleEvent type for the "component before destroy" event.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEFORE_DESTROY_EVENT = <span class="string">"before_destroy"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The LifecycleEvent type for the "periodic" event.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PERIODIC_EVENT = <span class="string">"periodic"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The LifecycleEvent type for the "configure_start" event. Used by those</span></span><br><span class="line"><span class="comment">    * components that use a separate component to perform configuration and</span></span><br><span class="line"><span class="comment">    * need to signal when configuration should be performed - usually after</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> #BEFORE_START_EVENT&#125; and before &#123;<span class="doctag">@link</span> #START_EVENT&#125;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONFIGURE_START_EVENT = <span class="string">"configure_start"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The LifecycleEvent type for the "configure_stop" event. Used by those</span></span><br><span class="line"><span class="comment">    * components that use a separate component to perform configuration and</span></span><br><span class="line"><span class="comment">    * need to signal when de-configuration should be performed - usually after</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> #STOP_EVENT&#125; and before &#123;<span class="doctag">@link</span> #AFTER_STOP_EVENT&#125;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONFIGURE_STOP_EVENT = <span class="string">"configure_stop"</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>关于life组件未必一定要通过.init start()这样的调用顺序</li>
</ul>
<figure class="highlight java"><figcaption><span>lifecyleBae</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (LifecycleState.STARTING_PREP.equals(state) || LifecycleState.STARTING.equals(state) ||</span><br><span class="line">              LifecycleState.STARTED.equals(state)) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              Exception e = <span class="keyword">new</span> LifecycleException();</span><br><span class="line">              log.debug(sm.getString(<span class="string">"lifecycleBase.alreadyStarted"</span>, toString()), e);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">              log.info(sm.getString(<span class="string">"lifecycleBase.alreadyStarted"</span>, toString()));</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (state.equals(LifecycleState.NEW)) &#123;  <span class="comment">//若通过start进入生命周期也会检查,并且可以执行一次init</span></span><br><span class="line">          init();</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state.equals(LifecycleState.FAILED)) &#123;</span><br><span class="line">          stop();</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!state.equals(LifecycleState.INITIALIZED) &amp;&amp;</span><br><span class="line">              !state.equals(LifecycleState.STOPPED)) &#123;</span><br><span class="line">          invalidTransition(Lifecycle.BEFORE_START_EVENT);</span><br><span class="line">      &#125;</span><br><span class="line">  ...省略</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>life和对应监听器</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tomcat 中 lifeCycle的子类属于 生命周期组件,不同时刻表示出不同的状态,由LifecycleState 类来表示</span></span><br><span class="line"><span class="comment">//1.通过 init start stop destory 来改变其状态</span></span><br><span class="line"><span class="comment">//2.由抽象类lifeBase 中setInternalState 来改变当前状态,并且在不同状态对应着不同事件,由LifecycleEvent</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleEvent</span> <span class="keyword">extends</span> <span class="title">EventObject</span> </span>&#123;</span><br><span class="line">   <span class="comment">//type 是lifeCycle中常量的子集,其数量和lifeState对应</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Construct a new LifecycleEvent with the specified parameters.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lifecycle Component on which this event occurred</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type Event type (required)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data Event data (if any)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifecycleEvent</span><span class="params">(Lifecycle lifecycle, String type, Object data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(lifecycle);</span><br><span class="line">        <span class="keyword">this</span>.type = type; <span class="comment">//type表示事件的类型,监听器是根据该类型进行调用逻辑的</span></span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The event data associated with this event.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The event type this instance represents.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the event data of this event.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the Lifecycle on which this event occurred.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Lifecycle) getSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the event type of this event.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Realm-域"><a class="header-anchor" href="#Realm-域">¶</a>Realm 域</h4>
<p>关于realm顾名思义,暂时理解对于不同组件的分类</p>
<img src="/2018/10/06/tomcat/Realm.png" class="" title="大致分类">
<img src="/2018/10/06/tomcat/realm1.png" class="" title="Realm的继承">
<p>如上图<code>CombinedRealm</code>具有list成员可以含有多个realm对象</p>
<figure class="highlight java"><figcaption><span>RealmBase</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该类是Mben成员所以其共有 init过程已知,不存在共有start</span></span><br><span class="line"><span class="comment">//以下是该抽象的逻辑</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.initInternal(); <span class="comment">//jmx</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// We want logger as soon as possible</span></span><br><span class="line">        <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123; <span class="comment">//realm基本都是container所持有的</span></span><br><span class="line">            <span class="keyword">this</span>.containerLog = container.getLogger();<span class="comment">//记录</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        x509UsernameRetriever = createUsernameRetriever(x509UsernameRetrieverClassName); <span class="comment">//不清楚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Prepare for the beginning of active use of the public methods of this</span></span><br><span class="line"><span class="comment">     * component and implement the requirements of</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> org.apache.catalina.util.LifecycleBase#startInternal()&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</span></span><br><span class="line"><span class="comment">     *  that prevents this component from being used</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (credentialHandler == <span class="keyword">null</span>) &#123;  <span class="comment">//结束</span></span><br><span class="line">            credentialHandler = <span class="keyword">new</span> MessageDigestCredentialHandler();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>UserDataRealm</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以此为例,combine的逻辑就是依次处理list中realm的start</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Context context = getServer().getGlobalNamingContext(); <span class="comment">//从Naming中取得database这个Resource</span></span><br><span class="line">            database = (UserDatabase) context.lookup(resourceName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(e);</span><br><span class="line">            containerLog.error(sm.getString(<span class="string">"userDatabaseRealm.lookup"</span>,</span><br><span class="line">                                            resourceName),</span><br><span class="line">                               e);</span><br><span class="line">            database = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (database == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</span><br><span class="line">                (sm.getString(<span class="string">"userDatabaseRealm.noDatabase"</span>, resourceName));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.startInternal(); <span class="comment">//执行父类逻辑</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="pipeline"><a class="header-anchor" href="#pipeline">¶</a>pipeline</h4>
<p>管道模式是tomcat中对于请求逻辑处理的分布化的方式,通过不同容器组件持有不同pipe,逐层传递,每一个pipe调用内部Valve处理一部分数据逻辑</p>
<img src="/2018/10/06/tomcat/StandarPipeline.png" class="" title="继承图">
<figure class="highlight java"><figcaption><span>StandardPipeline</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// coyoteAdapter进行res/rep处理-&gt;Engine.pipe-&gt;Host.pipe-&gt;Context.pipe-&gt;Wrapper.pipe 逐层处理逻辑</span></span><br><span class="line"><span class="comment">// 实际上pipe是拥有Valve的组件,每层容器调用自身pipe中Valve节点,由Valve节点完成真正的复杂逻辑工作</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//pipe是containerBase对象成员</span></span><br><span class="line"><span class="comment">//basic是对应容器构造函数中添加的</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">如:</span></span><br><span class="line"><span class="comment">* public StandardHost() &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        super();</span></span><br><span class="line"><span class="comment">        pipeline.setBasic(new StandardHostValve());</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">/</span></span><br><span class="line"><span class="comment">protected Valve basic = null;</span></span><br><span class="line"><span class="comment">//当调用addValve时加入</span></span><br><span class="line"><span class="comment"> protected Valve first = null;</span></span><br><span class="line"><span class="comment"> //保持的关系是 first-&gt;Valve-&gt;Valve-.....-&gt;basic,也就是说basic在这个node结构的最后</span></span><br><span class="line"><span class="comment">//该函数使用在xml解析的过程中,创建新的Valve,加入到对应container的pipeline中</span></span><br><span class="line"><span class="comment">//pipeline </span></span><br><span class="line"><span class="comment">public void addValve(Valve valve) &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // Validate that we can add this Valve</span></span><br><span class="line"><span class="comment">        if (valve instanceof Contained)</span></span><br><span class="line"><span class="comment">            ((Contained) valve).setContainer(this.container);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // Start the new component if necessary</span></span><br><span class="line"><span class="comment">        if (getState().isAvailable()) &#123;</span></span><br><span class="line"><span class="comment">            if (valve instanceof Lifecycle) &#123;</span></span><br><span class="line"><span class="comment">                try &#123;</span></span><br><span class="line"><span class="comment">                    ((Lifecycle) valve).start();</span></span><br><span class="line"><span class="comment">                &#125; catch (LifecycleException e) &#123;</span></span><br><span class="line"><span class="comment">                    log.error("StandardPipeline.addValve: start: ", e);</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // Add this Valve to the set associated with this Pipeline</span></span><br><span class="line"><span class="comment">        if (first == null) &#123;</span></span><br><span class="line"><span class="comment">            first = valve;</span></span><br><span class="line"><span class="comment">            valve.setNext(basic);</span></span><br><span class="line"><span class="comment">        &#125; else &#123;</span></span><br><span class="line"><span class="comment">        //维持上述的节点关系</span></span><br><span class="line"><span class="comment">            Valve current = first;</span></span><br><span class="line"><span class="comment">            while (current != null) &#123;</span></span><br><span class="line"><span class="comment">                if (current.getNext() == basic) &#123;</span></span><br><span class="line"><span class="comment">                    current.setNext(valve);</span></span><br><span class="line"><span class="comment">                    valve.setNext(basic);</span></span><br><span class="line"><span class="comment">                    break;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">                current = current.getNext();</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        container.fireContainerEvent(Container.ADD_VALVE_EVENT, valve);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">      protected synchronized void startInternal() throws LifecycleException &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // Start the Valves in our pipeline (including the basic), if any</span></span><br><span class="line"><span class="comment">        Valve current = first;</span></span><br><span class="line"><span class="comment">        if (current == null) &#123;</span></span><br><span class="line"><span class="comment">            current = basic;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        //按照节点关系顺序执行对应的start,pipe的启动在对应容器start阶段</span></span><br><span class="line"><span class="comment">        while (current != null) &#123;</span></span><br><span class="line"><span class="comment">            if (current instanceof Lifecycle)</span></span><br><span class="line"><span class="comment">                ((Lifecycle) current).start();</span></span><br><span class="line"><span class="comment">            current = current.getNext();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        setState(LifecycleState.STARTING);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="Valve"><a class="header-anchor" href="#Valve">¶</a>Valve</h4>
<img src="/2018/10/06/tomcat/StandardHostValve.png" class="" title="继承">
<p>A <b>Valve</b> is a request processing component associated with a
 * particular Container.  A series of Valves are generally associated with
 * each other into a Pipeline.  The detailed contract for a Valve is included
 * in the description of the <code>invoke()</code> method below.</p>
如注释所言,valve是容器执行请求的组件,valve与pipeline关联。
<figure class="highlight java"><figcaption><span>Valve</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//上层life各个阶段只改变状态</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.initInternal();</span><br><span class="line">        containerLog = getContainer().getLogger();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Start this component and implement the requirements</span></span><br><span class="line"><span class="comment">     * of &#123;<span class="doctag">@link</span> org.apache.catalina.util.LifecycleBase#startInternal()&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</span></span><br><span class="line"><span class="comment">     *  that prevents this component from being used</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Stop this component and implement the requirements</span></span><br><span class="line"><span class="comment">     * of &#123;<span class="doctag">@link</span> org.apache.catalina.util.LifecycleBase#stopInternal()&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</span></span><br><span class="line"><span class="comment">     *  that prevents this component from being used</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stopInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">        setState(LifecycleState.STOPPING);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="tomcat部署"><a class="header-anchor" href="#tomcat部署">¶</a>tomcat部署</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String Package = <span class="string">"org.apache.catalina.startup"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ApplicationContextXml = <span class="string">"META-INF/context.xml"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ApplicationWebXml = <span class="string">"/WEB-INF/web.xml"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TomcatWebXml = <span class="string">"/WEB-INF/tomcat-web.xml"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DefaultContextXml = <span class="string">"conf/context.xml"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DefaultWebXml = <span class="string">"conf/web.xml"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HostContextXml = <span class="string">"context.xml.default"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HostWebXml = <span class="string">"web.xml.default"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WarTracker = <span class="string">"/META-INF/war-tracker"</span>;</span><br></pre></td></tr></table></figure>
<h4 id="NioEndPoint底层机制"><a class="header-anchor" href="#NioEndPoint底层机制">¶</a>NioEndPoint底层机制</h4>
<h5 id="连接请求到执行器处理"><a class="header-anchor" href="#连接请求到执行器处理">¶</a>连接请求到执行器处理</h5>
<ul>
<li>uml关系图</li>
</ul>
<img src="/2018/10/06/tomcat/NioEndPoint.jpg" class="">
<ul>
<li>acceptor:用来接受新的连接,使用blocking方式接受,将新的连接通过注册到轮询事件队列中</li>
</ul>
<figure class="highlight java"><figcaption><span>acceptor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该线程启动部分在connector.start</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span>&lt;<span class="title">U</span>&gt; <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> errorDelay = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Loop until we receive a shutdown command</span></span><br><span class="line">        <span class="keyword">while</span> (endpoint.isRunning()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Loop if endpoint is paused</span></span><br><span class="line">            <span class="keyword">while</span> (endpoint.isPaused() &amp;&amp; endpoint.isRunning()) &#123;</span><br><span class="line">                state = AcceptorState.PAUSED;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">50</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="comment">// Ignore</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!endpoint.isRunning()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            state = AcceptorState.RUNNING;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//if we have reached max connections, wait</span></span><br><span class="line">                endpoint.countUpOrAwaitConnection();  <span class="comment">//管理连接数量,到达数量此处阻塞,就不会接受新的连接了</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Endpoint might have been paused while waiting for latch</span></span><br><span class="line">                <span class="comment">// If that is the case, don't accept new connections</span></span><br><span class="line">                <span class="keyword">if</span> (endpoint.isPaused()) &#123; <span class="comment">//point暂停时不要接受任何输入</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                U socket = <span class="keyword">null</span>; <span class="comment">//此处看NioEndPoint代码 SocketChannel</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Accept the next incoming connection from the server</span></span><br><span class="line">                    <span class="comment">// socket</span></span><br><span class="line">                    socket = endpoint.serverSocketAccept();  <span class="comment">//执行accept,那么看来对于接受外界socket还是要通过这种方式,并且此处是阻塞的,返回socketChanel</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ioe) &#123;</span><br><span class="line">                    <span class="comment">// We didn't get a socket</span></span><br><span class="line">                    endpoint.countDownConnection();</span><br><span class="line">                    <span class="keyword">if</span> (endpoint.isRunning()) &#123;</span><br><span class="line">                        <span class="comment">// Introduce delay if necessary</span></span><br><span class="line">                        errorDelay = handleExceptionWithDelay(errorDelay);</span><br><span class="line">                        <span class="comment">// re-throw</span></span><br><span class="line">                        <span class="keyword">throw</span> ioe;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Successful accept, reset the error delay</span></span><br><span class="line">                errorDelay = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Configure the socket</span></span><br><span class="line">                <span class="keyword">if</span> (endpoint.isRunning() &amp;&amp; !endpoint.isPaused()) &#123;</span><br><span class="line">                    <span class="comment">// setSocketOptions() will hand the socket off to</span></span><br><span class="line">                    <span class="comment">// an appropriate processor if successful</span></span><br><span class="line">                    <span class="keyword">if</span> (!endpoint.setSocketOptions(socket)) &#123; <span class="comment">//调用对应endpoint,将接受到的socket通过轮询poller加入到注册事件中</span></span><br><span class="line">                        endpoint.closeSocket(socket);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    endpoint.destroySocket(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                String msg = sm.getString(<span class="string">"endpoint.accept.fail"</span>);</span><br><span class="line">                <span class="comment">// APR specific.</span></span><br><span class="line">                <span class="comment">// Could push this down but not sure it is worth the trouble.</span></span><br><span class="line">                <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">                    Error e = (Error) t;</span><br><span class="line">                    <span class="keyword">if</span> (e.getError() == <span class="number">233</span>) &#123;</span><br><span class="line">                        <span class="comment">// Not an error on HP-UX so log as a warning</span></span><br><span class="line">                        <span class="comment">// so it can be filtered out on that platform</span></span><br><span class="line">                        <span class="comment">// See bug 50273</span></span><br><span class="line">                        log.warn(msg, t);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        log.error(msg, t);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        log.error(msg, t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        state = AcceptorState.ENDED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//NioEndPoint的实现</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">setSocketOptions</span><span class="params">(SocketChannel socket)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Process the connection</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//disable blocking, APR style, we are gonna be polling it</span></span><br><span class="line">            socket.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            Socket sock = socket.socket();</span><br><span class="line">            socketProperties.setProperties(sock);</span><br><span class="line"></span><br><span class="line">            NioChannel channel = nioChannels.pop(); <span class="comment">//从nio队列中取出,并进行封装</span></span><br><span class="line">            <span class="keyword">if</span> (channel == <span class="keyword">null</span>) &#123;</span><br><span class="line">                SocketBufferHandler bufhandler = <span class="keyword">new</span> SocketBufferHandler( <span class="comment">//构造buffer</span></span><br><span class="line">                        socketProperties.getAppReadBufSize(),</span><br><span class="line">                        socketProperties.getAppWriteBufSize(),</span><br><span class="line">                        socketProperties.getDirectBuffer());</span><br><span class="line">                <span class="keyword">if</span> (isSSLEnabled()) &#123;  <span class="comment">//分别处理是否是ssl</span></span><br><span class="line">                    channel = <span class="keyword">new</span> SecureNioChannel(socket, bufhandler, selectorPool, <span class="keyword">this</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    channel = <span class="keyword">new</span> NioChannel(socket, bufhandler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                channel.setIOChannel(socket);</span><br><span class="line">                channel.reset();</span><br><span class="line">            &#125;</span><br><span class="line">            getPoller0().register(channel); <span class="comment">//构造注册事件</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.error(<span class="string">""</span>,t);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable tt) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(tt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Tell to close the socket</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>pollerEvent:轮询事件的种类, 1.注册 2.改变ops</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为nioEndPoint内部类,poller事件队列,描述该线程队列如何处理</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PollerEvent</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> NioChannel socket;  <span class="comment">//关联的Channel</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> interestOps;    <span class="comment">//该事件的操作类型</span></span><br><span class="line">        <span class="keyword">private</span> NioSocketWrapper socketWrapper; <span class="comment">//包装</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PollerEvent</span><span class="params">(NioChannel ch, NioSocketWrapper w, <span class="keyword">int</span> intOps)</span> </span>&#123;</span><br><span class="line">            reset(ch, w, intOps);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">(NioChannel ch, NioSocketWrapper w, <span class="keyword">int</span> intOps)</span> </span>&#123;</span><br><span class="line">            socket = ch;</span><br><span class="line">            interestOps = intOps;</span><br><span class="line">            socketWrapper = w;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            reset(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *  key实际上只有这四种关心的操作</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@see</span> SelectionKey#OP_WRITE</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@see</span> SelectionKey#OP_READ</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@see</span> SelectionKey#OP_ACCEPT</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@see</span> SelectionKey#OP_CONNECT</span></span><br><span class="line"><span class="comment">         *   因此pollEvent事件线程执行的逻辑</span></span><br><span class="line"><span class="comment">         *    1.出现新的连接,将该channel注册到selector中</span></span><br><span class="line"><span class="comment">         *    2.由于key被取消,进行连接数的减少</span></span><br><span class="line"><span class="comment">         *    3.对某个channel对应的key,增加其interestOps</span></span><br><span class="line"><span class="comment">         *    4.socketWrapper=null,取消对应的key</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (interestOps == OP_REGISTER) &#123;  <span class="comment">//注册事件</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socket.getIOChannel().register(</span><br><span class="line">                            socket.getPoller().getSelector(), SelectionKey.OP_READ, socketWrapper);</span><br><span class="line">                    <span class="comment">//将该channel以read的方式注册到poller线程中的selector,也就是此key关心的是OP_READ</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">                    log.error(sm.getString(<span class="string">"endpoint.nio.registerFail"</span>), x);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> SelectionKey key = socket.getIOChannel().keyFor(socket.getPoller().getSelector());  <span class="comment">//找到此channel对应的key</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// The key was cancelled (e.g. due to socket closure)</span></span><br><span class="line">                        <span class="comment">// and removed from the selector while it was being</span></span><br><span class="line">                        <span class="comment">// processed. Count down the connections at this point</span></span><br><span class="line">                        <span class="comment">// since it won't have been counted down when the socket</span></span><br><span class="line">                        <span class="comment">// closed. 此处表示该该key被取消,因此要减少一个连接数</span></span><br><span class="line">                        socket.socketWrapper.getEndpoint().countDownConnection(); <span class="comment">//连接数和limitLatch有关,此处调用countDownConnection减少一个</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">final</span> NioSocketWrapper socketWrapper = (NioSocketWrapper) key.attachment();</span><br><span class="line">                        <span class="keyword">if</span> (socketWrapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">//we are registering the key to start with, reset the fairness counter.</span></span><br><span class="line">                            <span class="keyword">int</span> ops = key.interestOps() | interestOps;  <span class="comment">//增加该key关心的操作</span></span><br><span class="line">                            socketWrapper.interestOps(ops);</span><br><span class="line">                            key.interestOps(ops); <span class="comment">//改变key关心的操作类型</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            socket.getPoller().cancelledKey(key); <span class="comment">//取消该key</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (CancelledKeyException ckx) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        socket.getPoller().cancelledKey(key);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ignore) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Poller event: socket ["</span> + socket + <span class="string">"], socketWrapper ["</span> + socketWrapper +</span><br><span class="line">                    <span class="string">"], interestOps ["</span> + interestOps + <span class="string">"]"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>poller:轮询线程,当acceptor注册,对应nio改变ops,都会导致事件的添加,该线程不断处理事件队列中的线程对象,并且进行selecotr的阻塞,判断有无就绪的SocketChnanel</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poller</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Selector selector; <span class="comment">//选择器</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> SynchronizedQueue&lt;PollerEvent&gt; events =</span><br><span class="line">                <span class="keyword">new</span> SynchronizedQueue&lt;&gt;(); <span class="comment">//事件队列</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> close = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">long</span> nextExpiration = <span class="number">0</span>;<span class="comment">//optimize expiration handling</span></span><br><span class="line">        <span class="comment">//具体的逻辑就是当有添加evnent时增加1,若==0,则唤醒</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">private</span> AtomicLong wakeupCounter = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>); <span class="comment">//用来唤醒selector.accpet部分辅助的量</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> keyCount = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addEvent</span><span class="params">(PollerEvent event)</span> </span>&#123;</span><br><span class="line">            events.offer(event);</span><br><span class="line">            <span class="keyword">if</span> ( wakeupCounter.incrementAndGet() == <span class="number">0</span> ) selector.wakeup(); <span class="comment">//此处是唤醒selector,使得run代码向下循环,执行事件线程</span></span><br><span class="line">        &#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">events</span><span class="params">()</span> </span>&#123; <span class="comment">//执行队列中事件,注意这个并发队列不是以前我看的没有内容线程暂停的,是tomcat自己实现的加了</span></span><br><span class="line">            <span class="comment">//synchronized的队列,代码易理解</span></span><br><span class="line">            <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            PollerEvent pe = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">while</span> ( (pe = events.poll()) != <span class="keyword">null</span> ) &#123;</span><br><span class="line">                result = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    pe.run();</span><br><span class="line">                    pe.reset();</span><br><span class="line">                    <span class="keyword">if</span> (running &amp;&amp; !paused) &#123;</span><br><span class="line">                        eventCache.push(pe);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> ( Throwable x ) &#123;</span><br><span class="line">                    log.error(<span class="string">""</span>,x);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Loop until destroy() is called</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">boolean</span> hasEvents = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!close) &#123;</span><br><span class="line">                        hasEvents = events(); <span class="comment">//不停执行事件</span></span><br><span class="line">                        <span class="keyword">if</span> (wakeupCounter.getAndSet(-<span class="number">1</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">//获取当前值,并且置于-1,如果当前值&gt;0,那么说明有好几个事件加入了</span></span><br><span class="line">                            <span class="comment">// ,那么就要及时唤醒,进入下一次循环处理事件</span></span><br><span class="line">                            <span class="comment">//if we are here, means we have other stuff to do</span></span><br><span class="line">                            <span class="comment">//do a non blocking select</span></span><br><span class="line">                            keyCount = selector.selectNow();  <span class="comment">//返回的是就绪key 的数量</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">//当且仅当-1才会进入这里,于此同时如果addEvent操作,就会唤醒,并count+1,且唤醒</span></span><br><span class="line">                            keyCount = selector.select(selectorTimeout);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//因为一次循环就会创建事件队列中所有的线程,因此此处置为0</span></span><br><span class="line">                        wakeupCounter.set(<span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (close) &#123;</span><br><span class="line">                        events();</span><br><span class="line">                        timeout(<span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            selector.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                            log.error(sm.getString(<span class="string">"endpoint.nio.selectorCloseFail"</span>), ioe);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(x);</span><br><span class="line">                    log.error(<span class="string">""</span>,x);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//either we timed out or we woke up, process events first</span></span><br><span class="line">                <span class="comment">//假设超时或者被主动唤醒,说明此处没有获得能使用键,执行事件,并且获取此时系统中有无事件线程</span></span><br><span class="line">                <span class="keyword">if</span> ( keyCount == <span class="number">0</span> ) hasEvents = (hasEvents | events());</span><br><span class="line">                <span class="comment">//当且仅当有readyKey才进行遍历</span></span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator =</span><br><span class="line">                    keyCount &gt; <span class="number">0</span> ? selector.selectedKeys().iterator() : <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">// Walk through the collection of ready keys and dispatch</span></span><br><span class="line">                <span class="comment">// any active event.</span></span><br><span class="line">                <span class="keyword">while</span> (iterator != <span class="keyword">null</span> &amp;&amp; iterator.hasNext()) &#123;  <span class="comment">//遍历</span></span><br><span class="line">                    SelectionKey sk = iterator.next();</span><br><span class="line">                    NioSocketWrapper attachment = (NioSocketWrapper)sk.attachment();</span><br><span class="line">                    <span class="comment">// Attachment may be null if another thread has called</span></span><br><span class="line">                    <span class="comment">// cancelledKey()</span></span><br><span class="line">                    <span class="keyword">if</span> (attachment == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        iterator.remove();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        iterator.remove();</span><br><span class="line">                        processKey(sk, attachment);  <span class="comment">//执行</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="comment">//while</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//process timeouts</span></span><br><span class="line">                timeout(keyCount,hasEvents);</span><br><span class="line">            &#125;<span class="comment">//while</span></span><br><span class="line"></span><br><span class="line">            getStopLatch().countDown(); <span class="comment">//减少latch,对应的await在stop中,实际上说明await调用只要在对应线程的创建线程中就可以,await在stop中</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processKey</span><span class="params">(SelectionKey sk, NioSocketWrapper attachment)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ( close ) &#123;</span><br><span class="line">                    cancelledKey(sk);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( sk.isValid() &amp;&amp; attachment != <span class="keyword">null</span> ) &#123;  <span class="comment">//真正获得连接后如何执行</span></span><br><span class="line">                    <span class="keyword">if</span> (sk.isReadable() || sk.isWritable() ) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( attachment.getSendfileData() != <span class="keyword">null</span> ) &#123; <span class="comment">//如果有fileData,执行发送文件</span></span><br><span class="line">                            processSendfile(sk,attachment, <span class="keyword">false</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            unreg(sk, attachment, sk.readyOps());  <span class="comment">//取  ~sk.readyOps &amp;sk.interestOps  改为interestOps</span></span><br><span class="line">                            <span class="keyword">boolean</span> closeSocket = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="comment">// Read goes before write</span></span><br><span class="line">                            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                             * <span class="doctag">@see</span> AbstractEndpoint#processSocket(SocketWrapperBase, SocketEvent, boolean) 处理</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">                            <span class="keyword">if</span> (sk.isReadable()) &#123;  </span><br><span class="line">                                <span class="keyword">if</span> (!processSocket(attachment, SocketEvent.OPEN_READ, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                                    closeSocket = <span class="keyword">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (!closeSocket &amp;&amp; sk.isWritable()) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (!processSocket(attachment, SocketEvent.OPEN_WRITE, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                                    closeSocket = <span class="keyword">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (closeSocket) &#123;</span><br><span class="line">                                cancelledKey(sk);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//invalid key</span></span><br><span class="line">                    cancelledKey(sk);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> ( CancelledKeyException ckx ) &#123;</span><br><span class="line">                cancelledKey(sk);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                log.error(<span class="string">""</span>,t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//AbstractEndpoint中</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processSocket</span><span class="params">(SocketWrapperBase&lt;S&gt; socketWrapper,</span></span></span><br><span class="line"><span class="function"><span class="params">            SocketEvent event, <span class="keyword">boolean</span> dispatch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (socketWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            SocketProcessorBase&lt;S&gt; sc = processorCache.pop();  <span class="comment">//SocketProcessorBase 执行器也用了队列缓冲</span></span><br><span class="line">            <span class="keyword">if</span> (sc == <span class="keyword">null</span>) &#123;</span><br><span class="line">                sc = createSocketProcessor(socketWrapper, event);<span class="comment">//子类创建,这个sc就是下文中的SocketProcessor</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sc.reset(socketWrapper, event);</span><br><span class="line">            &#125;</span><br><span class="line">            Executor executor = getExecutor();</span><br><span class="line">            <span class="keyword">if</span> (dispatch &amp;&amp; executor != <span class="keyword">null</span>) &#123; <span class="comment">//该执行器线程执行</span></span><br><span class="line">                executor.execute(sc);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sc.run();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RejectedExecutionException ree) &#123;</span><br><span class="line">            getLog().warn(sm.getString(<span class="string">"endpoint.executor.fail"</span>, socketWrapper) , ree);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            <span class="comment">// This means we got an OOM or similar creating a thread, or that</span></span><br><span class="line">            <span class="comment">// the pool and its queue are full</span></span><br><span class="line">            getLog().error(sm.getString(<span class="string">"endpoint.process.fail"</span>), t);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>SocketProcessor: NioEndpoint内部类,实际是一个线程类,用来调用对应的processor来进行处理</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketProcessor</span> <span class="keyword">extends</span> <span class="title">SocketProcessorBase</span>&lt;<span class="title">NioChannel</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SocketProcessor</span><span class="params">(SocketWrapperBase&lt;NioChannel&gt; socketWrapper, SocketEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(socketWrapper, event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRun</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        NioChannel socket = socketWrapper.getSocket();</span><br><span class="line">        SelectionKey key = socket.getIOChannel().keyFor(socket.getPoller().getSelector());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> handshake = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (socket.isHandshakeComplete()) &#123;<span class="comment">// 这几个判断都是针对于ssl进行的</span></span><br><span class="line">                        <span class="comment">// No TLS handshaking required. Let the handler</span></span><br><span class="line">                        <span class="comment">// process this socket / event combination.</span></span><br><span class="line">                        handshake = <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event == SocketEvent.STOP || event == SocketEvent.DISCONNECT ||</span><br><span class="line">                            event == SocketEvent.ERROR) &#123;</span><br><span class="line">                        <span class="comment">// Unable to complete the TLS handshake. Treat it as</span></span><br><span class="line">                        <span class="comment">// if the handshake failed.</span></span><br><span class="line">                        handshake = -<span class="number">1</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        handshake = socket.handshake(key.isReadable(), key.isWritable());</span><br><span class="line">                        <span class="comment">// The handshake process reads/writes from/to the</span></span><br><span class="line">                        <span class="comment">// socket. status may therefore be OPEN_WRITE once</span></span><br><span class="line">                        <span class="comment">// the handshake completes. However, the handshake</span></span><br><span class="line">                        <span class="comment">// happens when the socket is opened so the status</span></span><br><span class="line">                        <span class="comment">// must always be OPEN_READ after it completes. It</span></span><br><span class="line">                        <span class="comment">// is OK to always set this as it is only used if</span></span><br><span class="line">                        <span class="comment">// the handshake completes.</span></span><br><span class="line">                        event = SocketEvent.OPEN_READ;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">                handshake = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) log.debug(<span class="string">"Error during SSL handshake"</span>,x);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (CancelledKeyException ckx) &#123;</span><br><span class="line">                handshake = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (handshake == <span class="number">0</span>) &#123;</span><br><span class="line">                SocketState state = SocketState.OPEN;</span><br><span class="line">                <span class="comment">// Process the request from this socket</span></span><br><span class="line">                <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    state = getHandler().process(socketWrapper, SocketEvent.OPEN_READ);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    state = getHandler().process(socketWrapper, event);  <span class="comment">//执行对应的event逻辑</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (state == SocketState.CLOSED) &#123;</span><br><span class="line">                    close(socket, key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (handshake == -<span class="number">1</span> ) &#123;</span><br><span class="line">                close(socket, key);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (handshake == SelectionKey.OP_READ)&#123;</span><br><span class="line">                socketWrapper.registerReadInterest();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (handshake == SelectionKey.OP_WRITE)&#123;</span><br><span class="line">                socketWrapper.registerWriteInterest();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CancelledKeyException cx) &#123;</span><br><span class="line">            socket.getPoller().cancelledKey(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (VirtualMachineError vme) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(vme);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            log.error(<span class="string">""</span>, t);</span><br><span class="line">            socket.getPoller().cancelledKey(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            socketWrapper = <span class="keyword">null</span>;</span><br><span class="line">            event = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//return to cache</span></span><br><span class="line">            <span class="keyword">if</span> (running &amp;&amp; !paused) &#123;</span><br><span class="line">                processorCache.push(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>ConnectionHandler: 将请求连接就绪的socket进行处理,创建执行器,这部分已经进入了子线程</li>
</ul>
<figure class="highlight java"><figcaption><span>ConnectionHandler</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SocketState <span class="title">process</span><span class="params">(SocketWrapperBase&lt;S&gt; wrapper, SocketEvent status)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">               getLog().debug(sm.getString(<span class="string">"abstractConnectionHandler.process"</span>,</span><br><span class="line">                       wrapper.getSocket(), status));</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (wrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">// Nothing to do. Socket has been closed.</span></span><br><span class="line">               <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           S socket = wrapper.getSocket();</span><br><span class="line"></span><br><span class="line">           Processor processor = connections.get(socket);</span><br><span class="line">           <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">               getLog().debug(sm.getString(<span class="string">"abstractConnectionHandler.connectionsGet"</span>,</span><br><span class="line">                       processor, socket));</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (processor != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">// Make sure an async timeout doesn't fire</span></span><br><span class="line">               getProtocol().removeWaitingProcessor(processor);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == SocketEvent.DISCONNECT || status == SocketEvent.ERROR) &#123;</span><br><span class="line">               <span class="comment">// Nothing to do. Endpoint requested a close and there is no</span></span><br><span class="line">               <span class="comment">// longer a processor associated with this socket.</span></span><br><span class="line">               <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           ContainerThreadMarker.set();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   String negotiatedProtocol = wrapper.getNegotiatedProtocol();</span><br><span class="line">                   <span class="keyword">if</span> (negotiatedProtocol != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       UpgradeProtocol upgradeProtocol =</span><br><span class="line">                               getProtocol().getNegotiatedProtocol(negotiatedProtocol);</span><br><span class="line">                       <span class="keyword">if</span> (upgradeProtocol != <span class="keyword">null</span>) &#123;</span><br><span class="line">                           processor = upgradeProtocol.getProcessor(</span><br><span class="line">                                   wrapper, getProtocol().getAdapter());</span><br><span class="line">                       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (negotiatedProtocol.equals(<span class="string">"http/1.1"</span>)) &#123;</span><br><span class="line">                           <span class="comment">// Explicitly negotiated the default protocol.</span></span><br><span class="line">                           <span class="comment">// Obtain a processor below.</span></span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           <span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">                           <span class="comment">// OpenSSL 1.0.2's ALPN callback doesn't support</span></span><br><span class="line">                           <span class="comment">// failing the handshake with an error if no</span></span><br><span class="line">                           <span class="comment">// protocol can be negotiated. Therefore, we need to</span></span><br><span class="line">                           <span class="comment">// fail the connection here. Once this is fixed,</span></span><br><span class="line">                           <span class="comment">// replace the code below with the commented out</span></span><br><span class="line">                           <span class="comment">// block.</span></span><br><span class="line">                           <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                               getLog().debug(sm.getString(</span><br><span class="line">                                   <span class="string">"abstractConnectionHandler.negotiatedProcessor.fail"</span>,</span><br><span class="line">                                   negotiatedProtocol));</span><br><span class="line">                           &#125;</span><br><span class="line">                           <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">                           <span class="comment">/*</span></span><br><span class="line"><span class="comment">                            * To replace the code above once OpenSSL 1.1.0 is</span></span><br><span class="line"><span class="comment">                            * used.</span></span><br><span class="line"><span class="comment">                           // Failed to create processor. This is a bug.</span></span><br><span class="line"><span class="comment">                           throw new IllegalStateException(sm.getString(</span></span><br><span class="line"><span class="comment">                                   "abstractConnectionHandler.negotiatedProcessor.fail",</span></span><br><span class="line"><span class="comment">                                   negotiatedProtocol));</span></span><br><span class="line"><span class="comment">                           */</span></span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">/**</span></span><br><span class="line"><span class="comment">                *  这几种执行器</span></span><br><span class="line"><span class="comment">                * <span class="doctag">@see</span> org.apache.coyote.http11.Http11Processor</span></span><br><span class="line"><span class="comment">                * <span class="doctag">@see</span> org.apache.coyote.ajp.AjpProcessor</span></span><br><span class="line"><span class="comment">                * <span class="doctag">@see</span> org.apache.coyote.http2.StreamProcessor</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">               <span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   processor = recycledProcessors.pop();</span><br><span class="line">                   <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                       getLog().debug(sm.getString(<span class="string">"abstractConnectionHandler.processorPop"</span>,</span><br><span class="line">                               processor));</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   processor = getProtocol().createProcessor();  <span class="comment">////实际上这个processor 由对应的protocalHandler创建</span></span><br><span class="line">                   register(processor); <span class="comment">//加入到jmx</span></span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               processor.setSslSupport(</span><br><span class="line">                       wrapper.getSslSupport(getProtocol().getClientCertProvider()));  <span class="comment">//还是对ssl有用,也就是 SecureNioChannel这样的信道</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">// Associate the processor with the connection</span></span><br><span class="line">               connections.put(socket, processor);  <span class="comment">//缓冲</span></span><br><span class="line"></span><br><span class="line">               SocketState state = SocketState.CLOSED;</span><br><span class="line">               <span class="keyword">do</span> &#123;</span><br><span class="line">                   state = processor.process(wrapper, status);  <span class="comment">//真正tomcat对于连接进行处理的入口点</span></span><br><span class="line">                   <span class="comment">//之后的代码都是根据socketState进行的处理</span></span><br><span class="line"></span><br><span class="line">                   <span class="keyword">if</span> (state == SocketState.UPGRADING) &#123;</span><br><span class="line">                       <span class="comment">// Get the HTTP upgrade handler</span></span><br><span class="line">                       UpgradeToken upgradeToken = processor.getUpgradeToken();</span><br><span class="line">                       <span class="comment">// Retrieve leftover input</span></span><br><span class="line">                       ByteBuffer leftOverInput = processor.getLeftoverInput();</span><br><span class="line">                       <span class="keyword">if</span> (upgradeToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">                           <span class="comment">// Assume direct HTTP/2 connection</span></span><br><span class="line">                           UpgradeProtocol upgradeProtocol = getProtocol().getUpgradeProtocol(<span class="string">"h2c"</span>);</span><br><span class="line">                           <span class="keyword">if</span> (upgradeProtocol != <span class="keyword">null</span>) &#123;</span><br><span class="line">                               processor = upgradeProtocol.getProcessor(</span><br><span class="line">                                       wrapper, getProtocol().getAdapter());</span><br><span class="line">                               wrapper.unRead(leftOverInput);</span><br><span class="line">                               <span class="comment">// Associate with the processor with the connection</span></span><br><span class="line">                               connections.put(socket, processor);</span><br><span class="line">                           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                               <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                                   getLog().debug(sm.getString(</span><br><span class="line">                                       <span class="string">"abstractConnectionHandler.negotiatedProcessor.fail"</span>,</span><br><span class="line">                                       <span class="string">"h2c"</span>));</span><br><span class="line">                               &#125;</span><br><span class="line">                               <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           HttpUpgradeHandler httpUpgradeHandler = upgradeToken.getHttpUpgradeHandler();</span><br><span class="line">                           <span class="comment">// Release the Http11 processor to be re-used</span></span><br><span class="line">                           release(processor);</span><br><span class="line">                           <span class="comment">// Create the upgrade processor</span></span><br><span class="line">                           processor = getProtocol().createUpgradeProcessor(wrapper, upgradeToken);</span><br><span class="line">                           <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                               getLog().debug(sm.getString(<span class="string">"abstractConnectionHandler.upgradeCreate"</span>,</span><br><span class="line">                                       processor, wrapper));</span><br><span class="line">                           &#125;</span><br><span class="line">                           wrapper.unRead(leftOverInput);</span><br><span class="line">                           <span class="comment">// Mark the connection as upgraded</span></span><br><span class="line">                           wrapper.setUpgraded(<span class="keyword">true</span>);</span><br><span class="line">                           <span class="comment">// Associate with the processor with the connection</span></span><br><span class="line">                           connections.put(socket, processor);</span><br><span class="line">                           <span class="comment">// Initialise the upgrade handler (which may trigger</span></span><br><span class="line">                           <span class="comment">// some IO using the new protocol which is why the lines</span></span><br><span class="line">                           <span class="comment">// above are necessary)</span></span><br><span class="line">                           <span class="comment">// This cast should be safe. If it fails the error</span></span><br><span class="line">                           <span class="comment">// handling for the surrounding try/catch will deal with</span></span><br><span class="line">                           <span class="comment">// it.</span></span><br><span class="line">                           <span class="keyword">if</span> (upgradeToken.getInstanceManager() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                               httpUpgradeHandler.init((WebConnection) processor);</span><br><span class="line">                           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                               ClassLoader oldCL = upgradeToken.getContextBind().bind(<span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">                               <span class="keyword">try</span> &#123;</span><br><span class="line">                                   httpUpgradeHandler.init((WebConnection) processor);</span><br><span class="line">                               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                   upgradeToken.getContextBind().unbind(<span class="keyword">false</span>, oldCL);</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">while</span> ( state == SocketState.UPGRADING);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (state == SocketState.LONG) &#123;</span><br><span class="line">                   <span class="comment">// In the middle of processing a request/response. Keep the</span></span><br><span class="line">                   <span class="comment">// socket associated with the processor. Exact requirements</span></span><br><span class="line">                   <span class="comment">// depend on type of long poll</span></span><br><span class="line">                   longPoll(wrapper, processor);</span><br><span class="line">                   <span class="keyword">if</span> (processor.isAsync()) &#123;</span><br><span class="line">                       getProtocol().addWaitingProcessor(processor);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.OPEN) &#123;</span><br><span class="line">                   <span class="comment">// In keep-alive but between requests. OK to recycle</span></span><br><span class="line">                   <span class="comment">// processor. Continue to poll for the next request.</span></span><br><span class="line">                   connections.remove(socket);</span><br><span class="line">                   release(processor);</span><br><span class="line">                   wrapper.registerReadInterest();</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.SENDFILE) &#123;</span><br><span class="line">                   <span class="comment">// Sendfile in progress. If it fails, the socket will be</span></span><br><span class="line">                   <span class="comment">// closed. If it works, the socket either be added to the</span></span><br><span class="line">                   <span class="comment">// poller (or equivalent) to await more data or processed</span></span><br><span class="line">                   <span class="comment">// if there are any pipe-lined requests remaining.</span></span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.UPGRADED) &#123;</span><br><span class="line">                   <span class="comment">// Don't add sockets back to the poller if this was a</span></span><br><span class="line">                   <span class="comment">// non-blocking write otherwise the poller may trigger</span></span><br><span class="line">                   <span class="comment">// multiple read events which may lead to thread starvation</span></span><br><span class="line">                   <span class="comment">// in the connector. The write() method will add this socket</span></span><br><span class="line">                   <span class="comment">// to the poller if necessary.</span></span><br><span class="line">                   <span class="keyword">if</span> (status != SocketEvent.OPEN_WRITE) &#123;</span><br><span class="line">                       longPoll(wrapper, processor);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.SUSPENDED) &#123;</span><br><span class="line">                   <span class="comment">// Don't add sockets back to the poller.</span></span><br><span class="line">                   <span class="comment">// The resumeProcessing() method will add this socket</span></span><br><span class="line">                   <span class="comment">// to the poller.</span></span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// Connection closed. OK to recycle the processor. Upgrade</span></span><br><span class="line">                   <span class="comment">// processors are not recycled.</span></span><br><span class="line">                   connections.remove(socket);</span><br><span class="line">                   <span class="keyword">if</span> (processor.isUpgrade()) &#123;</span><br><span class="line">                       UpgradeToken upgradeToken = processor.getUpgradeToken();</span><br><span class="line">                       HttpUpgradeHandler httpUpgradeHandler = upgradeToken.getHttpUpgradeHandler();</span><br><span class="line">                       InstanceManager instanceManager = upgradeToken.getInstanceManager();</span><br><span class="line">                       <span class="keyword">if</span> (instanceManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">                           httpUpgradeHandler.destroy();</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           ClassLoader oldCL = upgradeToken.getContextBind().bind(<span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">                           <span class="keyword">try</span> &#123;</span><br><span class="line">                               httpUpgradeHandler.destroy();</span><br><span class="line">                           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                               <span class="keyword">try</span> &#123;</span><br><span class="line">                                   instanceManager.destroyInstance(httpUpgradeHandler);</span><br><span class="line">                               &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                                   ExceptionUtils.handleThrowable(e);</span><br><span class="line">                                   getLog().error(sm.getString(<span class="string">"abstractConnectionHandler.error"</span>), e);</span><br><span class="line">                               &#125;</span><br><span class="line">                               upgradeToken.getContextBind().unbind(<span class="keyword">false</span>, oldCL);</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       release(processor);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> state;</span><br><span class="line">           &#125; <span class="keyword">catch</span>(java.net.SocketException e) &#123;</span><br><span class="line">               <span class="comment">// SocketExceptions are normal</span></span><br><span class="line">               getLog().debug(sm.getString(</span><br><span class="line">                       <span class="string">"abstractConnectionHandler.socketexception.debug"</span>), e);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">               <span class="comment">// IOExceptions are normal</span></span><br><span class="line">               getLog().debug(sm.getString(</span><br><span class="line">                       <span class="string">"abstractConnectionHandler.ioexception.debug"</span>), e);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (ProtocolException e) &#123;</span><br><span class="line">               <span class="comment">// Protocol exceptions normally mean the client sent invalid or</span></span><br><span class="line">               <span class="comment">// incomplete data.</span></span><br><span class="line">               getLog().debug(sm.getString(</span><br><span class="line">                       <span class="string">"abstractConnectionHandler.protocolexception.debug"</span>), e);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// Future developers: if you discover any other</span></span><br><span class="line">           <span class="comment">// rare-but-nonfatal exceptions, catch them here, and log as</span></span><br><span class="line">           <span class="comment">// above.</span></span><br><span class="line">           <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">               ExceptionUtils.handleThrowable(e);</span><br><span class="line">               <span class="comment">// any other exception or error is odd. Here we log it</span></span><br><span class="line">               <span class="comment">// with "ERROR" level, so it will show up even on</span></span><br><span class="line">               <span class="comment">// less-than-verbose logs.</span></span><br><span class="line">               getLog().error(sm.getString(<span class="string">"abstractConnectionHandler.error"</span>), e);</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               ContainerThreadMarker.clear();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Make sure socket/processor is removed from the list of current</span></span><br><span class="line">           <span class="comment">// connections</span></span><br><span class="line">           connections.remove(socket);</span><br><span class="line">           release(processor);</span><br><span class="line">           <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="nio读写逻辑相关"><a class="header-anchor" href="#nio读写逻辑相关">¶</a>nio读写逻辑相关</h5>
<ul>
<li>uml</li>
</ul>
<img src="/2018/10/06/tomcat/NioChannel.jpg" class="">
<ul>
<li>NioSocketWrapper:封装了nioChannel,实现了如何进行读写操作,要么通过nioApi直接读写,要么通过SelectorPool</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span>  <span class="title">NioSocketWrapper</span> <span class="keyword">extends</span> <span class="title">SocketWrapperBase</span>&lt;<span class="title">NioChannel</span>&gt; </span>&#123;</span><br><span class="line">       <span class="comment">//其父类封装了NioChannel/SocketBufferHandler相关的包装操作,实际进行读写的逻辑交给子类是实现,也就是NioSocketWrapper这种子类实现,实现有三种</span></span><br><span class="line">       <span class="comment">//也就是说父类提供公共接口由外部调用,由子类实现读写逻辑</span></span><br><span class="line">       <span class="comment">//fillReadBuffer和doWrite 实现从读取数据到buffer和将构造好的buffer写出去</span></span><br><span class="line">       <span class="comment">//父类提供写接口 为write函数,有许多重写</span></span><br><span class="line">       <span class="comment">//读接口因该是read</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">//分别对应nio nio2 apr,这样的逻辑和c++ io相似,和java io包装的方式有些相反</span></span><br><span class="line">       <span class="comment">//这个类有许多跟CountDownLatch相关的</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> NioSelectorPool pool;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">private</span> Poller poller = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">int</span> interestOps = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">private</span> CountDownLatch readLatch = <span class="keyword">null</span>; <span class="comment">//读写latch,用于NioBlockSelector</span></span><br><span class="line">       <span class="keyword">private</span> CountDownLatch writeLatch = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">volatile</span> SendfileData sendfileData = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastRead = System.currentTimeMillis();</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastWrite = lastRead;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">NioSocketWrapper</span><span class="params">(NioChannel channel, NioEndpoint endpoint)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">super</span>(channel, endpoint);</span><br><span class="line">           pool = endpoint.getSelectorPool();</span><br><span class="line">           socketBufferHandler = channel.getBufHandler();</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//写逻辑</span></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(<span class="keyword">boolean</span> block, ByteBuffer from)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">           <span class="keyword">long</span> writeTimeout = getWriteTimeout();  <span class="comment">//超时数</span></span><br><span class="line">           Selector selector = <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               selector = pool.get();  <span class="comment">//获取selectorPoll的一个</span></span><br><span class="line">           &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">               <span class="comment">// Ignore</span></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               pool.write(from, getSocket(), selector, writeTimeout, block);</span><br><span class="line">               <span class="keyword">if</span> (block) &#123;</span><br><span class="line">                   <span class="comment">// Make sure we are flushed</span></span><br><span class="line">                   <span class="keyword">do</span> &#123;</span><br><span class="line">                       <span class="keyword">if</span> (getSocket().flush(<span class="keyword">true</span>, selector, writeTimeout)) &#123;  <span class="comment">//非ssl此处没有用</span></span><br><span class="line">                           <span class="keyword">break</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">while</span> (<span class="keyword">true</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               updateLastWrite();</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (selector != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   pool.put(selector); <span class="comment">//并没有销毁selector</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// If there is data left in the buffer the socket will be registered for</span></span><br><span class="line">           <span class="comment">// write further up the stack. This is to ensure the socket is only</span></span><br><span class="line">           <span class="comment">// registered for write once as both container and user code can trigger</span></span><br><span class="line">           <span class="comment">// write registration.</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//读</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">boolean</span> block, <span class="keyword">byte</span>[] b, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">           <span class="keyword">int</span> nRead = populateReadBuffer(b, off, len); <span class="comment">//向buffer中取数据</span></span><br><span class="line">           <span class="keyword">if</span> (nRead &gt; <span class="number">0</span>) &#123; <span class="comment">////这个逻辑是内部的buffer已经有数据了,此时将buffer数据</span></span><br><span class="line">           <span class="comment">//放置到b中就可以了</span></span><br><span class="line">               <span class="keyword">return</span> nRead;</span><br><span class="line">               <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * Since more bytes may have arrived since the buffer was last</span></span><br><span class="line"><span class="comment">                * filled, it is an option at this point to perform a</span></span><br><span class="line"><span class="comment">                * non-blocking read. However correctly handling the case if</span></span><br><span class="line"><span class="comment">                * that read returns end of stream adds complexity. Therefore,</span></span><br><span class="line"><span class="comment">                * at the moment, the preference is for simplicity.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Fill the read buffer as best we can.</span></span><br><span class="line">           nRead = fillReadBuffer(block);   <span class="comment">//这个函数是NioSocketWrapper实现的真正读取逻辑,也就是向buffer中添加</span></span><br><span class="line">           <span class="comment">//数据</span></span><br><span class="line">           updateLastRead();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Fill as much of the remaining byte array as possible with the</span></span><br><span class="line">           <span class="comment">// data that was just read</span></span><br><span class="line">           <span class="keyword">if</span> (nRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               socketBufferHandler.configureReadBufferForRead();</span><br><span class="line">               nRead = Math.min(nRead, len);</span><br><span class="line">               socketBufferHandler.getReadBuffer().get(b, off, nRead);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> nRead;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">fillReadBuffer</span><span class="params">(<span class="keyword">boolean</span> block)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">           socketBufferHandler.configureReadBufferForWrite();</span><br><span class="line">           <span class="keyword">return</span> fillReadBuffer(block, socketBufferHandler.getReadBuffer());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">fillReadBuffer</span><span class="params">(<span class="keyword">boolean</span> block, ByteBuffer to)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">           <span class="keyword">int</span> nRead;</span><br><span class="line">           NioChannel channel = getSocket();</span><br><span class="line">           <span class="keyword">if</span> (block) &#123;</span><br><span class="line">               Selector selector = <span class="keyword">null</span>;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   selector = pool.get(); <span class="comment">//block 读则调用</span></span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">                   <span class="comment">// Ignore</span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   NioEndpoint.NioSocketWrapper att = (NioEndpoint.NioSocketWrapper) channel</span><br><span class="line">                           .getAttachment();</span><br><span class="line">                   <span class="keyword">if</span> (att == <span class="keyword">null</span>) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Key must be cancelled."</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">                   nRead = pool.read(to, channel, selector, att.getReadTimeout()); <span class="comment">//通过pool来处理</span></span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                   <span class="keyword">if</span> (selector != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       pool.put(selector);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               nRead = channel.read(to); <span class="comment">//非blocking读则调用该函数,此处代码就是真正的 channel.read(buffer)</span></span><br><span class="line">               <span class="keyword">if</span> (nRead == -<span class="number">1</span>) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> nRead;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>NioChannel:封装了实际的socketChannel,并且是endPoint|procol的泛型参数之一</li>
</ul>
<figure class="highlight java"><figcaption><span>NioChannel</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioChannel</span> <span class="keyword">implements</span> <span class="title">ByteChannel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> StringManager sm = StringManager.getManager(NioChannel<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> ByteBuffer emptyBuf = ByteBuffer.allocate(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> SocketChannel sc = <span class="keyword">null</span>; <span class="comment">//真正的socketChannel</span></span><br><span class="line">    <span class="keyword">protected</span> SocketWrapperBase&lt;NioChannel&gt; socketWrapper = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> SocketBufferHandler bufHandler; <span class="comment">//持有读写buffer和相关调整方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Poller poller;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NioChannel</span><span class="params">(SocketChannel channel, SocketBufferHandler bufHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sc = channel;</span><br><span class="line">        <span class="keyword">this</span>.bufHandler = bufHandler;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">free</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bufHandler.free(); <span class="comment">//处理内部buffer</span></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123; <span class="comment">//关闭sc</span></span><br><span class="line">        getIOChannel().socket().close();</span><br><span class="line">        getIOChannel().close();</span><br><span class="line">    &#125;</span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(ByteBuffer src)</span> <span class="keyword">throws</span> IOException </span>&#123; <span class="comment">//实际进行读写操作</span></span><br><span class="line">        checkInterruptStatus();</span><br><span class="line">        <span class="keyword">return</span> sc.write(src);</span><br><span class="line">    &#125;</span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(ByteBuffer dst)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sc.read(dst);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>SocketBufferHandler:持有读写buffer,并有调整方法</li>
</ul>
<figure class="highlight java"><figcaption><span>SocketBufferHandler</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> readBufferConfiguredForWrite = <span class="keyword">true</span>;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">volatile</span> ByteBuffer readBuffer;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> writeBufferConfiguredForWrite = <span class="keyword">true</span>;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">volatile</span> ByteBuffer writeBuffer;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> direct;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">SocketBufferHandler</span><span class="params">(<span class="keyword">int</span> readBufferSize, <span class="keyword">int</span> writeBufferSize,  //由连接器获取连接之后创建对应channel时创建,并被wrapper和channel持有</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">boolean</span> direct)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">this</span>.direct = direct;</span><br><span class="line">     <span class="keyword">if</span> (direct) &#123;</span><br><span class="line">         readBuffer = ByteBuffer.allocateDirect(readBufferSize);</span><br><span class="line">         writeBuffer = ByteBuffer.allocateDirect(writeBufferSize);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         readBuffer = ByteBuffer.allocate(readBufferSize);</span><br><span class="line">         writeBuffer = ByteBuffer.allocate(writeBufferSize);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>NioSelectorPool:读写使用了selector多路复用,这里说的blocking应该指的是selecotr的blocking</li>
</ul>
<figure class="highlight java"><figcaption><span>NioSelectorPool</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该类实现处理读写channel缓冲逻辑,其中NioBlockingSelector部分逻辑在connector部分写了</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioSelectorPool</span> </span>&#123;</span><br><span class="line"> <span class="keyword">protected</span> ConcurrentLinkedQueue&lt;Selector&gt; selectors =</span><br><span class="line">            <span class="keyword">new</span> ConcurrentLinkedQueue&lt;&gt;(); <span class="comment">//不使用block的选择器缓冲</span></span><br><span class="line">  <span class="keyword">protected</span> NioBlockingSelector blockingSelector; <span class="comment">//blocking使用的选择器      </span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">//写逻辑,这里有部分代码没看,就是tomcat从Servlet,还是什么组件进行的写回操作</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(ByteBuffer buf, NioChannel socket, Selector selector,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">long</span> writeTimeout, <span class="keyword">boolean</span> block)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( SHARED &amp;&amp; block ) &#123;</span><br><span class="line">            <span class="keyword">return</span> blockingSelector.write(buf,socket,writeTimeout);  <span class="comment">//只有阻塞并且SHARED=true,调用逻辑在connector部分写了</span></span><br><span class="line">        &#125;</span><br><span class="line">        SelectionKey key = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> written = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> timedout = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> keycount = <span class="number">1</span>; <span class="comment">//assume we can write</span></span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis(); <span class="comment">//start the timeout timer  //下边代码实际相似</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ( (!timedout) &amp;&amp; buf.hasRemaining() ) &#123;  <span class="comment">//Remain =limit-position</span></span><br><span class="line">                <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> ( keycount &gt; <span class="number">0</span> ) &#123; <span class="comment">//only write if we were registered for a write</span></span><br><span class="line">                    cnt = socket.write(buf); <span class="comment">//write the data</span></span><br><span class="line">                    <span class="keyword">if</span> (cnt == -<span class="number">1</span>) <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</span><br><span class="line"></span><br><span class="line">                    written += cnt;  <span class="comment">//写出的数量</span></span><br><span class="line">                    <span class="keyword">if</span> (cnt &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        time = System.currentTimeMillis(); <span class="comment">//reset our timeout timer</span></span><br><span class="line">                        <span class="keyword">continue</span>; <span class="comment">//we successfully wrote, try again without a selector//可以理解为如果能写出数据,那就说明此时写channel是可用的</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (cnt==<span class="number">0</span> &amp;&amp; (!block)) <span class="keyword">break</span>; <span class="comment">//don't block  如果=0且非阻塞则跳出</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//只有当这一次没有写出,并且还是阻塞,才执行以下逻辑,意思就是如果没有写出数据,并且服务器允许对此次写进行等待,那么执行以下逻辑</span></span><br><span class="line">                <span class="keyword">if</span> ( selector != <span class="keyword">null</span> ) &#123;</span><br><span class="line">                    <span class="comment">//register OP_WRITE to the selector</span></span><br><span class="line">                    <span class="keyword">if</span> (key==<span class="keyword">null</span>) key = socket.getIOChannel().register(selector, SelectionKey.OP_WRITE); <span class="comment">//注册</span></span><br><span class="line">                    <span class="keyword">else</span> key.interestOps(SelectionKey.OP_WRITE);</span><br><span class="line">                    <span class="keyword">if</span> (writeTimeout==<span class="number">0</span>) &#123;</span><br><span class="line">                        timedout = buf.hasRemaining();<span class="comment">//假设返回true[1]-&gt;[2]  这个逻辑是只能进行一次写操作,如果没写完就超时异常</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (writeTimeout&lt;<span class="number">0</span>) &#123; <span class="comment">//阻塞逻辑</span></span><br><span class="line">                        keycount = selector.select(); <span class="comment">//这个逻辑说明一直进行写操作,必须等到buffer写完,否则一直继续循环</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        keycount = selector.select(writeTimeout);<span class="comment">//[3]-&gt;[4]</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//[2]:抛出异常  [4]:判断写代码用的时间是否&gt;writeTimeout 最大超时时间,大于就抛出异常</span></span><br><span class="line">                <span class="keyword">if</span> (writeTimeout &gt; <span class="number">0</span> &amp;&amp; (selector == <span class="keyword">null</span> || keycount == <span class="number">0</span>) ) timedout = (System.currentTimeMillis()-time)&gt;=writeTimeout;</span><br><span class="line">            &#125;<span class="comment">//while</span></span><br><span class="line">            <span class="keyword">if</span> ( timedout ) <span class="keyword">throw</span> <span class="keyword">new</span> SocketTimeoutException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                key.cancel();</span><br><span class="line">                <span class="keyword">if</span> (selector != <span class="keyword">null</span>) selector.selectNow();<span class="comment">//removes the key from this selector</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> written;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"> <span class="comment">//读取的逻辑   </span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(ByteBuffer buf, NioChannel socket, Selector selector, <span class="keyword">long</span> readTimeout)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> read(buf,socket,selector,readTimeout,<span class="keyword">true</span>);  <span class="comment">//idea的提示功能来进行这种读取的代码调用就这一种,也就是  //说如果是这种调用,那么必定是阻塞式除非使用反射</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(ByteBuffer buf, NioChannel socket, Selector selector, <span class="keyword">long</span> readTimeout, <span class="keyword">boolean</span> block)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( SHARED &amp;&amp; block ) &#123;</span><br><span class="line">            <span class="keyword">return</span> blockingSelector.read(buf,socket,readTimeout);</span><br><span class="line">        &#125;</span><br><span class="line">        SelectionKey key = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> read = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> timedout = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> keycount = <span class="number">1</span>; <span class="comment">//assume we can write</span></span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis(); <span class="comment">//start the timeout timer</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ( (!timedout) ) &#123;</span><br><span class="line">                <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> ( keycount &gt; <span class="number">0</span> ) &#123; <span class="comment">//only read if we were registered for a read</span></span><br><span class="line">                    cnt = socket.read(buf);</span><br><span class="line">                    <span class="keyword">if</span> (cnt == -<span class="number">1</span>) &#123; <span class="comment">//某一次读取-1</span></span><br><span class="line">                        <span class="keyword">if</span> (read == <span class="number">0</span>) &#123;<span class="comment">//说明第一次读取到-1</span></span><br><span class="line">                            read = -<span class="number">1</span>; <span class="comment">//返回值说明此处读取到末尾</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    read += cnt;</span><br><span class="line">                    <span class="keyword">if</span> (cnt &gt; <span class="number">0</span>) <span class="keyword">continue</span>; <span class="comment">//read some more  //继续读取</span></span><br><span class="line">                    <span class="keyword">if</span> (cnt==<span class="number">0</span> &amp;&amp; (read&gt;<span class="number">0</span> || (!block) ) ) <span class="keyword">break</span>; <span class="comment">//we are done reading  非阻塞或者此次读取为0并且已经不是第一次跳出</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( selector != <span class="keyword">null</span> ) &#123;<span class="comment">//perform a blocking read    不使用SHARED的阻塞方式,超时逻辑和write相同</span></span><br><span class="line">                    <span class="comment">//register OP_WRITE to the selector</span></span><br><span class="line">                    <span class="keyword">if</span> (key==<span class="keyword">null</span>) key = socket.getIOChannel().register(selector, SelectionKey.OP_READ);</span><br><span class="line">                    <span class="keyword">else</span> key.interestOps(SelectionKey.OP_READ);</span><br><span class="line">                    <span class="keyword">if</span> (readTimeout==<span class="number">0</span>) &#123;</span><br><span class="line">                        timedout = (read==<span class="number">0</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (readTimeout&lt;<span class="number">0</span>) &#123;</span><br><span class="line">                        keycount = selector.select();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        keycount = selector.select(readTimeout);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (readTimeout &gt; <span class="number">0</span> &amp;&amp; (selector == <span class="keyword">null</span> || keycount == <span class="number">0</span>) ) timedout = (System.currentTimeMillis()-time)&gt;=readTimeout;</span><br><span class="line">            &#125;<span class="comment">//while</span></span><br><span class="line">            <span class="keyword">if</span> ( timedout ) <span class="keyword">throw</span> <span class="keyword">new</span> SocketTimeoutException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                key.cancel();</span><br><span class="line">                <span class="keyword">if</span> (selector != <span class="keyword">null</span>) selector.selectNow();<span class="comment">//removes the key from this selector</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> read;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processor-和adaptor"><a class="header-anchor" href="#processor-和adaptor">¶</a>processor 和adaptor</h4>
<h5 id="Http11Processor-一般处理http请求的process"><a class="header-anchor" href="#Http11Processor-一般处理http请求的process">¶</a>Http11Processor 一般处理http请求的process</h5>
<ul>
<li>继承图<br>
<img src="http://pmftd1xvt.bkt.clouddn.com/Http11Processor.png" alt=""></li>
</ul>
<figure class="highlight java"><figcaption><span>Http11Processor::构造器</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Http11Processor</span><span class="params">(AbstractHttp11Protocol&lt;?&gt; protocol)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.protocol = protocol;</span><br><span class="line"></span><br><span class="line">        userDataHelper = <span class="keyword">new</span> UserDataHelper(log);</span><br><span class="line"></span><br><span class="line">        inputBuffer = <span class="keyword">new</span> Http11InputBuffer(request, protocol.getMaxHttpHeaderSize());</span><br><span class="line">        request.setInputBuffer(inputBuffer);</span><br><span class="line"></span><br><span class="line">        outputBuffer = <span class="keyword">new</span> Http11OutputBuffer(response, protocol.getMaxHttpHeaderSize());</span><br><span class="line">        response.setOutputBuffer(outputBuffer);</span><br><span class="line">         <span class="comment">//... 设置in/outBuffer</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">new</span> Request(), <span class="keyword">new</span> Response()); <span class="comment">//实例化req和res对象</span></span><br><span class="line">    &#125;	</span><br></pre></td></tr></table></figure>
<ul>
<li>关于in/outBuffer<br>
<img src="http://pmftd1xvt.bkt.clouddn.com/Http11InputBuffer.png" alt=""></li>
</ul>
<h4 id="mapper"><a class="header-anchor" href="#mapper">¶</a>mapper</h4>
<ul>
<li>mapper 的构造初始填充<br>
mapper 创建于service,连接使用都是公用的mapper,填充由mapperListener导致,发生在content构造之后<br>
首先理解关于路由的过程 tomcat将url 分为三部分 如: localhost:8080/demo/index.hmlt<br>
localhost 为host<br>
demo 为content<br>
index.html Wrapper<br>
tomcat 按照多级映射 mapper包含host[] -&gt;context[] -&gt;wrapper[]</li>
</ul>
<figure class="highlight java"><figcaption><span>Mapper</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//原型</span></span><br><span class="line"> <span class="comment">// ------------------------------------------------- MapElement Inner Class</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MapElement</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> String name;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> T object;  <span class="comment">//这个T就是应该存放的对象</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MapElement</span><span class="params">(String name, T object)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">            <span class="keyword">this</span>.object = object;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	 <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MappedHost</span> <span class="keyword">extends</span> <span class="title">MapElement</span>&lt;<span class="title">Host</span>&gt; </span>&#123;  <span class="comment">//host映射,它持有ContextList 只不过是对数组的封装</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> ContextList contextList;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Link to the "real" MappedHost, shared by all aliases.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MappedHost realHost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Links to all registered aliases, for easy enumeration. This field</span></span><br><span class="line"><span class="comment">         * is available only in the "real" MappedHost. In an alias this field</span></span><br><span class="line"><span class="comment">         * is &lt;code&gt;null&lt;/code&gt;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MappedHost&gt; aliases;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Constructor used for the primary Host</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> name The name of the virtual host</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> host The host</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MappedHost</span><span class="params">(String name, Host host)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(name, host);</span><br><span class="line">            realHost = <span class="keyword">this</span>;</span><br><span class="line">            contextList = <span class="keyword">new</span> ContextList();</span><br><span class="line">            aliases = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextList</span> </span>&#123;  ContextList实现</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> MappedContext[] contexts;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> nesting;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ContextList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>(<span class="keyword">new</span> MappedContext[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">ContextList</span><span class="params">(MappedContext[] contexts, <span class="keyword">int</span> nesting)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.contexts = contexts;</span><br><span class="line">            <span class="keyword">this</span>.nesting = nesting;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ContextList <span class="title">addContext</span><span class="params">(MappedContext mappedContext,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">int</span> slashCount)</span> </span>&#123;</span><br><span class="line">            MappedContext[] newContexts = <span class="keyword">new</span> MappedContext[contexts.length + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (insertMap(contexts, newContexts, mappedContext)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ContextList(newContexts, Math.max(nesting,</span><br><span class="line">                        slashCount));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ContextList <span class="title">removeContext</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">            MappedContext[] newContexts = <span class="keyword">new</span> MappedContext[contexts.length - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (removeMap(contexts, newContexts, path)) &#123;</span><br><span class="line">                <span class="keyword">int</span> newNesting = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (MappedContext context : newContexts) &#123;</span><br><span class="line">                    newNesting = Math.max(newNesting, slashCount(context.name));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ContextList(newContexts, newNesting);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	 <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MappedContext</span> <span class="keyword">extends</span> <span class="title">MapElement</span>&lt;<span class="title">Void</span>&gt; </span>&#123; <span class="comment">//context映射,内部含有ContextVersion对象,该对象是对MappedWrapper的封装</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> ContextVersion[] versions;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MappedContext</span><span class="params">(String name, ContextVersion firstVersion)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(name, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.versions = <span class="keyword">new</span> ContextVersion[] &#123; firstVersion &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	 <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextVersion</span> <span class="keyword">extends</span> <span class="title">MapElement</span>&lt;<span class="title">Context</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> String path;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> slashCount;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> WebResourceRoot resources;</span><br><span class="line">        <span class="keyword">public</span> String[] welcomeResources;</span><br><span class="line">        <span class="keyword">public</span> MappedWrapper defaultWrapper = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">public</span> MappedWrapper[] exactWrappers = <span class="keyword">new</span> MappedWrapper[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">public</span> MappedWrapper[] wildcardWrappers = <span class="keyword">new</span> MappedWrapper[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">public</span> MappedWrapper[] extensionWrappers = <span class="keyword">new</span> MappedWrapper[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> nesting = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> paused;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ContextVersion</span><span class="params">(String version, String path, <span class="keyword">int</span> slashCount,</span></span></span><br><span class="line"><span class="function"><span class="params">                Context context, WebResourceRoot resources,</span></span></span><br><span class="line"><span class="function"><span class="params">                String[] welcomeResources)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(version, context);</span><br><span class="line">            <span class="keyword">this</span>.path = path;</span><br><span class="line">            <span class="keyword">this</span>.slashCount = slashCount;</span><br><span class="line">            <span class="keyword">this</span>.resources = resources;</span><br><span class="line">            <span class="keyword">this</span>.welcomeResources = welcomeResources;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPaused</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> paused;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">markPaused</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            paused = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	 <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MappedWrapper</span> <span class="keyword">extends</span> <span class="title">MapElement</span>&lt;<span class="title">Wrapper</span>&gt; </span>&#123; <span class="comment">//wrapper是最小容器</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> jspWildCard;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> resourceOnly;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MappedWrapper</span><span class="params">(String name, Wrapper wrapper, <span class="keyword">boolean</span> jspWildCard,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">boolean</span> resourceOnly)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(name, wrapper);</span><br><span class="line">            <span class="keyword">this</span>.jspWildCard = jspWildCard;</span><br><span class="line">            <span class="keyword">this</span>.resourceOnly = resourceOnly;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">------------------------------------------------------------------------------------------------------------------</span><br><span class="line">mapper 通过url 映射到正确的Wrap过程</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">internalMap</span><span class="params">(CharChunk host, CharChunk uri,</span></span></span><br><span class="line"><span class="function"><span class="params">            String version, MappingData mappingData)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//mapper中查找使用了二分法</span></span><br><span class="line">        <span class="comment">//[0]: 确保host不为空</span></span><br><span class="line">        <span class="keyword">if</span> (mappingData.host != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// The legacy code (dating down at least to Tomcat 4.1) just</span></span><br><span class="line">            <span class="comment">// skipped all mapping work in this case. That behaviour has a risk</span></span><br><span class="line">            <span class="comment">// of returning an inconsistent result.</span></span><br><span class="line">            <span class="comment">// I do not see a valid use case for it.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uri.setLimit(-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Virtual host mapping [1]: 虚拟主机映射</span></span><br><span class="line">        MappedHost[] hosts = <span class="keyword">this</span>.hosts;</span><br><span class="line">        MappedHost mappedHost = exactFindIgnoreCase(hosts, host); <span class="comment">//根据host寻找</span></span><br><span class="line">        <span class="keyword">if</span> (mappedHost == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Note: Internally, the Mapper does not use the leading * on a</span></span><br><span class="line">            <span class="comment">//       wildcard host. This is to allow this shortcut.</span></span><br><span class="line">            <span class="keyword">int</span> firstDot = host.indexOf(<span class="string">'.'</span>);</span><br><span class="line">            <span class="keyword">if</span> (firstDot &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> offset = host.getOffset();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    host.setOffset(firstDot + offset);</span><br><span class="line">                    mappedHost = exactFindIgnoreCase(hosts, host);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// Make absolutely sure this gets reset</span></span><br><span class="line">                    host.setOffset(offset);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mappedHost == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mappedHost = defaultHost;</span><br><span class="line">                <span class="keyword">if</span> (mappedHost == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mappingData.host = mappedHost.object;   <span class="comment">//设置host,该host就是StandardHost</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Context mapping [2]:获取context映射</span></span><br><span class="line">        ContextList contextList = mappedHost.contextList; <span class="comment">// 获取对应host中的contextList映射</span></span><br><span class="line">        MappedContext[] contexts = contextList.contexts;  <span class="comment">// 该host对应的所有contextMapper 数组</span></span><br><span class="line">        <span class="keyword">int</span> pos = find(contexts, uri);  <span class="comment">//根据uri 寻找</span></span><br><span class="line">        <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> lastSlash = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> uriEnd = uri.getEnd();</span><br><span class="line">        <span class="keyword">int</span> length = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">boolean</span> found = <span class="keyword">false</span>;</span><br><span class="line">        MappedContext context = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> (pos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            context = contexts[pos];</span><br><span class="line">            <span class="keyword">if</span> (uri.startsWith(context.name)) &#123;</span><br><span class="line">                length = context.name.length();</span><br><span class="line">                <span class="keyword">if</span> (uri.getLength() == length) &#123;</span><br><span class="line">                    found = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uri.startsWithIgnoreCase(<span class="string">"/"</span>, length)) &#123;</span><br><span class="line">                    found = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (lastSlash == -<span class="number">1</span>) &#123;</span><br><span class="line">                lastSlash = nthSlash(uri, contextList.nesting + <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                lastSlash = lastSlash(uri);</span><br><span class="line">            &#125;</span><br><span class="line">            uri.setEnd(lastSlash);</span><br><span class="line">            pos = find(contexts, uri); <span class="comment">//根据uri寻找对应的contentMap</span></span><br><span class="line">        &#125;</span><br><span class="line">        uri.setEnd(uriEnd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">            <span class="keyword">if</span> (contexts[<span class="number">0</span>].name.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">                context = contexts[<span class="number">0</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                context = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 找到了context</span></span><br><span class="line">        mappingData.contextPath.setString(context.name); <span class="comment">//设置根据context name设置</span></span><br><span class="line">        <span class="comment">//[3]:获取版本映射</span></span><br><span class="line">        ContextVersion contextVersion = <span class="keyword">null</span>;  <span class="comment">//[]要找到的</span></span><br><span class="line">        ContextVersion[] contextVersions = context.versions;  <span class="comment">//获取关于warp的映射数组,tomcat9 貌似对于一个context做了一个版本区别,按理此处不该是数组,</span></span><br><span class="line">        <span class="comment">//明显是通过不同数组代表不同的版本,默认使用的话应该是1</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> versionCount = contextVersions.length;</span><br><span class="line">        <span class="keyword">if</span> (versionCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            Context[] contextObjects = <span class="keyword">new</span> Context[contextVersions.length];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; contextObjects.length; i++) &#123;</span><br><span class="line">                contextObjects[i] = contextVersions[i].object;</span><br><span class="line">            &#125;</span><br><span class="line">            mappingData.contexts = contextObjects;</span><br><span class="line">            <span class="keyword">if</span> (version != <span class="keyword">null</span>) &#123;</span><br><span class="line">                contextVersion = exactFind(contextVersions, version);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (contextVersion == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Return the latest version</span></span><br><span class="line">            <span class="comment">// The versions array is known to contain at least one element</span></span><br><span class="line">            contextVersion = contextVersions[versionCount - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        mappingData.context = contextVersion.object; <span class="comment">//设置context</span></span><br><span class="line">        mappingData.contextSlashCount = contextVersion.slashCount;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Wrapper mapping [4]:按照正确的版本寻找对应的 Wrapper</span></span><br><span class="line">        <span class="keyword">if</span> (!contextVersion.isPaused()) &#123;</span><br><span class="line">            internalMapWrapper(contextVersion, uri, mappingData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
<h4 id="tomcat中jdni"><a class="header-anchor" href="#tomcat中jdni">¶</a>tomcat中jdni</h4>
<p>为了容易理解,我在各部分尽量加上uml或能够说明的图,我也发现单纯看代码比较麻烦</p>
<ul>
<li>jdni的实现逻辑:以name路径,找到对应的对象;以路径存储对象;存储类型分为直接对象,和对象信息,后者在取出时按照信息进行实例化</li>
</ul>
<img src="/2018/10/06/tomcat/JDNI1.png" class="">
<p>spi 则是jdni具体实现,所有操作都要围绕NamingManager操作,用户入口接口一般时initialContext</p>
<ul>
<li>jdni模型</li>
</ul>

<p>jdni的组织结构是一个树结构,Context类型表示上下文,资源节点必须存在于context节点中,一个Context存在任意子节点,节点类型可以为Context或者资源,任意节点都有name,充当路径,根节点一般为&quot;&quot;<br>
如: tomcat中  lookup(“java:UserDatabase”) 表示以根节点&quot;&quot;开始寻找UserDatabase表示的资源</p>
<ul>
<li>jdni相关类<br>
NamingManager 属于一个静态类,是jdni的核心,基本操作都是调用该类进行中转发起的<br>
ObjectFacotry 寻找对象后创建对象的类,但并不代表实际创建对象的操作是该类处理的,在org.apache.naming包下实现了部分子类,用以处理不同的jndi类型,该工厂决定了对象按照Refence如何创建<br>
initialContext 用于用户接口 lookup 和bind 函数分别用于获取和存储对象<br>
StateFactory 用于绑定时如何处理的工厂,tomcat貌似没有实现这种子类</li>
</ul>
<figure class="highlight java"><figcaption><span>JNDI</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Context</span> </span>&#123;  <span class="comment">//该接口是jdk上下文接口,这里只提及一个常量</span></span><br><span class="line"><span class="comment">//jndi 使用hashTable作为供namingManager使用的环境变量 </span></span><br><span class="line"><span class="keyword">public</span> Hashtable&lt;?,?&gt; getEnvironment() <span class="keyword">throws</span> NamingException;</span><br><span class="line">String INITIAL_CONTEXT_FACTORY = <span class="string">"java.naming.factory.initial"</span>;  <span class="comment">//key,value 此处value表示一个factory的类位置,供namingManager初始化 initFactory使用,此处tomcat也使用了该变量,用于指定initFactory,放到了system.pero中</span></span><br><span class="line">&#125;</span><br><span class="line">-------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">//用户接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitialContext</span> <span class="keyword">implements</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">InitialContext</span><span class="params">()</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        init(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	 <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Hashtable&lt;?,?&gt; environment)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NamingException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        myProps = (Hashtable&lt;Object,Object&gt;)</span><br><span class="line">                ResourceManager.getInitialEnvironment(environment); <span class="comment">//此处代码最终会在system.pero中寻找和Context中常量匹配的key,value 当作env</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (myProps.get(Context.INITIAL_CONTEXT_FACTORY) != <span class="keyword">null</span>) &#123; <span class="comment">//如果设置了,则进行初始化context</span></span><br><span class="line">            <span class="comment">// user has specified initial context factory; try to get it</span></span><br><span class="line">            getDefaultInitCtx();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Context <span class="title">getDefaultInitCtx</span><span class="params">()</span> <span class="keyword">throws</span> NamingException</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!gotDefault) &#123;</span><br><span class="line">            defaultInitCtx = NamingManager.getInitialContext(myProps); <span class="comment">//NamingManager通过env获得initFactory,然后通过Fac创建出initContext</span></span><br><span class="line">            gotDefault = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (defaultInitCtx == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoInitialContextException();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> defaultInitCtx;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//lookup和bind</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(Name name)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getURLOrDefaultInitCtx(name).lookup(name);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Name name, Object obj)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        getURLOrDefaultInitCtx(name).bind(name, obj);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	 <span class="function"><span class="keyword">protected</span> Context <span class="title">getURLOrDefaultInitCtx</span><span class="params">(Name name)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (NamingManager.hasInitialContextFactoryBuilder()) &#123;  <span class="comment">//当设置FactoryBuilder,则通过builder获取fac,再获取initContext</span></span><br><span class="line">            <span class="keyword">return</span> getDefaultInitCtx();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (name.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            String first = name.get(<span class="number">0</span>);</span><br><span class="line">            String scheme = getURLScheme(first);</span><br><span class="line">            <span class="keyword">if</span> (scheme != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Context ctx = NamingManager.getURLContext(scheme, myProps); <span class="comment">//否则说明要通过urlFactory来获取initContext,tomcat就采取的这种方式,实际上tomcat也创建了initContext,但是它没有用,而非要使用url路径来返回一个新的context</span></span><br><span class="line">                <span class="keyword">if</span> (ctx != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ctx;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getDefaultInitCtx();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//核心NamingManager</span></span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamingManager</span></span>&#123;</span><br><span class="line">	<span class="comment">//获取initContext的方式</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Context <span class="title">getInitialContext</span><span class="params">(Hashtable&lt;?,?&gt; env)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        InitialContextFactory factory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        InitialContextFactoryBuilder builder = getInitialContextFactoryBuilder(); 尝试通过builder获取</span><br><span class="line">        <span class="keyword">if</span> (builder == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No builder installed, use property</span></span><br><span class="line">            <span class="comment">// Get initial context factory class name</span></span><br><span class="line"></span><br><span class="line">            String className = env != <span class="keyword">null</span> ?</span><br><span class="line">                (String)env.get(Context.INITIAL_CONTEXT_FACTORY) : <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (className == <span class="keyword">null</span>) &#123;</span><br><span class="line">                NoInitialContextException ne = <span class="keyword">new</span> NoInitialContextException(</span><br><span class="line">                    <span class="string">"Need to specify class name in environment or system "</span> +</span><br><span class="line">                    <span class="string">"property, or in an application resource file: "</span> +</span><br><span class="line">                    Context.INITIAL_CONTEXT_FACTORY);</span><br><span class="line">                <span class="keyword">throw</span> ne;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ServiceLoader&lt;InitialContextFactory&gt; loader =</span><br><span class="line">                    ServiceLoader.load(InitialContextFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">            Iterator&lt;InitialContextFactory&gt; iterator = loader.iterator();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    InitialContextFactory f = iterator.next();</span><br><span class="line">                    <span class="keyword">if</span> (f.getClass().getName().equals(className)) &#123;</span><br><span class="line">                        factory = f;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServiceConfigurationError e) &#123;</span><br><span class="line">                NoInitialContextException ne =</span><br><span class="line">                        <span class="keyword">new</span> NoInitialContextException(</span><br><span class="line">                                <span class="string">"Cannot load initial context factory "</span></span><br><span class="line">                                        + <span class="string">"'"</span> + className + <span class="string">"'"</span>);</span><br><span class="line">                ne.setRootCause(e);</span><br><span class="line">                <span class="keyword">throw</span> ne;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line">                    Object o = helper.loadClass(className).newInstance();  <span class="comment">//通过INITIAL_CONTEXT_FACTORY 对应的class位置,反射出factory</span></span><br><span class="line">                    factory = (InitialContextFactory) o;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    NoInitialContextException ne =</span><br><span class="line">                            <span class="keyword">new</span> NoInitialContextException(</span><br><span class="line">                                    <span class="string">"Cannot instantiate class: "</span> + className);</span><br><span class="line">                    ne.setRootCause(e);</span><br><span class="line">                    <span class="keyword">throw</span> ne;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            factory = builder.createInitialContextFactory(env);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> factory.getInitialContext(env); <span class="comment">//通过factory创建initContext</span></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	    <span class="comment">//试图使用url来创建</span></span><br><span class="line">		 <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Context <span class="title">getURLContext</span><span class="params">(String scheme,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Hashtable&lt;?,?&gt; environment)</span>  <span class="keyword">throws</span> NamingException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// pass in 'null' to indicate creation of generic context for scheme</span></span><br><span class="line">        <span class="comment">// (i.e. not specific to a URL).</span></span><br><span class="line"></span><br><span class="line">            Object answer = getURLObject(scheme, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, environment);</span><br><span class="line">            <span class="keyword">if</span> (answer <span class="keyword">instanceof</span> Context) &#123;</span><br><span class="line">                <span class="keyword">return</span> (Context)answer;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getURLObject</span><span class="params">(String scheme, Object urlInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       Hashtable&lt;?,?&gt; environment)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// e.g. "ftpURLContextFactory"</span></span><br><span class="line">        ObjectFactory factory = (ObjectFactory)ResourceManager.getFactory(</span><br><span class="line">            Context.URL_PKG_PREFIXES, environment, nameCtx,</span><br><span class="line">            <span class="string">"."</span> + scheme + <span class="string">"."</span> + scheme + <span class="string">"URLContextFactory"</span>, defaultPkgPrefix);  <span class="comment">//创建url工厂</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Found object factory</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> factory.getObjectInstance(urlInfo, name, nameCtx, environment);  <span class="comment">//通过url工厂返回context</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            NamingException ne = <span class="keyword">new</span> NamingException();</span><br><span class="line">            ne.setRootCause(e);</span><br><span class="line">            <span class="keyword">throw</span> ne;</span><br><span class="line">        &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//实例化对象的接口</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getObjectInstance</span><span class="params">(Object refInfo, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="function"><span class="params">                          Hashtable&lt;?,?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ObjectFactory factory;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use builder if installed</span></span><br><span class="line">        ObjectFactoryBuilder builder = getObjectFactoryBuilder(); <span class="comment">//有builder使用builder创建fac</span></span><br><span class="line">        <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// builder must return non-null factory</span></span><br><span class="line">            factory = builder.createObjectFactory(refInfo, environment);</span><br><span class="line">            <span class="keyword">return</span> factory.getObjectInstance(refInfo, name, nameCtx,</span><br><span class="line">                environment);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use reference if possible  否则使用Reference中的factoryClass来创建工厂</span></span><br><span class="line">        Reference ref = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">            ref = (Reference) refInfo;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">            ref = ((Referenceable)(refInfo)).getReference();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object answer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String f = ref.getFactoryClassName();</span><br><span class="line">            <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// if reference identifies a factory, use exclusively</span></span><br><span class="line"></span><br><span class="line">                factory = getObjectFactoryFromReference(ref, f); <span class="comment">//获取工厂</span></span><br><span class="line">                <span class="keyword">if</span> (factory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> factory.getObjectInstance(ref, name, nameCtx, <span class="comment">//通过工厂创建对象</span></span><br><span class="line">                                                     environment);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// No factory found, so return original refInfo.</span></span><br><span class="line">                <span class="comment">// Will reach this point if factory class is not in</span></span><br><span class="line">                <span class="comment">// class path and reference does not contain a URL for it</span></span><br><span class="line">                <span class="keyword">return</span> refInfo;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// if reference has no factory, check for addresses</span></span><br><span class="line">                <span class="comment">// containing URLs</span></span><br><span class="line"></span><br><span class="line">                answer = processURLAddrs(ref, name, nameCtx, environment);</span><br><span class="line">                <span class="keyword">if</span> (answer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> answer;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// try using any specified factories</span></span><br><span class="line">        answer =</span><br><span class="line">            createObjectFromFactories(refInfo, name, nameCtx, environment);</span><br><span class="line">        <span class="keyword">return</span> (answer != <span class="keyword">null</span>) ? answer : refInfo;</span><br><span class="line">    &#125;	</span><br><span class="line">&#125;</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">// 大概流程:</span></span><br><span class="line">  initialContext创建-&gt;根据env创建initContext-&gt;lookup-&gt;NamingManager判断并返回一个Context-&gt;由该context进行lookup-&gt;根据此类型信息中的factory进行创建</span><br></pre></td></tr></table></figure>
<ul>
<li>tomcat</li>
</ul>
<figure class="highlight java"><figcaption><span>tomcat实现</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该context作为节点存放资源和context</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamingContext</span> <span class="keyword">implements</span> <span class="title">Context</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Hashtable&lt;String, Object&gt; env; <span class="comment">//环境变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> HashMap&lt;String, NamingEntry&gt; bindings;<span class="comment">//实际上绑定的资源就在此处,实际上绑定较为简单,lookup存在创建对象的复杂性</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> Object <span class="title">lookup</span><span class="params">(Name name, <span class="keyword">boolean</span> resolveLinks)</span> <span class="keyword">throws</span> NamingException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Removing empty parts</span></span><br><span class="line">        <span class="keyword">while</span> ((!name.isEmpty()) &amp;&amp; (name.get(<span class="number">0</span>).length() == <span class="number">0</span>)) name = name.getSuffix(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (name.isEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// If name is empty, a newly allocated naming context is returned</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> NamingContext(env, <span class="keyword">this</span>.name, bindings);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        NamingEntry entry = bindings.get(name.get(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (entry == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(sm.getString(<span class="string">"namingContext.nameNotBound"</span>, name, name.get(<span class="number">0</span>)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name.size() &gt; <span class="number">1</span>)  <span class="comment">//这说明寻找的位置必定是 /xx/xxx/xxxx 这种,说明存在子context,此时的this是作为当前根节点,</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// If the size of the name is greater that 1, then we go through a</span></span><br><span class="line">            <span class="comment">// number of subcontexts.</span></span><br><span class="line">            <span class="keyword">if</span> (entry.type != NamingEntry.CONTEXT)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NamingException(sm.getString(<span class="string">"namingContext.contextExpected"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ((Context) entry.value).lookup(name.getSuffix(<span class="number">1</span>)); <span class="comment">//从相对位置1开始继续寻找</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>  <span class="comment">//否则说明该context节点就是包含资源的context,从此处map寻找就可以</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ((resolveLinks) &amp;&amp; (entry.type == NamingEntry.LINK_REF)) <span class="comment">//这是tomcat为了实现局部和全局资源而做的,在局部context(指的是tomcat context)ref就是这么实现的</span></span><br><span class="line">            &#123;</span><br><span class="line">                String link = ((LinkRef) entry.value).getLinkName();</span><br><span class="line">                <span class="keyword">if</span> (link.startsWith(<span class="string">"."</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// Link relative to this context</span></span><br><span class="line">                    <span class="keyword">return</span> lookup(link.substring(<span class="number">1</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> InitialContext(env).lookup(link);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (entry.type == NamingEntry.REFERENCE)  <span class="comment">//REFERENCE 就是jndi推荐存放的数据类型</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Object obj = NamingManager.getObjectInstance(entry.value, name, <span class="keyword">this</span>, env);  <span class="comment">//按照jndi的流程进行创建</span></span><br><span class="line">                    <span class="keyword">if</span> (entry.value <span class="keyword">instanceof</span> ResourceRef) <span class="comment">//ResourceRef类型存放着大量信息</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">boolean</span> singleton = Boolean.parseBoolean((String) ((ResourceRef) entry.value).get(<span class="string">"singleton"</span>).getContent());</span><br><span class="line">                        <span class="keyword">if</span> (singleton) <span class="comment">//假设是单例模式,就改变entry信息</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            entry.type = NamingEntry.ENTRY;</span><br><span class="line">                            entry.value = obj;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> obj;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (NamingException e)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    log.warn(sm.getString(<span class="string">"namingContext.failResolvingReference"</span>), e);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NamingException(e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> entry.value; <span class="comment">//这中情况说明是单例,上次已经创建了一次,这一次返回就好了</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">	    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Name name, Object obj, <span class="keyword">boolean</span> rebind)</span> <span class="keyword">throws</span> NamingException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!checkWritable())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((!name.isEmpty()) &amp;&amp; (name.get(<span class="number">0</span>).length() == <span class="number">0</span>)) name = name.getSuffix(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (name.isEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NamingException(sm.getString(<span class="string">"namingContext.invalidName"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        NamingEntry entry = bindings.get(name.get(<span class="number">0</span>));  <span class="comment">//获取当前路径的当前根节点</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name.size() &gt; <span class="number">1</span>)<span class="comment">//说明当前路径为 /xx/xxx/xxxx..</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry == <span class="keyword">null</span>)  <span class="comment">//说明xx按理说是一个context,但是对于this来说并没有把它当作子context存放,也就是说tomcat的NamingContext.bind方法不支持直接创建子context</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(sm.getString(<span class="string">"namingContext.nameNotBound"</span>, name, name.get(<span class="number">0</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (entry.type == NamingEntry.CONTEXT)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (rebind)</span><br><span class="line">                &#123;</span><br><span class="line">                    ((Context) entry.value).rebind(name.getSuffix(<span class="number">1</span>), obj);  <span class="comment">//重新调用bind函数,实际就是树结构的向下节点查询</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    ((Context) entry.value).bind(name.getSuffix(<span class="number">1</span>), obj);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NamingException(sm.getString(<span class="string">"namingContext.contextExpected"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">//说明到了最后一层context节点</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ((!rebind) &amp;&amp; (entry != <span class="keyword">null</span>)) <span class="comment">//说明this节点存放着name对应的数据,但是并不进行rebind,因此alreadyBound异常</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NameAlreadyBoundException(sm.getString(<span class="string">"namingContext.alreadyBound"</span>, name.get(<span class="number">0</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Getting the type of the object and wrapping it within a new</span></span><br><span class="line">                <span class="comment">// NamingEntry</span></span><br><span class="line">                Object toBind = NamingManager.getStateToBind(obj, name, <span class="keyword">this</span>, env);  <span class="comment">//调用状态工厂进行处理,但是tomcat并没有实现状态工厂,而是每次存储都是符合逻辑的数据</span></span><br><span class="line">                <span class="keyword">if</span> (toBind <span class="keyword">instanceof</span> Context)</span><br><span class="line">                &#123;</span><br><span class="line">                    entry = <span class="keyword">new</span> NamingEntry(name.get(<span class="number">0</span>), toBind, NamingEntry.CONTEXT);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (toBind <span class="keyword">instanceof</span> LinkRef)</span><br><span class="line">                &#123;</span><br><span class="line">                    entry = <span class="keyword">new</span> NamingEntry(name.get(<span class="number">0</span>), toBind, NamingEntry.LINK_REF);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (toBind <span class="keyword">instanceof</span> Reference)</span><br><span class="line">                &#123;</span><br><span class="line">                    entry = <span class="keyword">new</span> NamingEntry(name.get(<span class="number">0</span>), toBind, NamingEntry.REFERENCE);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (toBind <span class="keyword">instanceof</span> Referenceable)</span><br><span class="line">                &#123;</span><br><span class="line">                    toBind = ((Referenceable) toBind).getReference();</span><br><span class="line">                    entry = <span class="keyword">new</span> NamingEntry(name.get(<span class="number">0</span>), toBind, NamingEntry.REFERENCE);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    entry = <span class="keyword">new</span> NamingEntry(name.get(<span class="number">0</span>), toBind, NamingEntry.ENTRY);</span><br><span class="line">                &#125;</span><br><span class="line">                bindings.put(name.get(<span class="number">0</span>), entry); <span class="comment">// 真正进行的绑定操作</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">---------------------------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//tomcat实现的url工厂,用于返回context来进行look操作和bind操作,实际上该类只返回selectorContext</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">javaURLContextFactory</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">ObjectFactory</span>, <span class="title">InitialContextFactory</span> </span>&#123;</span><br><span class="line">	   <span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    Hashtable&lt;?,?&gt; environment)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((ContextBindings.isThreadBound()) ||  <span class="comment">//判断当前线程或者类加载器是否被ContextBindings存储,这是实现隔离机制的方式</span></span><br><span class="line">            (ContextBindings.isClassLoaderBound())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SelectorContext((Hashtable&lt;String,Object&gt;)environment);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get a new (writable) initial context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">getInitialContext</span><span class="params">(Hashtable&lt;?,?&gt; environment)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ContextBindings.isThreadBound() ||</span><br><span class="line">            (ContextBindings.isClassLoaderBound())) &#123; <span class="comment">//当前线程满足条件,返回SelectorContext</span></span><br><span class="line">            <span class="comment">// Redirect the request to the bound initial context </span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SelectorContext(</span><br><span class="line">                    (Hashtable&lt;String,Object&gt;)environment, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the thread is not bound, return a shared writable context</span></span><br><span class="line">        <span class="keyword">if</span> (initialContext == <span class="keyword">null</span>) &#123; <span class="comment">//如果不满足,那么就会以initialContext做为上下文的根处理,并且是会被共享的</span></span><br><span class="line">            <span class="keyword">synchronized</span>(javaURLContextFactory<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (initialContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    initialContext = <span class="keyword">new</span> NamingContext(</span><br><span class="line">                            (Hashtable&lt;String,Object&gt;)environment, MAIN);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> initialContext;  <span class="comment">//对于没有的被绑定的线程,都会使用该context作为起始点</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//该类也是static类,使用了大量的map进行保持线程,类加载器:context的映射,Server和Context就是通过类加载器区分的context,从而实现了全局和局部资源</span></span><br><span class="line"><span class="comment">//绑定的过程发生在NamingContextListener.lifeEvnet过程中</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextBindings</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// -------------------------------------------------------------- Variables</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bindings object - naming context. Keyed by object.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Hashtable&lt;Object,Context&gt; objectBindings = <span class="keyword">new</span> Hashtable&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bindings thread - naming context. Keyed by thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Hashtable&lt;Thread,Context&gt; threadBindings = <span class="keyword">new</span> Hashtable&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bindings thread - object. Keyed by thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Hashtable&lt;Thread,Object&gt; threadObjectBindings = <span class="keyword">new</span> Hashtable&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bindings class loader - naming context. Keyed by class loader.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Hashtable&lt;ClassLoader,Context&gt; clBindings = <span class="keyword">new</span> Hashtable&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bindings class loader - object. Keyed by class loader.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Hashtable&lt;ClassLoader,Object&gt; clObjectBindings = <span class="keyword">new</span> Hashtable&lt;&gt;();</span><br><span class="line">---------------------------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectorContext</span> <span class="keyword">implements</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(Name name)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(sm.getString(<span class="string">"selectorContext.methodUsingName"</span>, <span class="string">"lookup"</span>,</span><br><span class="line">                    name));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Strip the URL header</span></span><br><span class="line">        <span class="comment">// Find the appropriate NamingContext according to the current bindings</span></span><br><span class="line">        <span class="comment">// Execute the lookup on that context</span></span><br><span class="line">        <span class="keyword">return</span> getBoundContext().lookup(parseName(name)); <span class="comment">//通过ContextBindings获取对应范围的NamingContext,再使用context.lookup 取得实际对象</span></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Name name, Object obj)</span> <span class="comment">//同理</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        getBoundContext().bind(parseName(name), obj);</span><br><span class="line">    &#125;	</span><br><span class="line">&#125;</span><br><span class="line">--------------------------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//tomcat中实现的一部分object工厂源码</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Object factory for resource links.&lt;/p&gt;  处理ResouceLink的关键</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Remy Maucherat</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceLinkFactory</span> <span class="keyword">implements</span> <span class="title">ObjectFactory</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Context globalContext = <span class="keyword">null</span>; <span class="comment">//该类持有全局context的引用</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="function"><span class="params">            Hashtable&lt;?,?&gt; environment)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> ResourceLinkRef)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Can we process this request?</span></span><br><span class="line">        Reference ref = (Reference) obj;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the global ref addr</span></span><br><span class="line">        String globalName = <span class="keyword">null</span>;</span><br><span class="line">        RefAddr refAddr = ref.get(ResourceLinkRef.GLOBALNAME);  <span class="comment">//获取global标签到全局context.lookUp就能获取到全局资源</span></span><br><span class="line">        <span class="keyword">if</span> (refAddr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            globalName = refAddr.getContent().toString();</span><br><span class="line">            <span class="comment">// Confirm that the current web application is currently configured</span></span><br><span class="line">            <span class="comment">// to access the specified global resource</span></span><br><span class="line">            <span class="keyword">if</span> (!validateGlobalResourceAccess(globalName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Object result = <span class="keyword">null</span>;</span><br><span class="line">            result = globalContext.lookup(globalName);</span><br><span class="line">            <span class="comment">// Check the expected type</span></span><br><span class="line">            String expectedClassName = ref.getClassName();</span><br><span class="line">            <span class="keyword">if</span> (expectedClassName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        sm.getString(<span class="string">"resourceLinkFactory.nullType"</span>, name, globalName));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class&lt;?&gt; expectedClazz = Class.forName(</span><br><span class="line">                        expectedClassName, <span class="keyword">true</span>, Thread.currentThread().getContextClassLoader());</span><br><span class="line">                <span class="keyword">if</span> (!expectedClazz.isAssignableFrom(result.getClass())) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(sm.getString(<span class="string">"resourceLinkFactory.wrongType"</span>,</span><br><span class="line">                            name, globalName, expectedClassName, result.getClass().getName()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(sm.getString(<span class="string">"resourceLinkFactory.unknownType"</span>,</span><br><span class="line">                        name, globalName, expectedClassName), e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;	</span><br><span class="line">--------------------------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Object factory for resource links for shared data sources.&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * 用来处理: javax.sql.DataSource数据类型,我这里是一个错误例子 ,正确的server.xml例子见后文</span></span><br><span class="line"><span class="comment">				  &lt;GlobalNamingResources&gt;</span></span><br><span class="line"><span class="comment">						&lt;!-- Editable user database that can also be used by</span></span><br><span class="line"><span class="comment">							 UserDatabaseRealm to authenticate users</span></span><br><span class="line"><span class="comment">						--&gt;</span></span><br><span class="line"><span class="comment">						&lt;Resource name="UserDatabase" auth="Container"</span></span><br><span class="line"><span class="comment">								  type="org.apache.catalina.UserDatabase"  //此处是UserDatabase</span></span><br><span class="line"><span class="comment">								  description="User database that can be updated and saved"</span></span><br><span class="line"><span class="comment">								  factory="org.apache.catalina.users.MemoryUserDatabaseFactory"</span></span><br><span class="line"><span class="comment">								  pathname="conf/tomcat-users.xml"/&gt;</span></span><br><span class="line"><span class="comment">					&lt;/GlobalNamingResources&gt;</span></span><br><span class="line"><span class="comment">			</span></span><br><span class="line"><span class="comment">					&lt;ResourceLink</span></span><br><span class="line"><span class="comment">                            name="UserData"</span></span><br><span class="line"><span class="comment">                            global="UserDatabase"</span></span><br><span class="line"><span class="comment">                            type="org.apache.catalina.UserDatabase" </span></span><br><span class="line"><span class="comment">                            factory="org.apache.naming.factory.DataSourceLinkFactory"&gt;</span></span><br><span class="line"><span class="comment">                    &lt;/ResourceLink&gt;</span></span><br><span class="line"><span class="comment">	该工厂创建的对象必须要有userName 和password两个属性,否则错误				</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceLinkFactory</span> <span class="keyword">extends</span> <span class="title">ResourceLinkFactory</span> </span>&#123;</span><br><span class="line">	 <span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?,?&gt; environment)</span> <span class="keyword">throws</span> NamingException </span>&#123; <span class="comment">//该函数由selector.lookup传递过来</span></span><br><span class="line">        Object result = <span class="keyword">super</span>.getObjectInstance(obj, name, nameCtx, environment); <span class="comment">//获取全局资源</span></span><br><span class="line">        <span class="comment">// Can we process this request?</span></span><br><span class="line">        <span class="keyword">if</span> (result!=<span class="keyword">null</span>) &#123;</span><br><span class="line">            Reference ref = (Reference) obj;</span><br><span class="line">            RefAddr userAttr = ref.get(<span class="string">"username"</span>); <span class="comment">//根据userName和password标签处理</span></span><br><span class="line">            RefAddr passAttr = ref.get(<span class="string">"password"</span>); </span><br><span class="line">            <span class="keyword">if</span> (userAttr.getContent()!=<span class="keyword">null</span> &amp;&amp; passAttr.getContent()!=<span class="keyword">null</span>) &#123; <span class="comment">//很明显,当userName和password两个标签为null,此处异常</span></span><br><span class="line">                result = wrapDataSource(result,userAttr.getContent().toString(), passAttr.getContent().toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//这里使用了proxy,以前写自定义数据源的时候用过,主要是DataSourceHandler.invoke的实现</span></span><br><span class="line">	 <span class="function"><span class="keyword">protected</span> Object <span class="title">wrapDataSource</span><span class="params">(Object datasource, String username, String password)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; proxyClass = Proxy.getProxyClass(datasource.getClass().getClassLoader(), datasource.getClass().getInterfaces());</span><br><span class="line">            Constructor&lt;?&gt; proxyConstructor = proxyClass.getConstructor(<span class="keyword">new</span> Class[] &#123; InvocationHandler<span class="class">.<span class="keyword">class</span> &#125;)</span>;</span><br><span class="line">            DataSourceHandler handler = <span class="keyword">new</span> DataSourceHandler((DataSource)datasource, username, password);</span><br><span class="line">            <span class="keyword">return</span> proxyConstructor.newInstance(handler);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">            <span class="keyword">if</span> (x <span class="keyword">instanceof</span> InvocationTargetException) &#123;</span><br><span class="line">                Throwable cause = x.getCause();</span><br><span class="line">                <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> ThreadDeath) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (ThreadDeath) cause;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> VirtualMachineError) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (VirtualMachineError) cause;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Exception) &#123;</span><br><span class="line">                    x = (Exception) cause;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (x <span class="keyword">instanceof</span> NamingException) <span class="keyword">throw</span> (NamingException)x;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                NamingException nx = <span class="keyword">new</span> NamingException(x.getMessage());</span><br><span class="line">                nx.initCause(x);</span><br><span class="line">                <span class="keyword">throw</span> nx;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//扩展:</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">	  <span class="keyword">private</span> <span class="keyword">final</span> DataSource ds;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String username;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String password;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Method getConnection;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DataSourceHandler</span><span class="params">(DataSource ds, String username, String password)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.ds = ds;</span><br><span class="line">            <span class="keyword">this</span>.username = username;</span><br><span class="line">            <span class="keyword">this</span>.password = password;</span><br><span class="line">            getConnection = ds.getClass().getMethod(<span class="string">"getConnection"</span>, String<span class="class">.<span class="keyword">class</span>, <span class="title">String</span>.<span class="title">class</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"getConnection"</span>.equals(method.getName()) &amp;&amp; (args==<span class="keyword">null</span> || args.length==<span class="number">0</span>)) &#123; <span class="comment">//当调用getConection</span></span><br><span class="line">                args = <span class="keyword">new</span> String[] &#123;username,password&#125;;</span><br><span class="line">                method = getConnection; <span class="comment">//将设置为ds的getConnection(user,word)这个函数 </span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"unwrap"</span>.equals(method.getName())) &#123;</span><br><span class="line">                <span class="keyword">return</span> unwrap((Class&lt;?&gt;)args[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> method.invoke(ds,args); <span class="comment">//调用代理函数</span></span><br><span class="line">            &#125;<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                <span class="keyword">if</span> (t <span class="keyword">instanceof</span> InvocationTargetException</span><br><span class="line">                        &amp;&amp; t.getCause() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> t.getCause();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> t;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"><span class="comment">//其他工厂等用到的时候再看</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>tomcat9 关于context的naming资源在web.xml中jndi的解析<br>
在tomcat web.xml配置的信息和在Server.xml 中<Context> 配置的资源一样都是属于局部Context的,注意Tomcat默认给的Server.xml中UserData的type和实际使用的类型不一样,因此默认的那么创建要通过factory这个属性<br>
在context中的资源必须通过 &quot;java:comp/env/…&quot;的路径进行寻找,因为在NamingContextListener处理context类型的时候创建了了两个子上下文</li>
</ul>
<figure class="highlight xml"><figcaption><span>web.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//1.解析web.xml的过程是contextConfig监听器做的,并且发生在context.startInternal,该life监听器激活的顺序大于context.NamingContextListener</span><br><span class="line">//2.当解析web.xml会构建一个WebXml类,存放了关于所有web.xml的信息,在contextConfig某一步过程中将解析到到的关于naming标签创建的Resouce子类加入到context.namingResource中,并随着namingContextListener的激活,注册到对应的jndi中</span><br><span class="line">//3.web.xml解析的resource就属于局部jdni并不是引用,不过应该可以解析引用的</span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>contextConfig</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该监听器进行context加载时复杂的处理,这里截取关于naming的部分</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//1. 构建WebXml 对象,使用degister,并且栈顶第一个元素就是WebXml</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextConfig</span> <span class="keyword">implements</span> <span class="title">LifecycleListener</span></span></span><br><span class="line"><span class="class"><span class="title">protected</span> <span class="title">void</span> <span class="title">webConfig</span>()</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">		WebXmlParser webXmlParser = <span class="keyword">new</span> WebXmlParser(context.getXmlNamespaceAware(), context.getXmlValidation(), context.getXmlBlockExternal());</span><br><span class="line"></span><br><span class="line">        Set&lt;WebXml&gt; defaults = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        defaults.add(getDefaultWebXmlFragment(webXmlParser));</span><br><span class="line"></span><br><span class="line">        Set&lt;WebXml&gt; tomcatWebXml = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        tomcatWebXml.add(getTomcatWebXmlFragment(webXmlParser));</span><br><span class="line"></span><br><span class="line">        WebXml webXml = createWebXml();  <span class="comment">//创建WebXml对象</span></span><br><span class="line">		   <span class="comment">// Parse context level web.xml</span></span><br><span class="line">        InputSource contextWebXml = getContextWebXmlSource();</span><br><span class="line">        <span class="keyword">if</span> (!webXmlParser.parseWebXml(contextWebXml, webXml, <span class="keyword">false</span>)) <span class="comment">//解析,这里将WebXml push进了栈顶</span></span><br><span class="line">        &#123;</span><br><span class="line">            ok = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		.............</span><br><span class="line">		<span class="comment">// Step 9. Apply merged web.xml to Context</span></span><br><span class="line">            <span class="keyword">if</span> (ok)</span><br><span class="line">            &#123;</span><br><span class="line">                configureContext(webXml); <span class="comment">//将webXml中关于naming的资源加入到对应context的namingResource中</span></span><br><span class="line">            &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//处理解析出来的WebXml中数据</span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureContext</span><span class="params">(WebXml webxml)</span></span>&#123;  <span class="comment">//此处不仅仅处理naming资源</span></span><br><span class="line">	 <span class="comment">//解析web.xml中配置的naming资源,并加入到context的namingResources中</span></span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;String, String&gt; entry : webxml.getContextParams().entrySet())</span><br><span class="line">        &#123;</span><br><span class="line">            context.addParameter(entry.getKey(), entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        context.setDenyUncoveredHttpMethods(webxml.getDenyUncoveredHttpMethods());</span><br><span class="line">        context.setDisplayName(webxml.getDisplayName());</span><br><span class="line">        context.setDistributable(webxml.isDistributable());</span><br><span class="line">		<span class="comment">//总之将这些资源添加到context.namingResource中,并且因为这个监听器触发的比NamingContextListener早,因此是一次性bind的</span></span><br><span class="line">        <span class="keyword">for</span> (ContextLocalEjb ejbLocalRef : webxml.getEjbLocalRefs().values())</span><br><span class="line">        &#123;</span><br><span class="line">            context.getNamingResources().addLocalEjb(ejbLocalRef);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (ContextEjb ejbRef : webxml.getEjbRefs().values())</span><br><span class="line">        &#123;</span><br><span class="line">            context.getNamingResources().addEjb(ejbRef);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (ContextEnvironment environment : webxml.getEnvEntries().values())</span><br><span class="line">        &#123;</span><br><span class="line">            context.getNamingResources().addEnvironment(environment);</span><br><span class="line">        &#125;</span><br><span class="line">		....</span><br><span class="line">		<span class="keyword">for</span> (MessageDestinationRef mdr : webxml.getMessageDestinationRefs().values())</span><br><span class="line">        &#123;</span><br><span class="line">            context.getNamingResources().addMessageDestinationRef(mdr);</span><br><span class="line">        &#125;</span><br><span class="line">		 <span class="comment">// Name is just used for ordering</span></span><br><span class="line">        <span class="keyword">for</span> (ContextResourceEnvRef resource : webxml.getResourceEnvRefs().values())</span><br><span class="line">        &#123;</span><br><span class="line">            context.getNamingResources().addResourceEnvRef(resource);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (ContextResource resource : webxml.getResourceRefs().values())</span><br><span class="line">        &#123;</span><br><span class="line">            context.getNamingResources().addResource(resource);</span><br><span class="line">        &#125;</span><br><span class="line">		....</span><br><span class="line">		 <span class="keyword">for</span> (ContextService service : webxml.getServiceRefs().values())</span><br><span class="line">        &#123;</span><br><span class="line">            context.getNamingResources().addService(service);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;	</span><br><span class="line"><span class="comment">// webxml解析规则部分</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebRuleSet</span> <span class="keyword">implements</span> <span class="title">RuleSet</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureNamingRules</span><span class="params">(Digester digester)</span> </span>&#123; <span class="comment">//关于解析naming的部分</span></span><br><span class="line"> <span class="comment">//resource-ref</span></span><br><span class="line">        digester.addObjectCreate(fullPrefix + <span class="string">"/resource-ref"</span>,</span><br><span class="line">                                 <span class="string">"org.apache.tomcat.util.descriptor.web.ContextResource"</span>);  <span class="comment">//明显是创建的ContextResource不是ContextResourceLink类型,也就是说创建的和在Server.xml配置的情况类似</span></span><br><span class="line">        digester.addSetNext(fullPrefix + <span class="string">"/resource-ref"</span>,  <span class="comment">//添加到WebXml子类</span></span><br><span class="line">                            <span class="string">"addResourceRef"</span>,</span><br><span class="line">                            <span class="string">"org.apache.tomcat.util.descriptor.web.ContextResource"</span>);</span><br><span class="line">        digester.addCallMethod(fullPrefix + <span class="string">"/resource-ref/description"</span>,  <span class="comment">//设置属性</span></span><br><span class="line">                               <span class="string">"setDescription"</span>, <span class="number">0</span>);</span><br><span class="line">        digester.addCallMethod(fullPrefix + <span class="string">"/resource-ref/res-auth"</span>,</span><br><span class="line">                               <span class="string">"setAuth"</span>, <span class="number">0</span>);</span><br><span class="line">        digester.addCallMethod(fullPrefix + <span class="string">"/resource-ref/res-ref-name"</span>,</span><br><span class="line">                               <span class="string">"setName"</span>, <span class="number">0</span>);</span><br><span class="line">        digester.addCallMethod(fullPrefix + <span class="string">"/resource-ref/res-sharing-scope"</span>,</span><br><span class="line">                               <span class="string">"setScope"</span>, <span class="number">0</span>);</span><br><span class="line">        digester.addCallMethod(fullPrefix + <span class="string">"/resource-ref/res-type"</span>,</span><br><span class="line">                               <span class="string">"setType"</span>, <span class="number">0</span>);</span><br><span class="line">        digester.addRule(fullPrefix + <span class="string">"/resource-ref/mapped-name"</span>,  <span class="comment">//这个规则实际上就是设置内部prop为 mapped-name:value 的键值对,在Server.xml解析过程中除了上述几个属性,多余的也是这么解析的</span></span><br><span class="line">                         <span class="keyword">new</span> MappedNameRule());</span><br><span class="line">        configureInjectionRules(digester, <span class="string">"web-app/resource-ref/"</span>);</span><br><span class="line">		............</span><br><span class="line">		<span class="comment">//结束之后在WebXml对象就有许多关于资源的key-value对</span></span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>
<ul>
<li>如何引用全局资源 <a href="https://tomcat.apache.org/tomcat-9.0-doc/config/context.html#Resource_Links" target="_blank" rel="noopener">https://tomcat.apache.org/tomcat-9.0-doc/config/context.html#Resource_Links</a><br>
1.目前来说我在源码HostConfig位置,tomcat是不会解析Meta-INF中context.xml多余的标签,因此局部引用方式我觉得在context.xml中写没有用<br>
2.在Server.xml <Context>标签配置<ResourceLink><br>
3.ResourceLink标签解析在server.xml解析完成</li>
</ul>
 <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"sharedDataSource"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">global</span>=<span class="string">"sharedDataSource"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">"javax.sql.DataSource"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">factory</span>=<span class="string">"org.apache.tomcat.jdbc.pool.DataSourceFactory"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">alternateUsernameAllowed</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">username</span>=<span class="string">"bar"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">password</span>=<span class="string">"barpass"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">...</span></span></span><br><span class="line"><span class="tag">  <span class="attr">...</span></span></span><br><span class="line">&lt;/GlobalNamingResources&gt;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">"/foo"</span><span class="attr">...</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">ResourceLink</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">"appDataSource"</span>  //表示在<span class="attr">context</span>的<span class="attr">ContextJdni</span>中创建的名字</span></span><br><span class="line"><span class="tag">            <span class="attr">global</span>=<span class="string">"sharedDataSource"</span>  //引用的全局位置</span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">"javax.sql.DataSource"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">factory</span>=<span class="string">"org.apache.naming.factory.DataSourceLinkFactory"</span>  //注意如果填了此项,后边的两个也要填,否则异常</span></span><br><span class="line"><span class="tag">            <span class="attr">username</span>=<span class="string">"foo"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">password</span>=<span class="string">"foopass"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">...</span></span></span><br><span class="line">&lt;/Context&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">"/bar"</span><span class="attr">...</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">ResourceLink</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">"appDataSource"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">global</span>=<span class="string">"sharedDataSource"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">"javax.sql.DataSource"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">...</span></span></span><br><span class="line">&lt;/Context&gt;</span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">fancylight</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/10/06/tomcat/">http://yoursite.com/2018/10/06/tomcat/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">源码    </a></div><div class="post_share"><div class="social-share" data-image="/img/spring.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2018/11/12/%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81-io/"><img class="prev_cover" src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">标准库源码-io</div></div></a></div><div class="next-post pull_right"><a href="/2018/09/05/%E9%93%BE%E6%8E%A5/"><img class="next_cover" src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">链接</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2018/11/12/标准库源码-io/" title="标准库源码-io"><img class="relatedPosts_cover "src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-11-12</div><div class="relatedPosts_title">标准库源码-io</div></div></a></div><div class="relatedPosts_item"><a href="/2019/01/04/标准库源码/" title="标准库源码"><img class="relatedPosts_cover "src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-01-04</div><div class="relatedPosts_title">标准库源码</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '624d139155758ea48077',
  clientSecret: 'cc126a301586ea63779cec6a6b53101749dbc9dd',
  repo: 'gittalk_issue',
  owner: 'fancylight',
  admin: ['fancylight'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By fancylight</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script></body></html>