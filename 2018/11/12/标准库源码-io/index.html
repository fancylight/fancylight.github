<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>标准库源码-io | 博客</title><meta name="description" content="标准库源码-io"><meta name="keywords" content="源码"><meta name="author" content="fancylight"><meta name="copyright" content="fancylight"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="标准库源码-io"><meta name="twitter:description" content="标准库源码-io"><meta name="twitter:image" content="http://yoursite.com/img/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="标准库源码-io"><meta property="og:url" content="http://yoursite.com/2018/11/12/%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81-io/"><meta property="og:site_name" content="博客"><meta property="og:description" content="标准库源码-io"><meta property="og:image" content="http://yoursite.com/img/post.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      now = new Date();
      hour = now.getHours();
      isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2018/11/12/%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81-io/"><link rel="prev" title="c++基础" href="http://yoursite.com/2019/01/04/c-%E5%9F%BA%E7%A1%80/"><link rel="next" title="tomcat" href="http://yoursite.com/2018/10/06/tomcat/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: false,
  highlightShrink: false,
  isFontAwesomeV5: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">37</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">14</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#c-io概述"><span class="toc-number">1.</span> <span class="toc-text">c++ io概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#local"><span class="toc-number">1.1.</span> <span class="toc-text">local</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ios-bsae"><span class="toc-number">1.2.</span> <span class="toc-text">ios_bsae</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#basic-ios-ios-public-ios-bsae"><span class="toc-number">1.3.</span> <span class="toc-text">basic_ios(ios):public ios_bsae</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#basic-streambuf"><span class="toc-number">1.4.</span> <span class="toc-text">basic_streambuf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#basic-ostream-ostream"><span class="toc-number">1.5.</span> <span class="toc-text">basic_ostream(ostream)</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span></div><div id="post-info"><div id="post-title"><div class="posttitle">标准库源码-io</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2018-11-12<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-05-09</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/C/">C</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h2 id="c-io概述"><a class="header-anchor" href="#c-io概述">¶</a>c++ io概述</h2>
<img src="/2018/11/12/%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81-io/io.png" class="">
<p>补充:</p>
<ol>
<li>关于postypes.h 定义的类型</li>
</ol>
<img src="/2018/11/12/%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81-io/fpos.png" class="">
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _GLIBCXX_HAVE_INT64_T_LONG</span></span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">long</span>          streamoff;  <span class="comment">//表示相对的文件/流位置（距 fpos 的偏移），足以表示任何文件大小</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(_GLIBCXX_HAVE_INT64_T_LONG_LONG)</span></span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span>     streamoff;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(_GLIBCXX_HAVE_INT64_T) </span></span><br><span class="line"> <span class="keyword">typedef</span> <span class="keyword">ptrdiff_t</span>	streamsize <span class="comment">//ptrdiff_t 表示指针间距离=(addr1-addr2)/typeSize  如 (int* -int*)/4</span></span><br><span class="line"> <span class="comment">//streamsize 表示 I/O 操作中传输的字符数，或 I/O 缓冲区的大小 </span></span><br><span class="line"> <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _StateT&gt;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">fpos</span> //表示流或文件中的绝对位置 (<span class="title">filePosition</span>?)</span></span><br><span class="line"><span class="class">    &#123;</span>&#125;</span><br><span class="line"> <span class="comment">//以下表示泛型特化   </span></span><br><span class="line">  <span class="keyword">typedef</span> fpos&lt;<span class="keyword">mbstate_t</span>&gt; streampos;</span><br><span class="line">  <span class="comment">/// File position for wchar_t streams.</span></span><br><span class="line">  <span class="keyword">typedef</span> fpos&lt;<span class="keyword">mbstate_t</span>&gt; wstreampos;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __cplusplus &gt;= 201103L</span></span><br><span class="line">  <span class="comment">/// File position for char16_t streams.</span></span><br><span class="line">  <span class="keyword">typedef</span> fpos&lt;<span class="keyword">mbstate_t</span>&gt; u16streampos;</span><br><span class="line">  <span class="comment">/// File position for char32_t streams.</span></span><br><span class="line">  <span class="keyword">typedef</span> fpos&lt;<span class="keyword">mbstate_t</span>&gt; u32streampos;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">typedef</span> fpos&lt;<span class="keyword">mbstate_t</span>&gt; streampos;  <span class="comment">//fpos表示的就是流的位置</span></span><br><span class="line">  <span class="comment">/// File position for wchar_t streams.</span></span><br><span class="line">  <span class="keyword">typedef</span> fpos&lt;<span class="keyword">mbstate_t</span>&gt; wstreampos;</span><br></pre></td></tr></table></figure>
<h3 id="local"><a class="header-anchor" href="#local">¶</a>local</h3>
<img src="/2018/11/12/%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81-io/locale.png" class="" title="locale.h">
<p>local是所有io类中都含有的一个成员属性,它完成了关于本地化的相关操作</p>
<figure class="highlight cpp"><figcaption><span>locale.class</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">typedef</span> <span class="keyword">int</span>	category;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Forward decls and friends:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">facet</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">id</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> _<span class="title">Impl</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">facet</span>;</span>  <span class="comment">//它完成了各式的本地化操作</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> _<span class="title">Impl</span>;</span></span><br><span class="line">    <span class="comment">//这三个实现在tcc中</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Facet&gt;</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">bool</span></span><br><span class="line">      has_facet(<span class="keyword">const</span> locale&amp;) <span class="keyword">throw</span>();</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Facet&gt;</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">const</span> _Facet&amp;</span><br><span class="line">      use_facet(<span class="keyword">const</span> locale&amp;);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Cache&gt;</span><br><span class="line">      <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> __<span class="title">use_cache</span>;</span></span><br><span class="line">  <span class="comment">//这实际上就是平面的类型    </span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> category none		= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> category ctype		= <span class="number">1L</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> category numeric	= <span class="number">1L</span> &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> category collate	= <span class="number">1L</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> category time		= <span class="number">1L</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> category monetary	= <span class="number">1L</span> &lt;&lt; <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> category messages	= <span class="number">1L</span> &lt;&lt; <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> category all		= (ctype | numeric | collate |</span><br><span class="line">					   time  | monetary | messages);</span><br><span class="line"><span class="keyword">private</span>: <span class="comment">//私有属性                       </span></span><br><span class="line">    <span class="comment">// The (shared) implementation</span></span><br><span class="line">    _Impl*		_M_impl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The "C" reference locale</span></span><br><span class="line">    <span class="keyword">static</span> _Impl*       _S_classic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Current global locale</span></span><br><span class="line">    <span class="keyword">static</span> _Impl*	_S_global;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Names of underlying locale categories.</span></span><br><span class="line">    <span class="comment">// NB: locale::global() has to know how to modify all the</span></span><br><span class="line">    <span class="comment">// underlying categories, not just the ones required by the C++</span></span><br><span class="line">    <span class="comment">// standard.</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span>* <span class="keyword">const</span> _S_categories;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><figcaption><span>impl.class</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// Friends.</span></span><br><span class="line">  <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">locale</span>;</span></span><br><span class="line">  <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">locale</span>:</span>:facet;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Facet&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">bool</span></span><br><span class="line">    has_facet(<span class="keyword">const</span> locale&amp;) <span class="keyword">throw</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Facet&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">const</span> _Facet&amp;</span><br><span class="line">    use_facet(<span class="keyword">const</span> locale&amp;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Cache&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> __<span class="title">use_cache</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// Data Members.</span></span><br><span class="line">  <span class="comment">//关于facet /id的声明文件中,并不能看到有用的信息,总之facet是基类,id用来表示facet,impl则是locale具体行为的类,它持有了facet和id成员</span></span><br><span class="line">  </span><br><span class="line">  _Atomic_word			_M_refcount;</span><br><span class="line">  <span class="keyword">const</span> facet**			_M_facets;</span><br><span class="line">  <span class="keyword">size_t</span>				_M_facets_size;</span><br><span class="line">  <span class="keyword">const</span> facet**			_M_caches;</span><br><span class="line">  <span class="keyword">char</span>**				_M_names;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> locale::id* <span class="keyword">const</span>	_S_id_ctype[];</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> locale::id* <span class="keyword">const</span>	_S_id_numeric[];</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> locale::id* <span class="keyword">const</span>	_S_id_collate[];</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> locale::id* <span class="keyword">const</span>	_S_id_time[];</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> locale::id* <span class="keyword">const</span>	_S_id_monetary[];</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> locale::id* <span class="keyword">const</span>	_S_id_messages[];</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> locale::id* <span class="keyword">const</span>* <span class="keyword">const</span> _S_facet_categories[];</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><figcaption><span>collate:facet</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Facet for localized string comparison.  //该平面是用来比较字符串的</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *  This facet encapsulates the code to compare strings in a localized</span></span><br><span class="line"><span class="comment">   *  manner.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *  The collate template uses protected virtual functions to provide</span></span><br><span class="line"><span class="comment">   *  the actual results.  The public accessors forward the call to</span></span><br><span class="line"><span class="comment">   *  the virtual functions.  These virtual functions are hooks for</span></span><br><span class="line"><span class="comment">   *  developers to implement the behavior they require from the</span></span><br><span class="line"><span class="comment">   *  collate facet.  //该类虚函数可以由子类决定实现</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT&gt;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> _<span class="title">GLIBCXX_NAMESPACE_CXX11</span> <span class="title">collate</span> :</span> <span class="keyword">public</span> locale::facet</span><br><span class="line">    &#123;  </span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> _CharT			char_type;</span><br><span class="line">      <span class="keyword">typedef</span> basic_string&lt;_CharT&gt;	string_type;</span><br><span class="line">      <span class="comment">//比如:</span></span><br><span class="line">       <span class="keyword">int</span></span><br><span class="line">      compare(<span class="keyword">const</span> _CharT* __lo1, <span class="keyword">const</span> _CharT* __hi1,</span><br><span class="line">	      <span class="keyword">const</span> _CharT* __lo2, <span class="keyword">const</span> _CharT* __hi2) <span class="keyword">const</span></span><br><span class="line">      &#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;do_compare(__lo1, __hi1, __lo2, __hi2); &#125;</span><br><span class="line">      <span class="comment">//虚</span></span><br><span class="line">            <span class="keyword">virtual</span> <span class="keyword">int</span></span><br><span class="line">      do_compare(<span class="keyword">const</span> _CharT* __lo1, <span class="keyword">const</span> _CharT* __hi1,</span><br><span class="line">		 <span class="keyword">const</span> _CharT* __lo2, <span class="keyword">const</span> _CharT* __hi2) <span class="keyword">const</span>; <span class="comment">//此处没有写成=0,tcc中也没有实现,不能确定是否库中没有实现</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><figcaption><span>num_put: public locale::facet</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该平面定义在locale_facets.中,起到了对于整形进行格式化,os的buf中的工作</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Primary class template num_put.</span></span><br><span class="line"><span class="comment">   *  @ingroup locales</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *  This facet encapsulates the code to convert a number to a string.  It is</span></span><br><span class="line"><span class="comment">   *  used by the ostream numeric insertion operators. //当os进行numberic输出操作时,将数字转换为字符串</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *  The num_put template uses protected virtual functions to provide the</span></span><br><span class="line"><span class="comment">   *  actual results.  The public accessors forward the call to the virtual</span></span><br><span class="line"><span class="comment">   *  functions.  These virtual functions are hooks for developers to</span></span><br><span class="line"><span class="comment">   *  implement the behavior they require from the num_put facet.  </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _OutIter&gt;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">num_put</span> :</span> <span class="keyword">public</span> locale::facet</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> _CharT		char_type;</span><br><span class="line">    <span class="keyword">typedef</span> _OutIter    iter_type; <span class="comment">//buf迭代器,见下文</span></span><br><span class="line">    <span class="comment">//典型的函数</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Numeric formatting.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  Formats the boolean @a v and inserts it into a stream.  It does so</span></span><br><span class="line"><span class="comment">       *  by calling num_put::do_put().</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  If ios_base::boolalpha is set, writes ctype&lt;CharT&gt;::truename() or</span></span><br><span class="line"><span class="comment">       *  ctype&lt;CharT&gt;::falsename().  Otherwise formats @a v as an int.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  @param  __s  Stream to write to.</span></span><br><span class="line"><span class="comment">       *  @param  __io  Source of locale and flags.</span></span><br><span class="line"><span class="comment">       *  @param  __fill  Char_type to use for filling.</span></span><br><span class="line"><span class="comment">       *  @param  __v  Value to format and insert.</span></span><br><span class="line"><span class="comment">       *  @return  Iterator after writing.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     iter_type</span><br><span class="line">      put(iter_type __s, ios_base&amp; __io, char_type __fill, <span class="keyword">bool</span> __v) <span class="keyword">const</span></span><br><span class="line">      &#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;do_put(__s, __io, __fill, __v); &#125; <span class="comment">//该函数实现也可以在locale_facet.h中找到</span></span><br><span class="line">      <span class="comment">//tcc实现</span></span><br><span class="line">       <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _OutIter&gt;</span><br><span class="line">    _OutIter</span><br><span class="line">    num_put&lt;_CharT, _OutIter&gt;::</span><br><span class="line">    do_put(iter_type __s, ios_base&amp; __io, char_type __fill, <span class="keyword">bool</span> __v) <span class="keyword">const</span> <span class="comment">//对bool类型进行格式化</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> ios_base::fmtflags __flags = __io.flags();</span><br><span class="line">      <span class="keyword">if</span> ((__flags &amp; ios_base::boolalpha) == <span class="number">0</span>) <span class="comment">//当不是boolalpha控制符时</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">const</span> <span class="keyword">long</span> __l = __v;</span><br><span class="line">          __s = _M_insert_int(__s, __io, __fill, __l); <span class="comment">//调用这个插入</span></span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">	  <span class="keyword">typedef</span> __numpunct_cache&lt;_CharT&gt;              __cache_type; <span class="comment">//声明在locale_facets.h中</span></span><br><span class="line">	  __use_cache&lt;__cache_type&gt; __uc;</span><br><span class="line">	  <span class="keyword">const</span> locale&amp; __loc = __io._M_getloc();</span><br><span class="line">	  <span class="keyword">const</span> __cache_type* __lc = __uc(__loc);       <span class="comment">//__uc(__loc)这是一个函数操作符,返回__numpunct_cache指针</span></span><br><span class="line"></span><br><span class="line">	  <span class="keyword">const</span> _CharT* __name = __v ? __lc-&gt;_M_truename</span><br><span class="line">	                             : __lc-&gt;_M_falsename;  <span class="comment">//改变bool为string类型的"true"/"false"</span></span><br><span class="line">	  <span class="keyword">int</span> __len = __v ? __lc-&gt;_M_truename_size</span><br><span class="line">	                  : __lc-&gt;_M_falsename_size;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">const</span> streamsize __w = __io.width();</span><br><span class="line">	  <span class="keyword">if</span> (__w &gt; <span class="keyword">static_cast</span>&lt;streamsize&gt;(__len))</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">const</span> streamsize __plen = __w - __len;</span><br><span class="line">	      _CharT* __ps</span><br><span class="line">		= <span class="keyword">static_cast</span>&lt;_CharT*&gt;(__builtin_alloca(<span class="keyword">sizeof</span>(_CharT)</span><br><span class="line">							* __plen));</span><br><span class="line"></span><br><span class="line">	      char_traits&lt;_CharT&gt;::assign(__ps, __plen, __fill);</span><br><span class="line">	      __io.width(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	      <span class="keyword">if</span> ((__flags &amp; ios_base::adjustfield) == ios_base::left)</span><br><span class="line">		&#123;</span><br><span class="line">		  __s = <span class="built_in">std</span>::__write(__s, __name, __len);   <span class="comment">//明显此函数才是进行buf插入的操作</span></span><br><span class="line">		  __s = <span class="built_in">std</span>::__write(__s, __ps, __plen);</span><br><span class="line">		&#125;</span><br><span class="line">	      <span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">		  __s = <span class="built_in">std</span>::__write(__s, __ps, __plen);</span><br><span class="line">		  __s = <span class="built_in">std</span>::__write(__s, __name, __len);</span><br><span class="line">		&#125;</span><br><span class="line">	      <span class="keyword">return</span> __s;</span><br><span class="line">	    &#125;</span><br><span class="line">	  __io.width(<span class="number">0</span>);</span><br><span class="line">	  __s = <span class="built_in">std</span>::__write(__s, __name, __len);</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">return</span> __s;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//插入整形</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _OutIter&gt;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _ValueT&gt;</span><br><span class="line">      _OutIter</span><br><span class="line">      num_put&lt;_CharT, _OutIter&gt;::</span><br><span class="line">      _M_insert_int(_OutIter __s, ios_base&amp; __io, _CharT __fill,</span><br><span class="line">		    _ValueT __v) <span class="keyword">const</span></span><br><span class="line">      &#123;</span><br><span class="line">      <span class="comment">//获取一些必要信息</span></span><br><span class="line">	<span class="keyword">using</span> __gnu_cxx::__add_unsigned;</span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">typename</span> __add_unsigned&lt;_ValueT&gt;::__type __unsigned_type;</span><br><span class="line">	<span class="keyword">typedef</span> __numpunct_cache&lt;_CharT&gt;	             __cache_type;</span><br><span class="line">	__use_cache&lt;__cache_type&gt; __uc;</span><br><span class="line">	<span class="keyword">const</span> locale&amp; __loc = __io._M_getloc();</span><br><span class="line">	<span class="keyword">const</span> __cache_type* __lc = __uc(__loc);</span><br><span class="line">	<span class="keyword">const</span> _CharT* __lit = __lc-&gt;_M_atoms_out;</span><br><span class="line">	<span class="keyword">const</span> ios_base::fmtflags __flags = __io.flags();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Long enough to hold hex, dec, and octal representations.  由于要将num转换为字符串,并且要保证不同进制,进行了空间分配</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> __ilen = <span class="number">5</span> * <span class="keyword">sizeof</span>(_ValueT);</span><br><span class="line">	_CharT* __cs = <span class="keyword">static_cast</span>&lt;_CharT*&gt;(__builtin_alloca(<span class="keyword">sizeof</span>(_CharT)</span><br><span class="line">							     * __ilen)); <span class="comment">//用来容纳任意整形改变成不同进制字符的char/wchar_t*</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// [22.2.2.2.2] Stage 1, numeric conversion to character.</span></span><br><span class="line">	<span class="comment">// Result is returned right-justified in the buffer.</span></span><br><span class="line">	<span class="keyword">const</span> ios_base::fmtflags __basefield = __flags &amp; ios_base::basefield;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">bool</span> __dec = (__basefield != ios_base::oct</span><br><span class="line">			    &amp;&amp; __basefield != ios_base::hex);</span><br><span class="line">	<span class="keyword">const</span> __unsigned_type __u = ((__v &gt; <span class="number">0</span> || !__dec)</span><br><span class="line">				     ? __unsigned_type(__v)</span><br><span class="line">				     : -__unsigned_type(__v));  <span class="comment">//你按照有无符号转换截断原则就知道了,v&lt;0&amp;&amp;__dec时,负数转换为同余正数</span></span><br><span class="line"> 	<span class="keyword">int</span> __len = __int_to_char(__cs + __ilen, __u, __lit, __flags, __dec);<span class="comment">//这个函数就是做生成进制字符串操作</span></span><br><span class="line">	__cs += __ilen - __len;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add grouping, if necessary.</span></span><br><span class="line">	<span class="keyword">if</span> (__lc-&gt;_M_use_grouping)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Grouping can add (almost) as many separators as the number</span></span><br><span class="line">	    <span class="comment">// of digits + space is reserved for numeric base or sign.</span></span><br><span class="line">	    _CharT* __cs2 = <span class="keyword">static_cast</span>&lt;_CharT*&gt;(__builtin_alloca(<span class="keyword">sizeof</span>(_CharT)</span><br><span class="line">								  * (__len + <span class="number">1</span>)</span><br><span class="line">								  * <span class="number">2</span>));</span><br><span class="line">	    _M_group_int(__lc-&gt;_M_grouping, __lc-&gt;_M_grouping_size,</span><br><span class="line">			 __lc-&gt;_M_thousands_sep, __io, __cs2 + <span class="number">2</span>, __cs, __len);</span><br><span class="line">	    __cs = __cs2 + <span class="number">2</span>;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Complete Stage 1, prepend numeric base or sign.</span></span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect(__dec, <span class="literal">true</span>))</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Decimal.</span></span><br><span class="line">	    <span class="keyword">if</span> (__v &gt;= <span class="number">0</span>)</span><br><span class="line">	      &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">bool</span>(__flags &amp; ios_base::showpos)</span><br><span class="line">		    &amp;&amp; __gnu_cxx::__numeric_traits&lt;_ValueT&gt;::__is_signed)</span><br><span class="line">		  *--__cs = __lit[__num_base::_S_oplus], ++__len;</span><br><span class="line">	      &#125;</span><br><span class="line">	    <span class="keyword">else</span></span><br><span class="line">	      *--__cs = __lit[__num_base::_S_ominus], ++__len;</span><br><span class="line">	  &#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">bool</span>(__flags &amp; ios_base::showbase) &amp;&amp; __v)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="keyword">if</span> (__basefield == ios_base::oct)</span><br><span class="line">	      *--__cs = __lit[__num_base::_S_odigits], ++__len;</span><br><span class="line">	    <span class="keyword">else</span></span><br><span class="line">	      &#123;</span><br><span class="line">		<span class="comment">// 'x' or 'X'</span></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> __uppercase = __flags &amp; ios_base::uppercase;</span><br><span class="line">		*--__cs = __lit[__num_base::_S_ox + __uppercase];</span><br><span class="line">		<span class="comment">// '0'</span></span><br><span class="line">		*--__cs = __lit[__num_base::_S_odigits];</span><br><span class="line">		__len += <span class="number">2</span>;</span><br><span class="line">	      &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Pad.</span></span><br><span class="line">	<span class="keyword">const</span> streamsize __w = __io.width();</span><br><span class="line">	<span class="keyword">if</span> (__w &gt; <span class="keyword">static_cast</span>&lt;streamsize&gt;(__len))</span><br><span class="line">	  &#123;</span><br><span class="line">	    _CharT* __cs3 = <span class="keyword">static_cast</span>&lt;_CharT*&gt;(__builtin_alloca(<span class="keyword">sizeof</span>(_CharT)</span><br><span class="line">								  * __w));</span><br><span class="line">	    _M_pad(__fill, __w, __io, __cs3, __cs, __len);</span><br><span class="line">	    __cs = __cs3;</span><br><span class="line">	  &#125;</span><br><span class="line">	__io.width(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// [22.2.2.2.2] Stage 4.</span></span><br><span class="line">	<span class="comment">// Write resulting, fully-formatted string to output iterator.</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">std</span>::__write(__s, __cs, __len);  <span class="comment">//最终写回还是这个函数</span></span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">     <span class="comment">//在clion MinGW环境下,ide不会显示这些虚函数的定义和子类,文件路径mingw530_32\i686-w64-mingw32\include\c++\bits</span></span><br><span class="line">    <span class="comment">//std::__write的调用,</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT&gt;</span><br><span class="line">    <span class="keyword">inline</span></span><br><span class="line">    ostreambuf_iterator&lt;_CharT&gt;</span><br><span class="line">    __write(ostreambuf_iterator&lt;_CharT&gt; __s, <span class="keyword">const</span> _CharT* __ws, <span class="keyword">int</span> __len)</span><br><span class="line">    &#123;</span><br><span class="line">      __s._M_put(__ws, __len);  <span class="comment">//这个函数实际调用了buf中的sputn函数</span></span><br><span class="line">      <span class="keyword">return</span> __s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is the unspecialized form of the template. 非特化版本</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _OutIter&gt;</span><br><span class="line">    <span class="keyword">inline</span></span><br><span class="line">    _OutIter</span><br><span class="line">    __write(_OutIter __s, <span class="keyword">const</span> _CharT* __ws, <span class="keyword">int</span> __len)  <span class="comment">//逻辑上来看就是插入到buf当前空闲位置,然后将迭代器移动</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> __j = <span class="number">0</span>; __j &lt; __len; __j++, ++__s)</span><br><span class="line">	*__s = __ws[__j];</span><br><span class="line">      <span class="keyword">return</span> __s;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">//与o向对应的i操作,其基本读操作都是_M_extract_int类似这样的函数  </span></span><br><span class="line"> <span class="comment">//这是一部分</span></span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">bool</span> __negative = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (!__testeof)</span><br><span class="line">	  &#123;</span><br><span class="line">	    __c = *__beg;</span><br><span class="line">	    __negative = __c == __lit[__num_base::_S_iminus];</span><br><span class="line">	    <span class="keyword">if</span> ((__negative || __c == __lit[__num_base::_S_iplus])</span><br><span class="line">		&amp;&amp; !(__lc-&gt;_M_use_grouping &amp;&amp; __c == __lc-&gt;_M_thousands_sep)</span><br><span class="line">		&amp;&amp; !(__c == __lc-&gt;_M_decimal_point))</span><br><span class="line">	      &#123;</span><br><span class="line">		<span class="keyword">if</span> (++__beg != __end)  <span class="comment">//beg这个迭代器的操作就是对内部buf的操作</span></span><br><span class="line">		  __c = *__beg;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		  __testeof = <span class="literal">true</span>;</span><br><span class="line">	      &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="ios-bsae"><a class="header-anchor" href="#ios-bsae">¶</a>ios_bsae</h3>
<p>定义:管理格式化标准以及相关异常<br>
声明在 ios_base.h中 iosfwd.h声明了向前泛型声明和类型别名</p>
<img src="/2018/11/12/%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81-io/ios_base.png" class="">
<ol>
<li>fmtflag<br>
<a href="//1.fmtflags" target="_blank" rel="noopener">//1.fmtflags</a><br>
常量	解释<br>
dec	为整数 I/O 使用十进制底：见 std::dec<br>
oct	为整数 I/O 使用八进制底：见 std::oct<br>
hex	为整数 I/O 使用十六进制底：见 std::hex<br>
basefield	dec|oct|hex 。适用于掩码运算<br>
left	左校正（添加填充字符到右）：见 std::left<br>
right	右校正（添加填充字符到左）：见 std::right<br>
internal	内部校正（添加填充字符到内部选定点）：见 std::internal<br>
adjustfield	left|right|internal 。适用于掩码运算<br>
scientific	用科学记数法生成浮点类型，或若与 fixed 组合则用十六进制记法：见 std::scientific<br>
fixed	用定点记法生成浮点类型，或若与 scientific 组合则用十六进制记法：见 std::fixed<br>
floatfield	scientific|fixed 。适用于掩码运算<br>
boolalpha	以字母数字格式插入并释出 bool 类型：见 std::boolalpha<br>
showbase	生成为整数输出指示数字基底的前缀，货币 I/O 中要求现金指示器：见 std::showbase<br>
showpoint	无条件为浮点数输出生成小数点字符：见 std::showpoint<br>
showpos	为非负数值输出生成 + 字符，见 std::showpos<br>
skipws	在具体输入操作前跳过前导空白符：见 std::skipws<br>
unitbuf	在每次输出操作后冲入输出：见 std::unitbuf<br>
uppercase	在具体输出的输出操作中以大写等价替换小写字符：见 std::uppercase</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> myIoTest::ios_base_test::flagEnumTest() &#123;</span><br><span class="line">    <span class="comment">//以hex输出</span></span><br><span class="line">    <span class="built_in">cout</span>.setf(ios_base::hex, ios::basefield);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="number">15</span> &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">    <span class="comment">//left | right :修改填充字符的默认定位。 left 与 right 应用到任何输出，而 internal 应用到整数、浮点和货币输出。在输入时无效果。</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Left fill:\n"</span> &lt;&lt; <span class="built_in">std</span>::left &lt;&lt; setfill(<span class="string">'*'</span>) <span class="comment">//os.setFill('*')</span></span><br><span class="line">         &lt;&lt; setw(<span class="number">12</span>) &lt;&lt; <span class="number">-1.23</span> &lt;&lt; <span class="string">'\n'</span></span><br><span class="line">         &lt;&lt; setw(<span class="number">12</span>) &lt;&lt; hex &lt;&lt; showbase &lt;&lt; <span class="number">42</span> &lt;&lt; <span class="string">'\n'</span></span><br><span class="line">         &lt;&lt; setw(<span class="number">12</span>) &lt;&lt; put_money(<span class="number">123</span>, <span class="literal">true</span>) &lt;&lt; <span class="string">"\n\n"</span>;</span><br><span class="line">    <span class="comment">//boolalpha 将缓冲使用bool量解释</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; boolalpha &lt;&lt; <span class="literal">true</span> &lt;&lt; <span class="string">"\n"</span> &lt;&lt; <span class="literal">false</span> &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">    <span class="function"><span class="built_in">istringstream</span> <span class="title">istringstream1</span><span class="params">(<span class="string">"true false"</span>)</span></span>;</span><br><span class="line">    <span class="keyword">bool</span> b1, b2;</span><br><span class="line">    istringstream1 &gt;&gt; boolalpha &gt;&gt; b1 &gt;&gt; b2;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; dec &lt;&lt; noboolalpha &lt;&lt; <span class="string">"true false is parse"</span> &lt;&lt; <span class="string">" "</span> &lt;&lt; b1 &lt;&lt; <span class="string">" "</span> &lt;&lt; b2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//1. os&lt;&lt; 一般来说 &lt;&lt;都是重写的,而且都不是成员操作符,也就是接受两边值,同时返回一个值</span></span><br><span class="line"><span class="comment">//2. setw=width()</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>std::ios_base::openmode  定义在ios_base.h中的一个enum<br>
常量	解释<br>
app	每次写入前寻位到流结尾<br>
binary	以二进制模式打开<br>
in	为读打开<br>
out	为写打开<br>
trunc	在打开时舍弃流的内容<br>
ate	打开后立即寻位到流结尾</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//例子:</span></span><br><span class="line"><span class="keyword">void</span> myIoTest::ios_base_test::openModeTest() &#123;</span><br><span class="line">    ifstream ifstream1;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* path;</span><br><span class="line">    ifstream1.<span class="built_in">open</span>(path);  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//源码:</span></span><br><span class="line"><span class="comment">//fstream.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">class</span> <span class="title">basic_ifstream</span> :</span> <span class="keyword">public</span> basic_istream&lt;_CharT, _Traits&gt; &#123;</span><br><span class="line">        <span class="keyword">typedef</span> basic_filebuf&lt;char_type, traits_type&gt; __filebuf_type; <span class="comment">//basic_filebuf也是定义在该文件中的一个类,和ifstream 是has a关系</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">        __filebuf_type _M_filebuf;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *__s, ios_base::openmode __mode = ios_base::in)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!_M_filebuf.<span class="built_in">open</span>(__s, __mode | ios_base::in)) <span class="comment">//实际上open都是basic_filebuf.open(),底层实现看不到</span></span><br><span class="line">                <span class="keyword">this</span>-&gt;setstate(ios_base::failbit);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">this</span>-&gt;<span class="built_in">clear</span>();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>iostate 依旧定义在ios_bsae.h中的enum<br>
常量	解释<br>
goodbit	无错误<br>
badbit	不可恢复的流错误<br>
failbit	输入/输出操作失败（格式化或提取错误）<br>
eofbit	关联的输出序列已抵达文件尾</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//eofbit</span></span><br><span class="line"><span class="number">1.</span> <span class="built_in">string</span> 输入函数 <span class="built_in">std</span>::getline ，若它以抵达流结尾，而非抵达指定的终止字符完成。</span><br><span class="line"><span class="number">2.</span> basic_istream::<span class="keyword">operator</span>&gt;&gt; 的数值输入重载，若在 num_get::<span class="built_in">get</span> 处理的阶段 <span class="number">2</span> ，读取下个字符时遇到流结尾。取决于分析</span><br><span class="line">状态，可能或可能不同时设置 failbit ：例如 <span class="keyword">int</span> n; <span class="function"><span class="built_in">istringstream</span> <span class="title">buf</span><span class="params">(<span class="string">"1"</span>)</span></span>; buf &gt;&gt; n; 设置 eofbit ，但不设置 </span><br><span class="line">failbit ：成功分析整数 <span class="number">1</span> 并存储之于 n 。另一方面， <span class="keyword">bool</span> b; <span class="function"><span class="built_in">istringstream</span> <span class="title">buf</span><span class="params">(<span class="string">"tr"</span>)</span></span>; buf &gt;&gt; boolalpha &gt;&gt; b; 一同</span><br><span class="line">设置 eofbit 和 failbit ：无足够的字符完成布尔 <span class="literal">true</span> 的分析。</span><br><span class="line"><span class="number">3.</span> <span class="keyword">operator</span>&gt;&gt;<span class="built_in">std</span>::basic_istream 的字符释出重载，若在释出字符数量上的限制（若存在）前抵达流结尾。</span><br></pre></td></tr></table></figure>
<pre><code>可查阅[iostate](https://zh.cppreference.com/w/cpp/io/ios_base/iostate)
</code></pre>
<ol start="4">
<li>seekdir ios_base.h中enum<br>
beg	流的开始<br>
end	流的结尾<br>
cur	流位置指示器的当前位置</li>
<li>内部定义函数</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.flags</span></span><br><span class="line"><span class="function">fmtflags <span class="title">flags</span><span class="params">()</span> <span class="keyword">const</span></span>;(<span class="number">1</span>)	</span><br><span class="line"><span class="function">fmtflags <span class="title">flags</span><span class="params">( fmtflags flags )</span></span>;(<span class="number">2</span>)</span><br><span class="line">管理格式化标志。</span><br><span class="line"><span class="number">1</span>) 返回当前格式化设置。</span><br><span class="line"><span class="number">2</span>) 以给定者替换当前设置。</span><br><span class="line"><span class="comment">//2.setf</span></span><br><span class="line"><span class="function">fmtflags <span class="title">setf</span><span class="params">( fmtflags flags )</span></span>;(<span class="number">1</span>)	</span><br><span class="line"><span class="function">fmtflags <span class="title">setf</span><span class="params">( fmtflags flags, fmtflags mask )</span></span>;(<span class="number">2</span>)</span><br><span class="line">设置格式化标志以指定设置。</span><br><span class="line"><span class="number">1</span>) 设置 flags 所标识的格式化标志。等效地进行下列操作： fl = fl | flags ，其中 fl 定义内部格式化标志的状态。</span><br><span class="line"><span class="number">2</span>) 清除 mask 下的格式化标志，并设置被清除的标志为 flags 所指定者。等效地进行下列操作： fl = (fl &amp; ~mask) | (flags &amp; mask) ，其中 fl 定义格式化标志的内部状态。</span><br><span class="line"><span class="comment">//源码:</span></span><br><span class="line">  fmtflags</span><br><span class="line">    setf(fmtflags __fmtfl)</span><br><span class="line">    &#123;</span><br><span class="line">      fmtflags __old = _M_flags;</span><br><span class="line">      _M_flags |= __fmtfl;  <span class="comment">//添加 __fmtfl到现有fmt中</span></span><br><span class="line">      <span class="keyword">return</span> __old;</span><br><span class="line">    &#125;</span><br><span class="line">    fmtflags</span><br><span class="line">    setf(fmtflags __fmtfl, fmtflags __mask)</span><br><span class="line">    &#123;</span><br><span class="line">      fmtflags __old = _M_flags;</span><br><span class="line">      _M_flags &amp;= ~__mask;   <span class="comment">//清除fmtflags __mask</span></span><br><span class="line">      _M_flags |= (__fmtfl &amp; __mask);  <span class="comment">//将__fmtfl添加</span></span><br><span class="line">      <span class="keyword">return</span> __old;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//3.unsetf</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unsetf</span><span class="params">( fmtflags flags )</span></span>; <span class="comment">//清除对应的fmt</span></span><br><span class="line"><span class="comment">//4.precision</span></span><br><span class="line"><span class="function">streamsize <span class="title">precision</span><span class="params">()</span> <span class="keyword">const</span></span>;(<span class="number">1</span>)	</span><br><span class="line"><span class="function">streamsize <span class="title">precision</span><span class="params">( streamsize new_precision )</span></span>;(<span class="number">2</span>)	</span><br><span class="line">管理 <span class="built_in">std</span>::num_put::do_put 所进行的浮点输出精度（即生成多少数位）。</span><br><span class="line"><span class="number">1</span>) 返回当前精度。</span><br><span class="line"><span class="number">2</span>) 设置精度为给定值。</span><br><span class="line"><span class="built_in">std</span>::basic_ios::init 所建立的默认精度为 <span class="number">6</span> 。</span><br><span class="line"><span class="keyword">void</span> myIoTest::ios_base_test::precisionTest() &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">double</span> d=<span class="number">2.234234324</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;setprecision(<span class="number">3</span>)&lt;&lt;d;</span><br><span class="line">    <span class="comment">//setprecision 并非定义在ios_base.h,而是iomanip.h</span></span><br><span class="line"> <span class="comment">//源码: iomanip.h</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> _<span class="title">Setprecision</span> &#123;</span> <span class="keyword">int</span> _M_n; &#125;; <span class="comment">//结构体  </span></span><br><span class="line">  <span class="function"><span class="keyword">inline</span> _Setprecision <span class="title">setprecision</span><span class="params">(<span class="keyword">int</span> __n)</span></span>&#123;  <span class="comment">//内联</span></span><br><span class="line">  <span class="keyword">return</span> &#123; __n &#125;; </span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _Traits&gt;</span><br><span class="line">    <span class="keyword">inline</span> basic_ostream&lt;_CharT, _Traits&gt;&amp; </span><br><span class="line">    <span class="keyword">operator</span>&lt;&lt;(basic_ostream&lt;_CharT, _Traits&gt;&amp; __os, _Setprecision __f) <span class="comment">//接受_Setprecision的操作符</span></span><br><span class="line">    &#123; </span><br><span class="line">      __os.precision(__f._M_n); </span><br><span class="line">      <span class="keyword">return</span> __os; </span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//这里理解一下inline的作用,貌似就是和宏定义相同,并非是通过函数调用,也就是说此处的汇编代码就是执行内联函数体直接展开,那么编译器也做了优化,并没有执行return rax.</span></span><br><span class="line"><span class="comment">//5.width</span></span><br><span class="line"><span class="function">streamsize <span class="title">width</span><span class="params">()</span> <span class="keyword">const</span></span>;(<span class="number">1</span>)	</span><br><span class="line"><span class="function">streamsize <span class="title">width</span><span class="params">( streamsize new_width )</span></span>;(<span class="number">2</span>)	</span><br><span class="line">管理某些输出操作时生成的最小字符数，和某些输出操作时生成的最大字符数。</span><br><span class="line"><span class="number">1</span>) 返回当前域宽。</span><br><span class="line"><span class="number">2</span>) 设置域宽为给定值 仅仅下一次io函数生效</span><br><span class="line"><span class="comment">//setw</span></span><br><span class="line">用于表达式 out &lt;&lt; setw(n) 或 in &gt;&gt; setw(n) 时，设置流 out 或 in 的 <span class="built_in">width</span> 参数准确为 n 。</span><br><span class="line">参数</span><br><span class="line">n	-	<span class="built_in">width</span> 的新值</span><br><span class="line">返回值</span><br><span class="line">返回未指定类型对象，满足若 str 是 std::basic_ostream&lt;CharT, Traits&gt; 或 std::basic_istream&lt;CharT, Traits&gt; 类型流的名称，则表达式 str &lt;&lt; setw(n) 或 str &gt;&gt; setw(n) 表现为如同执行下列代码：</span><br><span class="line">str.<span class="built_in">width</span>(n);</span><br><span class="line"><span class="comment">//此处执行方式和prcstion相同,都是iomanip定义的</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//6.std::ios_base::register_callback</span></span><br><span class="line">注册将为 imbue() 、 <span class="built_in">std</span>::basic_ios::copyfmt() 和 ~ios_base() 调用的用户定义函数。每次都调用每个注册的回调：事件类型（ event 类型值）作为首参数传递，而且可用于区别调用方。</span><br><span class="line"><span class="comment">//当调用 imbue() 这几个函数时,才会触发回调</span></span><br><span class="line"><span class="comment">//https://zh.cppreference.com/w/cpp/io/ios_base/register_callback 此处有一段实例</span></span><br><span class="line"><span class="comment">//7. xalloc 返回能安全用作 pword() 和 iword() 下标的程序范围内独有的整数</span></span><br><span class="line"><span class="comment">//8.iword/pword</span></span><br><span class="line">源码:</span><br><span class="line"> <span class="comment">// 27.4.2.5  Members for iword/pword storage</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">Words</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      <span class="keyword">void</span>*	_M_pword;</span><br><span class="line">      <span class="keyword">long</span>	_M_iword;</span><br><span class="line">      _Words() : _M_pword(<span class="number">0</span>), _M_iword(<span class="number">0</span>) &#123; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// Allocated storage.</span></span><br><span class="line">    <span class="keyword">int</span>			_M_word_size;</span><br><span class="line">    _Words*		_M_word;</span><br><span class="line"> <span class="comment">//返回值可以用来查看,也可以用来修改</span></span><br><span class="line">  <span class="keyword">long</span>&amp;</span><br><span class="line">    iword(<span class="keyword">int</span> __ix) <span class="comment">//</span></span><br><span class="line">    &#123;</span><br><span class="line">      _Words&amp; __word = (__ix &lt; _M_word_size)</span><br><span class="line">			? _M_word[__ix] : _M_grow_words(__ix, <span class="literal">true</span>);</span><br><span class="line">      <span class="keyword">return</span> __word._M_iword;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//9.</span></span><br><span class="line">imbue </span><br><span class="line">设置本地环境 </span><br><span class="line">(公开成员函数)</span><br><span class="line">getloc </span><br><span class="line">返回当前本地环境 </span><br><span class="line">(公开成员函数)</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>补充</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内部回调结构</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Callback_list</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      <span class="comment">// Data Members</span></span><br><span class="line">      _Callback_list*		_M_next;  <span class="comment">//下一个回调节点</span></span><br><span class="line">      ios_base::event_callback	_M_fn;<span class="comment">//该回调对应的类型 </span></span><br><span class="line">      <span class="keyword">int</span>			_M_index; <span class="comment">//下标</span></span><br><span class="line">      _Atomic_word		_M_refcount;  <span class="comment">// 0 means one reference.</span></span><br><span class="line"></span><br><span class="line">      _Callback_list(ios_base::event_callback __fn, <span class="keyword">int</span> __index,</span><br><span class="line">		     _Callback_list* __cb)</span><br><span class="line">      : _M_next(__cb), _M_fn(__fn), _M_index(__index), _M_refcount(<span class="number">0</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">void</span></span><br><span class="line">      _M_add_reference() &#123; __gnu_cxx::__atomic_add_dispatch(&amp;_M_refcount, <span class="number">1</span>); &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 0 =&gt; OK to delete.</span></span><br><span class="line">      <span class="keyword">int</span></span><br><span class="line">      _M_remove_reference() </span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Be race-detector-friendly.  For more info see bits/c++config.</span></span><br><span class="line">        _GLIBCXX_SYNCHRONIZATION_HAPPENS_BEFORE(&amp;_M_refcount);</span><br><span class="line">        <span class="keyword">int</span> __res = __gnu_cxx::__exchange_and_add_dispatch(&amp;_M_refcount, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (__res == <span class="number">0</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            _GLIBCXX_SYNCHRONIZATION_HAPPENS_AFTER(&amp;_M_refcount);</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">return</span> __res;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="basic-ios-ios-public-ios-bsae"><a class="header-anchor" href="#basic-ios-ios-public-ios-bsae">¶</a>basic_ios(ios):public ios_bsae</h3>
<ol>
<li>特征_Traits</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//iosfwd.h</span></span><br><span class="line">`<span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _Traits = char_traits&lt;_CharT&gt; &gt;</span><br><span class="line">    class basic_ios`</span><br><span class="line"><span class="comment">//stringfwd.h</span></span><br><span class="line">  struct char_traits;</span><br><span class="line">  <span class="keyword">template</span>&lt;&gt; <span class="class"><span class="keyword">struct</span> <span class="title">char_traits</span>&lt;char&gt;;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _GLIBCXX_USE_WCHAR_T</span></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt; <span class="class"><span class="keyword">struct</span> <span class="title">char_traits</span>&lt;wchar_t&gt;;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ((__cplusplus &gt;= 201103L) \</span></span><br><span class="line">     &amp;&amp; defined(_GLIBCXX_USE_C99_STDINT_TR1))</span><br><span class="line">  <span class="keyword">template</span>&lt;&gt; <span class="class"><span class="keyword">struct</span> <span class="title">char_traits</span>&lt;char16_t&gt;;</span></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt; <span class="class"><span class="keyword">struct</span> <span class="title">char_traits</span>&lt;char32_t&gt;;</span></span><br><span class="line">  <span class="comment">//也就是实际上使用那个特征模板由_CharT决定, 如char 和wchar_t</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">//char_traits.h 定义char类型 特化模板</span></span><br><span class="line"><span class="keyword">template</span>&lt;&gt; <span class="comment">//截取关于char的特化一部分</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">char_traits</span>&lt;char&gt;</span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">char</span>              char_type;</span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">int</span>               int_type;</span><br><span class="line">      <span class="keyword">typedef</span> streampos         pos_type;  <span class="comment">// typedef fpos&lt;mbstate_t&gt; streampos;(postype.h中定义)</span></span><br><span class="line">      <span class="keyword">typedef</span> streamoff         off_type; </span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">mbstate_t</span>         state_type; <span class="comment">//int</span></span><br><span class="line"> <span class="comment">//后边都是关系的static函数,其他特化也是如此</span></span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">      assign(char_type&amp; __c1, <span class="keyword">const</span> char_type&amp; __c2) _GLIBCXX_NOEXCEPT</span><br><span class="line">      &#123; __c1 = __c2; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">static</span> _GLIBCXX_CONSTEXPR <span class="keyword">bool</span></span><br><span class="line">      eq(<span class="keyword">const</span> char_type&amp; __c1, <span class="keyword">const</span> char_type&amp; __c2) _GLIBCXX_NOEXCEPT</span><br><span class="line">      &#123; <span class="keyword">return</span> __c1 == __c2; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">static</span> _GLIBCXX_CONSTEXPR <span class="keyword">bool</span></span><br><span class="line">      lt(<span class="keyword">const</span> char_type&amp; __c1, <span class="keyword">const</span> char_type&amp; __c2) _GLIBCXX_NOEXCEPT</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="comment">// LWG 467.</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;(__c1)</span><br><span class="line">		&lt; <span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;(__c2));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">      compare(<span class="keyword">const</span> char_type* __s1, <span class="keyword">const</span> char_type* __s2, <span class="keyword">size_t</span> __n)</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="keyword">if</span> (__n == <span class="number">0</span>)</span><br><span class="line">	  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> __builtin_memcmp(__s1, __s2, __n);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>部分属性</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _Traits&gt;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">basic_ios</span> :</span> <span class="keyword">public</span> ios_base</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">public</span>:</span><br><span class="line">      <span class="comment">//结合不同的模板如_CharT=char,_Traits= struct char_traits&lt;char&gt;</span></span><br><span class="line">      <span class="keyword">typedef</span> _CharT                                 char_type; <span class="comment">//char</span></span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> _Traits::int_type             int_type;  <span class="comment">//int</span></span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> _Traits::pos_type             pos_type;<span class="comment">//fpos&lt;int&gt;</span></span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> _Traits::off_type             off_type; <span class="comment">//streamoff(long long)</span></span><br><span class="line">      <span class="keyword">typedef</span> _Traits                                traits_type;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//都是facet的子类,用于local</span></span><br><span class="line">      <span class="keyword">typedef</span> ctype&lt;_CharT&gt;                          __ctype_type; </span><br><span class="line">      <span class="keyword">typedef</span> num_put&lt;_CharT, ostreambuf_iterator&lt;_CharT, _Traits&gt; &gt;</span><br><span class="line">						     __num_put_type;</span><br><span class="line">      <span class="keyword">typedef</span> num_get&lt;_CharT, istreambuf_iterator&lt;_CharT, _Traits&gt; &gt;</span><br><span class="line">						     __num_get_type;</span><br><span class="line">      <span class="comment">// Data members:</span></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      basic_ostream&lt;_CharT, _Traits&gt;*                _M_tie; <span class="comment">//绑定的流指针</span></span><br><span class="line">      <span class="keyword">mutable</span> char_type                              _M_fill;<span class="comment">//填充的字符</span></span><br><span class="line">      <span class="keyword">mutable</span> <span class="keyword">bool</span>                                   _M_fill_init;<span class="comment">//是否填充</span></span><br><span class="line">      basic_streambuf&lt;_CharT, _Traits&gt;*              _M_streambuf;<span class="comment">//内部缓冲</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Cached use_facet&lt;ctype&gt;, which is based on the current locale info.</span></span><br><span class="line">      <span class="keyword">const</span> __ctype_type*                            _M_ctype;</span><br><span class="line">      <span class="comment">// For ostream.</span></span><br><span class="line">      <span class="keyword">const</span> __num_put_type*                          _M_num_put;  <span class="comment">//对于输出流&lt;&lt;操作符属于num的进行格式化为 _CharT类型,并插入到buf中</span></span><br><span class="line">      <span class="comment">// For istream.</span></span><br><span class="line">      <span class="keyword">const</span> __num_get_type*                          _M_num_get;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>函数</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. good eod fail bad operator! operator bool  都是检查状态</span></span><br><span class="line"><span class="comment">//源码</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __cplusplus &gt;= 201103L</span></span><br><span class="line">      <span class="function"><span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span> <span class="comment">//这里就是一个类型转换符,并且使用了explicit阻止了自动转换,要通过static&lt;bool&gt;cast()</span></span></span><br><span class="line"><span class="function">      </span>&#123; <span class="keyword">return</span> !<span class="keyword">this</span>-&gt;fail(); &#125;</span><br><span class="line">------------      </span><br><span class="line">     <span class="keyword">bool</span></span><br><span class="line">      fail() <span class="keyword">const</span></span><br><span class="line">      &#123; <span class="keyword">return</span> (<span class="keyword">this</span>-&gt;rdstate() &amp; (badbit | failbit)) != <span class="number">0</span>; &#125;</span><br><span class="line"><span class="comment">//2.rdstate setstate clear 控制ios_base::_M_streambuf_state</span></span><br><span class="line"><span class="comment">//3.copyfmt </span></span><br><span class="line"><span class="function">basic_ios&amp; <span class="title">copyfmt</span><span class="params">(<span class="keyword">const</span> basic_ios&amp; other)</span></span>;</span><br><span class="line"><span class="comment">//源码</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _Traits&gt;</span><br><span class="line">    basic_ios&lt;_CharT, _Traits&gt;&amp;</span><br><span class="line">    basic_ios&lt;_CharT, _Traits&gt;::copyfmt(<span class="keyword">const</span> basic_ios&amp; __rhs)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">      <span class="comment">// 292. effects of a.copyfmt (a)</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;__rhs)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">// Per 27.1.1, do not call imbue, yet must trash all caches</span></span><br><span class="line">	  <span class="comment">// associated with imbue()</span></span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Alloc any new word array first, so if it fails we have "rollback".</span></span><br><span class="line">      <span class="comment">//erase_evnet事件传递,触发该流的erase_event回调函数</span></span><br><span class="line">	  _Words* __words = (__rhs._M_word_size &lt;= _S_local_word_size) ?</span><br><span class="line">	                     _M_local_word : <span class="keyword">new</span> _Words[__rhs._M_word_size];</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Bump refs before doing callbacks, for safety.</span></span><br><span class="line">	  _Callback_list* __cb = __rhs._M_callbacks;</span><br><span class="line">	  <span class="keyword">if</span> (__cb)</span><br><span class="line">	    __cb-&gt;_M_add_reference();</span><br><span class="line">	  _M_call_callbacks(erase_event);</span><br><span class="line">	  <span class="keyword">if</span> (_M_word != _M_local_word)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">delete</span> [] _M_word;</span><br><span class="line">	      _M_word = <span class="number">0</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	  _M_dispose_callbacks();</span><br><span class="line">      <span class="comment">//拷贝other的所有信息</span></span><br><span class="line">	  <span class="comment">// NB: Don't want any added during above.</span></span><br><span class="line">	  _M_callbacks = __cb;</span><br><span class="line">	  <span class="keyword">for</span> (<span class="keyword">int</span> __i = <span class="number">0</span>; __i &lt; __rhs._M_word_size; ++__i)</span><br><span class="line">	    __words[__i] = __rhs._M_word[__i];</span><br><span class="line">	  _M_word = __words;</span><br><span class="line">	  _M_word_size = __rhs._M_word_size;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">this</span>-&gt;flags(__rhs.flags());</span><br><span class="line">	  <span class="keyword">this</span>-&gt;<span class="built_in">width</span>(__rhs.<span class="built_in">width</span>());</span><br><span class="line">	  <span class="keyword">this</span>-&gt;precision(__rhs.precision());</span><br><span class="line">	  <span class="keyword">this</span>-&gt;tie(__rhs.tie());</span><br><span class="line">	  <span class="keyword">this</span>-&gt;<span class="built_in">fill</span>(__rhs.<span class="built_in">fill</span>());</span><br><span class="line">	  _M_ios_locale = __rhs.getloc();</span><br><span class="line">	  _M_cache_locale(_M_ios_locale);</span><br><span class="line">       <span class="comment">//调用 copyfmt_even 事件回调函数</span></span><br><span class="line">	  _M_call_callbacks(copyfmt_event);</span><br><span class="line">       <span class="comment">//拷贝异常状态 </span></span><br><span class="line">	  <span class="comment">// The next is required to be the last assignment.</span></span><br><span class="line">	  <span class="keyword">this</span>-&gt;exceptions(__rhs.exceptions());</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">//4.fill</span></span><br><span class="line">    char_type</span><br><span class="line">      <span class="built_in">fill</span>() <span class="keyword">const</span></span><br><span class="line">      &#123;</span><br><span class="line">	<span class="keyword">if</span> (!_M_fill_init)</span><br><span class="line">	  &#123;</span><br><span class="line">	    _M_fill = <span class="keyword">this</span>-&gt;widen(<span class="string">' '</span>);</span><br><span class="line">	    _M_fill_init = <span class="literal">true</span>;</span><br><span class="line">	  &#125;</span><br><span class="line">	<span class="keyword">return</span> _M_fill;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//实际上调用了_M_ctype的widen</span></span><br><span class="line">         char_type</span><br><span class="line">      widen(<span class="keyword">char</span> __c) <span class="keyword">const</span></span><br><span class="line">      &#123; <span class="keyword">return</span> __check_facet(_M_ctype).widen(__c); &#125;</span><br><span class="line"> <span class="comment">//5.imube 实现</span></span><br><span class="line">   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _Traits&gt;</span><br><span class="line">    locale</span><br><span class="line">    basic_ios&lt;_CharT, _Traits&gt;::imbue(<span class="keyword">const</span> locale&amp; __loc)</span><br><span class="line">    &#123;</span><br><span class="line">      locale __old(<span class="keyword">this</span>-&gt;getloc());</span><br><span class="line">      ios_base::imbue(__loc); <span class="comment">//调用了父类实现的</span></span><br><span class="line">      _M_cache_locale(__loc); </span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;rdbuf() != <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">this</span>-&gt;rdbuf()-&gt;pubimbue(__loc);<span class="comment">//改变内部buf</span></span><br><span class="line">      <span class="keyword">return</span> __old;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//6.tie  </span></span><br><span class="line">std::basic_ostream&lt;CharT,Traits&gt;* tie() const;</span><br><span class="line">(<span class="number">1</span>)	</span><br><span class="line">std::basic_ostream&lt;CharT,Traits&gt;* tie( std::basic_ostream&lt;CharT,Traits&gt;* str );</span><br><span class="line">(<span class="number">2</span>)	</span><br><span class="line">管理联系流。联系流是输出流，它与流缓冲（ rdbuf() ）所控制的输出序列同步，即在任何 *<span class="keyword">this</span> 上的输入/输出操作前，在联系流上调用 <span class="built_in">flush</span>() 。</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>) 返回当前联系流。若无联系流，则返回空指针。</span><br><span class="line"><span class="number">2</span>) 设置当前联系流为 str 。返回操作前的联系流。若无联系流，则返回空指针。</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::ofstream <span class="title">os</span><span class="params">(<span class="string">"test.txt"</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::ifstream <span class="title">is</span><span class="params">(<span class="string">"test.txt"</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">value</span><span class="params">(<span class="string">"0"</span>)</span></span>;</span><br><span class="line"> </span><br><span class="line">    os &lt;&lt; <span class="string">"Hello"</span>;</span><br><span class="line">    is &gt;&gt; value;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Result before tie(): \""</span> &lt;&lt; value &lt;&lt; <span class="string">"\"\n"</span>;</span><br><span class="line">    is.<span class="built_in">clear</span>();</span><br><span class="line">    is.tie(&amp;os);</span><br><span class="line">  </span><br><span class="line">    is &gt;&gt; value;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Result after tie(): \""</span> &lt;&lt; value &lt;&lt; <span class="string">"\"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将is.tie(os),当is&gt;&gt;时,os调用flush,此时文本中才有值</span></span><br><span class="line"><span class="comment">//Result before tie(): "0"</span></span><br><span class="line"><span class="comment">//Result after tie(): "Hello"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//narrow </span></span><br><span class="line">窄化字符 </span><br><span class="line">widen </span><br><span class="line">拓宽字符 </span><br><span class="line">init </span><br><span class="line"><span class="comment">//模板tcc 实现,该函数会被子类构造器调用</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _Traits&gt;</span><br><span class="line">    <span class="keyword">void</span></span><br><span class="line">    basic_ios&lt;_CharT, _Traits&gt;::init(basic_streambuf&lt;_CharT, _Traits&gt;* __sb)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// NB: This may be called more than once on the same object.</span></span><br><span class="line">      ios_base::_M_init();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Cache locale data and specific facets used by iostreams.</span></span><br><span class="line">      _M_cache_locale(_M_ios_locale);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// NB: The 27.4.4.1 Postconditions Table specifies requirements</span></span><br><span class="line">      <span class="comment">// after basic_ios::init() has been called. As part of this,</span></span><br><span class="line">      <span class="comment">// fill() must return widen(' ') any time after init() has been</span></span><br><span class="line">      <span class="comment">// called, which needs an imbued ctype facet of char_type to</span></span><br><span class="line">      <span class="comment">// return without throwing an exception. Unfortunately,</span></span><br><span class="line">      <span class="comment">// ctype&lt;char_type&gt; is not necessarily a required facet, so</span></span><br><span class="line">      <span class="comment">// streams with char_type != [char, wchar_t] will not have it by</span></span><br><span class="line">      <span class="comment">// default. Because of this, the correct value for _M_fill is</span></span><br><span class="line">      <span class="comment">// constructed on the first call of fill(). That way,</span></span><br><span class="line">      <span class="comment">// unformatted input and output with non-required basic_ios</span></span><br><span class="line">      <span class="comment">// instantiations is possible even without imbuing the expected</span></span><br><span class="line">      <span class="comment">// ctype&lt;char_type&gt; facet.</span></span><br><span class="line">      _M_fill = _CharT();</span><br><span class="line">      _M_fill_init = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      _M_tie = <span class="number">0</span>;</span><br><span class="line">      _M_exception = goodbit;</span><br><span class="line">      _M_streambuf = __sb;  <span class="comment">//改变子类的缓冲</span></span><br><span class="line">      _M_streambuf_state = __sb ? goodbit : badbit;</span><br><span class="line">    &#125;</span><br><span class="line">初始化一个默认构造的<span class="built_in">std</span>::basic_ios </span><br><span class="line"><span class="built_in">move</span>  (C++<span class="number">11</span>) </span><br><span class="line">从另一 <span class="built_in">std</span>::basic_ios 移动，除了 rdbuf </span><br><span class="line">swap  (C++<span class="number">11</span>) </span><br><span class="line">与另一 <span class="built_in">std</span>::basic_ios 交换，除了 rdbuf </span><br><span class="line">set_rdbuf </span><br><span class="line">替换 rdbuf 而不清除其错误状态</span><br></pre></td></tr></table></figure>
<h3 id="basic-streambuf"><a class="header-anchor" href="#basic-streambuf">¶</a>basic_streambuf</h3>
<ol>
<li>简单构成</li>
</ol>
<img src="/2018/11/12/%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81-io/streambuf0.png" class="" title="底层数据">
<p>cppref中的一部分解释:</p>
<ul>
<li>buf维护了两个缓冲区,结构类似于vector这样的指针,对于输入in来说称为获取区,对于out来说称为放置区</li>
<li>图中的associated character sequence,关联字符序列，又称作源（对于输入）或池（对于输出）。它可以是通过 OS API 访问的实体（文件、 TCP 接头、串行端口、其他字符设备），或者可以是能转译成字符源或池的对象（ std::vector 、数组、字符串字面量）。也就是说源或者池分别指的外部io和api内部的对象.</li>
<li>basic_streambuf 对象可支持输入（该情况下起始、下一位置和终止指针所描述的区域被称为获取区）、输出（放置区），或同时输入与输出。在最后一种情况下，跟踪六个指针，它们可能全部指向同一数组的元素，或指向二个单独数组的元素。</li>
<li>若放置区中下一位置指针小于终止指针，则写位置可用。下一位置指针可被解引用和赋值</li>
<li>若获取区中下一位置指针小于终止指针，则读位置可用。下一位置指针可被解引用和读取。</li>
<li>若获取区中下一位置指针大于起始指针，则回放位置可用，而下一位置指针可以被自减并赋值，以将字符放回到获取区。</li>
<li>受控制序列中的字符表示和编码可以异于关联序列中的字符表示，该情况下典型地用 std::codecvt 本地环境进行转换。常见的例子是通过 std::wfstream 对象访问 UTF-8 （或其他多字节编码）文件：受控制字符序列由 wchar_t 字符组成，但关联序列由字节组成。</li>
<li>具体的缓冲类，如 std::basic_filebuf 或 std::basic_stringbuf 导出自 std::basic_streambuf 。</li>
</ul>
<figure class="highlight cpp"><figcaption><span>basic_streambuf.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//类型</span></span><br><span class="line">      <span class="keyword">typedef</span> _CharT 					char_type;</span><br><span class="line">      <span class="keyword">typedef</span> _Traits 					traits_type;</span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> traits_type::int_type 		int_type;</span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> traits_type::pos_type 		pos_type;</span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> traits_type::off_type 		off_type;</span><br><span class="line"><span class="comment">//友元</span></span><br><span class="line">     <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">basic_ios</span>&lt;char_type, traits_type&gt;;</span></span><br><span class="line">      <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">basic_istream</span>&lt;char_type, traits_type&gt;;</span></span><br><span class="line">      <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">basic_ostream</span>&lt;char_type, traits_type&gt;;</span></span><br><span class="line">      <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">istreambuf_iterator</span>&lt;char_type, traits_type&gt;;</span></span><br><span class="line">      <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">ostreambuf_iterator</span>&lt;char_type, traits_type&gt;;</span></span><br><span class="line"><span class="comment">//友元函数,仅仅截取了一个</span></span><br><span class="line"><span class="comment">//该函数被定义在stringbuf.tcc 而不是basic_streambuf.tcc中</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT2, <span class="keyword">typename</span> _Traits2, <span class="keyword">typename</span> _Alloc&gt;</span><br><span class="line">        <span class="keyword">friend</span> basic_istream&lt;_CharT2, _Traits2&gt;&amp;</span><br><span class="line">        getline(basic_istream&lt;_CharT2, _Traits2&gt;&amp;,</span><br><span class="line">		basic_string&lt;_CharT2, _Traits2, _Alloc&gt;&amp;, _CharT2);        </span><br><span class="line"><span class="comment">//关键成员</span></span><br><span class="line"><span class="comment">//内部的io缓冲,分配方式和vector这种扩容数组很相似</span></span><br><span class="line">  char_type* 		_M_in_beg;     <span class="comment">///&lt; Start of get area.</span></span><br><span class="line">      char_type* 		_M_in_cur;     <span class="comment">///&lt; Current read area.</span></span><br><span class="line">      char_type* 		_M_in_end;     <span class="comment">///&lt; End of get area.</span></span><br><span class="line">      char_type* 		_M_out_beg;    <span class="comment">///&lt; Start of put area.</span></span><br><span class="line">      char_type* 		_M_out_cur;    <span class="comment">///&lt; Current put area.</span></span><br><span class="line">      char_type* 		_M_out_end;    <span class="comment">///&lt; End of put area.</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">/// Current locale setting.</span></span><br><span class="line">      locale 			_M_buf_locale;</span><br><span class="line">      <span class="comment">//公开的函数</span></span><br><span class="line">      getloc() <span class="keyword">const</span> <span class="comment">//获取_M_buf_locale</span></span><br><span class="line">      pubimbue(<span class="keyword">const</span> locale&amp; __loc) <span class="comment">//设置_M_buf_locale</span></span><br><span class="line">      <span class="comment">//实际调用虚函数</span></span><br><span class="line">       <span class="function">basic_streambuf* <span class="title">pubsetbuf</span><span class="params">(char_type* __s, streamsize __n)</span></span>&#123;  <span class="comment">//设置buf为__s</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">this</span>-&gt;setbuf(__s, __n);</span><br><span class="line">       &#125;</span><br><span class="line"><span class="comment">//       ------------------------------</span></span><br><span class="line"><span class="comment">//寻位</span></span><br><span class="line">        pos_type</span><br><span class="line">      pubseekoff(off_type __off, ios_base::seekdir __way,    <span class="comment">//改变buf位置为__way(ios_base中定义)</span></span><br><span class="line">		 ios_base::openmode __mode = ios_base::in | ios_base::out) </span><br><span class="line">      &#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;seekoff(__off, __way, __mode); &#125;</span><br><span class="line">      </span><br><span class="line">       pos_type</span><br><span class="line">      pubseekpos(pos_type __sp,</span><br><span class="line">		 ios_base::openmode __mode = ios_base::in | ios_base::out) <span class="comment">//通过sp来改变位置 pos_type是fpos类型</span></span><br><span class="line">      &#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;seekpos(__sp, __mode); &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">int</span></span><br><span class="line">      pubsync() &#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;sync(); &#125; <span class="comment">//从名字上看是于流关系的io设备进行同步,刷新??</span></span><br><span class="line"><span class="comment">//----------------------------------</span></span><br><span class="line"><span class="comment">//获取区函数</span></span><br><span class="line">       streamsize</span><br><span class="line">      in_avail() <span class="comment">//当前获取区剩余</span></span><br><span class="line">      &#123;</span><br><span class="line">	<span class="keyword">const</span> streamsize __ret = <span class="keyword">this</span>-&gt;egptr() - <span class="keyword">this</span>-&gt;gptr(); <span class="comment">//end-cur==0?__ret:this-&gt;showmanyc();</span></span><br><span class="line">	<span class="keyword">return</span> __ret ? __ret : <span class="keyword">this</span>-&gt;showmanyc(); </span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">       int_type</span><br><span class="line">      snextc() <span class="comment">//读取下一个字符</span></span><br><span class="line">      &#123;</span><br><span class="line">	int_type __ret = traits_type::eof();</span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect(!traits_type::eq_int_type(<span class="keyword">this</span>-&gt;sbumpc(),</span><br><span class="line">						       __ret), <span class="literal">true</span>))</span><br><span class="line">	  __ret = <span class="keyword">this</span>-&gt;sgetc();</span><br><span class="line">	<span class="keyword">return</span> __ret;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//读取当前数据,并指针前进</span></span><br><span class="line">      int_type</span><br><span class="line">      sbumpc()  </span><br><span class="line">      &#123;</span><br><span class="line">	int_type __ret;</span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect(<span class="keyword">this</span>-&gt;gptr() &lt; <span class="keyword">this</span>-&gt;egptr(), <span class="literal">true</span>)) <span class="comment">//非空</span></span><br><span class="line">	  &#123;</span><br><span class="line">	    __ret = traits_type::to_int_type(*<span class="keyword">this</span>-&gt;gptr()); <span class="comment">//读取并转为int_type</span></span><br><span class="line">	    <span class="keyword">this</span>-&gt;gbump(<span class="number">1</span>); <span class="comment">//前进</span></span><br><span class="line">	  &#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	  __ret = <span class="keyword">this</span>-&gt;uflow(); <span class="comment">//空则调用uflow</span></span><br><span class="line">	<span class="keyword">return</span> __ret;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">       int_type <span class="comment">//读取当前的数据</span></span><br><span class="line">      sgetc()</span><br><span class="line">      &#123;</span><br><span class="line">	int_type __ret;</span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect(<span class="keyword">this</span>-&gt;gptr() &lt; <span class="keyword">this</span>-&gt;egptr(), <span class="literal">true</span>))<span class="comment">//非空</span></span><br><span class="line">	  __ret = traits_type::to_int_type(*<span class="keyword">this</span>-&gt;gptr()); <span class="comment">//读取当前获取区值</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	  __ret = <span class="keyword">this</span>-&gt;underflow(); <span class="comment">//若当前指针指向end,则进行underflow操作,并返回读取后的数据</span></span><br><span class="line">	<span class="keyword">return</span> __ret;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//该函数子类可以实现</span></span><br><span class="line">      <span class="keyword">virtual</span> int_type</span><br><span class="line">      uflow()</span><br><span class="line">      &#123;</span><br><span class="line">	int_type __ret = traits_type::eof();</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">bool</span> __testeof = traits_type::eq_int_type(<span class="keyword">this</span>-&gt;underflow(), <span class="comment">//调用应该实现的underflow,该函数应该到io设备中读取数据,放回缓冲区,并且返回此时扩容的缓冲第一个指针,也就是之前__builtin_expect(this-&gt;gptr() &lt; this-&gt;egptr(), true)的情况时,current_prt指针指向了没有数据的位置,若此次有数据,那么说明io设备还能读取,否则返回的一定是eof;然后此时指针指向了扩容部分的第二个位置,也就是说cpp_zh的那张图是正确的,current位置维持着是将要读取的位置</span></span><br><span class="line">							__ret);</span><br><span class="line">	<span class="keyword">if</span> (!__testeof)</span><br><span class="line">	  &#123;</span><br><span class="line">	    __ret = traits_type::to_int_type(*<span class="keyword">this</span>-&gt;gptr());</span><br><span class="line">	    <span class="keyword">this</span>-&gt;gbump(<span class="number">1</span>);  <span class="comment">//这两个句等同于sbumpc</span></span><br><span class="line">	  &#125;</span><br><span class="line">	<span class="keyword">return</span> __ret;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">     streamsize</span><br><span class="line">      sgetn(char_type* __s, streamsize __n)</span><br><span class="line">      &#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;xsgetn(__s, __n); &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//定义在tcc中</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _Traits&gt;</span><br><span class="line">    streamsize</span><br><span class="line">    basic_streambuf&lt;_CharT, _Traits&gt;::</span><br><span class="line">    xsgetn(char_type* __s, streamsize __n)</span><br><span class="line">    &#123;</span><br><span class="line">      streamsize __ret = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (__ret &lt; __n)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">const</span> streamsize __buf_len = <span class="keyword">this</span>-&gt;egptr() - <span class="keyword">this</span>-&gt;gptr();  </span><br><span class="line">	  <span class="keyword">if</span> (__buf_len)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">const</span> streamsize __remaining = __n - __ret;</span><br><span class="line">	      <span class="keyword">const</span> streamsize __len = <span class="built_in">std</span>::min(__buf_len, __remaining);  <span class="comment">//获取n和剩余最大值</span></span><br><span class="line">	      traits_type::copy(__s, <span class="keyword">this</span>-&gt;gptr(), __len);<span class="comment">//拷贝</span></span><br><span class="line">	      __ret += __len; <span class="comment">//读取了多少</span></span><br><span class="line">	      __s += __len;<span class="comment">//移动_s指针</span></span><br><span class="line">	      <span class="keyword">this</span>-&gt;__safe_gbump(__len);<span class="comment">//移动缓冲指针</span></span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (__ret &lt; __n)</span><br><span class="line">	    &#123;<span class="comment">//说明缓冲区已经满了</span></span><br><span class="line">	      <span class="keyword">const</span> int_type __c = <span class="keyword">this</span>-&gt;uflow();  <span class="comment">//扩容,返回当前指针数据,并且缓冲区指针向前移动</span></span><br><span class="line">	      <span class="keyword">if</span> (!traits_type::eq_int_type(__c, traits_type::eof()))</span><br><span class="line">		&#123;</span><br><span class="line">		  traits_type::assign(*__s++, traits_type::to_char_type(__c)); <span class="comment">//因为使用了uflow,因此要把这个数据返回</span></span><br><span class="line">		  ++__ret; <span class="comment">//增加ret</span></span><br><span class="line">		&#125;</span><br><span class="line">	      <span class="keyword">else</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">return</span> __ret; <span class="comment">//返回</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ----------------------------------------    </span></span><br><span class="line"><span class="comment">// 回放</span></span><br><span class="line"> int_type <span class="comment">//将__c放到反位置</span></span><br><span class="line">      sputbackc(char_type __c)</span><br><span class="line">      &#123;</span><br><span class="line">	int_type __ret;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">bool</span> __testpos = <span class="keyword">this</span>-&gt;eback() &lt; <span class="keyword">this</span>-&gt;gptr();</span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect(!__testpos ||</span><br><span class="line">			     !traits_type::eq(__c, <span class="keyword">this</span>-&gt;gptr()[<span class="number">-1</span>]), <span class="literal">false</span>)) gptr() &gt; eback()||而字符 c 不等于 gptr() 左一位置的字符</span><br><span class="line">	  __ret = <span class="keyword">this</span>-&gt;pbackfail(traits_type::to_int_type(__c)); <span class="comment">//虚函数 子类实现,若不能移动则返回eof</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	  &#123;</span><br><span class="line">      <span class="comment">//移动,并读取,返回,相同不用插入</span></span><br><span class="line">	    <span class="keyword">this</span>-&gt;gbump(<span class="number">-1</span>); </span><br><span class="line">	    __ret = traits_type::to_int_type(*<span class="keyword">this</span>-&gt;gptr());</span><br><span class="line">	  &#125;</span><br><span class="line">	<span class="keyword">return</span> __ret;</span><br><span class="line">      &#125;</span><br><span class="line">     <span class="comment">//例子:</span></span><br><span class="line">     <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testSputbackc</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="function"><span class="built_in">std</span>::<span class="built_in">stringstream</span> <span class="title">s</span><span class="params">(<span class="string">"abcdef"</span>)</span></span>; <span class="comment">// gptr() 指向 "abcdef" 中的 'a'</span></span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Before putback, string holds "</span> &lt;&lt; s.str() &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">            <span class="keyword">char</span> c1 = s.get(); <span class="comment">// c1 = 'a' ， gptr() 现在指向 "abcdef" 中的 'b'</span></span><br><span class="line">            <span class="keyword">char</span> c2 = s.rdbuf()-&gt;sputbackc(<span class="string">'z'</span>); <span class="comment">// 同 s.putback('z')</span></span><br><span class="line">            <span class="comment">// gptr() 现在指向 "zbcdef" 中的 'z'</span></span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"After putback, string holds "</span> &lt;&lt; s.str() &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">            <span class="keyword">char</span> c3 = s.get(); <span class="comment">// c3 = 'z' ， gptr() 现在指向 "zbcdef" 中的 'b'</span></span><br><span class="line">            <span class="keyword">char</span> c4 = s.get(); <span class="comment">// c4 = 'b' ， gptr() 现在指向 "zbcdef" 中的 'c'</span></span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; c1 &lt;&lt; c2 &lt;&lt; c3 &lt;&lt; c4 &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line"></span><br><span class="line">            s.rdbuf()-&gt;sputbackc(<span class="string">'b'</span>);  <span class="comment">// gptr() 现在指向 "zbcdef" 中的 'b'</span></span><br><span class="line">            s.rdbuf()-&gt;sputbackc(<span class="string">'z'</span>);  <span class="comment">// gptr() 现在指向 "zbcdef" 中的 'z'</span></span><br><span class="line">            <span class="keyword">int</span> eof = s.rdbuf()-&gt;sputbackc(<span class="string">'x'</span>);  <span class="comment">// 无内容能反获取： pbackfail() 失败</span></span><br><span class="line">            <span class="keyword">if</span> (eof == EOF)</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"No room to putback after 'z'\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//输出:</span></span><br><span class="line">        <span class="comment">//Before putback, string holds abcdef</span></span><br><span class="line">        <span class="comment">//After putback, string holds zbcdef</span></span><br><span class="line">        <span class="comment">//azzb</span></span><br><span class="line">        <span class="comment">//No room to putback after 'z'</span></span><br><span class="line">  </span><br><span class="line">    int_type</span><br><span class="line">      sungetc()<span class="comment">//取回反位置,若不能移动则返回eof</span></span><br><span class="line">      &#123;</span><br><span class="line">	int_type __ret;</span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect(<span class="keyword">this</span>-&gt;eback() &lt; <span class="keyword">this</span>-&gt;gptr(), <span class="literal">true</span>))</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="keyword">this</span>-&gt;gbump(<span class="number">-1</span>);</span><br><span class="line">	    __ret = traits_type::to_int_type(*<span class="keyword">this</span>-&gt;gptr());</span><br><span class="line">	  &#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	  __ret = <span class="keyword">this</span>-&gt;pbackfail();</span><br><span class="line">	<span class="keyword">return</span> __ret;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//例</span></span><br><span class="line">      <span class="keyword">void</span> myIoTest::bufTest::testSunget() &#123;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">stringstream</span> <span class="title">s</span><span class="params">(<span class="string">"abcdef"</span>)</span></span>; <span class="comment">// gptr() 指向 'a'</span></span><br><span class="line">    <span class="keyword">char</span> c1 = s.get(); <span class="comment">// c = 'a', gptr() 现在指向 'b'</span></span><br><span class="line">    <span class="keyword">char</span> c2 = s.rdbuf()-&gt;sungetc(); <span class="comment">// 同 s.unget() ： gptr() 又指向 'a'</span></span><br><span class="line">    <span class="keyword">char</span> c3 = s.get(); <span class="comment">// c3 = 'a' ， gptr() 现在指向 'b'</span></span><br><span class="line">    <span class="keyword">char</span> c4 = s.get(); <span class="comment">// c4 = 'b' ， gptr() 现在指向 'c'</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; c1 &lt;&lt; c2 &lt;&lt; c3 &lt;&lt; c4 &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line"></span><br><span class="line">    s.rdbuf()-&gt;sungetc();  <span class="comment">// 回到 'b'</span></span><br><span class="line">    s.rdbuf()-&gt;sungetc();  <span class="comment">// 回到 'a'</span></span><br><span class="line">    <span class="keyword">int</span> eof = s.rdbuf()-&gt;sungetc();  <span class="comment">// 无内容可反获取： pbackfail() 失败</span></span><br><span class="line">    <span class="keyword">if</span> (eof == EOF)</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Nothing to unget after 'a'\n"</span>;&#125;</span><br><span class="line">----------------------------------</span><br><span class="line"><span class="comment">//放置区</span></span><br><span class="line">  int_type</span><br><span class="line">      sputc(char_type __c)</span><br><span class="line">      &#123;</span><br><span class="line">	int_type __ret;</span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect(<span class="keyword">this</span>-&gt;pptr() &lt; <span class="keyword">this</span>-&gt;epptr(), <span class="literal">true</span>))</span><br><span class="line">	  &#123;</span><br><span class="line">	    *<span class="keyword">this</span>-&gt;pptr() = __c;</span><br><span class="line">	    <span class="keyword">this</span>-&gt;pbump(<span class="number">1</span>);</span><br><span class="line">	    __ret = traits_type::to_int_type(__c);</span><br><span class="line">	  &#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	  __ret = <span class="keyword">this</span>-&gt;overflow(traits_type::to_int_type(__c));</span><br><span class="line">	<span class="keyword">return</span> __ret;</span><br><span class="line">      &#125;</span><br><span class="line">      sputn()<span class="comment">//放置数组,对比于sgetn,调用虚函数xsputn</span></span><br><span class="line"><span class="comment">//tcc中实现</span></span><br><span class="line"> <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _Traits&gt;</span><br><span class="line">    streamsize</span><br><span class="line">    basic_streambuf&lt;_CharT, _Traits&gt;::</span><br><span class="line">    xsputn(<span class="keyword">const</span> char_type* __s, streamsize __n)</span><br><span class="line">    &#123;</span><br><span class="line">      streamsize __ret = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (__ret &lt; __n)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">const</span> streamsize __buf_len = <span class="keyword">this</span>-&gt;epptr() - <span class="keyword">this</span>-&gt;pptr();</span><br><span class="line">	  <span class="keyword">if</span> (__buf_len)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">const</span> streamsize __remaining = __n - __ret;</span><br><span class="line">	      <span class="keyword">const</span> streamsize __len = <span class="built_in">std</span>::min(__buf_len, __remaining);</span><br><span class="line">	      traits_type::copy(<span class="keyword">this</span>-&gt;pptr(), __s, __len);</span><br><span class="line">	      __ret += __len;</span><br><span class="line">	      __s += __len;</span><br><span class="line">	      <span class="keyword">this</span>-&gt;__safe_pbump(__len);  <span class="comment">//移动缓冲区</span></span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (__ret &lt; __n)</span><br><span class="line">	    &#123;</span><br><span class="line">	      int_type __c = <span class="keyword">this</span>-&gt;overflow(traits_type::to_int_type(*__s));  <span class="comment">//调用虚函数,对设备进行写操作,子类实现</span></span><br><span class="line">	      <span class="keyword">if</span> (!traits_type::eq_int_type(__c, traits_type::eof()))</span><br><span class="line">		&#123;</span><br><span class="line">		  ++__ret;</span><br><span class="line">		  ++__s;</span><br><span class="line">		&#125;</span><br><span class="line">	      <span class="keyword">else</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">return</span> __ret;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">//总结来看,buf就是起到缓冲的作用,和java不同? c++io自带缓冲,in--&gt;underflow,out--&gt;overflow,分别对输入/输出序列进行操作.   </span></span><br><span class="line"> <span class="comment">//结合下文的it,本文的buf,以及上文的facet,实际上对于字符的控制,如格式化,本地化,都是和iostream有着has a关系的facet完成,并且在完成格式化操作后,由facet的api调用迭代器,实际上就是调用对应iostream的buf, i:将设备读取过来的字节转换成对应的类型,流入用户内存中,根据条件判断是否应该在此次i操作对底层设置进行读访问;o:将用户内存中的各种类型进行正确的格式化后输出刀缓冲,根据各种判定条件触发是否将缓冲刷入o设备.</span></span><br></pre></td></tr></table></figure>
<p>2.密切相关的类迭代器</p>
<figure class="highlight cpp"><figcaption><span>ostreambuf_iterator</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义在steambuf_iterator.h中,并没有tcc</span></span><br><span class="line"> <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _Traits&gt;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ostreambuf_iterator</span></span></span><br><span class="line"><span class="class">    :</span> <span class="keyword">public</span> iterator&lt;output_iterator_tag, <span class="keyword">void</span>, <span class="keyword">void</span>, <span class="keyword">void</span>, <span class="keyword">void</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="comment">// Types:</span></span><br><span class="line">      <span class="comment">//@&#123;</span></span><br><span class="line">      <span class="comment">/// Public typedefs</span></span><br><span class="line">      <span class="keyword">typedef</span> _CharT                           char_type;</span><br><span class="line">      <span class="keyword">typedef</span> _Traits                          traits_type;</span><br><span class="line">      <span class="keyword">typedef</span> basic_streambuf&lt;_CharT, _Traits&gt; streambuf_type;</span><br><span class="line">      <span class="keyword">typedef</span> basic_ostream&lt;_CharT, _Traits&gt;   ostream_type;</span><br><span class="line">      <span class="comment">//@&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT2&gt;</span><br><span class="line">	<span class="keyword">friend</span> <span class="keyword">typename</span> __gnu_cxx::__enable_if&lt;__is_char&lt;_CharT2&gt;::__value,</span><br><span class="line">		                    ostreambuf_iterator&lt;_CharT2&gt; &gt;::__type</span><br><span class="line">	copy(istreambuf_iterator&lt;_CharT2&gt;, istreambuf_iterator&lt;_CharT2&gt;,</span><br><span class="line">	     ostreambuf_iterator&lt;_CharT2&gt;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      streambuf_type*	_M_sbuf;</span><br><span class="line">      <span class="keyword">bool</span>		_M_failed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="comment">///  Construct output iterator from ostream.</span></span><br><span class="line">      ostreambuf_iterator(ostream_type&amp; __s) _GLIBCXX_USE_NOEXCEPT</span><br><span class="line">      : _M_sbuf(__s.rdbuf()), _M_failed(!_M_sbuf) &#123; &#125;  <span class="comment">//这两个函数都可以进行隐式构造</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">///  Construct output iterator from streambuf.</span></span><br><span class="line">      ostreambuf_iterator(streambuf_type* __s) _GLIBCXX_USE_NOEXCEPT</span><br><span class="line">      : _M_sbuf(__s), _M_failed(!_M_sbuf) &#123; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">///  Write character to streambuf.  Calls streambuf.sputc().</span></span><br><span class="line">  <span class="comment">//这个=符号才是真正做操作的函数,具体看std::__write(_OutIter __s, const _CharT* __ws, int __len),定义在locale_facet.h中   </span></span><br><span class="line">      ostreambuf_iterator&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(_CharT __c)   </span><br><span class="line">      &#123;</span><br><span class="line">	<span class="keyword">if</span> (!_M_failed &amp;&amp;</span><br><span class="line">	    _Traits::eq_int_type(_M_sbuf-&gt;sputc(__c), _Traits::eof()))<span class="comment">//实际上调用了buf.sputc函数</span></span><br><span class="line">	  _M_failed = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"> <span class="comment">//这个看出来了,对于osbuf_iter,重写的++ 没做什么事情</span></span><br><span class="line">      <span class="comment">/// Return *this.</span></span><br><span class="line">      ostreambuf_iterator&amp;</span><br><span class="line">      <span class="keyword">operator</span>*()</span><br><span class="line">      &#123; <span class="keyword">return</span> *<span class="keyword">this</span>; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// Return *this.</span></span><br><span class="line">      ostreambuf_iterator&amp;</span><br><span class="line">      <span class="keyword">operator</span>++(<span class="keyword">int</span>)</span><br><span class="line">      &#123; <span class="keyword">return</span> *<span class="keyword">this</span>; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// Return *this.</span></span><br><span class="line">      ostreambuf_iterator&amp;</span><br><span class="line">      <span class="keyword">operator</span>++()</span><br><span class="line">      &#123; <span class="keyword">return</span> *<span class="keyword">this</span>; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// Return true if previous operator=() failed.</span></span><br><span class="line">      <span class="keyword">bool</span></span><br><span class="line">      failed() <span class="keyword">const</span> _GLIBCXX_USE_NOEXCEPT</span><br><span class="line">      &#123; <span class="keyword">return</span> _M_failed; &#125;</span><br><span class="line"></span><br><span class="line">      ostreambuf_iterator&amp;</span><br><span class="line">      _M_put(<span class="keyword">const</span> _CharT* __ws, streamsize __len)</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect(!_M_failed, <span class="literal">true</span>)</span><br><span class="line">	    &amp;&amp; __builtin_expect(<span class="keyword">this</span>-&gt;_M_sbuf-&gt;sputn(__ws, __len) != __len,</span><br><span class="line">				<span class="literal">false</span>))</span><br><span class="line">	  _M_failed = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h3 id="basic-ostream-ostream"><a class="header-anchor" href="#basic-ostream-ostream">¶</a>basic_ostream(ostream)</h3>
<ol>
<li>基本</li>
</ol>
<img src="/2018/11/12/%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81-io/basic_ostream.png" class="" title="ostream构成">
<ol start="2">
<li>代码</li>
</ol>
<figure class="highlight cpp"><figcaption><span>basic_ostream.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">basic_ostream</span> :</span> <span class="keyword">virtual</span> <span class="keyword">public</span> basic_ios&lt;_CharT, _Traits&gt; <span class="comment">//虚继承</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">//type</span></span><br><span class="line">      <span class="comment">// Types (inherited from basic_ios):</span></span><br><span class="line">      <span class="keyword">typedef</span> _CharT			 		char_type;</span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> _Traits::int_type 		int_type;</span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> _Traits::pos_type 		pos_type;</span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> _Traits::off_type 		off_type;</span><br><span class="line">      <span class="keyword">typedef</span> _Traits			 		traits_type;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Non-standard Types:</span></span><br><span class="line">      <span class="keyword">typedef</span> basic_streambuf&lt;_CharT, _Traits&gt; 		__streambuf_type;</span><br><span class="line">      <span class="keyword">typedef</span> basic_ios&lt;_CharT, _Traits&gt;		__ios_type;</span><br><span class="line">      <span class="keyword">typedef</span> basic_ostream&lt;_CharT, _Traits&gt;		__ostream_type;</span><br><span class="line">      <span class="keyword">typedef</span> num_put&lt;_CharT, ostreambuf_iterator&lt;_CharT, _Traits&gt; &gt;</span><br><span class="line">      							__num_put_type;</span><br><span class="line">      <span class="keyword">typedef</span> ctype&lt;_CharT&gt;	      			__ctype_type;</span><br><span class="line">      <span class="comment">//调用basic_ios::int</span></span><br><span class="line">            <span class="keyword">explicit</span></span><br><span class="line">      basic_ostream(__streambuf_type* __sb)</span><br><span class="line">      &#123; <span class="keyword">this</span>-&gt;init(__sb); &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="function">class <span class="title">sentry</span><span class="params">(哨兵)</span></span>;</span><br><span class="line">      <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">sentry</span>;</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _Traits&gt;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">basic_ostream</span>&lt;_CharT, _Traits&gt;:</span>:sentry</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Data Members.</span></span><br><span class="line">      <span class="keyword">bool</span> 				_M_ok;</span><br><span class="line">      basic_ostream&lt;_CharT, _Traits&gt;&amp; 	_M_os;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/*tcc中实现</span></span><br><span class="line"><span class="comment">    *   if(_os.tie&amp;&amp;os.good)</span></span><br><span class="line"><span class="comment">    *     _os.ite().flush</span></span><br><span class="line"><span class="comment">    *       if (__os.good())</span></span><br><span class="line"><span class="comment">	  _M_ok = true;</span></span><br><span class="line"><span class="comment">        else</span></span><br><span class="line"><span class="comment">	 __os.setstate(ios_base::failbit);</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">      <span class="keyword">explicit</span></span><br><span class="line">      sentry(basic_ostream&lt;_CharT, _Traits&gt;&amp; __os);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Possibly flushes the stream.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  If @c ios_base::unitbuf is set in @c os.flags(), and</span></span><br><span class="line"><span class="comment">       *  @c std::uncaught_exception() is true, the sentry destructor calls</span></span><br><span class="line"><span class="comment">       *  @c flush() on the output stream.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      ~sentry()</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="comment">// XXX MT</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">bool</span>(_M_os.flags() &amp; ios_base::unitbuf) &amp;&amp; !uncaught_exception())</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Can't call flush directly or else will get into recursive lock.</span></span><br><span class="line">	    <span class="keyword">if</span> (_M_os.rdbuf() &amp;&amp; _M_os.rdbuf()-&gt;pubsync() == <span class="number">-1</span>)</span><br><span class="line">	      _M_os.setstate(ios_base::badbit);</span><br><span class="line">	  &#125;</span><br><span class="line">      <span class="comment">//重写bool</span></span><br><span class="line">      <span class="meta">#<span class="meta-keyword">if</span> __cplusplus &gt;= 201103L</span></span><br><span class="line">      <span class="keyword">explicit</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">      </span>&#123; <span class="keyword">return</span> _M_ok; &#125;</span><br><span class="line">      &#125;</span><br><span class="line"> <span class="comment">//&lt;&lt;输出操作符,直接输出的操作符都调用了这个模板函数,定义在tcc中</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _CharT, <span class="keyword">typename</span> _Traits&gt;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _ValueT&gt;</span><br><span class="line">      basic_ostream&lt;_CharT, _Traits&gt;&amp;</span><br><span class="line">      basic_ostream&lt;_CharT, _Traits&gt;::</span><br><span class="line">      _M_insert(_ValueT __v)</span><br><span class="line">      &#123;</span><br><span class="line">	sentry __cerb(*<span class="keyword">this</span>);  <span class="comment">//这里就明白了,sentry就是在流进行io操作时对流本身进行的一次检验</span></span><br><span class="line">	<span class="keyword">if</span> (__cerb)<span class="comment">//sentry的bool转换,查看 sentry::_M_ok</span></span><br><span class="line">	  &#123;</span><br><span class="line">	    ios_base::iostate __err = ios_base::goodbit;</span><br><span class="line">	    __try</span><br><span class="line">	      &#123;</span><br><span class="line">		<span class="keyword">const</span> __num_put_type&amp; __np = __check_facet(<span class="keyword">this</span>-&gt;_M_num_put); <span class="comment">//_M_num_put时facet的子类</span></span><br><span class="line">		<span class="keyword">if</span> (__np.put(*<span class="keyword">this</span>, *<span class="keyword">this</span>, <span class="keyword">this</span>-&gt;fill(), __v).failed())  <span class="comment">//这里让人很困惑的原因时,第一个参数是隐式构造成的,cnm</span></span><br><span class="line">		  __err |= ios_base::badbit;</span><br><span class="line">	      &#125;</span><br><span class="line">	    __catch(__cxxabiv1::__forced_unwind&amp;)</span><br><span class="line">	      &#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;_M_setstate(ios_base::badbit);		</span><br><span class="line">		__throw_exception_again;</span><br><span class="line">	      &#125;</span><br><span class="line">	    __catch(...)</span><br><span class="line">	      &#123; <span class="keyword">this</span>-&gt;_M_setstate(ios_base::badbit); &#125;</span><br><span class="line">	    <span class="keyword">if</span> (__err)</span><br><span class="line">	      <span class="keyword">this</span>-&gt;setstate(__err);</span><br><span class="line">	  &#125;</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">fancylight</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/11/12/%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81-io/">http://yoursite.com/2018/11/12/%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81-io/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">源码    </a></div><div class="post_share"><div class="social-share" data-image="封面.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/01/04/c-%E5%9F%BA%E7%A1%80/"><img class="prev_cover" src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">c++基础</div></div></a></div><div class="next-post pull_right"><a href="/2018/10/06/tomcat/"><img class="next_cover" src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">tomcat</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/01/04/标准库源码/" title="标准库源码"><img class="relatedPosts_cover "src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-01-04</div><div class="relatedPosts_title">标准库源码</div></div></a></div><div class="relatedPosts_item"><a href="/2018/10/06/tomcat/" title="tomcat"><img class="relatedPosts_cover "src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-10-06</div><div class="relatedPosts_title">tomcat</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By fancylight</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script></body></html>