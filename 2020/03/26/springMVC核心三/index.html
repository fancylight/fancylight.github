<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>springMVC核心三 | 博客</title><meta name="description" content="描述适配器处理结束后的视图处理以及异常机制"><meta name="keywords" content="框架,spring,springMvc"><meta name="author" content="fancylight"><meta name="copyright" content="fancylight"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="springMVC核心三"><meta name="twitter:description" content="描述适配器处理结束后的视图处理以及异常机制"><meta name="twitter:image" content="https://www.fancylight.top/img/spring.png"><meta property="og:type" content="article"><meta property="og:title" content="springMVC核心三"><meta property="og:url" content="https://www.fancylight.top/2020/03/26/springMVC%E6%A0%B8%E5%BF%83%E4%B8%89/"><meta property="og:site_name" content="博客"><meta property="og:description" content="描述适配器处理结束后的视图处理以及异常机制"><meta property="og:image" content="https://www.fancylight.top/img/spring.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script><!-- hexo-inject:begin --><!-- hexo-inject:end -->const autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      now = new Date();
      hour = now.getHours();
      isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://www.fancylight.top/2020/03/26/springMVC%E6%A0%B8%E5%BF%83%E4%B8%89/"><link rel="prev" title="springMVC配置" href="https://www.fancylight.top/2020/03/31/springMVC%E9%85%8D%E7%BD%AE/"><link rel="next" title="springMVC核心二" href="https://www.fancylight.top/2020/03/23/springMVC%E6%A0%B8%E5%BF%83%E4%BA%8C/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: false,
  highlightShrink: false,
  isFontAwesomeV5: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false
}</script><meta name="generator" content="Hexo 4.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">48</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">26</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 目录</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#视图解析器"><span class="toc-number">1.</span> <span class="toc-text">视图解析器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BeanNameViewResolver"><span class="toc-number">1.1.</span> <span class="toc-text">BeanNameViewResolver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ContentNegotiating"><span class="toc-number">1.2.</span> <span class="toc-text">ContentNegotiating</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractCachingViewResolver"><span class="toc-number">1.3.</span> <span class="toc-text">AbstractCachingViewResolver</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ResourceBundleViewResolver"><span class="toc-number">1.3.1.</span> <span class="toc-text">ResourceBundleViewResolver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XmlViewResolver"><span class="toc-number">1.3.2.</span> <span class="toc-text">XmlViewResolver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UrlBasedViewResolver"><span class="toc-number">1.3.3.</span> <span class="toc-text">UrlBasedViewResolver</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#子类"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">子类</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#视图"><span class="toc-number">2.</span> <span class="toc-text">视图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstactView"><span class="toc-number">2.1.</span> <span class="toc-text">AbstactView</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AbstractJackson2View"><span class="toc-number">2.1.1.</span> <span class="toc-text">AbstractJackson2View</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AbstractUrlBasedView"><span class="toc-number">2.1.2.</span> <span class="toc-text">AbstractUrlBasedView</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#InternalResourceView"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">InternalResourceView</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RedirectView"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">RedirectView</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异常处理器"><span class="toc-number">3.</span> <span class="toc-text">异常处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DispatcherServlet调用逻辑"><span class="toc-number">3.1.</span> <span class="toc-text">DispatcherServlet调用逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HandlerExceptionResolver体系"><span class="toc-number">3.2.</span> <span class="toc-text">HandlerExceptionResolver体系</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HandlerExceptionResolverComposite"><span class="toc-number">3.2.1.</span> <span class="toc-text">HandlerExceptionResolverComposite</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AbstractHandlerExceptionResolver"><span class="toc-number">3.2.2.</span> <span class="toc-text">AbstractHandlerExceptionResolver</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#SimpleMappingExceptionResolver"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">SimpleMappingExceptionResolver</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DefaultHandlerExceptionResolver"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">DefaultHandlerExceptionResolver</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ResponseStatusExceptionResolver"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">ResponseStatusExceptionResolver</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ExceptionHandlerExceptionResolver"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">ExceptionHandlerExceptionResolver</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ExceptionHandlerMethodResolver"><span class="toc-number">3.2.2.4.1.</span> <span class="toc-text">ExceptionHandlerMethodResolver</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 目录</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">springMVC核心三</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-03-26<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-04-03</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/java/">java</a></span><div class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">6.3k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 33 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2020/03/26/springMVC%E6%A0%B8%E5%BF%83%E4%B8%89/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></div></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><p>关于视图,我认为<code>mvc</code>框架中的提供完整视图从处理机制,和使用<code>Rest</code>开发基本是冲突,关于<code>View</code><br>部分,如模板处理,不做过多分析.</p>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><h2 id="视图解析器"><a href="#视图解析器" class="headerlink" title="视图解析器"></a>视图解析器</h2><img src="/2020/03/26/springMVC%E6%A0%B8%E5%BF%83%E4%B8%89/ViewResolver.png" class="">
<p>简单来说分为三类,<code>ViewResolverComposite</code>为典型的<code>Composite</code>,一般为<code>DispatcherServlet</code>持有</p>
<ul>
<li>接口定义<figure class="highlight java"><figcaption><span>ViewResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure>
<h3 id="BeanNameViewResolver"><a href="#BeanNameViewResolver" class="headerlink" title="BeanNameViewResolver"></a>BeanNameViewResolver</h3>从<code>Context</code>中获取<code>View</code></li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>BeanNameViewResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        ApplicationContext context = obtainApplicationContext();</span><br><span class="line">        <span class="keyword">if</span> (!context.containsBean(viewName)) &#123;</span><br><span class="line">            <span class="comment">// Allow for ViewResolver chaining...</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!context.isTypeMatch(viewName, View<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Found bean named '"</span> + viewName + <span class="string">"' but it does not implement View"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Since we're looking into the general ApplicationContext here,</span></span><br><span class="line">            <span class="comment">// let's accept this as a non-match and allow for chaining as well...</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> context.getBean(viewName, View<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ContentNegotiating"><a href="#ContentNegotiating" class="headerlink" title="ContentNegotiating"></a>ContentNegotiating</h3>使用了<code>ContentNegotiationManager</code>,该类用来通过<code>Request</code>判断<code>MiedaType</code></li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>ContentNegotiatingViewResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentNegotiatingViewResolver</span> <span class="keyword">extends</span> <span class="title">WebApplicationObjectSupport</span></span></span><br><span class="line"><span class="class">          <span class="keyword">implements</span> <span class="title">ViewResolver</span>, <span class="title">Ordered</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> ContentNegotiationManager contentNegotiationManager;</span><br><span class="line">          <span class="comment">//FactoryBean</span></span><br><span class="line">          <span class="keyword">private</span> <span class="keyword">final</span> ContentNegotiationManagerFactoryBean cnmFactoryBean = <span class="keyword">new</span> ContentNegotiationManagerFactoryBean();</span><br><span class="line">          <span class="comment">//内部含有的Resolver</span></span><br><span class="line">          <span class="keyword">private</span> List&lt;ViewResolver&gt; viewResolvers;</span><br><span class="line">        <span class="comment">//WebApplicationObjectSupport提供的,调用点实际上是ApplicationContextAwareProcessor#postProcessBeforeInitialization</span></span><br><span class="line">        <span class="comment">//即populate之后调用</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initServletContext</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">          Collection&lt;ViewResolver&gt; matchingBeans =</span><br><span class="line">                  BeanFactoryUtils.beansOfTypeIncludingAncestors(obtainApplicationContext(), ViewResolver<span class="class">.<span class="keyword">class</span>).<span class="title">values</span>()</span>;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.viewResolvers == <span class="keyword">null</span>) &#123; <span class="comment">//若本ViewResolver并没有定义viewResovler,则将beanFacory其他解析器添加</span></span><br><span class="line">              <span class="keyword">this</span>.viewResolvers = <span class="keyword">new</span> ArrayList&lt;&gt;(matchingBeans.size());</span><br><span class="line">              <span class="keyword">for</span> (ViewResolver viewResolver : matchingBeans) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (<span class="keyword">this</span> != viewResolver) &#123;</span><br><span class="line">                      <span class="keyword">this</span>.viewResolvers.add(viewResolver);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//若执行到这里viewResolvers.!=null</span></span><br><span class="line">        <span class="comment">//说明有某些处理器,如InstantiationAwareBeanPostProcessor可能添加ViewResolver到这里</span></span><br><span class="line">        <span class="comment">//并且不是通过pvs添加,这样直接添加的是不属于beanFactory管理的</span></span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.viewResolvers.size(); i++) &#123;</span><br><span class="line">                  ViewResolver vr = <span class="keyword">this</span>.viewResolvers.get(i);</span><br><span class="line">                  <span class="keyword">if</span> (matchingBeans.contains(vr)) &#123; <span class="comment">//明显就判断了一下,已经含有的不能是beanFactory中的</span></span><br><span class="line">                      <span class="keyword">continue</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  String name = vr.getClass().getName() + i;</span><br><span class="line">          <span class="comment">//将并非是ioc容器创造出来的解析器调用init</span></span><br><span class="line">                  obtainApplicationContext().getAutowireCapableBeanFactory().initializeBean(vr, name);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">          AnnotationAwareOrderComparator.sort(<span class="keyword">this</span>.viewResolvers);</span><br><span class="line">          <span class="keyword">this</span>.cnmFactoryBean.setServletContext(servletContext);</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">//创造内部的ContextNegotiationMannager</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.contentNegotiationManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">this</span>.contentNegotiationManager = <span class="keyword">this</span>.cnmFactoryBean.build();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.viewResolvers == <span class="keyword">null</span> || <span class="keyword">this</span>.viewResolvers.isEmpty()) &#123;</span><br><span class="line">              logger.warn(<span class="string">"No ViewResolvers configured"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//视图解析</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">          RequestAttributes attrs = RequestContextHolder.getRequestAttributes();</span><br><span class="line">          Assert.state(attrs <span class="keyword">instanceof</span> ServletRequestAttributes, <span class="string">"No current ServletRequestAttributes"</span>);</span><br><span class="line">          List&lt;MediaType&gt; requestedMediaTypes = getMediaTypes(((ServletRequestAttributes) attrs).getRequest());</span><br><span class="line">          <span class="keyword">if</span> (requestedMediaTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//遍历内部所有解析器,获取候选view</span></span><br><span class="line">              List&lt;View&gt; candidateViews = getCandidateViews(viewName, locale, requestedMediaTypes);</span><br><span class="line">        <span class="comment">//选择View#getContextTpe和判断出来的MiedaType符合的视图</span></span><br><span class="line">              View bestView = getBestView(candidateViews, requestedMediaTypes, attrs);</span><br><span class="line">            <span class="keyword">if</span> (bestView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> bestView;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String mediaTypeInfo = logger.isDebugEnabled() &amp;&amp; requestedMediaTypes != <span class="keyword">null</span> ?</span><br><span class="line">                <span class="string">" given "</span> + requestedMediaTypes.toString() : <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.useNotAcceptableStatusCode) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Using 406 NOT_ACCEPTABLE"</span> + mediaTypeInfo);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> NOT_ACCEPTABLE_VIEW;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.debug(<span class="string">"View remains unresolved"</span> + mediaTypeInfo);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;      </span><br></pre></td></tr></table></figure></li>
<li>总结<ul>
<li>改类本质也是委托模式,包含<code>List&lt;ViewResolver&gt;</code>来处理</li>
<li>目的是为了选出<code>View#getContexType</code>和<code>MiedaType</code>符合的视图</li>
<li>该类可以通过<code>mvc:content-negotiation</code>进行配置,参考<code>ViewResolversBeanDefinitionParser</code>实现<h3 id="AbstractCachingViewResolver"><a href="#AbstractCachingViewResolver" class="headerlink" title="AbstractCachingViewResolver"></a>AbstractCachingViewResolver</h3>简而言之,此类是带有缓存的视图解析器,总体逻辑简单,由子类实现<code>loadView()</code>来创建视图</li>
</ul>
</li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>AbstractCachingViewResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CACHE_LIMIT = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Fast access cache for Views, returning already cached instances without a global lock.</span></span><br><span class="line">  <span class="comment">//容量为1024的并发map</span></span><br><span class="line">  <span class="comment">//key实际上是 viewname+Local.toString(当前请求的Local字符串化,如zh,en)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, View&gt; viewAccessCache = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(DEFAULT_CACHE_LIMIT);</span><br><span class="line"><span class="comment">//Map from view key to View instance, synchronized for View creation.</span></span><br><span class="line"><span class="comment">//创建缓存时加锁,这里有趣的是重写removeEldestEntry</span></span><br><span class="line"><span class="comment">//简单来说在&#123;@link LinkedHashMap&#125;中说明该函数是当插入新元素时,可以选择将eldest元素是否删除,</span></span><br><span class="line"><span class="comment">//典型的就是当使用map作为含有limit的时候,如这里1024,超过该值就选择删除最早的元素</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, View&gt; viewCreationCache =</span><br><span class="line">            <span class="keyword">new</span> LinkedHashMap&lt;Object, View&gt;(DEFAULT_CACHE_LIMIT, <span class="number">0.75f</span>, <span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;Object, View&gt; eldest)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (size() &gt; getCacheLimit()) &#123;</span><br><span class="line">                        viewAccessCache.remove(eldest.getKey());<span class="comment">//主动删除viewAccessCache缓存</span></span><br><span class="line">            <span class="comment">//返回true后this的eldest会被LinkHashMap删除</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">      <span class="comment">//构建视图逻辑</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (!isCache()) &#123;</span><br><span class="line">                  <span class="keyword">return</span> createView(viewName, locale);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> &#123;</span><br><span class="line">                  Object cacheKey = getCacheKey(viewName, locale);</span><br><span class="line">                  View view = <span class="keyword">this</span>.viewAccessCache.get(cacheKey);</span><br><span class="line">                  <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">                      <span class="keyword">synchronized</span> (<span class="keyword">this</span>.viewCreationCache) &#123;</span><br><span class="line">                <span class="comment">//简单来看,当创建的时候将降维单线程</span></span><br><span class="line">                <span class="comment">//1.可以防止当CacheKey相同时,发生不必要的重复创建工作,但是这点可以通过sych(cacheKey.intern())实现</span></span><br><span class="line">                <span class="comment">//2.我认为是子类实现的createView未必是线程安全的,因此这么实现锁</span></span><br><span class="line">                          view = <span class="keyword">this</span>.viewCreationCache.get(cacheKey);</span><br><span class="line">                          <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">                              <span class="comment">// Ask the subclass to create the View object.</span></span><br><span class="line">                              view = createView(viewName, locale);</span><br><span class="line">                              <span class="keyword">if</span> (view == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.cacheUnresolved) &#123;</span><br><span class="line">                                  view = UNRESOLVED_VIEW;</span><br><span class="line">                              &#125;</span><br><span class="line">                              <span class="keyword">if</span> (view != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.cacheFilter.filter(view, viewName, locale)) &#123;</span><br><span class="line">                                  <span class="keyword">this</span>.viewAccessCache.put(cacheKey, view);</span><br><span class="line">                                  <span class="keyword">this</span>.viewCreationCache.put(cacheKey, view);</span><br><span class="line">                              &#125;</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                          logger.trace(formatKey(cacheKey) + <span class="string">"served from cache"</span>);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">return</span> (view != UNRESOLVED_VIEW ? view : <span class="keyword">null</span>);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> View <span class="title">createView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> loadView(viewName, locale);</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> View <span class="title">loadView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure></li>
<li>总结<ul>
<li>附带缓存,并且实现了线程安全<h4 id="ResourceBundleViewResolver"><a href="#ResourceBundleViewResolver" class="headerlink" title="ResourceBundleViewResolver"></a>ResourceBundleViewResolver</h4>该类实现上使用了<code>ResourceBundle</code>来对于不同<code>Local</code>根据不同的in18配置文件,返回不同的<code>View</code></li>
</ul>
</li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>ResourceBundleViewResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//properties默认名字</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_BASENAME = <span class="string">"views"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> View <span class="title">loadView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        BeanFactory factory = initFactory(locale);<span class="comment">//创造不同的bf</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> factory.getBean(viewName, View<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">            <span class="comment">// Allow for ViewResolver chaining...</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> BeanFactory <span class="title">initFactory</span><span class="params">(Locale locale)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">          <span class="comment">// Try to find cached factory for Locale:</span></span><br><span class="line">          <span class="comment">// Have we already encountered that Locale before?</span></span><br><span class="line">          <span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">              BeanFactory cachedFactory = <span class="keyword">this</span>.localeCache.get(locale);</span><br><span class="line">              <span class="keyword">if</span> (cachedFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">return</span> cachedFactory;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Build list of ResourceBundle references for Locale.</span></span><br><span class="line">          List&lt;ResourceBundle&gt; bundles = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">          <span class="keyword">for</span> (String basename : <span class="keyword">this</span>.basenames) &#123;</span><br><span class="line">              ResourceBundle bundle = getBundle(basename, locale);</span><br><span class="line">              bundles.add(bundle);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Try to find cached factory for ResourceBundle list:</span></span><br><span class="line">          <span class="comment">// even if Locale was different, same bundles might have been found.</span></span><br><span class="line">          <span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">              BeanFactory cachedFactory = <span class="keyword">this</span>.bundleCache.get(bundles);</span><br><span class="line">              <span class="keyword">if</span> (cachedFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">this</span>.localeCache.put(locale, cachedFactory);</span><br><span class="line">                  <span class="keyword">return</span> cachedFactory;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Create child ApplicationContext for views.</span></span><br><span class="line">      <span class="comment">//通过上边获取到的ResourceBundle去读取不同的properties文件,并加载进行GAC</span></span><br><span class="line">          GenericWebApplicationContext factory = <span class="keyword">new</span> GenericWebApplicationContext();</span><br><span class="line">          factory.setParent(getApplicationContext());</span><br><span class="line">          factory.setServletContext(getServletContext());</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Load bean definitions from resource bundle.</span></span><br><span class="line">      <span class="comment">//properties配置读取器</span></span><br><span class="line">          PropertiesBeanDefinitionReader reader = <span class="keyword">new</span> PropertiesBeanDefinitionReader(factory);</span><br><span class="line">          reader.setDefaultParentBean(<span class="keyword">this</span>.defaultParentView);</span><br><span class="line">          <span class="keyword">for</span> (ResourceBundle bundle : bundles) &#123;</span><br><span class="line">              reader.registerBeanDefinitions(bundle);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          factory.refresh();</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Cache factory for both Locale and ResourceBundle list.</span></span><br><span class="line">          <span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">              <span class="keyword">this</span>.localeCache.put(locale, factory);</span><br><span class="line">              <span class="keyword">this</span>.bundleCache.put(bundles, factory);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> factory;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></li>
<li>总结<ul>
<li>实现简单,具体如何配置参考后文</li>
<li>properties必须是<code>views.properties</code>这样的命名</li>
<li>例子<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">testViewName.(class)</span>=<span class="string">org.springframework.web.servlet.view.InternalResourceView</span></span><br><span class="line"><span class="meta">testViewName.url</span>=<span class="string">/WEB-INF/index.jsp</span></span><br></pre></td></tr></table></figure></li>
<li>关于<code>properties</code>作为配置文件,参考<code>PropertiesBeanDefinitionReader</code>  <h4 id="XmlViewResolver"><a href="#XmlViewResolver" class="headerlink" title="XmlViewResolver"></a>XmlViewResolver</h4>和<code>ResourceBundleViewResolver</code>实现一致,不过是从xml中读取</li>
</ul>
</li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>XmlViewResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">   </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_LOCATION = <span class="string">"/WEB-INF/views.xml"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> View <span class="title">loadView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        BeanFactory factory = initFactory();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> factory.getBean(viewName, View<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">            <span class="comment">// Allow for ViewResolver chaining...</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> BeanFactory <span class="title">initFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.cachedFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.cachedFactory;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ApplicationContext applicationContext = obtainApplicationContext();</span><br><span class="line"></span><br><span class="line">        Resource actualLocation = <span class="keyword">this</span>.location;</span><br><span class="line">        <span class="keyword">if</span> (actualLocation == <span class="keyword">null</span>) &#123;</span><br><span class="line">            actualLocation = applicationContext.getResource(DEFAULT_LOCATION);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create child ApplicationContext for views.</span></span><br><span class="line">    <span class="comment">//读取xml并创建gac</span></span><br><span class="line">        GenericWebApplicationContext factory = <span class="keyword">new</span> GenericWebApplicationContext();</span><br><span class="line">        factory.setParent(applicationContext);</span><br><span class="line">        factory.setServletContext(getServletContext());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load XML resource with context-aware entity resolver.</span></span><br><span class="line">        XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(factory);</span><br><span class="line">        reader.setEnvironment(applicationContext.getEnvironment());</span><br><span class="line">        reader.setEntityResolver(<span class="keyword">new</span> ResourceEntityResolver(applicationContext));</span><br><span class="line">        reader.loadBeanDefinitions(actualLocation);</span><br><span class="line"></span><br><span class="line">        factory.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.cachedFactory = factory;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line">- 总结</span><br><span class="line">  - 上述两种视图解析器的使用,用例子说明了gbc中的bean定义来源是可以多样化的</span><br></pre></td></tr></table></figure>
<h4 id="UrlBasedViewResolver"><a href="#UrlBasedViewResolver" class="headerlink" title="UrlBasedViewResolver"></a>UrlBasedViewResolver</h4></li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>UrlBasedViewResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REDIRECT_URL_PREFIX = <span class="string">"redirect:"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FORWARD_URL_PREFIX = <span class="string">"forward:"</span>;</span><br><span class="line"><span class="comment">//返回的视图对象</span></span><br><span class="line"><span class="keyword">private</span> Class&lt;?&gt; viewClass;</span><br><span class="line"><span class="keyword">private</span> String prefix = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">private</span> String suffix = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//重写父类,为了处理重定向和转发视图</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> View <span class="title">createView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// If this resolver is not supposed to handle the given view,</span></span><br><span class="line">        <span class="comment">// return null to pass on to the next resolver in the chain.</span></span><br><span class="line">        <span class="keyword">if</span> (!canHandle(viewName, locale)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//处理RedirectView</span></span><br><span class="line">        <span class="comment">// Check for special "redirect:" prefix.</span></span><br><span class="line">        <span class="keyword">if</span> (viewName.startsWith(REDIRECT_URL_PREFIX)) &#123;</span><br><span class="line">            String redirectUrl = viewName.substring(REDIRECT_URL_PREFIX.length());</span><br><span class="line">            RedirectView view = <span class="keyword">new</span> RedirectView(redirectUrl,</span><br><span class="line">                    isRedirectContextRelative(), isRedirectHttp10Compatible());</span><br><span class="line">            String[] hosts = getRedirectHosts();</span><br><span class="line">            <span class="keyword">if</span> (hosts != <span class="keyword">null</span>) &#123;</span><br><span class="line">                view.setHosts(hosts);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> applyLifecycleMethods(REDIRECT_URL_PREFIX, view);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建Internal视图</span></span><br><span class="line">        <span class="comment">// Check for special "forward:" prefix.</span></span><br><span class="line">        <span class="keyword">if</span> (viewName.startsWith(FORWARD_URL_PREFIX)) &#123;</span><br><span class="line">            String forwardUrl = viewName.substring(FORWARD_URL_PREFIX.length());</span><br><span class="line">            InternalResourceView view = <span class="keyword">new</span> InternalResourceView(forwardUrl);</span><br><span class="line">            <span class="keyword">return</span> applyLifecycleMethods(FORWARD_URL_PREFIX, view);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Else fall back to superclass implementation: calling loadView.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.createView(viewName, locale);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//由不同的子类决定不同的视图</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; requiredViewClass() &#123;</span><br><span class="line">        <span class="keyword">return</span> AbstractUrlBasedView<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> View <span class="title">loadView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            AbstractUrlBasedView view = buildView(viewName);</span><br><span class="line">            View result = applyLifecycleMethods(viewName, view);</span><br><span class="line">            <span class="keyword">return</span> (view.checkResource(locale) ? result : <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> View <span class="title">applyLifecycleMethods</span><span class="params">(String viewName, AbstractUrlBasedView view)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = getApplicationContext();</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object initialized = context.getAutowireCapableBeanFactory().initializeBean(view, viewName);</span><br><span class="line">            <span class="keyword">if</span> (initialized <span class="keyword">instanceof</span> View) &#123;</span><br><span class="line">                <span class="keyword">return</span> (View) initialized;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//构建视图对象,并没有通过bf构建,而是反射</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AbstractUrlBasedView <span class="title">buildView</span><span class="params">(String viewName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            Class&lt;?&gt; viewClass = getViewClass();</span><br><span class="line">            Assert.state(viewClass != <span class="keyword">null</span>, <span class="string">"No view class"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//子类决定类型,为何不使用泛型来实现</span></span><br><span class="line">            AbstractUrlBasedView view = (AbstractUrlBasedView) BeanUtils.instantiateClass(viewClass);</span><br><span class="line">            view.setUrl(getPrefix() + viewName + getSuffix());</span><br><span class="line">            view.setAttributesMap(getAttributesMap());</span><br><span class="line"></span><br><span class="line">            String contentType = getContentType();</span><br><span class="line">            <span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">                view.setContentType(contentType);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String requestContextAttribute = getRequestContextAttribute();</span><br><span class="line">            <span class="keyword">if</span> (requestContextAttribute != <span class="keyword">null</span>) &#123;</span><br><span class="line">                view.setRequestContextAttribute(requestContextAttribute);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Boolean exposePathVariables = getExposePathVariables();</span><br><span class="line">            <span class="keyword">if</span> (exposePathVariables != <span class="keyword">null</span>) &#123;</span><br><span class="line">                view.setExposePathVariables(exposePathVariables);</span><br><span class="line">            &#125;</span><br><span class="line">            Boolean exposeContextBeansAsAttributes = getExposeContextBeansAsAttributes();</span><br><span class="line">            <span class="keyword">if</span> (exposeContextBeansAsAttributes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                view.setExposeContextBeansAsAttributes(exposeContextBeansAsAttributes);</span><br><span class="line">            &#125;</span><br><span class="line">            String[] exposedContextBeanNames = getExposedContextBeanNames();</span><br><span class="line">            <span class="keyword">if</span> (exposedContextBeanNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">                view.setExposedContextBeanNames(exposedContextBeanNames);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> view;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li>
<li>总体<ul>
<li>支持<code>forward:</code>和<code>redirect:</code></li>
<li>带有<code>prefix</code>和<code>suffix</code></li>
<li>由子类决定<code>viewClass</code></li>
<li>重写<code>createView</code>来处理<code>rediect</code>视图,以及<code>forward</code>视图<h5 id="子类"><a href="#子类" class="headerlink" title="子类"></a>子类</h5></li>
</ul>
</li>
<li>InternalResourceViewResolver:用来构建<code>InternalResourceView</code><figure class="highlight java"><figcaption><span>InternalResourceViewResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InternalResourceViewResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; viewClass = requiredViewClass();</span><br><span class="line">        <span class="keyword">if</span> (InternalResourceView<span class="class">.<span class="keyword">class</span> </span>== viewClass &amp;&amp; jstlPresent) &#123;</span><br><span class="line">            viewClass = JstlView<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        setViewClass(viewClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AbstractUrlBasedView <span class="title">buildView</span><span class="params">(String viewName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InternalResourceView view = (InternalResourceView) <span class="keyword">super</span>.buildView(viewName);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.alwaysInclude != <span class="keyword">null</span>) &#123;</span><br><span class="line">            view.setAlwaysInclude(<span class="keyword">this</span>.alwaysInclude);</span><br><span class="line">        &#125;</span><br><span class="line">        view.setPreventDispatchLoop(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>TilesViewResolver:构建<code>TilesView</code></li>
<li>ScriptTemplateViewResolver:构建<code>ScriptTemplateView</code></li>
<li>XsltViewResolver:构建<code>XsltView</code><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2>接口定义<figure class="highlight java"><figcaption><span>View</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">View</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">getContentType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">render</span><span class="params">(@Nullable Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2020/03/26/springMVC%E6%A0%B8%E5%BF%83%E4%B8%89/View.png" class="">
<h3 id="AbstactView"><a href="#AbstactView" class="headerlink" title="AbstactView"></a>AbstactView</h3></li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>AbstactView</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractView</span> <span class="keyword">extends</span> <span class="title">WebApplicationObjectSupport</span> <span class="keyword">implements</span> <span class="title">View</span>, <span class="title">BeanNameAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">render</span><span class="params">(@Nullable Map&lt;String, ?&gt; model, HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">"View "</span> + formatViewName() +</span><br><span class="line">                    <span class="string">", model "</span> + (model != <span class="keyword">null</span> ? model : Collections.emptyMap()) +</span><br><span class="line">                    (<span class="keyword">this</span>.staticAttributes.isEmpty() ? <span class="string">""</span> : <span class="string">", static attributes "</span> + <span class="keyword">this</span>.staticAttributes));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; mergedModel = createMergedOutputModel(model, request, response);</span><br><span class="line">        prepareResponse(request, response);<span class="comment">//处理响应头</span></span><br><span class="line">        renderMergedOutputModel(mergedModel, getRequestToExpose(request), response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//合并属性</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Map&lt;String, Object&gt; <span class="title">createMergedOutputModel</span><span class="params">(@Nullable Map&lt;String, ?&gt; model,</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//View.PATH_VARIABLES map</span></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        Map&lt;String, Object&gt; pathVars = (<span class="keyword">this</span>.exposePathVariables ?</span><br><span class="line">                (Map&lt;String, Object&gt;) request.getAttribute(View.PATH_VARIABLES) : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Consolidate static and dynamic model attributes.</span></span><br><span class="line">        <span class="comment">//staticAttributes map</span></span><br><span class="line">        <span class="keyword">int</span> size = <span class="keyword">this</span>.staticAttributes.size();</span><br><span class="line">        size += (model != <span class="keyword">null</span> ? model.size() : <span class="number">0</span>);</span><br><span class="line">        size += (pathVars != <span class="keyword">null</span> ? pathVars.size() : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; mergedModel = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(size);</span><br><span class="line">        mergedModel.putAll(<span class="keyword">this</span>.staticAttributes);</span><br><span class="line">        <span class="keyword">if</span> (pathVars != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mergedModel.putAll(pathVars);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//model map</span></span><br><span class="line">        <span class="keyword">if</span> (model != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mergedModel.putAll(model);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Expose RequestContext?</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.requestContextAttribute != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mergedModel.put(<span class="keyword">this</span>.requestContextAttribute, createRequestContext(request, response, mergedModel));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mergedModel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareResponse</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (generatesDownloadContent()) &#123;</span><br><span class="line">            response.setHeader(<span class="string">"Pragma"</span>, <span class="string">"private"</span>);</span><br><span class="line">            response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"private, must-revalidate"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//子类实现</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">renderMergedOutputModel</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="AbstractJackson2View"><a href="#AbstractJackson2View" class="headerlink" title="AbstractJackson2View"></a>AbstractJackson2View</h4>代码简单,通过jackson api进行<code>application/json</code>和<code>application/xml</code>转换处理</li>
<li>MappingJackson2JsonView<br>处理上文中合并的<code>modelMap</code>,将value转换成json</li>
<li>MappingJackson2XmlView<br>处理上文中合并的<code>modelMap</code>,将value转换成xml<h4 id="AbstractUrlBasedView"><a href="#AbstractUrlBasedView" class="headerlink" title="AbstractUrlBasedView"></a>AbstractUrlBasedView</h4>该部分子类和<code>UrlBasedViewResolver</code>子类相对应<h5 id="InternalResourceView"><a href="#InternalResourceView" class="headerlink" title="InternalResourceView"></a>InternalResourceView</h5></li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>InternalResourceView</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalResourceView</span> <span class="keyword">extends</span> <span class="title">AbstractUrlBasedView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">renderMergedOutputModel</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Expose the model object as request attributes.</span></span><br><span class="line">        <span class="comment">//model属性添加到res中</span></span><br><span class="line">        exposeModelAsRequestAttributes(model, request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Expose helpers as request attributes, if any.</span></span><br><span class="line">        exposeHelpers(request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Determine the path for the request dispatcher</span></span><br><span class="line">        <span class="comment">// url  = prefix  +viewName+ suffix</span></span><br><span class="line">        String dispatcherPath = prepareForRendering(request, response);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Obtain a RequestDispatcher for the target resource (typically a JSP).</span></span><br><span class="line">        RequestDispatcher rd = getRequestDispatcher(request, dispatcherPath);</span><br><span class="line">        <span class="keyword">if</span> (rd == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"Could not get RequestDispatcher for ["</span> + getUrl() +</span><br><span class="line">                    <span class="string">"]: Check that the corresponding file exists within your web application archive!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If already included or response already committed, perform include, else forward.</span></span><br><span class="line">        <span class="keyword">if</span> (useInclude(request, response)) &#123;</span><br><span class="line">            response.setContentType(getContentType());</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Including ["</span> + getUrl() + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            rd.include(request, response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Note: The forwarded resource is supposed to determine the content type itself.</span></span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Forwarding to ["</span> + getUrl() + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            rd.forward(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>总结<ul>
<li><code>prefix</code>+viewname+’suffix’访问jsp或servlet,以及其他页面</li>
<li>通过<code>RequestDispatcher</code>进行<code>include</code>和<code>forward</code>处理<h5 id="RedirectView"><a href="#RedirectView" class="headerlink" title="RedirectView"></a>RedirectView</h5></li>
</ul>
</li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>RedirectView</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedirectView</span> <span class="keyword">extends</span> <span class="title">AbstractUrlBasedView</span> <span class="keyword">implements</span> <span class="title">SmartView</span> </span>&#123;</span><br><span class="line">    <span class="comment">//匹配重定义url中是否有占位符url</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern URI_TEMPLATE_VARIABLE_PATTERN = Pattern.compile(<span class="string">"\\&#123;([^/]+?)\\&#125;"</span>);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">renderMergedOutputModel</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        String targetUrl = createTargetUrl(model,request);</span><br><span class="line">        <span class="comment">//调用一个 RequestDataValueProcessor当作触发器,默认 没有实现</span></span><br><span class="line">        targetUrl = updateTargetUrl(targetUrl, model, request, response);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Save flash attributes</span></span><br><span class="line">        <span class="comment">//将outFlash数据放置到重定向url中</span></span><br><span class="line">        RequestContextUtils.saveOutputFlashMap(targetUrl, request, response);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Redirect</span></span><br><span class="line">        <span class="comment">//response重定向设置</span></span><br><span class="line">        sendRedirect(request, response, targetUrl, <span class="keyword">this</span>.http10Compatible);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> String <span class="title">createTargetUrl</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Prepare target URL.</span></span><br><span class="line">            StringBuilder targetUrl = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            String url = getUrl();</span><br><span class="line">            Assert.state(url != <span class="keyword">null</span>, <span class="string">"'url' not set"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.contextRelative &amp;&amp; getUrl().startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">                <span class="comment">// Do not apply context path to relative URLs.</span></span><br><span class="line">                targetUrl.append(getContextPath(request));</span><br><span class="line">            &#125;</span><br><span class="line">            targetUrl.append(getUrl());</span><br><span class="line"></span><br><span class="line">            String enc = <span class="keyword">this</span>.encodingScheme;</span><br><span class="line">            <span class="keyword">if</span> (enc == <span class="keyword">null</span>) &#123;</span><br><span class="line">                enc = request.getCharacterEncoding();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (enc == <span class="keyword">null</span>) &#123;</span><br><span class="line">                enc = WebUtils.DEFAULT_CHARACTER_ENCODING;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//替换重定向中的temp url</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.expandUriTemplateVariables &amp;&amp; StringUtils.hasText(targetUrl)) &#123;</span><br><span class="line">                <span class="comment">//获取当前的temp url</span></span><br><span class="line">                Map&lt;String, String&gt; variables = getCurrentRequestUriVariables(request);</span><br><span class="line">                targetUrl = replaceUriTemplateVariables(targetUrl.toString(), model, variables, enc);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isPropagateQueryProperties()) &#123;</span><br><span class="line">                appendCurrentQueryParams(targetUrl, request);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.exposeModelAttributes) &#123;</span><br><span class="line">                appendQueryProperties(targetUrl, model, enc);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> targetUrl.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> String <span class="title">getContextPath</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">            String contextPath = request.getContextPath();</span><br><span class="line">            <span class="keyword">while</span> (contextPath.startsWith(<span class="string">"//"</span>)) &#123;</span><br><span class="line">                contextPath = contextPath.substring(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> contextPath;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//一段一段替换</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> StringBuilder <span class="title">replaceUriTemplateVariables</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            String targetUrl, Map&lt;String, Object&gt; model, Map&lt;String, String&gt; currentUriVariables, String encodingScheme)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</span><br><span class="line"></span><br><span class="line">        StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        Matcher matcher = URI_TEMPLATE_VARIABLE_PATTERN.matcher(targetUrl);</span><br><span class="line">        <span class="keyword">int</span> endLastMatch = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">            String name = matcher.group(<span class="number">1</span>);</span><br><span class="line">            Object value = (model.containsKey(name) ? model.remove(name) : currentUriVariables.get(name));</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Model has no value for key '"</span> + name + <span class="string">"'"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            result.append(targetUrl.substring(endLastMatch, matcher.start()));</span><br><span class="line">            result.append(UriUtils.encodePathSegment(value.toString(), encodingScheme));</span><br><span class="line">            endLastMatch = matcher.end();</span><br><span class="line">        &#125;</span><br><span class="line">        result.append(targetUrl.substring(endLastMatch));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">getCurrentRequestUriVariables</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">            String name = HandlerMapping.URI_TEMPLATE_VARIABLES_ATTRIBUTE; <span class="comment">//temp url是在mapping中处理的</span></span><br><span class="line">            Map&lt;String, String&gt; uriVars = (Map&lt;String, String&gt;) request.getAttribute(name);</span><br><span class="line">            <span class="keyword">return</span> (uriVars != <span class="keyword">null</span>) ? uriVars : Collections.&lt;String, String&gt; emptyMap();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>总结</p>
<ul>
<li>支持temp url<ul>
<li>例子  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"redirect/&#123;red&#125;/test/&#123;red2&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">redirectView</span><span class="params">(RedirectAttributes attributes)</span></span>&#123;</span><br><span class="line">        attributes.addAttribute(<span class="string">"reKey"</span>,<span class="string">"reValue"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:/redirect/&#123;red&#125;/test/&#123;red2&#125;/xx"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>会将<code>OutFlashMap</code>的数据,拼接到重定向url中,并且缓存到<code>FlashMapManager</code></p>
<p>剩下的视图不做过多分析,基本基于<code>rest</code>是不会使用的</p>
<h2 id="异常处理器"><a href="#异常处理器" class="headerlink" title="异常处理器"></a>异常处理器</h2><h3 id="DispatcherServlet调用逻辑"><a href="#DispatcherServlet调用逻辑" class="headerlink" title="DispatcherServlet调用逻辑"></a>DispatcherServlet调用逻辑</h3><figure class="highlight java"><figcaption><span>DispatcherServlet</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">processHandlerException</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Success and error responses may use different content types</span></span><br><span class="line">        request.removeAttribute(HandlerMapping.PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check registered HandlerExceptionResolvers...</span></span><br><span class="line">        ModelAndView exMv = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//[1!] 处理器调用</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.handlerExceptionResolvers != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (HandlerExceptionResolver resolver : <span class="keyword">this</span>.handlerExceptionResolvers) &#123;</span><br><span class="line">                exMv = resolver.resolveException(request, response, handler, ex);</span><br><span class="line">                <span class="keyword">if</span> (exMv != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//[1]</span></span><br><span class="line">        <span class="comment">//[2]处理</span></span><br><span class="line">        <span class="keyword">if</span> (exMv != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (exMv.isEmpty()) &#123;</span><br><span class="line">                request.setAttribute(EXCEPTION_ATTRIBUTE, ex);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// We might still need view name translation for a plain error model...</span></span><br><span class="line">            <span class="keyword">if</span> (!exMv.hasView()) &#123;</span><br><span class="line">                String defaultViewName = getDefaultViewName(request);</span><br><span class="line">                <span class="keyword">if</span> (defaultViewName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    exMv.setViewName(defaultViewName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(<span class="string">"Using resolved error view: "</span> + exMv, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Using resolved error view: "</span> + exMv);</span><br><span class="line">            &#125;</span><br><span class="line">            WebUtils.exposeErrorRequestAttributes(request, ex, getServletName());</span><br><span class="line">            <span class="keyword">return</span> exMv;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//[2!]</span></span><br><span class="line">        <span class="comment">//[3] 若处理器没有正确返回视图,则抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="HandlerExceptionResolver体系"><a href="#HandlerExceptionResolver体系" class="headerlink" title="HandlerExceptionResolver体系"></a>HandlerExceptionResolver体系</h3><img src="/2020/03/26/springMVC%E6%A0%B8%E5%BF%83%E4%B8%89/HandlerExceptionRe.png" class="" title="HandlerExceptionResolver.png">
<h4 id="HandlerExceptionResolverComposite"><a href="#HandlerExceptionResolverComposite" class="headerlink" title="HandlerExceptionResolverComposite"></a>HandlerExceptionResolverComposite</h4><p>典型的<code>Composite</code>,<code>DispatcherServlet</code>默认并不是这个,在使用注解配置mvc的<code>WebMvcConfigurationSupport#handlerExceptionResolver</code>中才<br>使用了这个来配置</p>
<h4 id="AbstractHandlerExceptionResolver"><a href="#AbstractHandlerExceptionResolver" class="headerlink" title="AbstractHandlerExceptionResolver"></a>AbstractHandlerExceptionResolver</h4></li>
</ul>
</li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>AbstractHandlerExceptionResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHandlerExceptionResolver</span> <span class="keyword">implements</span> <span class="title">HandlerExceptionResolver</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Handler实例,如Controller,HandlerMethod,等</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;?&gt; mappedHandlers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_CACHE_CONTROL = <span class="string">"Cache-Control"</span>;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="comment">//Handler类对象</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt;[] mappedHandlerClasses;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">resolveException</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletRequest request, HttpServletResponse response, @Nullable Object handler, Exception ex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shouldApplyTo(request, handler)) &#123;<span class="comment">//判断是否进行异常处理</span></span><br><span class="line">            prepareResponse(ex, response); <span class="comment">//设置一个Cache-Control</span></span><br><span class="line">            ModelAndView result = doResolveException(request, response, handler, ex);<span class="comment">//子类实现</span></span><br><span class="line">            <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Print debug message when warn logger is not enabled.</span></span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled() &amp;&amp; (<span class="keyword">this</span>.warnLogger == <span class="keyword">null</span> || !<span class="keyword">this</span>.warnLogger.isWarnEnabled())) &#123;</span><br><span class="line">                    logger.debug(<span class="string">"Resolved ["</span> + ex + <span class="string">"]"</span> + (result.isEmpty() ? <span class="string">""</span> : <span class="string">" to "</span> + result));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Explicitly configured warn logger in logException method.</span></span><br><span class="line">                logException(ex, request);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">shouldApplyTo</span><span class="params">(HttpServletRequest request, @Nullable Object handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;<span class="comment">//包含实例</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.mappedHandlers != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.mappedHandlers.contains(handler)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.mappedHandlerClasses != <span class="keyword">null</span>) &#123;<span class="comment">//包含类</span></span><br><span class="line">                <span class="keyword">for</span> (Class&lt;?&gt; handlerClass : <span class="keyword">this</span>.mappedHandlerClasses) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (handlerClass.isInstance(handler)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Else only apply if there are no explicit handler mappings.</span></span><br><span class="line">        <span class="comment">//若不去设置,这里一般都是这条件,全通过</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.mappedHandlers == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.mappedHandlerClasses == <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>总结<ul>
<li>提供了对于<code>Handler</code>的过滤能力,spring默认实现并没有使用<h5 id="SimpleMappingExceptionResolver"><a href="#SimpleMappingExceptionResolver" class="headerlink" title="SimpleMappingExceptionResolver"></a>SimpleMappingExceptionResolver</h5></li>
</ul>
</li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>SimpleMappingExceptionResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleMappingExceptionResolver</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerExceptionResolver</span> </span>&#123;</span><br><span class="line">        <span class="comment">// key为异常名,value为视图名</span></span><br><span class="line">        <span class="keyword">private</span> Properties exceptionMappings;</span><br><span class="line">        <span class="comment">//不处理的异常</span></span><br><span class="line">        <span class="meta">@Nullable</span></span><br><span class="line">        <span class="keyword">private</span> Class&lt;?&gt;[] excludedExceptions;</span><br><span class="line">        <span class="comment">//默认错误视图页面</span></span><br><span class="line">        <span class="meta">@Nullable</span></span><br><span class="line">        <span class="keyword">private</span> String defaultErrorView;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Nullable</span></span><br><span class="line">        <span class="keyword">private</span> Integer defaultStatusCode;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Map&lt;String, Integer&gt; statusCodes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Nullable</span></span><br><span class="line">        <span class="keyword">private</span> String exceptionAttribute = DEFAULT_EXCEPTION_ATTRIBUTE;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">doResolveException</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletRequest request, HttpServletResponse response, @Nullable Object handler, Exception ex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Expose ModelAndView for chosen error view.</span></span><br><span class="line">        String viewName = determineViewName(ex, request);</span><br><span class="line">        <span class="keyword">if</span> (viewName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Apply HTTP status code for error views, if specified.</span></span><br><span class="line">            <span class="comment">// Only apply it if we're processing a top-level request.</span></span><br><span class="line">            Integer statusCode = determineStatusCode(request, viewName);</span><br><span class="line">            <span class="keyword">if</span> (statusCode != <span class="keyword">null</span>) &#123;</span><br><span class="line">                applyStatusCodeIfPossible(request, response, statusCode);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> getModelAndView(viewName, ex, request); <span class="comment">//创建ModelAndView,并返回</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">determineViewName</span><span class="params">(Exception ex, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String viewName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.excludedExceptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; excludedEx : <span class="keyword">this</span>.excludedExceptions) &#123; <span class="comment">//排除的跳过</span></span><br><span class="line">                <span class="keyword">if</span> (excludedEx.equals(ex.getClass())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Check for specific exception mappings.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.exceptionMappings != <span class="keyword">null</span>) &#123; <span class="comment">//若定义了properties,则进行匹配</span></span><br><span class="line">            viewName = findMatchingViewName(<span class="keyword">this</span>.exceptionMappings, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Return default error view else, if defined.</span></span><br><span class="line">        <span class="keyword">if</span> (viewName == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.defaultErrorView != <span class="keyword">null</span>) &#123; <span class="comment">//未定义或未匹配到,则返回默认值</span></span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Resolving to default view '"</span> + <span class="keyword">this</span>.defaultErrorView + <span class="string">"'"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            viewName = <span class="keyword">this</span>.defaultErrorView;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> viewName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------匹配逻辑----------------</span></span><br><span class="line">    <span class="comment">//简单来说就是递归确定ex以及其父类有无能够和propeties中有匹配的情况,匹配就返回viewname</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">findMatchingViewName</span><span class="params">(Properties exceptionMappings, Exception ex)</span> </span>&#123;</span><br><span class="line">        String viewName = <span class="keyword">null</span>;</span><br><span class="line">        String dominantMapping = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> deepest = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">for</span> (Enumeration&lt;?&gt; names = exceptionMappings.propertyNames(); names.hasMoreElements();) &#123;</span><br><span class="line">            String exceptionMapping = (String) names.nextElement();</span><br><span class="line">            <span class="keyword">int</span> depth = getDepth(exceptionMapping, ex); <span class="comment">//递归</span></span><br><span class="line">            <span class="keyword">if</span> (depth &gt;= <span class="number">0</span> &amp;&amp; (depth &lt; deepest || (depth == deepest &amp;&amp;</span><br><span class="line">                    dominantMapping != <span class="keyword">null</span> &amp;&amp; exceptionMapping.length() &gt; dominantMapping.length()))) &#123;</span><br><span class="line">                deepest = depth;</span><br><span class="line">                dominantMapping = exceptionMapping;</span><br><span class="line">                viewName = exceptionMappings.getProperty(exceptionMapping);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (viewName != <span class="keyword">null</span> &amp;&amp; logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Resolving to view '"</span> + viewName + <span class="string">"' based on mapping ["</span> + dominantMapping + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> viewName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getDepth</span><span class="params">(String exceptionMapping, Exception ex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getDepth(exceptionMapping, ex.getClass(), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getDepth</span><span class="params">(String exceptionMapping, Class&lt;?&gt; exceptionClass, <span class="keyword">int</span> depth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (exceptionClass.getName().contains(exceptionMapping)) &#123;</span><br><span class="line">            <span class="comment">// Found it!</span></span><br><span class="line">            <span class="keyword">return</span> depth;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If we've gone as far as we can go and haven't found it...</span></span><br><span class="line">        <span class="keyword">if</span> (exceptionClass == Throwable<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getDepth(exceptionMapping, exceptionClass.getSuperclass(), depth + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------状态码----------------</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Integer <span class="title">determineStatusCode</span><span class="params">(HttpServletRequest request, String viewName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.statusCodes.containsKey(viewName)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.statusCodes.get(viewName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.defaultStatusCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="DefaultHandlerExceptionResolver"><a href="#DefaultHandlerExceptionResolver" class="headerlink" title="DefaultHandlerExceptionResolver"></a>DefaultHandlerExceptionResolver</h5>该实现将spring提供的异常一一对应,返回对应的状态码,<code>MVCContainer</code>为空</li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>DefaultHandlerExceptionResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultHandlerExceptionResolver</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerExceptionResolver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">doResolveException</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletRequest request, HttpServletResponse response, @Nullable Object handler, Exception ex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> HttpRequestMethodNotSupportedException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleHttpRequestMethodNotSupported(</span><br><span class="line">                        (HttpRequestMethodNotSupportedException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> HttpMediaTypeNotSupportedException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleHttpMediaTypeNotSupported(</span><br><span class="line">                        (HttpMediaTypeNotSupportedException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> HttpMediaTypeNotAcceptableException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleHttpMediaTypeNotAcceptable(</span><br><span class="line">                        (HttpMediaTypeNotAcceptableException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> MissingPathVariableException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleMissingPathVariable(</span><br><span class="line">                        (MissingPathVariableException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> MissingServletRequestParameterException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleMissingServletRequestParameter(</span><br><span class="line">                        (MissingServletRequestParameterException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ServletRequestBindingException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleServletRequestBindingException(</span><br><span class="line">                        (ServletRequestBindingException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ConversionNotSupportedException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleConversionNotSupported(</span><br><span class="line">                        (ConversionNotSupportedException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> TypeMismatchException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleTypeMismatch(</span><br><span class="line">                        (TypeMismatchException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> HttpMessageNotReadableException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleHttpMessageNotReadable(</span><br><span class="line">                        (HttpMessageNotReadableException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> HttpMessageNotWritableException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleHttpMessageNotWritable(</span><br><span class="line">                        (HttpMessageNotWritableException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> MethodArgumentNotValidException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleMethodArgumentNotValidException(</span><br><span class="line">                        (MethodArgumentNotValidException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> MissingServletRequestPartException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleMissingServletRequestPartException(</span><br><span class="line">                        (MissingServletRequestPartException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BindException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleBindException((BindException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> NoHandlerFoundException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleNoHandlerFoundException(</span><br><span class="line">                        (NoHandlerFoundException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> AsyncRequestTimeoutException) &#123;</span><br><span class="line">                <span class="keyword">return</span> handleAsyncRequestTimeoutException(</span><br><span class="line">                        (AsyncRequestTimeoutException) ex, request, response, handler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception handlerEx) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">"Failure while trying to resolve exception ["</span> + ex.getClass().getName() + <span class="string">"]"</span>, handlerEx);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//随便看一个</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">handleHttpRequestMethodNotSupported</span><span class="params">(HttpRequestMethodNotSupportedException ex,</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletRequest request, HttpServletResponse response, @Nullable Object handler)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        String[] supportedMethods = ex.getSupportedMethods();</span><br><span class="line">        <span class="keyword">if</span> (supportedMethods != <span class="keyword">null</span>) &#123;</span><br><span class="line">            response.setHeader(<span class="string">"Allow"</span>, StringUtils.arrayToDelimitedString(supportedMethods, <span class="string">", "</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//405状态码</span></span><br><span class="line">        response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, ex.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>总结<ul>
<li>不同情况对应不同状态码,默认情况<code>DispatcherServlet</code>会使用这个<h5 id="ResponseStatusExceptionResolver"><a href="#ResponseStatusExceptionResolver" class="headerlink" title="ResponseStatusExceptionResolver"></a>ResponseStatusExceptionResolver</h5></li>
</ul>
</li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>ResponseStatusExceptionResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseStatusExceptionResolver</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerExceptionResolver</span> <span class="keyword">implements</span> <span class="title">MessageSourceAware</span> </span>&#123;</span><br><span class="line">    <span class="comment">//含有消息源</span></span><br><span class="line">    <span class="keyword">private</span> MessageSource messageSource;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessageSource</span><span class="params">(MessageSource messageSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.messageSource = messageSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">doResolveException</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                HttpServletRequest request, HttpServletResponse response, @Nullable Object handler, Exception ex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ResponseStatusException) &#123; <span class="comment">//若抛出status异常</span></span><br><span class="line">                    <span class="keyword">return</span> resolveResponseStatusException((ResponseStatusException) ex, request, response, handler);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ResponseStatus status = AnnotatedElementUtils.findMergedAnnotation(ex.getClass(), ResponseStatus<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                <span class="keyword">if</span> (status != <span class="keyword">null</span>) &#123;<span class="comment">//若异常被@SessionStatus标记</span></span><br><span class="line">                    <span class="keyword">return</span> resolveResponseStatus(status, request, response, handler, ex);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ex.getCause() <span class="keyword">instanceof</span> Exception) &#123;</span><br><span class="line">                    <span class="keyword">return</span> doResolveException(request, response, handler, (Exception) ex.getCause());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception resolveEx) &#123;</span><br><span class="line">                <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                    logger.warn(<span class="string">"Failure while trying to resolve exception ["</span> + ex.getClass().getName() + <span class="string">"]"</span>, resolveEx);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//code和reason可以从StatusExe或@ResponseStatus中获取</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">applyStatusAndReason</span><span class="params">(<span class="keyword">int</span> statusCode, @Nullable String reason, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">                    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="comment">//response处理</span></span><br><span class="line">                <span class="keyword">if</span> (!StringUtils.hasLength(reason)) &#123;</span><br><span class="line">                    response.sendError(statusCode);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    String resolvedReason = (<span class="keyword">this</span>.messageSource != <span class="keyword">null</span> ?</span><br><span class="line">                            <span class="keyword">this</span>.messageSource.getMessage(reason, <span class="keyword">null</span>, reason, LocaleContextHolder.getLocale()) :</span><br><span class="line">                            reason);</span><br><span class="line">                    response.sendError(statusCode, resolvedReason);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView();</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>总结<ul>
<li>用于<code>ResponseStatusException</code>和被<code>@ResponseStaues</code>标记的注解</li>
<li><code>DispatcherServlet</code>默认异常处理器之一<h5 id="ExceptionHandlerExceptionResolver"><a href="#ExceptionHandlerExceptionResolver" class="headerlink" title="ExceptionHandlerExceptionResolver"></a>ExceptionHandlerExceptionResolver</h5>最常见的异常处理器</li>
</ul>
</li>
<li>代码逻辑<figure class="highlight java"><figcaption><span>ExceptionHandlerExceptionResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHandlerMethodExceptionResolver</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerExceptionResolver</span> </span>&#123;</span><br><span class="line">    <span class="comment">//重写了applyto逻辑,保证了该处理器处理的handler一定是MethodHandler类型</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">shouldApplyTo</span><span class="params">(HttpServletRequest request, @Nullable Object handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.shouldApplyTo(request, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> HandlerMethod) &#123;</span><br><span class="line">            HandlerMethod handlerMethod = (HandlerMethod) handler;</span><br><span class="line">            handler = handlerMethod.getBean();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.shouldApplyTo(request, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> ModelAndView <span class="title">doResolveException</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        HttpServletRequest request, HttpServletResponse response, @Nullable Object handler, Exception ex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> doResolveHandlerMethodException(request, response, (HandlerMethod) handler, ex);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> ModelAndView <span class="title">doResolveHandlerMethodException</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletRequest request, HttpServletResponse response, @Nullable HandlerMethod handlerMethod, Exception ex)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//子类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionHandlerExceptionResolver</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerMethodExceptionResolver</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">            <span class="comment">//内部组件和RequestMappingAdaptor很相似</span></span><br><span class="line">            <span class="keyword">private</span> List&lt;HandlerMethodArgumentResolver&gt; customArgumentResolvers;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> HandlerMethodArgumentResolverComposite argumentResolvers;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> List&lt;HandlerMethodReturnValueHandler&gt; customReturnValueHandlers;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> HandlerMethodReturnValueHandlerComposite returnValueHandlers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ContentNegotiationManager contentNegotiationManager = <span class="keyword">new</span> ContentNegotiationManager();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; responseBodyAdvice = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, ExceptionHandlerMethodResolver&gt; exceptionHandlerCache =</span><br><span class="line">        <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">64</span>);</span><br><span class="line"><span class="comment">//初始化确定</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ControllerAdviceBean, ExceptionHandlerMethodResolver&gt; exceptionHandlerAdviceCache =</span><br><span class="line">        <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"><span class="comment">//---------------------始化-------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Do this first, it may add ResponseBodyAdvice beans</span></span><br><span class="line">        initExceptionHandlerAdviceCache();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.argumentResolvers == <span class="keyword">null</span>) &#123;</span><br><span class="line">            List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers();</span><br><span class="line">            <span class="keyword">this</span>.argumentResolvers = <span class="keyword">new</span> HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.returnValueHandlers == <span class="keyword">null</span>) &#123;</span><br><span class="line">            List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers();</span><br><span class="line">            <span class="keyword">this</span>.returnValueHandlers = <span class="keyword">new</span> HandlerMethodReturnValueHandlerComposite().addHandlers(handlers);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initExceptionHandlerAdviceCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getApplicationContext() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取@Controlleradvice类,并转换为ControllerAdviceBean</span></span><br><span class="line">        List&lt;ControllerAdviceBean&gt; adviceBeans = ControllerAdviceBean.findAnnotatedBeans(getApplicationContext());</span><br><span class="line">        <span class="keyword">for</span> (ControllerAdviceBean adviceBean : adviceBeans) &#123;</span><br><span class="line">            Class&lt;?&gt; beanType = adviceBean.getBeanType();</span><br><span class="line">            <span class="keyword">if</span> (beanType == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unresolvable type for ControllerAdviceBean: "</span> + adviceBean);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//resolver用来存方法@ExceptionHandler函数,并提供匹配函数</span></span><br><span class="line">            ExceptionHandlerMethodResolver resolver = <span class="keyword">new</span> ExceptionHandlerMethodResolver(beanType);</span><br><span class="line">            <span class="keyword">if</span> (resolver.hasExceptionMappings()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.exceptionHandlerAdviceCache.put(adviceBean, resolver);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ResponseBodyAdvice<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">beanType</span>)) </span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.responseBodyAdvice.add(adviceBean);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            <span class="keyword">int</span> handlerSize = <span class="keyword">this</span>.exceptionHandlerAdviceCache.size();</span><br><span class="line">            <span class="keyword">int</span> adviceSize = <span class="keyword">this</span>.responseBodyAdvice.size();</span><br><span class="line">            <span class="keyword">if</span> (handlerSize == <span class="number">0</span> &amp;&amp; adviceSize == <span class="number">0</span>) &#123;</span><br><span class="line">                logger.debug(<span class="string">"ControllerAdvice beans: none"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.debug(<span class="string">"ControllerAdvice beans: "</span> +</span><br><span class="line">                        handlerSize + <span class="string">" @ExceptionHandler, "</span> + adviceSize + <span class="string">" ResponseBodyAdvice"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;            </span><br><span class="line"><span class="comment">//-------------------处理异常----------------------</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">doResolveHandlerMethodException</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletResponse response, @Nullable HandlerMethod handlerMethod, Exception exception)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//[1]根据异常处理函数创建一个ServletIncocableHandlerMethod</span></span><br><span class="line">        ServletInvocableHandlerMethod exceptionHandlerMethod = getExceptionHandlerMethod(handlerMethod, exception);</span><br><span class="line">        <span class="keyword">if</span> (exceptionHandlerMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//[1!]</span></span><br><span class="line">        <span class="comment">//[2]设置入参和回参处理器</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.argumentResolvers != <span class="keyword">null</span>) &#123;</span><br><span class="line">            exceptionHandlerMethod.setHandlerMethodArgumentResolvers(<span class="keyword">this</span>.argumentResolvers);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.returnValueHandlers != <span class="keyword">null</span>) &#123;</span><br><span class="line">            exceptionHandlerMethod.setHandlerMethodReturnValueHandlers(<span class="keyword">this</span>.returnValueHandlers);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//[2!]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//[3]调用invoke,这里又用到了invoke(arg...)可变参数,将exception,cause,handlerMethod传递过去</span></span><br><span class="line">        <span class="comment">//另个用到这种是InintFactory传递dataBinder的时候</span></span><br><span class="line">        ServletWebRequest webRequest = <span class="keyword">new</span> ServletWebRequest(request, response);</span><br><span class="line">        ModelAndViewContainer mavContainer = <span class="keyword">new</span> ModelAndViewContainer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Using @ExceptionHandler "</span> + exceptionHandlerMethod);</span><br><span class="line">            &#125;</span><br><span class="line">            Throwable cause = exception.getCause();</span><br><span class="line">            <span class="keyword">if</span> (cause != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Expose cause as provided argument as well</span></span><br><span class="line">                exceptionHandlerMethod.invokeAndHandle(webRequest, mavContainer, exception, cause, handlerMethod);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Otherwise, just the given exception as-is</span></span><br><span class="line">                exceptionHandlerMethod.invokeAndHandle(webRequest, mavContainer, exception, handlerMethod);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable invocationEx) &#123;</span><br><span class="line">            <span class="comment">// Any other than the original exception (or its cause) is unintended here,</span></span><br><span class="line">            <span class="comment">// probably an accident (e.g. failed assertion or the like).</span></span><br><span class="line">            <span class="keyword">if</span> (invocationEx != exception &amp;&amp; invocationEx != exception.getCause() &amp;&amp; logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">"Failure in @ExceptionHandler "</span> + exceptionHandlerMethod, invocationEx);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Continue with default processing of the original exception...</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mavContainer.isRequestHandled()) &#123;<span class="comment">//如果异常处理器结束了处理,则返回一个空白,基本发生于rest情况,即出现@ResponseBody注解</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;<span class="comment">//返回完整视图容器</span></span><br><span class="line">            ModelMap model = mavContainer.getModel();</span><br><span class="line">            HttpStatus status = mavContainer.getStatus();</span><br><span class="line">            ModelAndView mav = <span class="keyword">new</span> ModelAndView(mavContainer.getViewName(), model, status);</span><br><span class="line">            mav.setViewName(mavContainer.getViewName());</span><br><span class="line">            <span class="keyword">if</span> (!mavContainer.isViewReference()) &#123;</span><br><span class="line">                mav.setView((View) mavContainer.getView());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (model <span class="keyword">instanceof</span> RedirectAttributes) &#123;</span><br><span class="line">                Map&lt;String, ?&gt; flashAttributes = ((RedirectAttributes) model).getFlashAttributes();</span><br><span class="line">                RequestContextUtils.getOutputFlashMap(request).putAll(flashAttributes);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mav;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//--------------根据handlerMethod创建SIHM---------------------</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ServletInvocableHandlerMethod <span class="title">getExceptionHandlerMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable HandlerMethod handlerMethod, Exception exception)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; handlerType = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (handlerMethod != <span class="keyword">null</span>) &#123;<span class="comment">//从含有本handlerMethod中寻找,并创建</span></span><br><span class="line">            <span class="comment">// Local exception handler methods on the controller class itself.</span></span><br><span class="line">            <span class="comment">// To be invoked through the proxy, even in case of an interface-based proxy.</span></span><br><span class="line">            handlerType = handlerMethod.getBeanType();</span><br><span class="line">            ExceptionHandlerMethodResolver resolver = <span class="keyword">this</span>.exceptionHandlerCache.get(handlerType);</span><br><span class="line">            <span class="keyword">if</span> (resolver == <span class="keyword">null</span>) &#123;</span><br><span class="line">                resolver = <span class="keyword">new</span> ExceptionHandlerMethodResolver(handlerType);</span><br><span class="line">                <span class="keyword">this</span>.exceptionHandlerCache.put(handlerType, resolver);</span><br><span class="line">            &#125;</span><br><span class="line">            Method method = resolver.resolveMethod(exception);</span><br><span class="line">            <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ServletInvocableHandlerMethod(handlerMethod.getBean(), method);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// For advice applicability check below (involving base packages, assignable types</span></span><br><span class="line">            <span class="comment">// and annotation presence), use target class instead of interface-based proxy.</span></span><br><span class="line">            <span class="keyword">if</span> (Proxy.isProxyClass(handlerType)) &#123;</span><br><span class="line">                handlerType = AopUtils.getTargetClass(handlerMethod.getBean());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//从全局advice中匹配并创建</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;ControllerAdviceBean, ExceptionHandlerMethodResolver&gt; entry : <span class="keyword">this</span>.exceptionHandlerAdviceCache.entrySet()) &#123;</span><br><span class="line">            ControllerAdviceBean advice = entry.getKey();</span><br><span class="line">            <span class="keyword">if</span> (advice.isApplicableToBeanType(handlerType)) &#123;</span><br><span class="line">                ExceptionHandlerMethodResolver resolver = entry.getValue();</span><br><span class="line">                Method method = resolver.resolveMethod(exception);</span><br><span class="line">                <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ServletInvocableHandlerMethod(advice.resolveBean(), method);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>总结<ul>
<li><code>@ExecptionHandler</code>的调用实际被转换成了<code>ServletInvokeHandlerMethod</code></li>
<li><code>@ExecptionHandler</code>可以使用在Controller,或者<code>@ControllerAdvice</code></li>
<li>参数可以为excption,cause,handlerMethod</li>
<li>入参和回参则决定于该处理器中的入参和回参处理器<h6 id="ExceptionHandlerMethodResolver"><a href="#ExceptionHandlerMethodResolver" class="headerlink" title="ExceptionHandlerMethodResolver"></a>ExceptionHandlerMethodResolver</h6>用来解析<code>@ExceptionHandler</code></li>
</ul>
</li>
<li>代码<figure class="highlight java"><figcaption><span>ExceptionHandlerMethodResolver</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionHandlerMethodResolver</span> </span>&#123;</span><br><span class="line">    <span class="comment">//======================属性===========================</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MethodFilter EXCEPTION_HANDLER_METHODS = method -&gt;</span><br><span class="line">            AnnotatedElementUtils.hasAnnotation(method, ExceptionHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;? extends Throwable&gt;, Method&gt; mappedMethods = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;? extends Throwable&gt;, Method&gt; exceptionLookupCache = <span class="keyword">new</span> ConcurrentReferenceHashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">    <span class="comment">//====================构造初始化==========================</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExceptionHandlerMethodResolver</span><span class="params">(Class&lt;?&gt; handlerType)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//handlerType中获取@ExceptionHandler函数</span></span><br><span class="line">        <span class="keyword">for</span> (Method method : MethodIntrospector.selectMethods(handlerType, EXCEPTION_HANDLER_METHODS)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Class&lt;? extends Throwable&gt; exceptionType : detectExceptionMappings(method)) &#123;<span class="comment">//判断该函数与其匹配的异常</span></span><br><span class="line">                addExceptionMapping(exceptionType, method);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//--------------异常匹配-----------------</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Class&lt;? extends Throwable&gt;&gt; detectExceptionMappings(Method method) &#123;</span><br><span class="line">        List&lt;Class&lt;? extends Throwable&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        detectAnnotationExceptionMappings(method, result);</span><br><span class="line">        <span class="keyword">if</span> (result.isEmpty()) &#123;<span class="comment">//说明@ExceptionHandler中没有value值</span></span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; paramType : method.getParameterTypes()) &#123; <span class="comment">//选择method形参作为异常匹配</span></span><br><span class="line">                <span class="keyword">if</span> (Throwable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">paramType</span>)) </span>&#123;</span><br><span class="line">                    result.add((Class&lt;? extends Throwable&gt;) paramType);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No exception types mapped to "</span> + method);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//获取方法中@ExceptionHandler#value作为异常值</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">detectAnnotationExceptionMappings</span><span class="params">(Method method, List&lt;Class&lt;? extends Throwable&gt;&gt; result)</span> </span>&#123;</span><br><span class="line">        ExceptionHandler ann = AnnotatedElementUtils.findMergedAnnotation(method, ExceptionHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Assert.state(ann != <span class="keyword">null</span>, <span class="string">"No ExceptionHandler annotation"</span>);</span><br><span class="line">        result.addAll(Arrays.asList(ann.value()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//-------------缓存--------------------</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addExceptionMapping</span><span class="params">(Class&lt;? extends Throwable&gt; exceptionType, Method method)</span> </span>&#123;</span><br><span class="line">        Method oldMethod = <span class="keyword">this</span>.mappedMethods.put(exceptionType, method);</span><br><span class="line">        <span class="keyword">if</span> (oldMethod != <span class="keyword">null</span> &amp;&amp; !oldMethod.equals(method)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Ambiguous @ExceptionHandler method mapped for ["</span> +</span><br><span class="line">                    exceptionType + <span class="string">"]: &#123;"</span> + oldMethod + <span class="string">", "</span> + method + <span class="string">"&#125;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//===========================解析====================================</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Method <span class="title">resolveMethod</span><span class="params">(Exception exception)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> resolveMethodByThrowable(exception);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Method <span class="title">resolveMethodByThrowable</span><span class="params">(Throwable exception)</span> </span>&#123;</span><br><span class="line">            Method method = resolveMethodByExceptionType(exception.getClass());</span><br><span class="line">            <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Throwable cause = exception.getCause();</span><br><span class="line">                <span class="keyword">if</span> (cause != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    method = resolveMethodByExceptionType(cause.getClass());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> method;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Method <span class="title">resolveMethodByExceptionType</span><span class="params">(Class&lt;? extends Throwable&gt; exceptionType)</span> </span>&#123;</span><br><span class="line">                Method method = <span class="keyword">this</span>.exceptionLookupCache.get(exceptionType);</span><br><span class="line">                <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    method = getMappedMethod(exceptionType);</span><br><span class="line">                    <span class="keyword">this</span>.exceptionLookupCache.put(exceptionType, method);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> method;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//由于初始化的逻辑会导致,多个excption对应一个method,因此此处做了一个排序</span></span><br><span class="line">            <span class="function"><span class="keyword">private</span> Method <span class="title">getMappedMethod</span><span class="params">(Class&lt;? extends Throwable&gt; exceptionType)</span> </span>&#123;</span><br><span class="line">                    List&lt;Class&lt;? extends Throwable&gt;&gt; matches = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                    <span class="keyword">for</span> (Class&lt;? extends Throwable&gt; mappedException : <span class="keyword">this</span>.mappedMethods.keySet()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mappedException.isAssignableFrom(exceptionType)) &#123;</span><br><span class="line">                            matches.add(mappedException);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!matches.isEmpty()) &#123;</span><br><span class="line">                        <span class="comment">//排序,简单来说就看匹配的excpetion和发生的异常是否类型更加接近</span></span><br><span class="line">                        matches.sort(<span class="keyword">new</span> ExceptionDepthComparator(exceptionType));</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">this</span>.mappedMethods.get(matches.get(<span class="number">0</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">fancylight</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.fancylight.top/2020/03/26/springMVC%E6%A0%B8%E5%BF%83%E4%B8%89/">https://www.fancylight.top/2020/03/26/springMVC%E6%A0%B8%E5%BF%83%E4%B8%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.fancylight.top" target="_blank">博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%A1%86%E6%9E%B6/">框架    </a><a class="post-meta__tags" href="/tags/spring/">spring    </a><a class="post-meta__tags" href="/tags/springMvc/">springMvc    </a></div><div class="post_share"><div class="social-share" data-image="/img/spring.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/03/31/springMVC%E9%85%8D%E7%BD%AE/"><img class="prev_cover" src="/img/spring.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">springMVC配置</div></div></a></div><div class="next-post pull_right"><a href="/2020/03/23/springMVC%E6%A0%B8%E5%BF%83%E4%BA%8C/"><img class="next_cover" src="/img/spring.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">springMVC核心二</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/02/19/SpringMVC源码/" title="SpringMVC体系"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-02-19</div><div class="relatedPosts_title">SpringMVC体系</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/28/springContext配置二/" title="springContext配置二"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-07-28</div><div class="relatedPosts_title">springContext配置二</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/17/springMVC内部/" title="springMVC内部"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-17</div><div class="relatedPosts_title">springMVC内部</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/31/springMVC配置/" title="springMVC配置"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-31</div><div class="relatedPosts_title">springMVC配置</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/23/springMVC核心二/" title="springMVC核心二"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-23</div><div class="relatedPosts_title">springMVC核心二</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/03/springMVC配置二/" title="springMVC配置二"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-03</div><div class="relatedPosts_title">springMVC配置二</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '624d139155758ea48077',
  clientSecret: 'cc126a301586ea63779cec6a6b53101749dbc9dd',
  repo: 'gittalk_issue',
  owner: 'fancylight',
  admin: ['fancylight'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By fancylight</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>