<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>spring常见 | 博客</title><meta name="description" content="spring常见"><meta name="keywords" content="框架,spring,spring组件"><meta name="author" content="fancylight"><meta name="copyright" content="fancylight"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="spring常见"><meta name="twitter:description" content="spring常见"><meta name="twitter:image" content="http://yoursite.com/img/spring.png"><meta property="og:type" content="article"><meta property="og:title" content="spring常见"><meta property="og:url" content="http://yoursite.com/2020/02/11/spring%E5%B8%B8%E8%A7%81/"><meta property="og:site_name" content="博客"><meta property="og:description" content="spring常见"><meta property="og:image" content="http://yoursite.com/img/spring.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      now = new Date();
      hour = now.getHours();
      isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/02/11/spring%E5%B8%B8%E8%A7%81/"><link rel="prev" title="Spring_aop织入分析" href="http://yoursite.com/2020/03/04/Spring-aop%E7%BB%87%E5%85%A5%E5%88%86%E6%9E%90/"><link rel="next" title="springMVC核心" href="http://yoursite.com/2019/12/26/springMVC%E6%A0%B8%E5%BF%83/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: false,
  highlightShrink: false,
  isFontAwesomeV5: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">37</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">20</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 目录</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#spring内部一些重要实现"><span class="toc-number">1.</span> <span class="toc-text">spring内部一些重要实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Bean相关"><span class="toc-number">1.1.</span> <span class="toc-text">Bean相关</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#xml解析"><span class="toc-number">1.1.1.</span> <span class="toc-text">xml解析</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#基本元素"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">基本元素</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#custom元素"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">custom元素</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#xml-和-注解实现的一些区别"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">xml 和 注解实现的一些区别</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BeanDefinition"><span class="toc-number">1.1.2.</span> <span class="toc-text">BeanDefinition</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BeanWrapper"><span class="toc-number">1.1.3.</span> <span class="toc-text">BeanWrapper</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#属性类型转换"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">属性类型转换</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#spring-post处理器"><span class="toc-number">1.2.</span> <span class="toc-text">spring_post处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LTW"><span class="toc-number">1.3.</span> <span class="toc-text">LTW</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MessageSource"><span class="toc-number">1.4.</span> <span class="toc-text">MessageSource</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#spring框架中提供的特殊调用点"><span class="toc-number">1.5.</span> <span class="toc-text">spring框架中提供的特殊调用点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#spring-web关于web容器的初始化"><span class="toc-number">1.5.1.</span> <span class="toc-text">spring web关于web容器的初始化</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 目录</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">spring常见</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-02-11<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-03-23</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/java/">java</a></span><div class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">5.2k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 26 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2020/02/11/spring%E5%B8%B8%E8%A7%81/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></div></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h3 id="spring内部一些重要实现"><a class="header-anchor" href="#spring内部一些重要实现">¶</a>spring内部一些重要实现</h3>
<h4 id="Bean相关"><a class="header-anchor" href="#Bean相关">¶</a>Bean相关</h4>
<ul>
<li>概念
<ul>
<li>BeanDefinition 是将ioc定义如xml,注解扫描的类转为成抽象描述,包含了用户定义的各种bean信息</li>
<li>BeanWrapper 是从该类抽离出的低级javaBean,包含了属性转换器,以及java 原信息</li>
<li>PropertyValue 仅仅是封装key-value 表示对象,存在于Bd内部,以及ioc属性转换过程中</li>
<li>PropertyEditor jdk提供的属性转换,A-&gt;B类型的转换,ioc逻辑中使用</li>
</ul>
</li>
</ul>
<h5 id="xml解析"><a class="header-anchor" href="#xml解析">¶</a>xml解析</h5>
<p>简而言之, 解析xml的类是BeanDefinitionParserDelegate完成的</p>
<ul>
<li>标准bean标签的解析过程
<ul>
<li>xml例子<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"test"</span> <span class="attr">class</span>=<span class="string">"com.light.Foo"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">        this is a test</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"files"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>d:/test/12.txt<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>d:/test/12.txt<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">key</span>=<span class="string">"key1"</span> <span class="attr">value</span>=<span class="string">"value1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h6 id="基本元素"><a class="header-anchor" href="#基本元素">¶</a>基本元素</h6>
<ul>
<li>前言<br>
解析bean的读取器为<code>BeanDefinitionReader</code>体系,并非是仅仅支持xml.</li>
<li>外部类<br>
<figure class="highlight java"><figcaption><span>DefaultBeanDefinitionDocumentReader</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该类是xml默认的 解析器实现类</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//委托模式</span></span><br><span class="line">		BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.delegate;</span><br><span class="line">		<span class="keyword">this</span>.delegate = createDelegate(getReaderContext(), root, parent);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">			String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);</span><br><span class="line">			<span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</span><br><span class="line">				String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</span><br><span class="line">						profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">				<span class="comment">// We cannot use Profiles.of(...) since profile expressions are not supported</span></span><br><span class="line">				<span class="comment">// in XML config. See SPR-12458 for details.</span></span><br><span class="line">				<span class="keyword">if</span> (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;</span><br><span class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">						logger.debug(<span class="string">"Skipped XML bean definition file due to specified profiles ["</span> + profileSpec +</span><br><span class="line">								<span class="string">"] not matching: "</span> + getReaderContext().getResource());</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		preProcessXml(root); <span class="comment">//空,子类实现</span></span><br><span class="line">		parseBeanDefinitions(root, <span class="keyword">this</span>.delegate);</span><br><span class="line">		postProcessXml(root); <span class="comment">//空,子类实现</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.delegate = parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//-------------------------------- 循环处理所有元素---------------------------------</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">			NodeList nl = root.getChildNodes();</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">				Node node = nl.item(i);</span><br><span class="line">				<span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">					Element ele = (Element) node;</span><br><span class="line">					<span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line">						parseDefaultElement(ele, delegate); <span class="comment">//处理不用引入如&lt;context&gt; 这样的默认标签</span></span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						delegate.parseCustomElement(ele); <span class="comment">//处理额外的标签</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			delegate.parseCustomElement(root);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------处理默认标签-------------------------------------------</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</span><br><span class="line">    importBeanDefinitionResource(ele);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</span><br><span class="line">    processAliasRegistration(ele);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">    processBeanDefinition(ele, delegate);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</span><br><span class="line">    <span class="comment">// recurse</span></span><br><span class="line">    doRegisterBeanDefinitions(ele);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//------------------------------------处理bean标签-----------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//holder仅仅用来包含BeanDefition,内部的BeanDiftion 就是GenicBeanDeition</span></span><br><span class="line">  <span class="comment">//[1]  解析并创建gbdH</span></span><br><span class="line">  BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);</span><br><span class="line">  <span class="comment">//[1!]</span></span><br><span class="line">  <span class="comment">//[2] 注册bd到beanFacotry(Registry)中</span></span><br><span class="line">  <span class="keyword">if</span> (bdHolder != <span class="keyword">null</span>) &#123;</span><br><span class="line">    bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Register the final decorated instance.</span></span><br><span class="line">      BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">      getReaderContext().error(<span class="string">"Failed to register bean definition with name '"</span> +</span><br><span class="line">          bdHolder.getBeanName() + <span class="string">"'"</span>, ele, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//[2!]</span></span><br><span class="line">    <span class="comment">//[3] 触发事件</span></span><br><span class="line">    getReaderContext().fireComponentRegistered(<span class="keyword">new</span> BeanComponentDefinition(bdHolder));</span><br><span class="line">    <span class="comment">//[3!]</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      </span><br></pre></td></tr></table></figure></li>
<li>委托类<br>
<figure class="highlight java"><figcaption><span>BeanDefinitionParserDelegate</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br></pre></td><td class="code"><pre><span class="line">     <span class="comment">//------------------------------------解析 并创建 gbd--------------------------------------</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> parseBeanDefinitionElement(ele, <span class="keyword">null</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="meta">@Nullable</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele, @Nullable BeanDefinition containingBean)</span> </span>&#123;</span><br><span class="line">         <span class="comment">//[1] 处理id和name,别名,保持id唯一性</span></span><br><span class="line">         String id = ele.getAttribute(ID_ATTRIBUTE);</span><br><span class="line">         String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">         List&lt;String&gt; aliases = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">         <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">           String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">           aliases.addAll(Arrays.asList(nameArr));</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         String beanName = id;</span><br><span class="line">         <span class="keyword">if</span> (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123;</span><br><span class="line">           beanName = aliases.remove(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">             logger.trace(<span class="string">"No XML 'id' specified - using '"</span> + beanName +</span><br><span class="line">                 <span class="string">"' as bean name and "</span> + aliases + <span class="string">" as aliases"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (containingBean == <span class="keyword">null</span>) &#123;</span><br><span class="line">           checkNameUniqueness(beanName, aliases, ele);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//[1!]</span></span><br><span class="line">         <span class="comment">//[2]解析标签,并创建gbd</span></span><br><span class="line">         AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean);</span><br><span class="line">         <span class="comment">//[2!]</span></span><br><span class="line">         <span class="keyword">if</span> (beanDefinition != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!StringUtils.hasText(beanName)) &#123;</span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (containingBean != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 beanName = BeanDefinitionReaderUtils.generateBeanName(</span><br><span class="line">                     beanDefinition, <span class="keyword">this</span>.readerContext.getRegistry(), <span class="keyword">true</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                 beanName = <span class="keyword">this</span>.readerContext.generateBeanName(beanDefinition);</span><br><span class="line">                 <span class="comment">// Register an alias for the plain bean class name, if still possible,</span></span><br><span class="line">                 <span class="comment">// if the generator returned the class name plus a suffix.</span></span><br><span class="line">                 <span class="comment">// This is expected for Spring 1.2/2.0 backwards compatibility.</span></span><br><span class="line">                 String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line">                 <span class="keyword">if</span> (beanClassName != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                     beanName.startsWith(beanClassName) &amp;&amp; beanName.length() &gt; beanClassName.length() &amp;&amp;</span><br><span class="line">                     !<span class="keyword">this</span>.readerContext.getRegistry().isBeanNameInUse(beanClassName)) &#123;</span><br><span class="line">                   aliases.add(beanClassName);</span><br><span class="line">                 &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                 logger.trace(<span class="string">"Neither XML 'id' nor 'name' specified - "</span> +</span><br><span class="line">                     <span class="string">"using generated bean name ["</span> + beanName + <span class="string">"]"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">               error(ex.getMessage(), ele);</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">             &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           String[] aliasesArray = StringUtils.toStringArray(aliases);</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> BeanDefinitionHolder(beanDefinition, beanName, aliasesArray);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//----------------------------------实际创建gbd的代码---------------------------</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> AbstractBeanDefinition <span class="title">parseBeanDefinitionElement</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">           Element ele, String beanName, @Nullable BeanDefinition containingBean)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> BeanEntry(beanName));</span><br><span class="line"></span><br><span class="line">         String className = <span class="keyword">null</span>;</span><br><span class="line">         <span class="comment">//class属性</span></span><br><span class="line">         <span class="keyword">if</span> (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</span><br><span class="line">           className = ele.getAttribute(CLASS_ATTRIBUTE).trim();</span><br><span class="line">         &#125;</span><br><span class="line">         String parent = <span class="keyword">null</span>;</span><br><span class="line">         <span class="comment">//parent属性</span></span><br><span class="line">         <span class="keyword">if</span> (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</span><br><span class="line">           parent = ele.getAttribute(PARENT_ATTRIBUTE);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 简单创建gbd实例</span></span><br><span class="line">           AbstractBeanDefinition bd = createBeanDefinition(className, parent);</span><br><span class="line">           <span class="comment">// 处理&lt;bean&gt; 标签中所有的属性,即attr,设置为abd(AbstractBeanDefinition) 对应的属性</span></span><br><span class="line">           parseBeanDefinitionAttributes(ele, beanName, containingBean, bd);</span><br><span class="line">           <span class="comment">// 子类node中寻找 获取desc</span></span><br><span class="line">           bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT));</span><br><span class="line">           <span class="comment">//  此处代码见下边</span></span><br><span class="line">           parseMetaElements(ele, bd);</span><br><span class="line">           <span class="comment">// 子类node寻找&lt;lookUp  name="" ,bean=""&gt; 元素,添加MethodOverrride对象到bd中</span></span><br><span class="line">           parseLookupOverrideSubElements(ele, bd.getMethodOverrides());</span><br><span class="line">           <span class="comment">// 寻找&lt;ReplaceMethod name="" repalcer=""&gt;  元素 添加MEthodOverride对象到bd中</span></span><br><span class="line">           parseReplacedMethodSubElements(ele, bd.getMethodOverrides());</span><br><span class="line">           <span class="comment">// 处理&lt;constructor-arg index= ...&gt;</span></span><br><span class="line">           <span class="comment">// bd.getConstructorArgumentValues().addGenericArgumentValue(valueHolder);</span></span><br><span class="line">           <span class="comment">// valueHolder就是解析后创建的要添加到bd中的对象  </span></span><br><span class="line">           parseConstructorArgElements(ele, bd);</span><br><span class="line">           <span class="comment">//处理子类中属性</span></span><br><span class="line">           parsePropertyElements(ele, bd);</span><br><span class="line">           <span class="comment">//处理qualifier标签</span></span><br><span class="line">           parseQualifierElements(ele, bd);</span><br><span class="line">           <span class="comment">//bd来源,如xml的路径  </span></span><br><span class="line">           bd.setResource(<span class="keyword">this</span>.readerContext.getResource());</span><br><span class="line">           <span class="comment">//</span></span><br><span class="line">           bd.setSource(extractSource(ele));</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> bd;</span><br><span class="line">         &#125;</span><br><span class="line">          <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//------------------------------处理meta元素-----------------------</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseMetaElements</span><span class="params">(Element ele, BeanMetadataAttributeAccessor attributeAccessor)</span> </span>&#123;</span><br><span class="line">         <span class="comment">//从子类寻&lt;meta&gt;标签,获取meat的key以及value属性,作为bd#attribute</span></span><br><span class="line">         NodeList nl = ele.getChildNodes();</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">           Node node = nl.item(i);</span><br><span class="line">           <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, META_ELEMENT)) &#123;</span><br><span class="line">             Element metaElement = (Element) node;</span><br><span class="line">             <span class="comment">//这里就能知道BeanMetadataAttributeAccessor的map是什么情况可以设置的</span></span><br><span class="line">             String key = metaElement.getAttribute(KEY_ATTRIBUTE);</span><br><span class="line">             String value = metaElement.getAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">             <span class="comment">//此处体现了BD体系中如何使用key-value</span></span><br><span class="line">             BeanMetadataAttribute attribute = <span class="keyword">new</span> BeanMetadataAttribute(key, value);</span><br><span class="line">             attribute.setSource(extractSource(metaElement));</span><br><span class="line">             attributeAccessor.addMetadataAttribute(attribute);</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//----------------------------处理property----------------------------</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parsePropertyElement</span><span class="params">(Element ele, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">	String propertyName = ele.getAttribute(NAME_ATTRIBUTE); <span class="comment">//获取该propery名</span></span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasLength(propertyName)) &#123;</span><br><span class="line">		error(<span class="string">"Tag 'property' must have a 'name' attribute"</span>, ele);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> PropertyEntry(propertyName));</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (bd.getPropertyValues().contains(propertyName)) &#123;</span><br><span class="line">			error(<span class="string">"Multiple 'property' definitions for property '"</span> + propertyName + <span class="string">"'"</span>, ele);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">     <span class="comment">//此处是具体代码</span></span><br><span class="line">		Object val = parsePropertyValue(ele, bd, propertyName);</span><br><span class="line">     <span class="comment">//返回值创建pv (key-vlaue) 类型</span></span><br><span class="line">		PropertyValue pv = <span class="keyword">new</span> PropertyValue(propertyName, val);</span><br><span class="line">		parseMetaElements(ele, pv);</span><br><span class="line">		pv.setSource(extractSource(ele));</span><br><span class="line">     <span class="comment">//添加到bd#pvs中,这个pvs在ioc中注值使用,非常关键</span></span><br><span class="line">		bd.getPropertyValues().addPropertyValue(pv);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.parseState.pop();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">parsePropertyValue</span><span class="params">(Element ele, BeanDefinition bd, @Nullable String propertyName)</span> </span>&#123;</span><br><span class="line">	String elementName = (propertyName != <span class="keyword">null</span> ?</span><br><span class="line">			<span class="string">"&lt;property&gt; element for property '"</span> + propertyName + <span class="string">"'"</span> :</span><br><span class="line">			<span class="string">"&lt;constructor-arg&gt; element"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Should only have one child element: ref, value, list, etc.</span></span><br><span class="line">   <span class="comment">//[1]获取当前元素(即Property) 子元素,最多最外层 只能存在一个如上</span></span><br><span class="line">	NodeList nl = ele.getChildNodes();</span><br><span class="line">	Element subElement = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">		Node node = nl.item(i);</span><br><span class="line">		<span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element &amp;&amp; !nodeNameEquals(node, DESCRIPTION_ELEMENT) &amp;&amp;</span><br><span class="line">				!nodeNameEquals(node, META_ELEMENT)) &#123;</span><br><span class="line">			<span class="comment">// Child element is what we're looking for.</span></span><br><span class="line">			<span class="keyword">if</span> (subElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">				error(elementName + <span class="string">" must not contain more than one sub-element"</span>, ele);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				subElement = (Element) node;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">   <span class="comment">//[1!]</span></span><br><span class="line">   <span class="comment">//[2] 不允许property元素带有value和ref属性, 或者任意属性并且有子元素</span></span><br><span class="line">	<span class="keyword">boolean</span> hasRefAttribute = ele.hasAttribute(REF_ATTRIBUTE);</span><br><span class="line">	<span class="keyword">boolean</span> hasValueAttribute = ele.hasAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">	<span class="keyword">if</span> ((hasRefAttribute &amp;&amp; hasValueAttribute) ||</span><br><span class="line">			((hasRefAttribute || hasValueAttribute) &amp;&amp; subElement != <span class="keyword">null</span>)) &#123;</span><br><span class="line">		error(elementName +</span><br><span class="line">				<span class="string">" is only allowed to contain either 'ref' attribute OR 'value' attribute OR sub-element"</span>, ele);</span><br><span class="line">	&#125;</span><br><span class="line">   <span class="comment">//[2]</span></span><br><span class="line">   <span class="comment">//[3] 分情况讨论</span></span><br><span class="line">	<span class="keyword">if</span> (hasRefAttribute) &#123;</span><br><span class="line">		String refName = ele.getAttribute(REF_ATTRIBUTE);</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</span><br><span class="line">			error(elementName + <span class="string">" contains empty 'ref' attribute"</span>, ele);</span><br><span class="line">		&#125;</span><br><span class="line">		RuntimeBeanReference ref = <span class="keyword">new</span> RuntimeBeanReference(refName);<span class="comment">//创建一个引用</span></span><br><span class="line">		ref.setSource(extractSource(ele));</span><br><span class="line">		<span class="keyword">return</span> ref;</span><br><span class="line">	&#125; <span class="comment">//ref情况返回</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (hasValueAttribute) &#123;</span><br><span class="line">		TypedStringValue valueHolder = <span class="keyword">new</span> TypedStringValue(ele.getAttribute(VALUE_ATTRIBUTE));</span><br><span class="line">		valueHolder.setSource(extractSource(ele));</span><br><span class="line">		<span class="keyword">return</span> valueHolder;</span><br><span class="line">	&#125;<span class="comment">//value 类型</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (subElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> parsePropertySubElement(subElement, bd); <span class="comment">//复杂情况,即property存在子元素</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Neither child element nor "ref" or "value" attribute found.</span></span><br><span class="line">		error(elementName + <span class="string">" must specify a ref or value"</span>, ele);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">   [<span class="number">3</span>!]</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">//-------------------------------处理property子元素------------------------------------</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">parsePropertySubElement</span><span class="params">(Element ele, @Nullable BeanDefinition bd, @Nullable String defaultValueType)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//[1]</span></span><br><span class="line">	<span class="keyword">if</span> (!isDefaultNamespace(ele)) &#123;</span><br><span class="line">		<span class="keyword">return</span> parseNestedCustomElement(ele, bd); <span class="comment">//非标准元素,去调用custom逻辑,见下文</span></span><br><span class="line">	&#125;</span><br><span class="line">   <span class="comment">//[1!]</span></span><br><span class="line">   <span class="comment">//[2]</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">      <span class="comment">//Bean标签,相当于递归调用</span></span><br><span class="line">		BeanDefinitionHolder nestedBd = parseBeanDefinitionElement(ele, bd);</span><br><span class="line">		<span class="keyword">if</span> (nestedBd != <span class="keyword">null</span>) &#123;</span><br><span class="line">			nestedBd = decorateBeanDefinitionIfRequired(ele, nestedBd, bd);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> nestedBd;</span><br><span class="line">	&#125;</span><br><span class="line">   <span class="comment">//[2!]</span></span><br><span class="line">   <span class="comment">//[3]</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, REF_ELEMENT)) &#123;</span><br><span class="line">		<span class="comment">// A generic reference to any name of any bean.</span></span><br><span class="line">		String refName = ele.getAttribute(BEAN_REF_ATTRIBUTE);</span><br><span class="line">		<span class="keyword">boolean</span> toParent = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</span><br><span class="line">			<span class="comment">// A reference to the id of another bean in a parent context.</span></span><br><span class="line">			refName = ele.getAttribute(PARENT_REF_ATTRIBUTE);</span><br><span class="line">			toParent = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</span><br><span class="line">				error(<span class="string">"'bean' or 'parent' is required for &lt;ref&gt; element"</span>, ele);</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</span><br><span class="line">			error(<span class="string">"&lt;ref&gt; element contains empty target attribute"</span>, ele);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		RuntimeBeanReference ref = <span class="keyword">new</span> RuntimeBeanReference(refName, toParent);</span><br><span class="line">		ref.setSource(extractSource(ele));</span><br><span class="line">		<span class="keyword">return</span> ref;<span class="comment">// &lt;ref bean=""&gt; 处理</span></span><br><span class="line">	&#125;</span><br><span class="line">   <span class="comment">//[4]</span></span><br><span class="line">   <span class="comment">//[5] &lt;idref bean=""&gt; 此处应该只能填写id</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, IDREF_ELEMENT)) &#123;</span><br><span class="line">		<span class="keyword">return</span> parseIdRefElement(ele);</span><br><span class="line">	&#125;</span><br><span class="line">   <span class="comment">//[5!]</span></span><br><span class="line">   <span class="comment">//[6] &lt;value &gt;处理</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, VALUE_ELEMENT)) &#123;</span><br><span class="line">		<span class="keyword">return</span> parseValueElement(ele, defaultValueType);</span><br><span class="line">	&#125;<span class="comment">//[6!]</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, NULL_ELEMENT)) &#123;</span><br><span class="line">		<span class="comment">// It's a distinguished null value. Let's wrap it in a TypedStringValue</span></span><br><span class="line">		<span class="comment">// object in order to preserve the source location.</span></span><br><span class="line">		TypedStringValue nullHolder = <span class="keyword">new</span> TypedStringValue(<span class="keyword">null</span>);</span><br><span class="line">		nullHolder.setSource(extractSource(ele));</span><br><span class="line">		<span class="keyword">return</span> nullHolder;</span><br><span class="line">	&#125;</span><br><span class="line">   <span class="comment">// 这几个类型 可能会继续引起子 解析,</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, ARRAY_ELEMENT)) &#123;</span><br><span class="line">		<span class="keyword">return</span> parseArrayElement(ele, bd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, LIST_ELEMENT)) &#123;</span><br><span class="line">		<span class="keyword">return</span> parseListElement(ele, bd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, SET_ELEMENT)) &#123;</span><br><span class="line">		<span class="keyword">return</span> parseSetElement(ele, bd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, MAP_ELEMENT)) &#123;</span><br><span class="line">		<span class="keyword">return</span> parseMapElement(ele, bd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, PROPS_ELEMENT)) &#123;</span><br><span class="line">		<span class="keyword">return</span> parsePropsElement(ele);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		error(<span class="string">"Unknown property sub-element: ["</span> + ele.getNodeName() + <span class="string">"]"</span>, ele);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">     </span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="custom元素"><a class="header-anchor" href="#custom元素">¶</a>custom元素</h6>
<ul>
<li>NamespaceHandler体系<br>
<figure class="highlight java"><figcaption><span>BeanDefinitionParserDelegate</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">     <span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> parseCustomElement(ele, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele, @Nullable BeanDefinition containingBd)</span> </span>&#123;</span><br><span class="line">	String namespaceUri = getNamespaceURI(ele);</span><br><span class="line">	<span class="keyword">if</span> (namespaceUri == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">   <span class="comment">//根据不同的元素使用不同的handler 来处理</span></span><br><span class="line">	NamespaceHandler handler = <span class="keyword">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</span><br><span class="line">	<span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">		error(<span class="string">"Unable to locate Spring NamespaceHandler for XML schema namespace ["</span> + namespaceUri + <span class="string">"]"</span>, ele);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> handler.parse(ele, <span class="keyword">new</span> ParserContext(<span class="keyword">this</span>.readerContext, <span class="keyword">this</span>, containingBd));</span><br><span class="line">&#125;</span><br><span class="line">     </span><br></pre></td></tr></table></figure><br>
<figure class="highlight java"><figcaption><span>ContextNamespaceHandler</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class="line">   	<span class="meta">@Override</span></span><br><span class="line">   	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">//内部的Parser实际 完成具体的逻辑</span></span><br><span class="line">   		registerBeanDefinitionParser(<span class="string">"property-placeholder"</span>, <span class="keyword">new</span> PropertyPlaceholderBeanDefinitionParser());</span><br><span class="line">   		registerBeanDefinitionParser(<span class="string">"property-override"</span>, <span class="keyword">new</span> PropertyOverrideBeanDefinitionParser());</span><br><span class="line">   		registerBeanDefinitionParser(<span class="string">"annotation-config"</span>, <span class="keyword">new</span> AnnotationConfigBeanDefinitionParser());</span><br><span class="line">   		registerBeanDefinitionParser(<span class="string">"component-scan"</span>, <span class="keyword">new</span> ComponentScanBeanDefinitionParser());</span><br><span class="line">   		registerBeanDefinitionParser(<span class="string">"load-time-weaver"</span>, <span class="keyword">new</span> LoadTimeWeaverBeanDefinitionParser());</span><br><span class="line">   		registerBeanDefinitionParser(<span class="string">"spring-configured"</span>, <span class="keyword">new</span> SpringConfiguredBeanDefinitionParser());</span><br><span class="line">   		registerBeanDefinitionParser(<span class="string">"mbean-export"</span>, <span class="keyword">new</span> MBeanExportBeanDefinitionParser());</span><br><span class="line">   		registerBeanDefinitionParser(<span class="string">"mbean-server"</span>, <span class="keyword">new</span> MBeanServerBeanDefinitionParser());</span><br><span class="line">   	&#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>ComponentScanBeanDefinitionParser</p>
  <figure class="highlight java"><figcaption><span>ComponentScanBeanDefinitionParser</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">  String basePackage = element.getAttribute(BASE_PACKAGE_ATTRIBUTE);</span><br><span class="line">  basePackage = parserContext.getReaderContext().getEnvironment().resolvePlaceholders(basePackage);</span><br><span class="line">  String[] basePackages = StringUtils.tokenizeToStringArray(basePackage,</span><br><span class="line">      ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Actually scan for bean definitions and register them.</span></span><br><span class="line">  <span class="comment">//调用该Scanner来处理</span></span><br><span class="line">  ClassPathBeanDefinitionScanner scanner = configureScanner(parserContext, element);</span><br><span class="line">  <span class="comment">//返回在对应的classPath 正确注解的bean</span></span><br><span class="line">  Set&lt;BeanDefinitionHolder&gt; beanDefinitions = scanner.doScan(basePackages);</span><br><span class="line">  <span class="comment">//给当前BeanFactory中添加一些后处理器,此处的功能和annotation-config类似</span></span><br><span class="line">  registerComponents(parserContext.getReaderContext(), beanDefinitions, element);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<ul>
<li>ClassPathBeanDefinitionScanner:这个才是实际扫描路径并创建的sbd的类<br>
spring处理注解@ComponentScan注解最终也要用到该类,外层是ComponentScanAnnotationParser<br>
具体注解处理的代码分析可以参考,<a href="/2019/09/05/springBoot%E5%AD%A6%E4%B9%A0%E4%B8%80/#applicationcontextinitializer">springBoot学习一</a>.</li>
</ul>
</li>
<li>
<p>AnnotationConfigBeanDefinitionParser</p>
  <figure class="highlight java"><figcaption><span>AnnotationConfigBeanDefinitionParser</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfigBeanDefinitionParser</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">		Object source = parserContext.extractSource(element);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Obtain bean definitions for all relevant BeanPostProcessors.</span></span><br><span class="line">    <span class="comment">//AnnotationConfigUtils该类在许多springContext都用到了</span></span><br><span class="line">		Set&lt;BeanDefinitionHolder&gt; processorDefinitions =</span><br><span class="line">				AnnotationConfigUtils.registerAnnotationConfigProcessors(parserContext.getRegistry(), source);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Register component for the surrounding &lt;context:annotation-config&gt; element.</span></span><br><span class="line">		CompositeComponentDefinition compDefinition = <span class="keyword">new</span> CompositeComponentDefinition(element.getTagName(), source);</span><br><span class="line">		parserContext.pushContainingComponent(compDefinition);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Nest the concrete beans in the surrounding component.</span></span><br><span class="line">		<span class="keyword">for</span> (BeanDefinitionHolder processorDefinition : processorDefinitions) &#123;</span><br><span class="line">			parserContext.registerComponent(<span class="keyword">new</span> BeanComponentDefinition(processorDefinition));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Finally register the composite component.</span></span><br><span class="line">		parserContext.popAndRegisterContainingComponent();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>对于AnnotationConfigUtils参考<a href="/2019/09/05/springBoot%E5%AD%A6%E4%B9%A0%E4%B8%80/#boot%E4%B8%ADcontext">context相关</a></p>
</li>
<li>
<p>LoadTimeWeaverBeanDefinitionParser<br>
创建<code>DefaultContextLoadTimeWeaver</code>GBD和<code>AspectJWeavingEnabler</code></p>
</li>
</ul>
  <figure class="highlight java"><figcaption><span>LoadTimeWeaverBeanDefinitionParser</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ASPECTJ_WEAVING_ENABLER_BEAN_NAME =</span><br><span class="line">		<span class="string">"org.springframework.context.config.internalAspectJWeavingEnabler"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ASPECTJ_WEAVING_ENABLER_CLASS_NAME =</span><br><span class="line">		<span class="string">"org.springframework.context.weaving.AspectJWeavingEnabler"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_LOAD_TIME_WEAVER_CLASS_NAME =</span><br><span class="line">		<span class="string">"org.springframework.context.weaving.DefaultContextLoadTimeWeaver"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEAVER_CLASS_ATTRIBUTE = <span class="string">"weaver-class"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ASPECTJ_WEAVING_ATTRIBUTE = <span class="string">"aspectj-weaving"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">//返回DefaultContextLoadTimeWeaver beanClass,具体逻辑要看AbstractSingleBeanDefinitionParser逻辑</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getBeanClassName</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (element.hasAttribute(WEAVER_CLASS_ATTRIBUTE)) &#123;</span><br><span class="line">		<span class="keyword">return</span> element.getAttribute(WEAVER_CLASS_ATTRIBUTE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> DEFAULT_LOAD_TIME_WEAVER_CLASS_NAME;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">//返回LTW bean Name</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">resolveId</span><span class="params">(Element element, AbstractBeanDefinition definition, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ConfigurableApplicationContext.LOAD_TIME_WEAVER_BEAN_NAME;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//解析标签,创建一个AspectJWeavingEnabler bean</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, ParserContext parserContext, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class="line">	builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (isAspectJWeavingEnabled(element.getAttribute(ASPECTJ_WEAVING_ATTRIBUTE), parserContext)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!parserContext.getRegistry().containsBeanDefinition(ASPECTJ_WEAVING_ENABLER_BEAN_NAME)) &#123;</span><br><span class="line">			RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(ASPECTJ_WEAVING_ENABLER_CLASS_NAME);</span><br><span class="line">			parserContext.registerBeanComponent(</span><br><span class="line">					<span class="keyword">new</span> BeanComponentDefinition(def, ASPECTJ_WEAVING_ENABLER_BEAN_NAME));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isBeanConfigurerAspectEnabled(parserContext.getReaderContext().getBeanClassLoader())) &#123;</span><br><span class="line">			<span class="keyword">new</span> SpringConfiguredBeanDefinitionParser().parse(element, parserContext);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   </span><br></pre></td></tr></table></figure>
简单来说LWT就是载入时织入,与spring aop实现点不同,后者是运行时编译</li>
</ul>
<h6 id="xml-和-注解实现的一些区别"><a class="header-anchor" href="#xml-和-注解实现的一些区别">¶</a>xml 和 注解实现的一些区别</h6>
<ul>
<li>单纯使用xml的话,gbd创建会包含所有的信息,如pvs,各种ioc属性</li>
<li>注解的话很多都要进行后处理器来处理
<ul>
<li>name一个String类型  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></span><br><span class="line">  zhangsan</span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>注解实现<br>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"张三"</span>)</span><br><span class="line"><span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure></li>
<li>前者会在为gbd#pvs,后者必须经过AutowiredAnnotationBeanPostProcessor(@AutoWire,@Value,@Inject)处理</li>
</ul>
</li>
</ul>
<h5 id="BeanDefinition"><a class="header-anchor" href="#BeanDefinition">¶</a>BeanDefinition</h5>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/RootBeanDetinition.png" class="" title="RootBeanDetinition">
<p>spring常见的接口设计模式:</p>
<ul>
<li>RootBeanDetinition实质是一个AttributeAccessor和BeanDefinition</li>
<li>属于AttributeAccessor的部分由父类BeanMetadataAttributeAccessor实现</li>
<li>AttributeAccessor:该接口定义如何访问源信息中的属性,在Bd体系中,通过 ‘BeanMetadataAttribut’,作为meta 原信息体现key-value
<ul>
<li>AttributeAccessor<figure class="highlight java"><figcaption><span>AttributeAccessor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAttribute</span><span class="params">(String name, @Nullable Object value)</span></span>;</span><br><span class="line">	<span class="function">Object <span class="title">getAttribute</span><span class="params">(String name)</span></span>;</span><br><span class="line">	<span class="function">Object <span class="title">removeAttribute</span><span class="params">(String name)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">hasAttribute</span><span class="params">(String name)</span></span>;</span><br><span class="line">	String[] attributeNames();</span><br><span class="line">      </span><br></pre></td></tr></table></figure>
</li>
<li>AttributeAccessorSupport<figure class="highlight java"><figcaption><span>AttributeAccessorSupport</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">     <span class="comment">//该map就是属性储存的位置,在该体系中,此map表示的是bean的一些附加信息,跟属性无关</span></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; attributes = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttribute</span><span class="params">(String name, @Nullable Object value)</span> </span>&#123;</span><br><span class="line">	Assert.notNull(name, <span class="string">"Name must not be null"</span>);</span><br><span class="line">	<span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">this</span>.attributes.put(name, value);</span><br><span class="line">	&#125;:</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		removeAttribute(name);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">     </span><br></pre></td></tr></table></figure>
</li>
<li>BeanMetadataAttributeAccessor<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/BeanMetadataAttributeAccessor.png" class="">
<figure class="highlight java"><figcaption><span>BeanMetadataAttributeAccessor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">//包含了要进行配置的对象</span></span><br><span class="line">      <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanMetadataElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return the configuration source &#123;<span class="doctag">@code</span> Object&#125; for this metadata element</span></span><br><span class="line"><span class="comment">	 * (may be &#123;<span class="doctag">@code</span> null&#125;).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">Object <span class="title">getSource</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">* Holder <span class="keyword">for</span> a key-value style attribute that is part of a bean definition.</span><br><span class="line">* Keeps track of the definition source in addition to the key-value pair.</span><br><span class="line">*</span><br><span class="line">* <span class="meta">@author</span> Juergen Hoeller</span><br><span class="line">* <span class="meta">@since</span> <span class="number">2.5</span></span><br><span class="line">*/</span><br><span class="line"><span class="comment">//包含了source中一个属性的键值对,可以理解为pair</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanMetadataAttribute</span> <span class="keyword">implements</span> <span class="title">BeanMetadataElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> Object value;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line"> <span class="keyword">private</span> Object source;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Extension of &#123;<span class="doctag">@link</span> org.springframework.core.AttributeAccessorSupport&#125;,</span></span><br><span class="line"><span class="comment"> * holding attributes as &#123;<span class="doctag">@link</span> BeanMetadataAttribute&#125; objects in order</span></span><br><span class="line"><span class="comment"> * to keep track of the definition source.</span></span><br><span class="line"><span class="comment"> * 该类用来访问source中属性,属性由BeanMetaDataAttribute包装</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"serial"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanMetadataAttributeAccessor</span> <span class="keyword">extends</span> <span class="title">AttributeAccessorSupport</span> <span class="keyword">implements</span> <span class="title">BeanMetadataElement</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  	<span class="keyword">private</span> Object source;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  	<span class="comment">/**</span></span><br><span class="line"><span class="comment">  	 * Set the configuration source &#123;<span class="doctag">@code</span> Object&#125; for this metadata element.</span></span><br><span class="line"><span class="comment">  	 * &lt;p&gt;The exact type of the object will depend on the configuration mechanism used.</span></span><br><span class="line"><span class="comment">  	 */</span></span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSource</span><span class="params">(@Nullable Object source)</span> </span>&#123;</span><br><span class="line">  		<span class="keyword">this</span>.source = source;</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line">  	<span class="meta">@Override</span></span><br><span class="line">  	<span class="meta">@Nullable</span></span><br><span class="line">  	<span class="function"><span class="keyword">public</span> Object <span class="title">getSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  		<span class="keyword">return</span> <span class="keyword">this</span>.source;</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  	<span class="comment">/**</span></span><br><span class="line"><span class="comment">  	 * Add the given BeanMetadataAttribute to this accessor's set of attributes.</span></span><br><span class="line"><span class="comment">  	 * <span class="doctag">@param</span> attribute the BeanMetadataAttribute object to register</span></span><br><span class="line"><span class="comment">  	 */</span></span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMetadataAttribute</span><span class="params">(BeanMetadataAttribute attribute)</span> </span>&#123;</span><br><span class="line">  		<span class="keyword">super</span>.setAttribute(attribute.getName(), attribute);</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line">      </span><br></pre></td></tr></table></figure>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/ScannedGenericBeanDefinition.png" class="">
此时的source用来说明bd的来源,该类型会在注册到<code>BeanFactory</code>时被转换为<code>RootBeanDefintion</code>类型<br>
图中propertyValues,是xml处理<propery>时添加的字面属性,在ioc过程中pvs要经过类型转换,以及各种处理器.</li>
</ul>
</li>
<li>BeanDefinition:该接口实质是描述了springBean配置</li>
<li>常见子类ScannedGenericBeanDefinition和GenericBeanDefinition  <figure class="highlight java"><figcaption><span>BeanDefinition</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setScope</span><span class="params">(@Nullable String scope)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setLazyInit</span><span class="params">(<span class="keyword">boolean</span> lazyInit)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setDependsOn</span><span class="params">(@Nullable String... dependsOn)</span></span>;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="BeanWrapper"><a class="header-anchor" href="#BeanWrapper">¶</a>BeanWrapper</h5>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/BeanWrapper.png" class="" title="BeanWrapper">
<ul>
<li>PropertyEditorRegistry 和 TypeConverter组成属性转换器</li>
</ul>
<h6 id="属性类型转换"><a class="header-anchor" href="#属性类型转换">¶</a>属性类型转换</h6>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/Property.png" class="" title="PropertyEditorRegistry">
<ul>
<li>
<p>PropertyEditor是jdk提供的接口,用来进行属性类型转换的</p>
  <figure class="highlight java"><figcaption><span>PropertyEditor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PropertyEditor</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">setValue</span><span class="params">(Object value)</span></span>;</span><br><span class="line">        <span class="comment">//将转递的stirng类型进行转换</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">setAsText</span><span class="params">(String text)</span> <span class="keyword">throws</span> java.lang.IllegalArgumentException</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//一般继承该接口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyEditorSupport</span> <span class="keyword">implements</span> <span class="title">PropertyEditor</span> </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> Object value;</span><br><span class="line">      <span class="keyword">private</span> Object source;</span><br><span class="line">      <span class="keyword">private</span> java.util.Vector&lt;PropertyChangeListener&gt; listeners;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">PropertyEditorSupport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      setSource(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">PropertyEditorSupport</span><span class="params">(Object source)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (source == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">      &#125;</span><br><span class="line">      setSource(source);</span><br><span class="line">  &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//spirng中的一个实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteArrayPropertyEditor</span> <span class="keyword">extends</span> <span class="title">PropertyEditorSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAsText</span><span class="params">(@Nullable String text)</span> </span>&#123;</span><br><span class="line">		setValue(text != <span class="keyword">null</span> ? text.getBytes() : <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getAsText</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">byte</span>[] value = (<span class="keyword">byte</span>[]) getValue();</span><br><span class="line">		<span class="keyword">return</span> (value != <span class="keyword">null</span> ? <span class="keyword">new</span> String(value) : <span class="string">""</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;    </span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>PropertyEditor使用</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.当类型String-&gt;Type转换</span></span><br><span class="line"><span class="comment">//调用setText()</span></span><br><span class="line"><span class="comment">//2.当其他类型-&gt;Type</span></span><br><span class="line"><span class="comment">//调用setValue()</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>PropertyEditorRegistrySupport使用Map存储PropertyEditor</p>
  <figure class="highlight java"><figcaption><span>PropertyEditorRegistrySupport</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyEditorRegistrySupport</span> <span class="keyword">implements</span> <span class="title">PropertyEditorRegistry</span> </span>&#123;</span><br><span class="line"> <span class="comment">//spring 实现的类型转换器,先略过    </span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> ConversionService conversionService;</span><br><span class="line"> <span class="comment">//默认的类型转换器</span></span><br><span class="line"> <span class="keyword">private</span> Map&lt;Class&lt;?&gt;, PropertyEditor&gt; defaultEditors;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createDefaultEditors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.defaultEditors.put(Charset<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">CharsetEditor</span>())</span>;</span><br><span class="line">	<span class="keyword">this</span>.defaultEditors.put(Class<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">ClassEditor</span>())</span>;</span><br><span class="line">	<span class="keyword">this</span>.defaultEditors.put(Class[]<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">ClassArrayEditor</span>())</span>;</span><br><span class="line">   <span class="comment">//....添加了大量的类型转换器</span></span><br><span class="line"> &#125;</span><br><span class="line">   </span><br></pre></td></tr></table></figure>
</li>
<li>
<p>TypeConverterDelegate作为委托模式用来真正处理类型转换</p>
  <figure class="highlight java"><figcaption><span>TypeConverterSupport</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeConverterSupport</span> <span class="keyword">extends</span> <span class="title">PropertyEditorRegistrySupport</span> <span class="keyword">implements</span> <span class="title">TypeConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	TypeConverterDelegate typeConverterDelegate;</span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">convertIfNecessary</span><span class="params">(@Nullable Object value, @Nullable Class&lt;T&gt; requiredType,</span></span></span><br><span class="line"><span class="function"><span class="params">			@Nullable TypeDescriptor typeDescriptor)</span> <span class="keyword">throws</span> TypeMismatchException </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.typeConverterDelegate.convertIfNecessary(<span class="keyword">null</span>, <span class="keyword">null</span>, value, requiredType,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//委托逻辑</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TypeConverterDelegate</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  *  propertyName 表示属性名</span></span><br><span class="line"><span class="comment">  *  oldValue 表示旧值,若该函数是pvs设值时调用一般是null</span></span><br><span class="line"><span class="comment">  *  newValue 表示此次要设置的值,也是要处理进行类型 转换的值</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">convertIfNecessary</span><span class="params">(@Nullable String propertyName, @Nullable Object oldValue, @Nullable Object newValue,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable Class&lt;T&gt; requiredType, @Nullable TypeDescriptor typeDescriptor)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Custom editor for this type?</span></span><br><span class="line"><span class="comment">//获取自定义的属性编辑器</span></span><br><span class="line">PropertyEditor editor = <span class="keyword">this</span>.propertyEditorRegistry.findCustomEditor(requiredType, propertyName);</span><br><span class="line"></span><br><span class="line">ConversionFailedException conversionAttemptEx = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// No custom editor but custom ConversionService specified?</span></span><br><span class="line"><span class="comment">// 尝试使用ConversionService进行转换</span></span><br><span class="line">ConversionService conversionService = <span class="keyword">this</span>.propertyEditorRegistry.getConversionService();</span><br><span class="line"><span class="keyword">if</span> (editor == <span class="keyword">null</span> &amp;&amp; conversionService != <span class="keyword">null</span> &amp;&amp; newValue != <span class="keyword">null</span> &amp;&amp; typeDescriptor != <span class="keyword">null</span>) &#123;</span><br><span class="line">TypeDescriptor sourceTypeDesc = TypeDescriptor.forObject(newValue);</span><br><span class="line"><span class="keyword">if</span> (conversionService.canConvert(sourceTypeDesc, typeDescriptor)) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (T) conversionService.convert(newValue, sourceTypeDesc, typeDescriptor);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (ConversionFailedException ex) &#123;</span><br><span class="line">    <span class="comment">// fallback to default conversion logic below</span></span><br><span class="line">    conversionAttemptEx = ex;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Object convertedValue = newValue;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Value not of required type?</span></span><br><span class="line"><span class="keyword">if</span> (editor != <span class="keyword">null</span> || (requiredType != <span class="keyword">null</span> &amp;&amp; !ClassUtils.isAssignableValue(requiredType, convertedValue))) &#123; <span class="comment">//没有自定义编辑器或者 不能直接分配(即newValue需要进行向requiredType的转换)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (typeDescriptor != <span class="keyword">null</span> &amp;&amp; requiredType != <span class="keyword">null</span> &amp;&amp; Collection<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">requiredType</span>) &amp;&amp;</span></span><br><span class="line"><span class="class">    <span class="title">convertedValue</span> <span class="title">instanceof</span> <span class="title">String</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//此处代码逻辑 是 当属性为Collection&lt;Class&gt;|Collection&lt;Eunm&gt; 时,可以将该字符串当作CSV转化    </span></span><br><span class="line">  TypeDescriptor elementTypeDesc = typeDescriptor.getElementTypeDescriptor();</span><br><span class="line">  <span class="keyword">if</span> (elementTypeDesc != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Class&lt;?&gt; elementType = elementTypeDesc.getType();</span><br><span class="line">    <span class="keyword">if</span> (Class<span class="class">.<span class="keyword">class</span> </span>== elementType || Enum<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">elementType</span>)) </span>&#123;</span><br><span class="line">      convertedValue = StringUtils.commaDelimitedListToStringArray((String) convertedValue);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (editor == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="comment">// 根据requiredType从map中获取对应的propertyEditor</span></span><br><span class="line">  editor = findDefaultEditor(requiredType);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//进行转换</span></span><br><span class="line">convertedValue = doConvertValue(oldValue, convertedValue, requiredType, editor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> standardConversion = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//....下边的逻辑是对于不能直接适配的情况,进一步的标准处理</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/doConvertValue.png" class="" title="doConvertValue">
<figure class="highlight java"><figcaption><span>doConvertValue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实际转换逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">doConvertValue</span><span class="params">(@Nullable Object oldValue, @Nullable Object newValue,</span></span></span><br><span class="line"><span class="function"><span class="params">			@Nullable Class&lt;?&gt; requiredType, @Nullable PropertyEditor editor)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		Object convertedValue = newValue;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (editor != <span class="keyword">null</span> &amp;&amp; !(convertedValue <span class="keyword">instanceof</span> String)) &#123;</span><br><span class="line">      <span class="comment">//一般来说spring基本都是将string类型进行转换,但是如果此处的value并不是String,</span></span><br><span class="line">      <span class="comment">//那么就要调用PropertyEditor的setValue进行转换,然后再get出来,这个set逻辑要</span></span><br><span class="line">      <span class="comment">//用户自己实现,或者spring内部提供了对应的转换器</span></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				editor.setValue(convertedValue);</span><br><span class="line">				Object newConvertedValue = editor.getValue();</span><br><span class="line">				<span class="keyword">if</span> (newConvertedValue != convertedValue) &#123;</span><br><span class="line">					convertedValue = newConvertedValue;</span><br><span class="line">					<span class="comment">// Reset PropertyEditor: It already did a proper conversion.</span></span><br><span class="line">					<span class="comment">// Don't use it again for a setAsText call.</span></span><br><span class="line">					editor = <span class="keyword">null</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">					logger.debug(<span class="string">"PropertyEditor ["</span> + editor.getClass().getName() + <span class="string">"] does not support setValue call"</span>, ex);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// Swallow and proceed.</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Object returnValue = convertedValue;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; !requiredType.isArray() &amp;&amp; convertedValue <span class="keyword">instanceof</span> String[]) &#123;</span><br><span class="line">		  <span class="comment">//若转换类型不为数组,并且给定的value为String数组,则将value转为成CVS</span></span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">"Converting String array to comma-delimited String ["</span> + convertedValue + <span class="string">"]"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			convertedValue = StringUtils.arrayToCommaDelimitedString((String[]) convertedValue);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//若经过上述两操作,cV还是String,那么就可以执行Text类型转换</span></span><br><span class="line">		<span class="keyword">if</span> (convertedValue <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">			<span class="keyword">if</span> (editor != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">// Use PropertyEditor's setAsText in case of a String value.</span></span><br><span class="line">				<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">					logger.trace(<span class="string">"Converting String to ["</span> + requiredType + <span class="string">"] using property editor ["</span> + editor + <span class="string">"]"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				String newTextValue = (String) convertedValue;</span><br><span class="line">				<span class="keyword">return</span> doConvertTextValue(oldValue, newTextValue, editor);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (String<span class="class">.<span class="keyword">class</span> </span>== requiredType) &#123;</span><br><span class="line">				returnValue = convertedValue;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> returnValue;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Object <span class="title">doConvertTextValue</span><span class="params">(@Nullable Object oldValue, String newTextValue, PropertyEditor editor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			editor.setValue(oldValue);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(<span class="string">"PropertyEditor ["</span> + editor.getClass().getName() + <span class="string">"] does not support setValue call"</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// Swallow and proceed.</span></span><br><span class="line">		&#125;</span><br><span class="line">		editor.setAsText(newTextValue);</span><br><span class="line">		<span class="keyword">return</span> editor.getValue();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">      </span><br></pre></td></tr></table></figure>
<ul>
<li>例子</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Sub sub;</span><br><span class="line">    <span class="keyword">private</span> List list;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;test&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;  <span class="comment">//不需要转换,$&#123;test&#125;从ev中获取</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"D:/1.txt"</span>)    </span><br><span class="line">    <span class="keyword">private</span> File file;    <span class="comment">//通过FileEditor 转换</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"1,2,3,4"</span>)</span><br><span class="line">    <span class="keyword">private</span> String[] test2; <span class="comment">//通过StringArrayEditor 直接转换</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"I:/BaiduNetdisk/api-ms-win-core-console-l1-1-0.dll,I:/BaiduNetdisk/api-ms-win-core-datetime-l1-1-0.dll"</span>)</span><br><span class="line">    <span class="keyword">private</span> List&lt;File&gt; files; <span class="comment">//先通过CustomCollectionEditor ,再通过FileEditor转换</span></span><br><span class="line">    <span class="comment">//但是默认情况下,这个转换器并不能正确处理这种类型</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//private File[] files   //没有该类型转换器</span></span><br></pre></td></tr></table></figure>
<p>这里描述一下非基础类型数组|集合转换逻辑<br>
convertIfNecessary-&gt;判断能否进行CVS处理,如果不行则执行CustomCollectionEditor转换,结果是一个<br>
单个 元素list,后续逻辑中 进行遍历,再调用convertIfNecessary,那么结果一定是错的.</p>
<ul>
<li>添加自定义编辑器<br>
通过CustomEditorConfigurer实现,这是一个BF_post</li>
</ul>
<h4 id="spring-post处理器"><a class="header-anchor" href="#spring-post处理器">¶</a>spring_post处理器</h4>
<ul>
<li>BeanPostProcessor</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MergedBeanDefinitionPostProcessor</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MergedBeanDefinitionPostProcessor</span> <span class="keyword">extends</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">postProcessMergedBeanDefinition</span><span class="params">(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">resetBeanDefinition</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>InstantiationAwareBeanPostProcessor</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InstantiationAwareBeanPostProcessor</span> <span class="keyword">extends</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">postProcessAfterInstantiation</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> PropertyValues <span class="title">postProcessProperties</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Instantiation表示实例化,即ioc反射创建BeanWrap;Initialization表示初始化,指ioc对于bean的init逻辑,如init-method</li>
<li>SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReference发生在早期引用获取过程</li>
<li>具体执行顺序参考<a href="/2019/05/21/ioc/#%E5%85%B3%E4%BA%8E%E5%8D%95%E4%BE%8Bbean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%92%8C%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98">生命周期</a></li>
</ul>
<h4 id="LTW"><a class="header-anchor" href="#LTW">¶</a>LTW</h4>
<p>载入时织入,使用方式参考<a href="https://www.w3xue.com/exp/article/20189/1890.html" target="_blank" rel="noopener">LTW</a>,</p>
<ul>
<li>由<code>LoadTimeWeaverBeanDefinitionParser</code>创建<code>AspectJWeavingEnabler</code>以及<code>DefaultContextLoadTimeWeaver</code></li>
</ul>
<h4 id="MessageSource"><a class="header-anchor" href="#MessageSource">¶</a>MessageSource</h4>
<p>该接口是spring提供的和i18n相关的基础类,使用起来并不复杂</p>
<ul>
<li>
<p>ResourceBulde:jdk实现的国际化类,也是messageSource的内部原理</p>
<ul>
<li>准备多种语言properties文件<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/%E5%A4%9A%E8%AF%AD%E8%A8%80.png" class="">
error.properties<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0000=error</span><br><span class="line">0001=info</span><br></pre></td></tr></table></figure>
error_zh.Properties<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0000=错误</span><br><span class="line">test=this is a &#123;0&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>使用<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据Local获取不同的ResourceBulde</span></span><br><span class="line">ResourceBundle resourceBundle = ResourceBundle.getBundle(<span class="string">"error"</span>,Locale.getDefault());</span><br><span class="line">String zh_test = resourceBundle.getString(<span class="string">"test"</span>)</span><br><span class="line"><span class="comment">//this is a &#123;0&#125;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>MessageFormat:jdk提供用来替换占位符的工具类</p>
<ul>
<li>接上文<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MessageFormat messageFormat = <span class="keyword">new</span> MessageFormat(zh_test);</span><br><span class="line">messageFormat.format(<span class="keyword">new</span> String[]&#123;<span class="string">"测试"</span>&#125;)</span><br><span class="line"><span class="comment">//静态调用</span></span><br><span class="line">MessageFormat.format(<span class="string">"this is a &#123;0&#125;"</span>,<span class="string">"测试"</span>)</span><br><span class="line"><span class="comment">//结果都是 this is a 测试</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>MessageSource</p>
<ul>
<li>定义<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* code 表示要转换的key,如上文的0000,test</span></span><br><span class="line"><span class="comment">* args 表示可以替换的占位符,如MessageFormat.format("this is a &#123;0&#125;",new String[]&#123;"测试"&#125;)第二个参数</span></span><br><span class="line"><span class="comment">* defaultMessage 表示未能匹配时返回的默认值</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">String <span class="title">getMessage</span><span class="params">(String code, @Nullable Object[] args, @Nullable String defaultMessage, Locale locale)</span></span>;</span><br><span class="line"><span class="comment">//无默认,不匹配则抛出异常</span></span><br><span class="line"><span class="function">String <span class="title">getMessage</span><span class="params">(String code, @Nullable Object[] args, Locale locale)</span> <span class="keyword">throws</span> NoSuchMessageException</span>;</span><br><span class="line"><span class="comment">//MessageSourceResolvable仅仅是封装了第一个函数的前三个参数</span></span><br><span class="line"><span class="function">String <span class="title">getMessage</span><span class="params">(MessageSourceResolvable resolvable, Locale locale)</span> <span class="keyword">throws</span> NoSuchMessageException</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>使用<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ResourceBundleMessageSource是spring提供的实现之一</span></span><br><span class="line">ResourceBundleMessageSource messageSource = <span class="keyword">new</span> ResourceBundleMessageSource();</span><br><span class="line"><span class="comment">//设置properties</span></span><br><span class="line">messageSource.setBasename(<span class="string">"error"</span>);</span><br><span class="line">messageSource.setDefaultEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">String message = messageSource.getMessage(<span class="string">"0001"</span>, <span class="keyword">null</span>, Locale.ENGLISH);</span><br><span class="line">System.out.println(message);</span><br><span class="line"><span class="comment">//error</span></span><br><span class="line">String str1 = messageSource.getMessage(<span class="string">"test"</span>,<span class="keyword">new</span> String[]&#123;<span class="string">"测试"</span>&#125;,Locale.CHINESE);</span><br><span class="line">System.out.println(str1);</span><br><span class="line"><span class="comment">//this is a 测试</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="spring框架中提供的特殊调用点"><a class="header-anchor" href="#spring框架中提供的特殊调用点">¶</a>spring框架中提供的特殊调用点</h4>
<h5 id="spring-web关于web容器的初始化"><a class="header-anchor" href="#spring-web关于web容器的初始化">¶</a>spring web关于web容器的初始化</h5>
<ul>
<li>web相关:参考<a href="/2019/02/19/SpringMVC%E6%BA%90%E7%A0%81/#dispatcherServlet">dispatcherServlet</a>
<ul>
<li>ContextLoaderListener:初始化MVC中ioc容器</li>
<li>SpringServletContainerInitializer:ServletContainerInitializer框架</li>
<li>WebApplicationInitializer:web初始化实际调用接口</li>
</ul>
</li>
<li>MVC相关
<ul>
<li>WebMvcConfigurer:MVC内部的设置</li>
</ul>
</li>
<li>spring context
<ul>
<li>ApplicationContextInitializer:该接口被context#refresh的调用|或context创建者调用<br>
,就是整体项目的入口,如SpringApplication | FrameworkServlet</li>
</ul>
</li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">fancylight</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/02/11/spring%E5%B8%B8%E8%A7%81/">http://yoursite.com/2020/02/11/spring%E5%B8%B8%E8%A7%81/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%A1%86%E6%9E%B6/">框架    </a><a class="post-meta__tags" href="/tags/spring/">spring    </a><a class="post-meta__tags" href="/tags/spring%E7%BB%84%E4%BB%B6/">spring组件    </a></div><div class="post_share"><div class="social-share" data-image="/img/spring.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/03/04/Spring-aop%E7%BB%87%E5%85%A5%E5%88%86%E6%9E%90/"><img class="prev_cover" src="/img/spring.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring_aop织入分析</div></div></a></div><div class="next-post pull_right"><a href="/2019/12/26/springMVC%E6%A0%B8%E5%BF%83/"><img class="next_cover" src="/img/spring.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">springMVC核心</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/03/10/spring内省/" title="spring内省"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-10</div><div class="relatedPosts_title">spring内省</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/04/Spring-aop织入分析/" title="Spring_aop织入分析"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-04</div><div class="relatedPosts_title">Spring_aop织入分析</div></div></a></div><div class="relatedPosts_item"><a href="/2019/02/19/SpringMVC源码/" title="SpringMVC体系"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-02-19</div><div class="relatedPosts_title">SpringMVC体系</div></div></a></div><div class="relatedPosts_item"><a href="/2019/05/25/aop/" title="aop"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-05-25</div><div class="relatedPosts_title">aop</div></div></a></div><div class="relatedPosts_item"><a href="/2019/09/05/springBoot学习一/" title="springBoot学习一"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-09-05</div><div class="relatedPosts_title">springBoot学习一</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/17/springMVC内部/" title="springMVC内部"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-17</div><div class="relatedPosts_title">springMVC内部</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '624d139155758ea48077',
  clientSecret: 'cc126a301586ea63779cec6a6b53101749dbc9dd',
  repo: 'gittalk_issue',
  owner: 'fancylight',
  admin: ['fancylight'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By fancylight</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script></body></html>