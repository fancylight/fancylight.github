<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>spring常见 | 博客</title><meta name="description" content="spring框架中常见的组件"><meta name="keywords" content="框架,spring,spring组件"><meta name="author" content="fancylight"><meta name="copyright" content="fancylight"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="spring常见"><meta name="twitter:description" content="spring框架中常见的组件"><meta name="twitter:image" content="https://www.fancylight.top/img/spring.png"><meta property="og:type" content="article"><meta property="og:title" content="spring常见"><meta property="og:url" content="https://www.fancylight.top/2020/02/11/spring%E5%B8%B8%E8%A7%81/"><meta property="og:site_name" content="博客"><meta property="og:description" content="spring框架中常见的组件"><meta property="og:image" content="https://www.fancylight.top/img/spring.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script><!-- hexo-inject:begin --><!-- hexo-inject:end -->const autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      now = new Date();
      hour = now.getHours();
      isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://www.fancylight.top/2020/02/11/spring%E5%B8%B8%E8%A7%81/"><link rel="prev" title="Spring_aop织入分析" href="https://www.fancylight.top/2020/03/04/Spring-aop%E7%BB%87%E5%85%A5%E5%88%86%E6%9E%90/"><link rel="next" title="springMVC核心" href="https://www.fancylight.top/2019/12/26/springMVC%E6%A0%B8%E5%BF%83/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: false,
  highlightShrink: false,
  isFontAwesomeV5: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false
}</script><meta name="generator" content="Hexo 4.2.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">56</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">26</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 目录</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bean相关"><span class="toc-number">1.</span> <span class="toc-text">Bean相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#xml解析"><span class="toc-number">1.1.</span> <span class="toc-text">xml解析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#基本元素"><span class="toc-number">1.1.1.</span> <span class="toc-text">基本元素</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#custom元素"><span class="toc-number">1.1.2.</span> <span class="toc-text">custom元素</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#NamespaceHandler体系"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">NamespaceHandler体系</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#xml-和-注解实现的一些区别"><span class="toc-number">1.1.3.</span> <span class="toc-text">xml 和 注解实现的一些区别</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BeanDefinition"><span class="toc-number">1.2.</span> <span class="toc-text">BeanDefinition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BeanWrapper"><span class="toc-number">1.3.</span> <span class="toc-text">BeanWrapper</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#属性类型转换"><span class="toc-number">1.3.1.</span> <span class="toc-text">属性类型转换</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spring-post处理器"><span class="toc-number">2.</span> <span class="toc-text">spring_post处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LTW"><span class="toc-number">3.</span> <span class="toc-text">LTW</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MessageSource"><span class="toc-number">4.</span> <span class="toc-text">MessageSource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spring框架中提供的特殊调用点"><span class="toc-number">5.</span> <span class="toc-text">spring框架中提供的特殊调用点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#spring-web关于web容器的初始化"><span class="toc-number">5.1.</span> <span class="toc-text">spring web关于web容器的初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#springIo"><span class="toc-number">6.</span> <span class="toc-text">springIo</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#resource接口"><span class="toc-number">6.1.</span> <span class="toc-text">resource接口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ResolvingResource"><span class="toc-number">6.1.1.</span> <span class="toc-text">ResolvingResource</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HttpResource"><span class="toc-number">6.1.2.</span> <span class="toc-text">HttpResource</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ContextResouce"><span class="toc-number">6.1.3.</span> <span class="toc-text">ContextResouce</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ServletCOntextResouce"><span class="toc-number">6.1.3.1.</span> <span class="toc-text">ServletCOntextResouce</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ResouceLoader"><span class="toc-number">6.2.</span> <span class="toc-text">ResouceLoader</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DefaultResourceLoader"><span class="toc-number">6.2.1.</span> <span class="toc-text">DefaultResourceLoader</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ClassRelativeResourceLoader"><span class="toc-number">6.2.1.1.</span> <span class="toc-text">ClassRelativeResourceLoader</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#FileSystemResourceLoader"><span class="toc-number">6.2.1.2.</span> <span class="toc-text">FileSystemResourceLoader</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ResourcePatternResolver"><span class="toc-number">6.2.2.</span> <span class="toc-text">ResourcePatternResolver</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#PathMatchingResourcePatternResolver"><span class="toc-number">6.2.2.1.</span> <span class="toc-text">PathMatchingResourcePatternResolver</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 目录</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">spring常见</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-02-11<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-04-08</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/java/">java</a></span><div class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">7.1k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 36 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2020/02/11/spring%E5%B8%B8%E8%A7%81/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></div></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h3 id="Bean相关"><a class="header-anchor" href="#Bean相关">¶</a>Bean相关</h3>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><ul>
<li>概念
<ul>
<li>BeanDefinition 是将ioc定义如xml,注解扫描的类转为成抽象描述,包含了用户定义的各种bean信息</li>
<li>BeanWrapper 是从该类抽离出的低级javaBean,包含了属性转换器,以及java 原信息</li>
<li>PropertyValue 仅仅是封装key-value 表示对象,存在于Bd内部,以及ioc属性转换过程中</li>
<li>PropertyEditor jdk提供的属性转换,A-&gt;B类型的转换,ioc逻辑中使用</li>
</ul>
</li>
</ul>
<h4 id="xml解析"><a class="header-anchor" href="#xml解析">¶</a>xml解析</h4>
<p>简而言之, 解析xml的类是BeanDefinitionParserDelegate完成的</p>
<ul>
<li>标准bean标签的解析过程
<ul>
<li>xml例子<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"test"</span> <span class="attr">class</span>=<span class="string">"com.light.Foo"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">        this is a test</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"files"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>d:/test/12.txt<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>d:/test/12.txt<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">key</span>=<span class="string">"key1"</span> <span class="attr">value</span>=<span class="string">"value1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h5 id="基本元素"><a class="header-anchor" href="#基本元素">¶</a>基本元素</h5>
<ul>
<li>前言<br>
解析bean的读取器为<code>BeanDefinitionReader</code>体系,并非是仅仅支持xml.</li>
<li>外部类<br>
<figure class="highlight java"><figcaption><span>DefaultBeanDefinitionDocumentReader</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该类是xml默认的 解析器实现类</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//委托模式</span></span><br><span class="line">        BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.delegate;</span><br><span class="line">        <span class="keyword">this</span>.delegate = createDelegate(getReaderContext(), root, parent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">            String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</span><br><span class="line">                String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</span><br><span class="line">                        profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">                <span class="comment">// We cannot use Profiles.of(...) since profile expressions are not supported</span></span><br><span class="line">                <span class="comment">// in XML config. See SPR-12458 for details.</span></span><br><span class="line">                <span class="keyword">if</span> (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                        logger.debug(<span class="string">"Skipped XML bean definition file due to specified profiles ["</span> + profileSpec +</span><br><span class="line">                                <span class="string">"] not matching: "</span> + getReaderContext().getResource());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        preProcessXml(root); <span class="comment">//空,子类实现</span></span><br><span class="line">        parseBeanDefinitions(root, <span class="keyword">this</span>.delegate);</span><br><span class="line">        postProcessXml(root); <span class="comment">//空,子类实现</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.delegate = parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//-------------------------------- 循环处理所有元素---------------------------------</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">            NodeList nl = root.getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">                Node node = nl.item(i);</span><br><span class="line">                <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">                    Element ele = (Element) node;</span><br><span class="line">                    <span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line">                        parseDefaultElement(ele, delegate); <span class="comment">//处理不用引入如&lt;context&gt; 这样的默认标签</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        delegate.parseCustomElement(ele); <span class="comment">//处理额外的标签</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            delegate.parseCustomElement(root);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------处理默认标签-------------------------------------------</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</span><br><span class="line">    importBeanDefinitionResource(ele);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</span><br><span class="line">    processAliasRegistration(ele);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">    processBeanDefinition(ele, delegate);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</span><br><span class="line">    <span class="comment">// recurse</span></span><br><span class="line">    doRegisterBeanDefinitions(ele);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//------------------------------------处理bean标签-----------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//holder仅仅用来包含BeanDefition,内部的BeanDiftion 就是GenicBeanDeition</span></span><br><span class="line">  <span class="comment">//[1]  解析并创建gbdH</span></span><br><span class="line">  BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);</span><br><span class="line">  <span class="comment">//[1!]</span></span><br><span class="line">  <span class="comment">//[2] 注册bd到beanFacotry(Registry)中</span></span><br><span class="line">  <span class="keyword">if</span> (bdHolder != <span class="keyword">null</span>) &#123;</span><br><span class="line">    bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Register the final decorated instance.</span></span><br><span class="line">      BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">      getReaderContext().error(<span class="string">"Failed to register bean definition with name '"</span> +</span><br><span class="line">          bdHolder.getBeanName() + <span class="string">"'"</span>, ele, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//[2!]</span></span><br><span class="line">    <span class="comment">//[3] 触发事件</span></span><br><span class="line">    getReaderContext().fireComponentRegistered(<span class="keyword">new</span> BeanComponentDefinition(bdHolder));</span><br><span class="line">    <span class="comment">//[3!]</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      </span><br></pre></td></tr></table></figure></li>
<li>委托类<br>
<figure class="highlight java"><figcaption><span>BeanDefinitionParserDelegate</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//------------------------------------解析 并创建 gbd--------------------------------------</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parseBeanDefinitionElement(ele, <span class="keyword">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Nullable</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele, @Nullable BeanDefinition containingBean)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//[1] 处理id和name,别名,保持id唯一性</span></span><br><span class="line">        String id = ele.getAttribute(ID_ATTRIBUTE);</span><br><span class="line">        String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; aliases = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">          String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">          aliases.addAll(Arrays.asList(nameArr));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String beanName = id;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123;</span><br><span class="line">          beanName = aliases.remove(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">"No XML 'id' specified - using '"</span> + beanName +</span><br><span class="line">                <span class="string">"' as bean name and "</span> + aliases + <span class="string">" as aliases"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (containingBean == <span class="keyword">null</span>) &#123;</span><br><span class="line">          checkNameUniqueness(beanName, aliases, ele);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//[1!]</span></span><br><span class="line">        <span class="comment">//[2]解析标签,并创建gbd</span></span><br><span class="line">        AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean);</span><br><span class="line">        <span class="comment">//[2!]</span></span><br><span class="line">        <span class="keyword">if</span> (beanDefinition != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!StringUtils.hasText(beanName)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (containingBean != <span class="keyword">null</span>) &#123;</span><br><span class="line">                beanName = BeanDefinitionReaderUtils.generateBeanName(</span><br><span class="line">                    beanDefinition, <span class="keyword">this</span>.readerContext.getRegistry(), <span class="keyword">true</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> &#123;</span><br><span class="line">                beanName = <span class="keyword">this</span>.readerContext.generateBeanName(beanDefinition);</span><br><span class="line">                <span class="comment">// Register an alias for the plain bean class name, if still possible,</span></span><br><span class="line">                <span class="comment">// if the generator returned the class name plus a suffix.</span></span><br><span class="line">                <span class="comment">// This is expected for Spring 1.2/2.0 backwards compatibility.</span></span><br><span class="line">                String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line">                <span class="keyword">if</span> (beanClassName != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    beanName.startsWith(beanClassName) &amp;&amp; beanName.length() &gt; beanClassName.length() &amp;&amp;</span><br><span class="line">                    !<span class="keyword">this</span>.readerContext.getRegistry().isBeanNameInUse(beanClassName)) &#123;</span><br><span class="line">                  aliases.add(beanClassName);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(<span class="string">"Neither XML 'id' nor 'name' specified - "</span> +</span><br><span class="line">                    <span class="string">"using generated bean name ["</span> + beanName + <span class="string">"]"</span>);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">              error(ex.getMessage(), ele);</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          String[] aliasesArray = StringUtils.toStringArray(aliases);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> BeanDefinitionHolder(beanDefinition, beanName, aliasesArray);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//----------------------------------实际创建gbd的代码---------------------------</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> AbstractBeanDefinition <span class="title">parseBeanDefinitionElement</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          Element ele, String beanName, @Nullable BeanDefinition containingBean)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> BeanEntry(beanName));</span><br><span class="line"></span><br><span class="line">        String className = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//class属性</span></span><br><span class="line">        <span class="keyword">if</span> (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</span><br><span class="line">          className = ele.getAttribute(CLASS_ATTRIBUTE).trim();</span><br><span class="line">        &#125;</span><br><span class="line">        String parent = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//parent属性</span></span><br><span class="line">        <span class="keyword">if</span> (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</span><br><span class="line">          parent = ele.getAttribute(PARENT_ATTRIBUTE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 简单创建gbd实例</span></span><br><span class="line">          AbstractBeanDefinition bd = createBeanDefinition(className, parent);</span><br><span class="line">          <span class="comment">// 处理&lt;bean&gt; 标签中所有的属性,即attr,设置为abd(AbstractBeanDefinition) 对应的属性</span></span><br><span class="line">          parseBeanDefinitionAttributes(ele, beanName, containingBean, bd);</span><br><span class="line">          <span class="comment">// 子类node中寻找 获取desc</span></span><br><span class="line">          bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT));</span><br><span class="line">          <span class="comment">//  此处代码见下边</span></span><br><span class="line">          parseMetaElements(ele, bd);</span><br><span class="line">          <span class="comment">// 子类node寻找&lt;lookUp  name="" ,bean=""&gt; 元素,添加MethodOverrride对象到bd中</span></span><br><span class="line">          parseLookupOverrideSubElements(ele, bd.getMethodOverrides());</span><br><span class="line">          <span class="comment">// 寻找&lt;ReplaceMethod name="" repalcer=""&gt;  元素 添加MEthodOverride对象到bd中</span></span><br><span class="line">          parseReplacedMethodSubElements(ele, bd.getMethodOverrides());</span><br><span class="line">          <span class="comment">// 处理&lt;constructor-arg index= ...&gt;</span></span><br><span class="line">          <span class="comment">// bd.getConstructorArgumentValues().addGenericArgumentValue(valueHolder);</span></span><br><span class="line">          <span class="comment">// valueHolder就是解析后创建的要添加到bd中的对象  </span></span><br><span class="line">          parseConstructorArgElements(ele, bd);</span><br><span class="line">          <span class="comment">//处理子类中属性</span></span><br><span class="line">          parsePropertyElements(ele, bd);</span><br><span class="line">          <span class="comment">//处理qualifier标签</span></span><br><span class="line">          parseQualifierElements(ele, bd);</span><br><span class="line">          <span class="comment">//bd来源,如xml的路径  </span></span><br><span class="line">          bd.setResource(<span class="keyword">this</span>.readerContext.getResource());</span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          bd.setSource(extractSource(ele));</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> bd;</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//------------------------------处理meta元素-----------------------</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseMetaElements</span><span class="params">(Element ele, BeanMetadataAttributeAccessor attributeAccessor)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//从子类寻&lt;meta&gt;标签,获取meat的key以及value属性,作为bd#attribute</span></span><br><span class="line">        NodeList nl = ele.getChildNodes();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">          Node node = nl.item(i);</span><br><span class="line">          <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, META_ELEMENT)) &#123;</span><br><span class="line">            Element metaElement = (Element) node;</span><br><span class="line">            <span class="comment">//这里就能知道BeanMetadataAttributeAccessor的map是什么情况可以设置的</span></span><br><span class="line">            String key = metaElement.getAttribute(KEY_ATTRIBUTE);</span><br><span class="line">            String value = metaElement.getAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">            <span class="comment">//此处体现了BD体系中如何使用key-value</span></span><br><span class="line">            BeanMetadataAttribute attribute = <span class="keyword">new</span> BeanMetadataAttribute(key, value);</span><br><span class="line">            attribute.setSource(extractSource(metaElement));</span><br><span class="line">            attributeAccessor.addMetadataAttribute(attribute);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//----------------------------处理property----------------------------</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parsePropertyElement</span><span class="params">(Element ele, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">      String propertyName = ele.getAttribute(NAME_ATTRIBUTE); <span class="comment">//获取该propery名</span></span><br><span class="line">      <span class="keyword">if</span> (!StringUtils.hasLength(propertyName)) &#123;</span><br><span class="line">          error(<span class="string">"Tag 'property' must have a 'name' attribute"</span>, ele);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> PropertyEntry(propertyName));</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (bd.getPropertyValues().contains(propertyName)) &#123;</span><br><span class="line">              error(<span class="string">"Multiple 'property' definitions for property '"</span> + propertyName + <span class="string">"'"</span>, ele);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">    <span class="comment">//此处是具体代码</span></span><br><span class="line">          Object val = parsePropertyValue(ele, bd, propertyName);</span><br><span class="line">    <span class="comment">//返回值创建pv (key-vlaue) 类型</span></span><br><span class="line">          PropertyValue pv = <span class="keyword">new</span> PropertyValue(propertyName, val);</span><br><span class="line">          parseMetaElements(ele, pv);</span><br><span class="line">          pv.setSource(extractSource(ele));</span><br><span class="line">    <span class="comment">//添加到bd#pvs中,这个pvs在ioc中注值使用,非常关键</span></span><br><span class="line">          bd.getPropertyValues().addPropertyValue(pv);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">parsePropertyValue</span><span class="params">(Element ele, BeanDefinition bd, @Nullable String propertyName)</span> </span>&#123;</span><br><span class="line">      String elementName = (propertyName != <span class="keyword">null</span> ?</span><br><span class="line">              <span class="string">"&lt;property&gt; element for property '"</span> + propertyName + <span class="string">"'"</span> :</span><br><span class="line">              <span class="string">"&lt;constructor-arg&gt; element"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Should only have one child element: ref, value, list, etc.</span></span><br><span class="line">  <span class="comment">//[1]获取当前元素(即Property) 子元素,最多最外层 只能存在一个如上</span></span><br><span class="line">      NodeList nl = ele.getChildNodes();</span><br><span class="line">      Element subElement = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">          Node node = nl.item(i);</span><br><span class="line">          <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element &amp;&amp; !nodeNameEquals(node, DESCRIPTION_ELEMENT) &amp;&amp;</span><br><span class="line">                  !nodeNameEquals(node, META_ELEMENT)) &#123;</span><br><span class="line">              <span class="comment">// Child element is what we're looking for.</span></span><br><span class="line">              <span class="keyword">if</span> (subElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  error(elementName + <span class="string">" must not contain more than one sub-element"</span>, ele);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> &#123;</span><br><span class="line">                  subElement = (Element) node;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="comment">//[1!]</span></span><br><span class="line">  <span class="comment">//[2] 不允许property元素带有value和ref属性, 或者任意属性并且有子元素</span></span><br><span class="line">      <span class="keyword">boolean</span> hasRefAttribute = ele.hasAttribute(REF_ATTRIBUTE);</span><br><span class="line">      <span class="keyword">boolean</span> hasValueAttribute = ele.hasAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">      <span class="keyword">if</span> ((hasRefAttribute &amp;&amp; hasValueAttribute) ||</span><br><span class="line">              ((hasRefAttribute || hasValueAttribute) &amp;&amp; subElement != <span class="keyword">null</span>)) &#123;</span><br><span class="line">          error(elementName +</span><br><span class="line">                  <span class="string">" is only allowed to contain either 'ref' attribute OR 'value' attribute OR sub-element"</span>, ele);</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="comment">//[2]</span></span><br><span class="line">  <span class="comment">//[3] 分情况讨论</span></span><br><span class="line">      <span class="keyword">if</span> (hasRefAttribute) &#123;</span><br><span class="line">          String refName = ele.getAttribute(REF_ATTRIBUTE);</span><br><span class="line">          <span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</span><br><span class="line">              error(elementName + <span class="string">" contains empty 'ref' attribute"</span>, ele);</span><br><span class="line">          &#125;</span><br><span class="line">          RuntimeBeanReference ref = <span class="keyword">new</span> RuntimeBeanReference(refName);<span class="comment">//创建一个引用</span></span><br><span class="line">          ref.setSource(extractSource(ele));</span><br><span class="line">          <span class="keyword">return</span> ref;</span><br><span class="line">      &#125; <span class="comment">//ref情况返回</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (hasValueAttribute) &#123;</span><br><span class="line">          TypedStringValue valueHolder = <span class="keyword">new</span> TypedStringValue(ele.getAttribute(VALUE_ATTRIBUTE));</span><br><span class="line">          valueHolder.setSource(extractSource(ele));</span><br><span class="line">          <span class="keyword">return</span> valueHolder;</span><br><span class="line">      &#125;<span class="comment">//value 类型</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (subElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> parsePropertySubElement(subElement, bd); <span class="comment">//复杂情况,即property存在子元素</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Neither child element nor "ref" or "value" attribute found.</span></span><br><span class="line">          error(elementName + <span class="string">" must specify a ref or value"</span>, ele);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  [<span class="number">3</span>!]</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//-------------------------------处理property子元素------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">parsePropertySubElement</span><span class="params">(Element ele, @Nullable BeanDefinition bd, @Nullable String defaultValueType)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//[1]</span></span><br><span class="line">      <span class="keyword">if</span> (!isDefaultNamespace(ele)) &#123;</span><br><span class="line">          <span class="keyword">return</span> parseNestedCustomElement(ele, bd); <span class="comment">//非标准元素,去调用custom逻辑,见下文</span></span><br><span class="line">      &#125;</span><br><span class="line">  <span class="comment">//[1!]</span></span><br><span class="line">  <span class="comment">//[2]</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">     <span class="comment">//Bean标签,相当于递归调用</span></span><br><span class="line">          BeanDefinitionHolder nestedBd = parseBeanDefinitionElement(ele, bd);</span><br><span class="line">          <span class="keyword">if</span> (nestedBd != <span class="keyword">null</span>) &#123;</span><br><span class="line">              nestedBd = decorateBeanDefinitionIfRequired(ele, nestedBd, bd);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> nestedBd;</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="comment">//[2!]</span></span><br><span class="line">  <span class="comment">//[3]</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, REF_ELEMENT)) &#123;</span><br><span class="line">          <span class="comment">// A generic reference to any name of any bean.</span></span><br><span class="line">          String refName = ele.getAttribute(BEAN_REF_ATTRIBUTE);</span><br><span class="line">          <span class="keyword">boolean</span> toParent = <span class="keyword">false</span>;</span><br><span class="line">          <span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</span><br><span class="line">              <span class="comment">// A reference to the id of another bean in a parent context.</span></span><br><span class="line">              refName = ele.getAttribute(PARENT_REF_ATTRIBUTE);</span><br><span class="line">              toParent = <span class="keyword">true</span>;</span><br><span class="line">              <span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</span><br><span class="line">                  error(<span class="string">"'bean' or 'parent' is required for &lt;ref&gt; element"</span>, ele);</span><br><span class="line">                  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</span><br><span class="line">              error(<span class="string">"&lt;ref&gt; element contains empty target attribute"</span>, ele);</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          RuntimeBeanReference ref = <span class="keyword">new</span> RuntimeBeanReference(refName, toParent);</span><br><span class="line">          ref.setSource(extractSource(ele));</span><br><span class="line">          <span class="keyword">return</span> ref;<span class="comment">// &lt;ref bean=""&gt; 处理</span></span><br><span class="line">      &#125;</span><br><span class="line">  <span class="comment">//[4]</span></span><br><span class="line">  <span class="comment">//[5] &lt;idref bean=""&gt; 此处应该只能填写id</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, IDREF_ELEMENT)) &#123;</span><br><span class="line">          <span class="keyword">return</span> parseIdRefElement(ele);</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="comment">//[5!]</span></span><br><span class="line">  <span class="comment">//[6] &lt;value &gt;处理</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, VALUE_ELEMENT)) &#123;</span><br><span class="line">          <span class="keyword">return</span> parseValueElement(ele, defaultValueType);</span><br><span class="line">      &#125;<span class="comment">//[6!]</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, NULL_ELEMENT)) &#123;</span><br><span class="line">          <span class="comment">// It's a distinguished null value. Let's wrap it in a TypedStringValue</span></span><br><span class="line">          <span class="comment">// object in order to preserve the source location.</span></span><br><span class="line">          TypedStringValue nullHolder = <span class="keyword">new</span> TypedStringValue(<span class="keyword">null</span>);</span><br><span class="line">          nullHolder.setSource(extractSource(ele));</span><br><span class="line">          <span class="keyword">return</span> nullHolder;</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="comment">// 这几个类型 可能会继续引起子 解析,</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, ARRAY_ELEMENT)) &#123;</span><br><span class="line">          <span class="keyword">return</span> parseArrayElement(ele, bd);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, LIST_ELEMENT)) &#123;</span><br><span class="line">          <span class="keyword">return</span> parseListElement(ele, bd);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, SET_ELEMENT)) &#123;</span><br><span class="line">          <span class="keyword">return</span> parseSetElement(ele, bd);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, MAP_ELEMENT)) &#123;</span><br><span class="line">          <span class="keyword">return</span> parseMapElement(ele, bd);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, PROPS_ELEMENT)) &#123;</span><br><span class="line">          <span class="keyword">return</span> parsePropsElement(ele);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">          error(<span class="string">"Unknown property sub-element: ["</span> + ele.getNodeName() + <span class="string">"]"</span>, ele);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="custom元素"><a class="header-anchor" href="#custom元素">¶</a>custom元素</h5>
<h6 id="NamespaceHandler体系"><a class="header-anchor" href="#NamespaceHandler体系">¶</a>NamespaceHandler体系</h6>
<ul>
<li>调用点</li>
</ul>
<figure class="highlight java"><figcaption><span>BeanDefinitionParserDelegate</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> parseCustomElement(ele, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele, @Nullable BeanDefinition containingBd)</span> </span>&#123;</span><br><span class="line">    String namespaceUri = getNamespaceURI(ele);</span><br><span class="line">    <span class="keyword">if</span> (namespaceUri == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据不同的元素使用不同的handler 来处理</span></span><br><span class="line">    NamespaceHandler handler = <span class="keyword">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        error(<span class="string">"Unable to locate Spring NamespaceHandler for XML schema namespace ["</span> + namespaceUri + <span class="string">"]"</span>, ele);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> handler.parse(ele, <span class="keyword">new</span> ParserContext(<span class="keyword">this</span>.readerContext, <span class="keyword">this</span>, containingBd));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>继承树</li>
</ul>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/BeanDetintionParser.png" class="">
<p>简单来看实际最多的是直接子类,另一类是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BeanDefinitionParser</span><br><span class="line">    AbstractBeanDefinitionParser</span><br><span class="line">        AbstractSingleBeanDefinitionParser</span><br></pre></td></tr></table></figure>
<ul>
<li>抽象逻辑<br>
<figure class="highlight java"><figcaption><span>AbstractBeanDefinitionParser</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">           <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBeanDefinitionParser</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionParser</span> </span>&#123;</span><br><span class="line">               <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ID_ATTRIBUTE = <span class="string">"id"</span>;</span><br><span class="line">               <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME_ATTRIBUTE = <span class="string">"name"</span>;</span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">	AbstractBeanDefinition definition = parseInternal(element, parserContext); <span class="comment">//子类实现解析bd</span></span><br><span class="line">	<span class="keyword">if</span> (definition != <span class="keyword">null</span> &amp;&amp; !parserContext.isNested()) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">//尝试获得id</span></span><br><span class="line">			String id = resolveId(element, definition, parserContext);</span><br><span class="line">			<span class="keyword">if</span> (!StringUtils.hasText(id)) &#123;</span><br><span class="line">				parserContext.getReaderContext().error(</span><br><span class="line">						<span class="string">"Id is required for element '"</span> + parserContext.getDelegate().getLocalName(element)</span><br><span class="line">								+ <span class="string">"' when used as a top-level tag"</span>, element);</span><br><span class="line">			&#125;</span><br><span class="line">               <span class="comment">//别名</span></span><br><span class="line">			String[] aliases = <span class="keyword">null</span>;</span><br><span class="line">			<span class="keyword">if</span> (shouldParseNameAsAliases()) &#123;</span><br><span class="line">				String name = element.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">				<span class="keyword">if</span> (StringUtils.hasLength(name)) &#123;</span><br><span class="line">					aliases = StringUtils.trimArrayElements(StringUtils.commaDelimitedListToStringArray(name));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">               <span class="comment">//注册</span></span><br><span class="line">			BeanDefinitionHolder holder = <span class="keyword">new</span> BeanDefinitionHolder(definition, id, aliases);</span><br><span class="line">			registerBeanDefinition(holder, parserContext.getRegistry());</span><br><span class="line">			<span class="keyword">if</span> (shouldFireEvents()) &#123; <span class="comment">//抽象类流出的接口</span></span><br><span class="line">				BeanComponentDefinition componentDefinition = <span class="keyword">new</span> BeanComponentDefinition(holder);</span><br><span class="line">				postProcessComponentDefinition(componentDefinition);</span><br><span class="line">				parserContext.registerComponent(componentDefinition);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">			String msg = ex.getMessage();</span><br><span class="line">			parserContext.getReaderContext().error((msg != <span class="keyword">null</span> ? msg : ex.toString()), element);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> definition;</span><br><span class="line">&#125;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>AbstractSingleBeanDefinitionParser</p>
<p>该类表示此标签仅仅创建一个bd,例如<code>&lt;context:property-placeholder</code>的结果</p>
  <figure class="highlight java"><figcaption><span>AbstractSingleBeanDefinitionParser</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> AbstractBeanDefinition <span class="title">parseInternal</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//bdBuidler用来创建bd,这里的getXX都是子类实现的</span></span><br><span class="line">	BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition();</span><br><span class="line">	String parentName = getParentName(element);<span class="comment">//子类获取</span></span><br><span class="line">	<span class="keyword">if</span> (parentName != <span class="keyword">null</span>) &#123;</span><br><span class="line">		builder.getRawBeanDefinition().setParentName(parentName);</span><br><span class="line">	&#125;</span><br><span class="line">	Class&lt;?&gt; beanClass = getBeanClass(element);</span><br><span class="line">	<span class="keyword">if</span> (beanClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">		builder.getRawBeanDefinition().setBeanClass(beanClass);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		String beanClassName = getBeanClassName(element);</span><br><span class="line">		<span class="keyword">if</span> (beanClassName != <span class="keyword">null</span>) &#123;</span><br><span class="line">			builder.getRawBeanDefinition().setBeanClassName(beanClassName);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	builder.getRawBeanDefinition().setSource(parserContext.extractSource(element));</span><br><span class="line">	BeanDefinition containingBd = parserContext.getContainingBeanDefinition();</span><br><span class="line">	<span class="keyword">if</span> (containingBd != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// Inner bean definition must receive same scope as containing bean.</span></span><br><span class="line">		builder.setScope(containingBd.getScope());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (parserContext.isDefaultLazyInit()) &#123;</span><br><span class="line">		<span class="comment">// Default-lazy-init applies to custom bean definitions as well.</span></span><br><span class="line">		builder.setLazyInit(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	doParse(element, parserContext, builder); <span class="comment">//再添加一些必要的属性</span></span><br><span class="line">	<span class="keyword">return</span> builder.getBeanDefinition();<span class="comment">//构建bd</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">       </span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h5 id="xml-和-注解实现的一些区别"><a class="header-anchor" href="#xml-和-注解实现的一些区别">¶</a>xml 和 注解实现的一些区别</h5>
<ul>
<li>单纯使用xml的话,gbd创建会包含所有的信息,如pvs,各种ioc属性</li>
<li>注解的话很多都要进行后处理器来处理
<ul>
<li>name一个String类型  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></span><br><span class="line">  zhangsan</span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>注解实现<br>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"张三"</span>)</span><br><span class="line"><span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure></li>
<li>前者会在为gbd#pvs,后者必须经过AutowiredAnnotationBeanPostProcessor(@AutoWire,@Value,@Inject)处理</li>
</ul>
</li>
</ul>
<h4 id="BeanDefinition"><a class="header-anchor" href="#BeanDefinition">¶</a>BeanDefinition</h4>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/RootBeanDetinition.png" class="" title="RootBeanDetinition">
<p>spring常见的接口设计模式:</p>
<ul>
<li>RootBeanDetinition实质是一个AttributeAccessor和BeanDefinition</li>
<li>属于AttributeAccessor的部分由父类BeanMetadataAttributeAccessor实现</li>
<li>AttributeAccessor:该接口定义如何访问源信息中的属性,在Bd体系中,通过 ‘BeanMetadataAttribut’,作为meta 原信息体现key-value
<ul>
<li>AttributeAccessor<figure class="highlight java"><figcaption><span>AttributeAccessor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAttribute</span><span class="params">(String name, @Nullable Object value)</span></span>;</span><br><span class="line">    <span class="function">Object <span class="title">getAttribute</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function">Object <span class="title">removeAttribute</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasAttribute</span><span class="params">(String name)</span></span>;</span><br><span class="line">    String[] attributeNames();</span><br><span class="line">      </span><br></pre></td></tr></table></figure>
</li>
<li>AttributeAccessorSupport<figure class="highlight java"><figcaption><span>AttributeAccessorSupport</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//该map就是属性储存的位置,在该体系中,此map表示的是bean的一些附加信息,跟属性无关</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; attributes = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttribute</span><span class="params">(String name, @Nullable Object value)</span> </span>&#123;</span><br><span class="line">    Assert.notNull(name, <span class="string">"Name must not be null"</span>);</span><br><span class="line">    <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.attributes.put(name, value);</span><br><span class="line">    &#125;:</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        removeAttribute(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
</li>
<li>BeanMetadataAttributeAccessor<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/BeanMetadataAttributeAccessor.png" class="">
<figure class="highlight java"><figcaption><span>BeanMetadataAttributeAccessor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">//包含了要进行配置的对象</span></span><br><span class="line">      <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanMetadataElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the configuration source &#123;<span class="doctag">@code</span> Object&#125; for this metadata element</span></span><br><span class="line"><span class="comment">     * (may be &#123;<span class="doctag">@code</span> null&#125;).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">Object <span class="title">getSource</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">* Holder <span class="keyword">for</span> a key-value style attribute that is part of a bean definition.</span><br><span class="line">* Keeps track of the definition source in addition to the key-value pair.</span><br><span class="line">*</span><br><span class="line">* <span class="meta">@author</span> Juergen Hoeller</span><br><span class="line">* <span class="meta">@since</span> <span class="number">2.5</span></span><br><span class="line">*/</span><br><span class="line"><span class="comment">//包含了source中一个属性的键值对,可以理解为pair</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanMetadataAttribute</span> <span class="keyword">implements</span> <span class="title">BeanMetadataElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> Object value;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line"> <span class="keyword">private</span> Object source;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Extension of &#123;<span class="doctag">@link</span> org.springframework.core.AttributeAccessorSupport&#125;,</span></span><br><span class="line"><span class="comment"> * holding attributes as &#123;<span class="doctag">@link</span> BeanMetadataAttribute&#125; objects in order</span></span><br><span class="line"><span class="comment"> * to keep track of the definition source.</span></span><br><span class="line"><span class="comment"> * 该类用来访问source中属性,属性由BeanMetaDataAttribute包装</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"serial"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanMetadataAttributeAccessor</span> <span class="keyword">extends</span> <span class="title">AttributeAccessorSupport</span> <span class="keyword">implements</span> <span class="title">BeanMetadataElement</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">      <span class="keyword">private</span> Object source;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Set the configuration source &#123;<span class="doctag">@code</span> Object&#125; for this metadata element.</span></span><br><span class="line"><span class="comment">       * &lt;p&gt;The exact type of the object will depend on the configuration mechanism used.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSource</span><span class="params">(@Nullable Object source)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.source = source;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="meta">@Nullable</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">getSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.source;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Add the given BeanMetadataAttribute to this accessor's set of attributes.</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@param</span> attribute the BeanMetadataAttribute object to register</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMetadataAttribute</span><span class="params">(BeanMetadataAttribute attribute)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">super</span>.setAttribute(attribute.getName(), attribute);</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line">      </span><br></pre></td></tr></table></figure>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/ScannedGenericBeanDefinition.png" class="">
此时的source用来说明bd的来源,该类型会在注册到<code>BeanFactory</code>时被转换为<code>RootBeanDefintion</code>类型<br>
图中propertyValues,是xml处理<propery>时添加的字面属性,在ioc过程中pvs要经过类型转换,以及各种处理器.</li>
</ul>
</li>
<li>BeanDefinition:该接口实质是描述了springBean配置</li>
<li>常见子类ScannedGenericBeanDefinition和GenericBeanDefinition  <figure class="highlight java"><figcaption><span>BeanDefinition</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setScope</span><span class="params">(@Nullable String scope)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setLazyInit</span><span class="params">(<span class="keyword">boolean</span> lazyInit)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setDependsOn</span><span class="params">(@Nullable String... dependsOn)</span></span>;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="BeanWrapper"><a class="header-anchor" href="#BeanWrapper">¶</a>BeanWrapper</h4>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/BeanWrapper.png" class="" title="BeanWrapper">
<ul>
<li>PropertyEditorRegistry 和 TypeConverter组成属性转换器</li>
</ul>
<h5 id="属性类型转换"><a class="header-anchor" href="#属性类型转换">¶</a>属性类型转换</h5>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/Property.png" class="" title="PropertyEditorRegistry">
<ul>
<li>
<p>PropertyEditor是jdk提供的接口,用来进行属性类型转换的</p>
  <figure class="highlight java"><figcaption><span>PropertyEditor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PropertyEditor</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">setValue</span><span class="params">(Object value)</span></span>;</span><br><span class="line">        <span class="comment">//将转递的stirng类型进行转换</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">setAsText</span><span class="params">(String text)</span> <span class="keyword">throws</span> java.lang.IllegalArgumentException</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//一般继承该接口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyEditorSupport</span> <span class="keyword">implements</span> <span class="title">PropertyEditor</span> </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> Object value;</span><br><span class="line">      <span class="keyword">private</span> Object source;</span><br><span class="line">      <span class="keyword">private</span> java.util.Vector&lt;PropertyChangeListener&gt; listeners;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">PropertyEditorSupport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      setSource(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">PropertyEditorSupport</span><span class="params">(Object source)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (source == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">      &#125;</span><br><span class="line">      setSource(source);</span><br><span class="line">  &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//spirng中的一个实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteArrayPropertyEditor</span> <span class="keyword">extends</span> <span class="title">PropertyEditorSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAsText</span><span class="params">(@Nullable String text)</span> </span>&#123;</span><br><span class="line">        setValue(text != <span class="keyword">null</span> ? text.getBytes() : <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAsText</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] value = (<span class="keyword">byte</span>[]) getValue();</span><br><span class="line">        <span class="keyword">return</span> (value != <span class="keyword">null</span> ? <span class="keyword">new</span> String(value) : <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;    </span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>PropertyEditor使用</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.当类型String-&gt;Type转换</span></span><br><span class="line"><span class="comment">//调用setText()</span></span><br><span class="line"><span class="comment">//2.当其他类型-&gt;Type</span></span><br><span class="line"><span class="comment">//调用setValue()</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>PropertyEditorRegistrySupport使用Map存储PropertyEditor</p>
  <figure class="highlight java"><figcaption><span>PropertyEditorRegistrySupport</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyEditorRegistrySupport</span> <span class="keyword">implements</span> <span class="title">PropertyEditorRegistry</span> </span>&#123;</span><br><span class="line"><span class="comment">//spring 实现的类型转换器,先略过    </span></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">private</span> ConversionService conversionService;</span><br><span class="line"><span class="comment">//默认的类型转换器</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;Class&lt;?&gt;, PropertyEditor&gt; defaultEditors;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createDefaultEditors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.defaultEditors.put(Charset<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">CharsetEditor</span>())</span>;</span><br><span class="line">      <span class="keyword">this</span>.defaultEditors.put(Class<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">ClassEditor</span>())</span>;</span><br><span class="line">      <span class="keyword">this</span>.defaultEditors.put(Class[]<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">ClassArrayEditor</span>())</span>;</span><br><span class="line">  <span class="comment">//....添加了大量的类型转换器</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
</li>
<li>
<p>TypeConverterDelegate作为委托模式用来真正处理类型转换</p>
  <figure class="highlight java"><figcaption><span>TypeConverterSupport</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeConverterSupport</span> <span class="keyword">extends</span> <span class="title">PropertyEditorRegistrySupport</span> <span class="keyword">implements</span> <span class="title">TypeConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    TypeConverterDelegate typeConverterDelegate;</span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">convertIfNecessary</span><span class="params">(@Nullable Object value, @Nullable Class&lt;T&gt; requiredType,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable TypeDescriptor typeDescriptor)</span> <span class="keyword">throws</span> TypeMismatchException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.typeConverterDelegate.convertIfNecessary(<span class="keyword">null</span>, <span class="keyword">null</span>, value, requiredType,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//委托逻辑</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TypeConverterDelegate</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  *  propertyName 表示属性名</span></span><br><span class="line"><span class="comment">  *  oldValue 表示旧值,若该函数是pvs设值时调用一般是null</span></span><br><span class="line"><span class="comment">  *  newValue 表示此次要设置的值,也是要处理进行类型 转换的值</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">convertIfNecessary</span><span class="params">(@Nullable String propertyName, @Nullable Object oldValue, @Nullable Object newValue,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable Class&lt;T&gt; requiredType, @Nullable TypeDescriptor typeDescriptor)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Custom editor for this type?</span></span><br><span class="line"><span class="comment">//获取自定义的属性编辑器</span></span><br><span class="line">PropertyEditor editor = <span class="keyword">this</span>.propertyEditorRegistry.findCustomEditor(requiredType, propertyName);</span><br><span class="line"></span><br><span class="line">ConversionFailedException conversionAttemptEx = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// No custom editor but custom ConversionService specified?</span></span><br><span class="line"><span class="comment">// 尝试使用ConversionService进行转换</span></span><br><span class="line">ConversionService conversionService = <span class="keyword">this</span>.propertyEditorRegistry.getConversionService();</span><br><span class="line"><span class="keyword">if</span> (editor == <span class="keyword">null</span> &amp;&amp; conversionService != <span class="keyword">null</span> &amp;&amp; newValue != <span class="keyword">null</span> &amp;&amp; typeDescriptor != <span class="keyword">null</span>) &#123;</span><br><span class="line">TypeDescriptor sourceTypeDesc = TypeDescriptor.forObject(newValue);</span><br><span class="line"><span class="keyword">if</span> (conversionService.canConvert(sourceTypeDesc, typeDescriptor)) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (T) conversionService.convert(newValue, sourceTypeDesc, typeDescriptor);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (ConversionFailedException ex) &#123;</span><br><span class="line">    <span class="comment">// fallback to default conversion logic below</span></span><br><span class="line">    conversionAttemptEx = ex;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Object convertedValue = newValue;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Value not of required type?</span></span><br><span class="line"><span class="keyword">if</span> (editor != <span class="keyword">null</span> || (requiredType != <span class="keyword">null</span> &amp;&amp; !ClassUtils.isAssignableValue(requiredType, convertedValue))) &#123; <span class="comment">//没有自定义编辑器或者 不能直接分配(即newValue需要进行向requiredType的转换)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (typeDescriptor != <span class="keyword">null</span> &amp;&amp; requiredType != <span class="keyword">null</span> &amp;&amp; Collection<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">requiredType</span>) &amp;&amp;</span></span><br><span class="line"><span class="class">    <span class="title">convertedValue</span> <span class="title">instanceof</span> <span class="title">String</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//此处代码逻辑 是 当属性为Collection&lt;Class&gt;|Collection&lt;Eunm&gt; 时,可以将该字符串当作CSV转化    </span></span><br><span class="line">  TypeDescriptor elementTypeDesc = typeDescriptor.getElementTypeDescriptor();</span><br><span class="line">  <span class="keyword">if</span> (elementTypeDesc != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Class&lt;?&gt; elementType = elementTypeDesc.getType();</span><br><span class="line">    <span class="keyword">if</span> (Class<span class="class">.<span class="keyword">class</span> </span>== elementType || Enum<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">elementType</span>)) </span>&#123;</span><br><span class="line">      convertedValue = StringUtils.commaDelimitedListToStringArray((String) convertedValue);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (editor == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="comment">// 根据requiredType从map中获取对应的propertyEditor</span></span><br><span class="line">  editor = findDefaultEditor(requiredType);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//进行转换</span></span><br><span class="line">convertedValue = doConvertValue(oldValue, convertedValue, requiredType, editor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> standardConversion = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//....下边的逻辑是对于不能直接适配的情况,进一步的标准处理</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/doConvertValue.png" class="" title="doConvertValue">
<figure class="highlight java"><figcaption><span>doConvertValue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实际转换逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">doConvertValue</span><span class="params">(@Nullable Object oldValue, @Nullable Object newValue,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable Class&lt;?&gt; requiredType, @Nullable PropertyEditor editor)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Object convertedValue = newValue;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (editor != <span class="keyword">null</span> &amp;&amp; !(convertedValue <span class="keyword">instanceof</span> String)) &#123;</span><br><span class="line">      <span class="comment">//一般来说spring基本都是将string类型进行转换,但是如果此处的value并不是String,</span></span><br><span class="line">      <span class="comment">//那么就要调用PropertyEditor的setValue进行转换,然后再get出来,这个set逻辑要</span></span><br><span class="line">      <span class="comment">//用户自己实现,或者spring内部提供了对应的转换器</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                editor.setValue(convertedValue);</span><br><span class="line">                Object newConvertedValue = editor.getValue();</span><br><span class="line">                <span class="keyword">if</span> (newConvertedValue != convertedValue) &#123;</span><br><span class="line">                    convertedValue = newConvertedValue;</span><br><span class="line">                    <span class="comment">// Reset PropertyEditor: It already did a proper conversion.</span></span><br><span class="line">                    <span class="comment">// Don't use it again for a setAsText call.</span></span><br><span class="line">                    editor = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">"PropertyEditor ["</span> + editor.getClass().getName() + <span class="string">"] does not support setValue call"</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Swallow and proceed.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object returnValue = convertedValue;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; !requiredType.isArray() &amp;&amp; convertedValue <span class="keyword">instanceof</span> String[]) &#123;</span><br><span class="line">          <span class="comment">//若转换类型不为数组,并且给定的value为String数组,则将value转为成CVS</span></span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(<span class="string">"Converting String array to comma-delimited String ["</span> + convertedValue + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            convertedValue = StringUtils.arrayToCommaDelimitedString((String[]) convertedValue);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//若经过上述两操作,cV还是String,那么就可以执行Text类型转换</span></span><br><span class="line">        <span class="keyword">if</span> (convertedValue <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="keyword">if</span> (editor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Use PropertyEditor's setAsText in case of a String value.</span></span><br><span class="line">                <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                    logger.trace(<span class="string">"Converting String to ["</span> + requiredType + <span class="string">"] using property editor ["</span> + editor + <span class="string">"]"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                String newTextValue = (String) convertedValue;</span><br><span class="line">                <span class="keyword">return</span> doConvertTextValue(oldValue, newTextValue, editor);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (String<span class="class">.<span class="keyword">class</span> </span>== requiredType) &#123;</span><br><span class="line">                returnValue = convertedValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Object <span class="title">doConvertTextValue</span><span class="params">(@Nullable Object oldValue, String newTextValue, PropertyEditor editor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            editor.setValue(oldValue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"PropertyEditor ["</span> + editor.getClass().getName() + <span class="string">"] does not support setValue call"</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Swallow and proceed.</span></span><br><span class="line">        &#125;</span><br><span class="line">        editor.setAsText(newTextValue);</span><br><span class="line">        <span class="keyword">return</span> editor.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">      </span><br></pre></td></tr></table></figure>
<ul>
<li>例子</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Sub sub;</span><br><span class="line">    <span class="keyword">private</span> List list;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;test&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;  <span class="comment">//不需要转换,$&#123;test&#125;从ev中获取</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"D:/1.txt"</span>)    </span><br><span class="line">    <span class="keyword">private</span> File file;    <span class="comment">//通过FileEditor 转换</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"1,2,3,4"</span>)</span><br><span class="line">    <span class="keyword">private</span> String[] test2; <span class="comment">//通过StringArrayEditor 直接转换</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"I:/BaiduNetdisk/api-ms-win-core-console-l1-1-0.dll,I:/BaiduNetdisk/api-ms-win-core-datetime-l1-1-0.dll"</span>)</span><br><span class="line">    <span class="keyword">private</span> List&lt;File&gt; files; <span class="comment">//先通过CustomCollectionEditor ,再通过FileEditor转换</span></span><br><span class="line">    <span class="comment">//但是默认情况下,这个转换器并不能正确处理这种类型</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//private File[] files   //没有该类型转换器</span></span><br></pre></td></tr></table></figure>
<p>这里描述一下非基础类型数组|集合转换逻辑<br>
convertIfNecessary-&gt;判断能否进行CVS处理,如果不行则执行CustomCollectionEditor转换,结果是一个<br>
单个 元素list,后续逻辑中 进行遍历,再调用convertIfNecessary,那么结果一定是错的.</p>
<ul>
<li>添加自定义编辑器<br>
通过CustomEditorConfigurer实现,这是一个BF_post</li>
</ul>
<h3 id="spring-post处理器"><a class="header-anchor" href="#spring-post处理器">¶</a>spring_post处理器</h3>
<ul>
<li>BeanPostProcessor</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MergedBeanDefinitionPostProcessor</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MergedBeanDefinitionPostProcessor</span> <span class="keyword">extends</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">postProcessMergedBeanDefinition</span><span class="params">(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">resetBeanDefinition</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>InstantiationAwareBeanPostProcessor</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InstantiationAwareBeanPostProcessor</span> <span class="keyword">extends</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">postProcessAfterInstantiation</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> PropertyValues <span class="title">postProcessProperties</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Instantiation表示实例化,即ioc反射创建BeanWrap;Initialization表示初始化,指ioc对于bean的init逻辑,如init-method</li>
<li>SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReference发生在早期引用获取过程</li>
<li>具体执行顺序参考<a href="/2019/05/21/ioc/#%E5%85%B3%E4%BA%8E%E5%8D%95%E4%BE%8Bbean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%92%8C%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98">生命周期</a></li>
</ul>
<h3 id="LTW"><a class="header-anchor" href="#LTW">¶</a>LTW</h3>
<p>载入时织入,使用方式参考<a href="https://www.w3xue.com/exp/article/20189/1890.html" target="_blank" rel="noopener">LTW</a>,</p>
<ul>
<li>由<code>LoadTimeWeaverBeanDefinitionParser</code>创建<code>AspectJWeavingEnabler</code>以及<code>DefaultContextLoadTimeWeaver</code></li>
</ul>
<h3 id="MessageSource"><a class="header-anchor" href="#MessageSource">¶</a>MessageSource</h3>
<p>该接口是spring提供的和i18n相关的基础类,使用起来并不复杂</p>
<ul>
<li>
<p>ResourceBulde:jdk实现的国际化类,也是messageSource的内部原理</p>
<ul>
<li>准备多种语言properties文件<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/%E5%A4%9A%E8%AF%AD%E8%A8%80.png" class="">
error.properties<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0000=error</span><br><span class="line">0001=info</span><br></pre></td></tr></table></figure>
error_zh.Properties<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0000=错误</span><br><span class="line">test=this is a &#123;0&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>使用<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据Local获取不同的ResourceBulde</span></span><br><span class="line">ResourceBundle resourceBundle = ResourceBundle.getBundle(<span class="string">"error"</span>,Locale.getDefault());</span><br><span class="line">String zh_test = resourceBundle.getString(<span class="string">"test"</span>)</span><br><span class="line"><span class="comment">//this is a &#123;0&#125;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>MessageFormat:jdk提供用来替换占位符的工具类</p>
<ul>
<li>接上文<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MessageFormat messageFormat = <span class="keyword">new</span> MessageFormat(zh_test);</span><br><span class="line">messageFormat.format(<span class="keyword">new</span> String[]&#123;<span class="string">"测试"</span>&#125;)</span><br><span class="line"><span class="comment">//静态调用</span></span><br><span class="line">MessageFormat.format(<span class="string">"this is a &#123;0&#125;"</span>,<span class="string">"测试"</span>)</span><br><span class="line"><span class="comment">//结果都是 this is a 测试</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>MessageSource</p>
<ul>
<li>定义<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* code 表示要转换的key,如上文的0000,test</span></span><br><span class="line"><span class="comment">* args 表示可以替换的占位符,如MessageFormat.format("this is a &#123;0&#125;",new String[]&#123;"测试"&#125;)第二个参数</span></span><br><span class="line"><span class="comment">* defaultMessage 表示未能匹配时返回的默认值</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">String <span class="title">getMessage</span><span class="params">(String code, @Nullable Object[] args, @Nullable String defaultMessage, Locale locale)</span></span>;</span><br><span class="line"><span class="comment">//无默认,不匹配则抛出异常</span></span><br><span class="line"><span class="function">String <span class="title">getMessage</span><span class="params">(String code, @Nullable Object[] args, Locale locale)</span> <span class="keyword">throws</span> NoSuchMessageException</span>;</span><br><span class="line"><span class="comment">//MessageSourceResolvable仅仅是封装了第一个函数的前三个参数</span></span><br><span class="line"><span class="function">String <span class="title">getMessage</span><span class="params">(MessageSourceResolvable resolvable, Locale locale)</span> <span class="keyword">throws</span> NoSuchMessageException</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>使用<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ResourceBundleMessageSource是spring提供的实现之一</span></span><br><span class="line">ResourceBundleMessageSource messageSource = <span class="keyword">new</span> ResourceBundleMessageSource();</span><br><span class="line"><span class="comment">//设置properties</span></span><br><span class="line">messageSource.setBasename(<span class="string">"error"</span>);</span><br><span class="line">messageSource.setDefaultEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">String message = messageSource.getMessage(<span class="string">"0001"</span>, <span class="keyword">null</span>, Locale.ENGLISH);</span><br><span class="line">System.out.println(message);</span><br><span class="line"><span class="comment">//error</span></span><br><span class="line">String str1 = messageSource.getMessage(<span class="string">"test"</span>,<span class="keyword">new</span> String[]&#123;<span class="string">"测试"</span>&#125;,Locale.CHINESE);</span><br><span class="line">System.out.println(str1);</span><br><span class="line"><span class="comment">//this is a 测试</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="spring框架中提供的特殊调用点"><a class="header-anchor" href="#spring框架中提供的特殊调用点">¶</a>spring框架中提供的特殊调用点</h3>
<h4 id="spring-web关于web容器的初始化"><a class="header-anchor" href="#spring-web关于web容器的初始化">¶</a>spring web关于web容器的初始化</h4>
<ul>
<li>web相关:参考<a href="/2019/02/19/SpringMVC%E6%BA%90%E7%A0%81/#dispatcherServlet">dispatcherServlet</a>
<ul>
<li>ContextLoaderListener:初始化MVC中ioc容器</li>
<li>SpringServletContainerInitializer:ServletContainerInitializer框架</li>
<li>WebApplicationInitializer:web初始化实际调用接口</li>
</ul>
</li>
<li>MVC相关
<ul>
<li>WebMvcConfigurer:MVC内部的设置</li>
</ul>
</li>
<li>spring context
<ul>
<li>ApplicationContextInitializer:该接口被context#refresh的调用|或context创建者调用<br>
,就是整体项目的入口,如SpringApplication | FrameworkServlet<br>
,就是整体项目的入口,如SpringApplication | FrameworkServlet</li>
</ul>
</li>
</ul>
<h3 id="springIo"><a class="header-anchor" href="#springIo">¶</a>springIo</h3>
<h4 id="resource接口"><a class="header-anchor" href="#resource接口">¶</a>resource接口</h4>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/resource.png" class="">
<figure class="highlight java"><figcaption><span>Resource</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Resource</span> <span class="keyword">extends</span> <span class="title">InputStreamSource</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">exists</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">isReadable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exists();</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">isOpen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">isFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function">URL <span class="title">getURL</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="function">URI <span class="title">getURI</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="function">File <span class="title">getFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> ReadableByteChannel <span class="title">readableChannel</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Channels.newChannel(getInputStream());</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function"><span class="keyword">long</span> <span class="title">contentLength</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="function"><span class="keyword">long</span> <span class="title">lastModified</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="function">Resource <span class="title">createRelative</span><span class="params">(String relativePath)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="function">String <span class="title">getFilename</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function">String <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<h5 id="ResolvingResource"><a class="header-anchor" href="#ResolvingResource">¶</a>ResolvingResource</h5>
<p>这种资源表示从url中获取,支持http协议,file,jboss的vfs协议</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">exists</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url = getURL();</span><br><span class="line">            <span class="keyword">if</span> (ResourceUtils.isFileURL(url)) &#123; <span class="comment">//file: vfs协议</span></span><br><span class="line">                <span class="comment">// Proceed with file system resolution</span></span><br><span class="line">                <span class="keyword">return</span> getFile().exists();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123; <span class="comment">//http协议</span></span><br><span class="line">                <span class="comment">// Try a URL connection content-length header</span></span><br><span class="line">                URLConnection con = url.openConnection();</span><br><span class="line">                customizeConnection(con);</span><br><span class="line">                HttpURLConnection httpCon =</span><br><span class="line">                        (con <span class="keyword">instanceof</span> HttpURLConnection ? (HttpURLConnection) con : <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (httpCon != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> code = httpCon.getResponseCode();</span><br><span class="line">                    <span class="keyword">if</span> (code == HttpURLConnection.HTTP_OK) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (code == HttpURLConnection.HTTP_NOT_FOUND) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (con.getContentLength() &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (httpCon != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// No HTTP OK status, and no content-length header: give up</span></span><br><span class="line">                    httpCon.disconnect();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Fall back to stream existence: can we open the stream?</span></span><br><span class="line">                    getInputStream().close();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ClassPathResource</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        InputStream is;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            is = <span class="keyword">this</span>.clazz.getResourceAsStream(<span class="keyword">this</span>.path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            is = <span class="keyword">this</span>.classLoader.getResourceAsStream(<span class="keyword">this</span>.path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            is = ClassLoader.getSystemResourceAsStream(<span class="keyword">this</span>.path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(getDescription() + <span class="string">" cannot be opened because it does not exist"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> is;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PathResource和FileSystemResource实现,都是依托了nio实现</li>
</ul>
<h5 id="HttpResource"><a class="header-anchor" href="#HttpResource">¶</a>HttpResource</h5>
<p>这里Resource使用在<code>ResourceHttpRequestHandler</code>类中处理web请求静态资源的时候用来附件响应头</p>
<h5 id="ContextResouce"><a class="header-anchor" href="#ContextResouce">¶</a>ContextResouce</h5>
<p>表示从封闭的<code>context</code>中获取资源,典型的就是<code>ServletContext</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ContextResource</span> <span class="keyword">extends</span> <span class="title">Resource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the path within the enclosing 'context'.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This is typically path relative to a context-specific root directory,</span></span><br><span class="line"><span class="comment">     * e.g. a ServletContext root or a PortletContext root.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getPathWithinContext</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ServletCOntextResouce"><a class="header-anchor" href="#ServletCOntextResouce">¶</a>ServletCOntextResouce</h6>
<p>直接从<code>ServletContext</code>中获取资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        InputStream is = <span class="keyword">this</span>.servletContext.getResourceAsStream(<span class="keyword">this</span>.path);</span><br><span class="line">        <span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">"Could not open "</span> + getDescription());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> is;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="ResouceLoader"><a class="header-anchor" href="#ResouceLoader">¶</a>ResouceLoader</h4>
<p>用来加载Resource资源的support</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Resource <span class="title">getResource</span><span class="params">(String location)</span></span>;</span><br><span class="line"><span class="function">ClassLoader <span class="title">getClassLoader</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>支持全路径:<code>file:C:/test.dat</code></li>
<li>支持类路径:<code>classpath:test.dat</code></li>
<li>支持相对路径:<code>WEB-INF/test.dat</code></li>
</ul>
<img src="/2020/02/11/spring%E5%B8%B8%E8%A7%81/resourceLoader.png" class="">
<p>实现中把context排除,那是包装类实现</p>
<h5 id="DefaultResourceLoader"><a class="header-anchor" href="#DefaultResourceLoader">¶</a>DefaultResourceLoader</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Resource <span class="title">getResource</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(location, <span class="string">"Location must not be null"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ProtocolResolver protocolResolver : <span class="keyword">this</span>.protocolResolvers) &#123; <span class="comment">//这是一个spi实现,spring默认没有实现</span></span><br><span class="line">            Resource resource = protocolResolver.resolve(location, <span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> resource;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//[1]ClassPathResource</span></span><br><span class="line">        <span class="keyword">if</span> (location.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> getResourceByPath(location); <span class="comment">//这个函数交由子类实现</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (location.startsWith(CLASSPATH_URL_PREFIX)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ClassPathResource(location.substring(CLASSPATH_URL_PREFIX.length()), getClassLoader());</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//[1!]</span></span><br><span class="line">    <span class="comment">//[2]UrlResource</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Try to parse the location as a URL...</span></span><br><span class="line">                URL url = <span class="keyword">new</span> URL(location);</span><br><span class="line">                <span class="keyword">return</span> (ResourceUtils.isFileURL(url) ? <span class="keyword">new</span> FileUrlResource(url) : <span class="keyword">new</span> UrlResource(url));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (MalformedURLException ex) &#123;</span><br><span class="line">                <span class="comment">// No URL -&gt; resolve as resource path.</span></span><br><span class="line">                <span class="keyword">return</span> getResourceByPath(location);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//[2!]</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//当资源以/开头时就会调用子类实现</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Resource <span class="title">getResourceByPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ClassPathContextResource(path, getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassPathContextResource</span> <span class="keyword">extends</span> <span class="title">ClassPathResource</span> <span class="keyword">implements</span> <span class="title">ContextResource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ClassPathContextResource</span><span class="params">(String path, @Nullable ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(path, classLoader);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPathWithinContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> getPath();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Resource <span class="title">createRelative</span><span class="params">(String relativePath)</span> </span>&#123;</span><br><span class="line">            String pathToUse = StringUtils.applyRelativePath(getPath(), relativePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ClassPathContextResource(pathToUse, getClassLoader());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>总结
<ul>
<li>若使用url则返回<code>UrlResource</code></li>
<li>若使用&quot;classpath:&quot;则返回<code>ClassPathResource</code></li>
<li>若使用&quot;/&quot;开头则调用<code>getResourceByPath</code>,由具体实现决定</li>
<li>该体系内部都是实现了一个<code>ContextResouce</code>的<code>Resource</code></li>
</ul>
</li>
</ul>
<h6 id="ClassRelativeResourceLoader"><a class="header-anchor" href="#ClassRelativeResourceLoader">¶</a>ClassRelativeResourceLoader</h6>
<ul>
<li>代码逻辑</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; clazz;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new ClassRelativeResourceLoader for the given class.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz the class to load resources through</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassRelativeResourceLoader</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(clazz, <span class="string">"Class must not be null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.clazz = clazz;</span><br><span class="line">        setClassLoader(clazz.getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Resource <span class="title">getResourceByPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ClassRelativeContextResource(path, <span class="keyword">this</span>.clazz); <span class="comment">//实际返回一个内部类</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ClassPathResource that explicitly expresses a context-relative path</span></span><br><span class="line"><span class="comment">     * through implementing the ContextResource interface.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassRelativeContextResource</span> <span class="keyword">extends</span> <span class="title">ClassPathResource</span> <span class="keyword">implements</span> <span class="title">ContextResource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; clazz;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ClassRelativeContextResource</span><span class="params">(String path, Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(path, clazz);</span><br><span class="line">            <span class="keyword">this</span>.clazz = clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPathWithinContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> getPath();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Resource <span class="title">createRelative</span><span class="params">(String relativePath)</span> </span>&#123;</span><br><span class="line">            String pathToUse = StringUtils.applyRelativePath(getPath(), relativePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ClassRelativeContextResource(pathToUse, <span class="keyword">this</span>.clazz);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>总结:开头为&quot;/&quot;返回classpath下文件</li>
</ul>
<h6 id="FileSystemResourceLoader"><a class="header-anchor" href="#FileSystemResourceLoader">¶</a>FileSystemResourceLoader</h6>
<ul>
<li>代码逻辑</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSystemResourceLoader</span> <span class="keyword">extends</span> <span class="title">DefaultResourceLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Resource <span class="title">getResourceByPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (path.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">            path = path.substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FileSystemContextResource(path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSystemContextResource</span> <span class="keyword">extends</span> <span class="title">FileSystemResource</span> <span class="keyword">implements</span> <span class="title">ContextResource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FileSystemContextResource</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPathWithinContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> getPath();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>总结:开头为&quot;/&quot;返回文件系统</li>
</ul>
<h5 id="ResourcePatternResolver"><a class="header-anchor" href="#ResourcePatternResolver">¶</a>ResourcePatternResolver</h5>
<p>支持ant风格进行获取资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourcePatternResolver</span> <span class="keyword">extends</span> <span class="title">ResourceLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Pseudo URL prefix for all matching resources from the class path: "classpath*:"</span></span><br><span class="line"><span class="comment">     * This differs from ResourceLoader's classpath URL prefix in that it</span></span><br><span class="line"><span class="comment">     * retrieves all matching resources for a given name (e.g. "/beans.xml"),</span></span><br><span class="line"><span class="comment">     * for example in the root of all deployed JAR files.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.core.io.ResourceLoader#CLASSPATH_URL_PREFIX</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String CLASSPATH_ALL_URL_PREFIX = <span class="string">"classpath*:"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resolve the given location pattern into Resource objects.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Overlapping resource entries that point to the same physical</span></span><br><span class="line"><span class="comment">     * resource should be avoided, as far as possible. The result should</span></span><br><span class="line"><span class="comment">     * have set semantics.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> locationPattern the location pattern to resolve</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the corresponding Resource objects</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException in case of I/O errors</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Resource[] getResources(String locationPattern) <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="PathMatchingResourcePatternResolver"><a class="header-anchor" href="#PathMatchingResourcePatternResolver">¶</a>PathMatchingResourcePatternResolver</h6>
<ul>
<li>概述
<ul>
<li>支持 占位符,即:‘classpath:’,或者ant风格,’*’,<code>**</code>,<code>?</code></li>
<li>支持协议&quot;file&quot;,“jar”</li>
<li>“classpath*:”,表示从所有类路径下寻找</li>
</ul>
</li>
<li>代码逻辑</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathMatchingResourcePatternResolver</span> <span class="keyword">implements</span> <span class="title">ResourcePatternResolver</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathMatchingResourcePatternResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.resourceLoader = <span class="keyword">new</span> DefaultResourceLoader();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new PathMatchingResourcePatternResolver.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;ClassLoader access will happen via the thread context class loader.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> resourceLoader the ResourceLoader to load root directories and</span></span><br><span class="line"><span class="comment"> * actual resources with</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathMatchingResourcePatternResolver</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(resourceLoader, <span class="string">"ResourceLoader must not be null"</span>);</span><br><span class="line">  <span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new PathMatchingResourcePatternResolver with a DefaultResourceLoader.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classLoader the ClassLoader to load classpath resources with,</span></span><br><span class="line"><span class="comment"> * or &#123;<span class="doctag">@code</span> null&#125; for using the thread context class loader</span></span><br><span class="line"><span class="comment"> * at the time of actual resource access</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.core.io.DefaultResourceLoader</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathMatchingResourcePatternResolver</span><span class="params">(@Nullable ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.resourceLoader = <span class="keyword">new</span> DefaultResourceLoader(classLoader);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//包装类实现</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Resource <span class="title">getResource</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getResourceLoader().getResource(location);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//path匹配实现</span></span><br><span class="line"><span class="keyword">public</span> Resource[] getResources(String locationPattern) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Assert.notNull(locationPattern, <span class="string">"Location pattern must not be null"</span>);</span><br><span class="line">        <span class="keyword">if</span> (locationPattern.startsWith(CLASSPATH_ALL_URL_PREFIX)) &#123; <span class="comment">//匹配classpath*:,即搜索全类路径</span></span><br><span class="line">            <span class="comment">// a class path resource (multiple resources for same name possible)</span></span><br><span class="line">            <span class="keyword">if</span> (getPathMatcher().isPattern(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()))) &#123; <span class="comment">//并非是ant路径即,后边路径中不包含*和?</span></span><br><span class="line">                <span class="comment">// a class path resource pattern</span></span><br><span class="line">                <span class="keyword">return</span> findPathMatchingResources(locationPattern);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// all class path resources with the given name</span></span><br><span class="line">                <span class="keyword">return</span> findAllClassPathResources(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()));<span class="comment">//[2]</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Generally only look for a pattern after a prefix here,</span></span><br><span class="line">            <span class="comment">// and on Tomcat only after the "*/" separator for its "war:" protocol.</span></span><br><span class="line">      <span class="comment">//若无前缀则prefixEnd=0</span></span><br><span class="line">            <span class="keyword">int</span> prefixEnd = (locationPattern.startsWith(<span class="string">"war:"</span>) ? locationPattern.indexOf(<span class="string">"*/"</span>) + <span class="number">1</span> :</span><br><span class="line">                    locationPattern.indexOf(<span class="string">':'</span>) + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (getPathMatcher().isPattern(locationPattern.substring(prefixEnd))) &#123; <span class="comment">//不带classpath*,带ant,带协议头[3]</span></span><br><span class="line">                <span class="comment">// a file pattern</span></span><br><span class="line">                <span class="keyword">return</span> findPathMatchingResources(locationPattern);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123; <span class="comment">//最简单的类型,如com/light/test.class,会通过当前类加载进行加载</span></span><br><span class="line">                <span class="comment">// a single resource with the given name</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Resource[] &#123;getResourceLoader().getResource(locationPattern)&#125;;<span class="comment">//不带classpath*,不带ant,带协议头[4]</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>总结</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">antResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    PathMatchingResourcePatternResolver resolver = <span class="keyword">new</span> PathMatchingResourcePatternResolver();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//[4]</span></span><br><span class="line">        printAllName(resolver.getResources(<span class="string">"aop1.xml"</span>));</span><br><span class="line">        printAllName(resolver.getResources(<span class="string">"classpath:aop1.xml"</span>));</span><br><span class="line">        printAllName(resolver.getResources(<span class="string">"file:aop1.xml"</span>));</span><br><span class="line">        printAllName(resolver.getResources(<span class="string">"java/lang/String.class"</span>));</span><br><span class="line">        printAllName(resolver.getResources(<span class="string">"com/google/protobuf/AbstractMessage.class"</span>));</span><br><span class="line">        <span class="comment">//[3]</span></span><br><span class="line"><span class="comment">//            printAllName(resolver.getResources("com/google/protobuf/*.class"));</span></span><br><span class="line">        <span class="comment">//[2]</span></span><br><span class="line"><span class="comment">//            printAllName(resolver.getResources("classpath*:com/**"));</span></span><br><span class="line">        <span class="comment">//[1]</span></span><br><span class="line">        printAllName(resolver.getResources(<span class="string">"classpath*:com/jcf/Test1.class"</span>));</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printAllName</span><span class="params">(Resource... resources)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(resource.getURL().toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"====================================="</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">file:&#x2F;F:&#x2F;java&#x2F;example&#x2F;app&#x2F;springTest&#x2F;target&#x2F;test-classes&#x2F;aop1.xml</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">file:&#x2F;F:&#x2F;java&#x2F;example&#x2F;app&#x2F;springTest&#x2F;target&#x2F;test-classes&#x2F;aop1.xml</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">file:aop1.xml</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">jrt:&#x2F;java.base&#x2F;java&#x2F;lang&#x2F;String.class</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">jar:file:&#x2F;C:&#x2F;Users&#x2F;fancylight&#x2F;.m2&#x2F;repository&#x2F;com&#x2F;google&#x2F;protobuf&#x2F;protobuf-java&#x2F;2.6.0&#x2F;protobuf-java-2.6.0.jar!&#x2F;com&#x2F;google&#x2F;protobuf&#x2F;AbstractMessage.class</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">file:&#x2F;F:&#x2F;java&#x2F;example&#x2F;app&#x2F;jcf&#x2F;target&#x2F;classes&#x2F;com&#x2F;jcf&#x2F;Test1.class</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>
<ul>
<li>实际上<code>xx:</code>,这部分可以是协议</li>
<li>如果实际是从类路径中获取数据,那么ide中运行,可能会出现<code>file</code>(target文件夹),‘jar’(maven仓库),<code>jrt</code>(jdk包)</li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">fancylight</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.fancylight.top/2020/02/11/spring%E5%B8%B8%E8%A7%81/">https://www.fancylight.top/2020/02/11/spring%E5%B8%B8%E8%A7%81/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.fancylight.top" target="_blank">博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%A1%86%E6%9E%B6/">框架    </a><a class="post-meta__tags" href="/tags/spring/">spring    </a><a class="post-meta__tags" href="/tags/spring%E7%BB%84%E4%BB%B6/">spring组件    </a></div><div class="post_share"><div class="social-share" data-image="/img/post.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/03/04/Spring-aop%E7%BB%87%E5%85%A5%E5%88%86%E6%9E%90/"><img class="prev_cover" src="/img/spring.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring_aop织入分析</div></div></a></div><div class="next-post pull_right"><a href="/2019/12/26/springMVC%E6%A0%B8%E5%BF%83/"><img class="next_cover" src="/img/spring.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">springMVC核心</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/03/10/spring内省/" title="spring内省"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-10</div><div class="relatedPosts_title">spring内省</div></div></a></div><div class="relatedPosts_item"><a href="/2019/02/19/SpringMVC源码/" title="SpringMVC体系"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-02-19</div><div class="relatedPosts_title">SpringMVC体系</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/04/Spring-aop织入分析/" title="Spring_aop织入分析"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-04</div><div class="relatedPosts_title">Spring_aop织入分析</div></div></a></div><div class="relatedPosts_item"><a href="/2019/05/25/aop/" title="aop"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-05-25</div><div class="relatedPosts_title">aop</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/01/spring-cache/" title="spring-cache"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-01</div><div class="relatedPosts_title">spring-cache</div></div></a></div><div class="relatedPosts_item"><a href="/2019/05/14/spring/" title="spring"><img class="relatedPosts_cover "src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-05-14</div><div class="relatedPosts_title">spring</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '624d139155758ea48077',
  clientSecret: 'cc126a301586ea63779cec6a6b53101749dbc9dd',
  repo: 'gittalk_issue',
  owner: 'fancylight',
  admin: ['fancylight'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By fancylight</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>